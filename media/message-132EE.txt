string line;
    ifstream myfile ("/opt/inkbox_device");
    if (myfile.is_open()) {
        while (getline(myfile, line)) {
            DEVICE = line;
        }
        myfile.close();
    }
    else {
        cout << "Unable to open file" << endl;
        return 1;
    }

    int EXIT_SIGN_FAILURE = 0;

    system("rc-service xorg stop 2>/dev/null");

    system("umount -l -f /kobo 2>/dev/null");
    if (DEVICE != "kt") {
        system("fuse-overlayfs -o allow_other,lowerdir=/opt/gui_rootfs/read,upperdir=/opt/gui_rootfs/write,workdir=/opt/gui_rootfs/work,nosuid /kobo");
    }
    else {
        system("unionfs -o cow,nonempty,nosuid,allow_other /opt/gui_rootfs/write=RW:/opt/gui_rootfs/read=RO /kobo");
    }

    system("rc-service ibxd restart");

    system("squashfuse /opt/update/update.isa /opt/isa");

    string DEVMODE;
    ifstream devmode_file("/opt/developer/key/valid-key");
    if (devmode_file.is_open()) {
        getline(devmode_file, DEVMODE);
        devmode_file.close();
    }

    if (DEVMODE == "true") {
        system("echo 'developer_fake-openssl_mount' > /run/initrd-fifo");
    }
    char *cmd = new char[1000];
    sprintf(cmd, "for f in /opt/isa/*.isa; do if [ \"${f}\" != \"/opt/isa/gui_rootfs.isa\" ]; then openssl dgst -sha256 -verify /opt/key/public.pem -signature \"${f}.dgst\" \"${f}\" &>/dev/null; if [ \"${?}\" != 0 ]; then %d=1; break; fi; fi; done", EXIT_SIGN_FAILURE);
    system(cmd);
    delete[] cmd;

    if (DEVMODE == "true") {
        system("echo 'developer_fake-openssl_unmount' > /run/initrd-fifo");
    }

    if (EXIT_SIGN_FAILURE == 0) {
        system("squashfuse -o allow_other,nosuid /opt/isa/inkbox.isa /kobo/mnt/onboard/.adds/inkbox");
        system("mount --bind /opt/config /kobo/mnt/onboard/.adds/inkbox/.config");
        if (DEVICE == "n437" || DEVICE == "n306") {
            system("mount --bind /lib/qt5-plugins/libkobo.so.2 /kobo/mnt/onboard/.adds/qt-linux-5.15.2-kobo/plugins/platforms/libkobo.so");
        }
        else if (DEVICE == "kt") {
            system("mount --bind /lib/qt5-plugi