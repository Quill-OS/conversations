==============================================================
Guild: Quill OS
Channel: Development / dev / postmarketOS Kobo Nia
==============================================================

[4/11/2023 9:17 PM] kuratius



[4/11/2023 9:18 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/pmbootstrapLog-288F4


[4/11/2023 9:19 PM] kuratius
what's the appropriate flashing method?


[4/11/2023 9:20 PM] andi15701
at first I would use nia only as a codename


[4/11/2023 9:21 PM] kuratius
it adds a kobo automatically


[4/11/2023 9:21 PM] andi15701
correct


[4/11/2023 9:22 PM] andi15701
flashing method is tricky, uuu works with empty sd


[4/11/2023 9:22 PM] andi15701
I would probably copy the device-kobo-clara package


[4/11/2023 9:23 PM] andi15701
instead of this dialog


[4/11/2023 9:23 PM] kuratius
where do I copy it and how am I meant to modify it?


[4/11/2023 9:23 PM] andi15701
so maybe answer "none"


[4/11/2023 9:24 PM] andi15701
source is:


[4/11/2023 9:24 PM] andi15701
~/.local/var/pmbootstrap/cache_git/pmaports/device/testing/device-kobo-clara


[4/11/2023 9:25 PM] kuratius
```21:24:15] *** pmaport generated: /home/pi/.local/var/pmbootstrap/cache_git/pmaports/device/testing/linux-kobo-nia
[21:24:15] Username [user]: dk
[21:24:24] Update package index for armv7 (4 file(s))
[21:24:32] Available user interfaces (13): 
[21:24:32] * none: Bare minimum OS image for testing and manual customization. The "console" UI should be selected if a graphical UI is not desired.
[21:24:32] * asteroid: (Wayland) Smartwatch UI from AsteroidOS
[21:24:32] * console: Console environment, with no graphical/touch UI
[21:24:32] * fbkeyboard: Plain framebuffer console with touchscreen keyboard support
[21:24:32] * gnome: (Wayland) Gnome Shell
[21:24:32] * gnome-mobile: (Wayland) Gnome Shell patched to adapt better to phones (Experimental)
[21:24:32] * i3wm: (X11) Tiling WM (keyboard required)
[21:24:32] * lxqt: (X11) Lightweight Qt Desktop Environment (stylus recommended)
[21:24:32] * mate: (X11) MATE Desktop Environment, fork of GNOME2 (stylus recommended)
[21:24:32] * plasma-desktop: (X11/Wayland) KDE Desktop Environment (works well with tablets)
[21:24:32] * shelli: Plain console with touchscreen gesture support
[21:24:32] * sxmo-de-dwm: Simple Mobile: Mobile environment based on SXMO and running on dwm
[21:24:32] * sxmo-de-sway: Simple Mobile: Mobile environment based on SXMO and running on sway
[21:24:32] * xfce4: (X11) Lightweight desktop (stylus recommended)
[21:24:32] NOTE: 6 user interfaces are not available. If device supports GPU acceleration, set "deviceinfo_gpu_accelerated" to make UIs available. See: <https://wiki.postmarketos.org/wiki/Deviceinfo_reference
[21:24:32] User interface [weston]: 

```


[4/11/2023 9:25 PM] andi15701
I try xfce4 first


[4/11/2023 9:26 PM] andi15701
You need a working kernel and u-boot


[4/11/2023 9:27 PM] andi15701
you have serial console working?


[4/11/2023 9:27 PM] kuratius
I can read it


[4/11/2023 9:27 PM] kuratius
writing is a bit iffy


[4/11/2023 9:28 PM] kuratius
(I have to hold down the cable, so I'm likely to lose contact if I type something)


[4/11/2023 9:29 PM] andi15701
So maybe we start with loading a kernel from that u-boot


[4/11/2023 9:29 PM] andi15701
a fresh one


[4/11/2023 9:30 PM] andi15701
Do you have the devicetree binary on the original system?


[4/11/2023 9:30 PM] kuratius
which option is xfce?


[4/11/2023 9:31 PM] kuratius
where would it be on the original sd?


[4/11/2023 9:31 PM] andi15701
[21:24:32] * xfce4: (X11) Lightweight desktop (stylus recommended)
[21:24:32] NOTE: 6 user interfaces are not available. If device supports GPU acceleration, set "deviceinfo_gpu_accelerated" to make UIs available. See: <https://wiki.postmarketos.org/wiki/Deviceinfo_reference
[21:24:32] User interface [weston]:

{Embed}
https://wiki.postmarketos.org/wiki/Deviceinfo_reference
Deviceinfo reference


[4/11/2023 9:31 PM] andi15701
but that is for later


[4/11/2023 9:31 PM] andi15701
looking it up


[4/11/2023 9:31 PM] kuratius
ah I just tried xfce instead xfce4


[4/11/2023 9:32 PM] kuratius
```21:31:37] Additional options: extra free space: 0 MB, boot partition size: 256 MB, parallel jobs: 5, ccache per arch: 5G, sudo timer: False, mirror: http://mirror.postmarketos.org/postmarketos/
[21:31:37] Change them? (y/n) [n]: 
```


[4/11/2023 9:32 PM] andi15701
https://misc.andi.de1.cc/kobo/


[4/11/2023 9:32 PM] andi15701
room before the first partition


[4/11/2023 9:32 PM] andi15701
check whether it is the same


[4/11/2023 9:33 PM] andi15701
https://github.com/akemnade/kobo-firmware-extractor

{Embed}
https://github.com/akemnade/kobo-firmware-extractor
GitHub - akemnade/kobo-firmware-extractor: extracts firmware from h...
extracts firmware from hidden partitions on Kobo/Tolino ebook readers - GitHub - akemnade/kobo-firmware-extractor: extracts firmware from hidden partitions on Kobo/Tolino ebook readers
/mnt/data/projects/git/conversations/media/kobo-firmware-extractor-61521


[4/11/2023 9:33 PM] andi15701
that tool can extract those hidden partitions


[4/11/2023 9:35 PM] kuratius
so compile with make, then run on the image, then run the sh file?


[4/11/2023 9:35 PM] andi15701
run the binary


[4/11/2023 9:36 PM] andi15701
with the corresponding offsets


[4/11/2023 9:41 PM] andi15701
extract-kobohidden clara-bkup.img 1286 out.dtb


[4/11/2023 9:42 PM] andi15701
something like that


[4/11/2023 9:55 PM] andi15701
the result should matchcarch/arm/boot/dts/imx6ull-e60u12.dts


[4/11/2023 9:56 PM] andi15701
in compiled form


[4/11/2023 9:56 PM] andi15701
so arch/arm/boot/dts/imx6ull-e60u12.dtb


[4/11/2023 9:56 PM] andi15701
if you compile that kernel


[4/11/2023 9:56 PM] andi15701
the vendor kernel


[4/11/2023 9:56 PM] andi15701
we then convert it into something more recent


[4/11/2023 10:11 PM] andi15701


{Attachments}
/mnt/data/projects/git/conversations/media/imx6ull-e60u12-1BFE8.dtb


[4/11/2023 10:11 PM] andi15701
that should be the result


[4/11/2023 10:11 PM] andi15701
so next thing: we convert that into something edible by a modern kernel


[4/11/2023 10:11 PM] andi15701
try to boot it


[4/11/2023 10:12 PM] andi15701
tell pmOS how to do it


[4/11/2023 10:20 PM] kuratius
(waiting on extraction of my image archive to complete, if it takes too long I might just clone the sd card again)


[4/11/2023 10:27 PM] andi15701
result of the extract-kobohidden call


[4/11/2023 10:27 PM] andi15701
I am too tired now


[4/11/2023 10:29 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/out-AEDBA.dtb


[4/11/2023 10:29 PM] kuratius
is this the right size?


[4/11/2023 10:30 PM] andi15701
a bit bigger


[4/11/2023 10:30 PM] andi15701
but might be ok


[4/11/2023 10:31 PM] andi15701
I will stop for today


[4/11/2023 10:32 PM] kuratius
kk


[4/12/2023 11:01 PM] andi15701
does that nia have bluetooth?


[4/12/2023 11:01 PM] kuratius
don't think so


[4/12/2023 11:02 PM] andi15701
wifi_regulator {
-                       btdis-gpio = <0x3a 0x16 0x00>;
-                       btint-gpio = <0x3a 0x18 0x00>;
                        compatible = "regulator-fixed";


[4/12/2023 11:02 PM] andi15701
I am wondering about that


[4/12/2023 11:02 PM] andi15701
bt = bluetooth


[4/12/2023 11:02 PM] andi15701
I am diffing the devicetree using dtdiff


[4/12/2023 11:02 PM] andi15701
lots of noise


[4/12/2023 11:03 PM] kuratius
do you think the file is corrupted?


[4/12/2023 11:03 PM] kuratius
or what do you mean by noise?


[4/12/2023 11:03 PM] andi15701
hall {
                        gpio-key,wakeup;
-                       gpios = <0x34 0x02 0x01>;
+                       gpios = <0x2f 0x02 0x01>;
                        label = "Hall";
                        linux,code = <0x23>;
                };


[4/12/2023 11:03 PM] kuratius
I bought this Nia in Japan for what it's worth


[4/12/2023 11:03 PM] andi15701
this one for example


[4/12/2023 11:04 PM] andi15701
logical identical


[4/12/2023 11:04 PM] andi15701
because both are references to the same gpio controller


[4/12/2023 11:04 PM] andi15701
gpio-controller;
                                interrupt-controller;
                                interrupts = <0x00 0x4a 0x04 0x00 0x4b 0x04>;
-                               linux,phandle = <0x34>;
-                               phandle = <0x34>;
+                               linux,phandle = <0x2f>;
+                               phandle = <0x2f>;
                                reg = <0x20ac000 0x4000>;


[4/12/2023 11:09 PM] andi15701
it the U67 component soldered


[4/12/2023 11:09 PM] andi15701
?


[4/12/2023 11:09 PM] kuratius
you need an image?


[4/12/2023 11:09 PM] kuratius
sec


[4/12/2023 11:09 PM] andi15701
on Sybet's niAudio images it is not soldered


[4/12/2023 11:11 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/PXL_20230326_111333253-32B4C.jpg


[4/12/2023 11:12 PM] andi15701
exciting


[4/12/2023 11:12 PM] andi15701
it is soldered


[4/12/2023 11:12 PM] kuratius
what's u67?


[4/12/2023 11:13 PM] andi15701
so that has some more functionality than Szybet's Nia


[4/12/2023 11:13 PM] andi15701
perhaps bluetooth


[4/12/2023 11:13 PM] kuratius
reminds me of how kindles have bluetooth enabled depending on what region you set them to


[4/12/2023 11:14 PM] kuratius
though for kindles it's a software thing only I think


[4/12/2023 11:14 PM] kuratius
(I can only use bluetooth on the kindle with my German amazon account, with my Japanese one it gets disabled)


[4/12/2023 11:25 PM] andi15701
the red marked thing

{Attachments}
/mnt/data/projects/git/conversations/media/u67-037E8.jpg


[4/12/2023 11:25 PM] andi15701
what is written on it?


[4/12/2023 11:26 PM] kuratius
sec


[4/12/2023 11:29 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/PXL_20230412_212853385-63523.jpg


[4/12/2023 11:30 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-DA5DC.png


[4/12/2023 11:30 PM] andi15701
ok, just an optic illusion


[4/12/2023 11:33 PM] kuratius
if you click on this and then on open in browser, is the text readable?


[4/12/2023 11:33 PM] andi15701
it is not there


[4/12/2023 11:34 PM] kuratius
also what do you think belongs in that position?


[4/12/2023 11:34 PM] kuratius
is there supposed to be text?


[4/12/2023 11:34 PM] andi15701
a chip


[4/12/2023 11:34 PM] kuratius
do you know what it's for?


[4/12/2023 11:35 PM] andi15701
with 32 pads


[4/12/2023 11:35 PM] andi15701
probably bluetooth


[4/12/2023 11:35 PM] kuratius
or is the chip maybe on the other side of the board


[4/12/2023 11:35 PM] andi15701
no


[4/12/2023 11:35 PM] andi15701
the pads are one-side only, not holes


[4/12/2023 11:35 PM] kuratius
i see


[4/12/2023 11:35 PM] kuratius
so no bluetooth?


[4/12/2023 11:36 PM] andi15701
no bluetooth


[4/12/2023 11:38 PM] kuratius
is there a chip that isnt on szybets nia or was that a false alarm?


[4/12/2023 11:39 PM] andi15701
false alarm


[4/12/2023 11:39 PM] andi15701
imx6ull-e60u22a10.dtb


[4/12/2023 11:39 PM] andi15701
is the correct dtb filename in the vendor kernel


[4/12/2023 11:41 PM] kuratius
where do I put that?


[4/12/2023 11:42 PM] andi15701
it is just the more readable file in the source kernel


[4/12/2023 11:42 PM] andi15701
next step: cleaning it up


[4/12/2023 11:42 PM] andi15701
imx6ull-e60u22a10.dts


[4/12/2023 11:43 PM] andi15701
generated from that source


[4/12/2023 11:46 PM] andi15701
pinctrl_flexcan2: flexcan2grp{


[4/12/2023 11:46 PM] andi15701
that is there


[4/12/2023 11:47 PM] andi15701
so any pinctrl.*: some-label wehre you cannot find references to that label


[4/12/2023 11:47 PM] andi15701
in either imx6ull-e60u22a10.dts


[4/12/2023 11:47 PM] andi15701
or imx6ull-e60u22a10-base.dts


[4/12/2023 11:59 PM] andi15701
mixed things up


[4/13/2023 12:00 AM] andi15701
so you would find &pinctrl_flexcan2


[4/13/2023 12:00 AM] andi15701
if there is a reference to it


[4/13/2023 12:00 AM] andi15701
if not than it should be deleted


[4/13/2023 12:43 AM] kuratius
sorry, what step are we at?


[4/13/2023 12:44 AM] andi15701
more tomorrow


[4/13/2023 12:44 AM] kuratius
kk


[4/13/2023 12:44 AM] andi15701
tired


[4/15/2023 12:08 AM] andi15701
the idea would be to create a recent close to mainline kernel, and that would be the one used in the linux-kobo-clara-mainline package + a devicetree for the nia.


[4/15/2023 12:13 AM] andi15701
And for that task I first wanted to make sure that we know where the factory devicetree  comes from to check if somebody has mixed up sources


[4/15/2023 12:14 AM] andi15701
I hope I find some time tomorrow


[4/16/2023 12:02 AM] andi15701
imx6ull-e60u22a10.dts contains a devicetree but that is not compatible with new kernels,


[4/16/2023 12:08 AM] andi15701
I am cleaning it up


[4/16/2023 12:08 AM] andi15701
does it have cold/warm backlight?


[4/16/2023 12:09 AM] kuratius
Nia is comfortlight, but without warmlight


[4/16/2023 12:09 AM] kuratius
So no I think


[4/16/2023 12:09 AM] andi15701
so you cannot regulate color temperature?


[4/16/2023 12:10 AM] kuratius
Don't think so


[4/16/2023 12:11 AM] kuratius
I think that is a comfortlight Pro feature


[4/16/2023 12:12 AM] kuratius
https://en.m.wikipedia.org/wiki/Kobo_eReader

{Embed}
https://en.m.wikipedia.org/wiki/Kobo_eReader
Kobo eReader
The Kobo eReader is an e-reader produced by Toronto-based Kobo Inc (a subsidiary of Rakuten). The company's name is an anagram of "book". The original version was released in May 2010 and was marketed as a minimalist alternative to the more expensive e-book readers available at the time. Like most e-readers, the Kobo uses an electronic ink scree...
/mnt/data/projects/git/conversations/media/1200px-Kobo_Aura-43822.jpg


[4/16/2023 12:18 AM] andi15701
memory {
                reg = <0x80000000 0x40000000>;
        };


[4/16/2023 12:18 AM] andi15701
1 GB of memory?!


[4/16/2023 12:19 AM] kuratius
How do I check if that's true?


[4/16/2023 12:21 AM] andi15701
enter free on a shell


[4/16/2023 12:21 AM] andi15701
I would expect 256MB


[4/16/2023 12:21 AM] kuratius
Serial shell in inkbox? Or the default koboOS?


[4/16/2023 12:22 AM] kuratius
Or can I ssh into it?


[4/16/2023 12:22 AM] andi15701
or do we have a bootlog somewhere?


[4/16/2023 12:23 AM] kuratius
Like this?


[4/16/2023 12:23 AM] kuratius
https://discord.com/channels/809205711778480158/809205711778480162/1090700867453337701


[4/16/2023 12:24 AM] kuratius
Wait


[4/16/2023 12:24 AM] kuratius
Wrong file


[4/16/2023 12:24 AM] kuratius
Sec


[4/16/2023 12:25 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/Crashlog2-5AB20.txt


[4/16/2023 12:25 AM] kuratius
This says 256Mb


[4/16/2023 12:25 AM] kuratius
This is from inkbox though


[4/16/2023 12:25 AM] kuratius
Not from the default os


[4/16/2023 12:25 AM] andi15701
ok, we trust that one


[4/16/2023 12:26 AM] kuratius
Does the default os think it's 1Gb?


[4/16/2023 12:27 AM] andi15701
it is specified in the device tree


[4/16/2023 12:27 AM] andi15701
but probably overwritten by u-boot


[4/16/2023 12:30 AM] andi15701
and then there are tihngs like:


[4/16/2023 12:30 AM] andi15701
hall {
-                   label = "Hall";
-               gpios = <&gpio5 2 GPIO_ACTIVE_LOW>;
-               linux,code = <KEY_H> ;
-               gpio-key,wakeup;


[4/16/2023 12:30 AM] andi15701
but we want:


[4/16/2023 12:30 AM] andi15701
+                       label = "Hall";
+                       gpios = <&gpio5 2 GPIO_ACTIVE_LOW>;
+                        linux,code = <SW_LID>;
+                        linux,input-type = <EV_SW>;
+                       gpio-key,wakeup;


[4/16/2023 12:32 AM] andi15701
so every ordinary linux knows that it is time to go to suspend if the cover is closed


[4/16/2023 12:32 AM] kuratius
Is the default devicetree misconfigured?


[4/16/2023 12:33 AM] andi15701
yes


[4/16/2023 12:33 AM] kuratius
lol


[4/16/2023 12:33 AM] andi15701
and then userspace has to correct that by implementing some mess on its own


[4/16/2023 12:35 AM] andi15701
so you need to fiddle with the userspace to ignore h key as an ordinary input


[4/16/2023 12:36 AM] andi15701
but pass it just to the powermanagement system


[4/16/2023 12:41 AM] andi15701
if (gptHWCFG->m_val.bUIStyle) {
                        if(0==strcmp(button->desc,"Hall"))
                                button->code = KEY_F1;
                        else if (0==strcmp(button->desc,"Home"))
                                button->code = KEY_HOME;
                }


[4/16/2023 12:41 AM] kuratius
I'm searching for the ram chip serial atm


[4/16/2023 12:41 AM] kuratius
I found something that sorta matches but it's a 2GB chip


[4/16/2023 12:41 AM] andi15701
and then we have that mess in the kernel just reconfiguring it to F1


[4/16/2023 12:41 AM] andi15701
2Gbit?


[4/16/2023 12:42 AM] andi15701
= 256MByte


[4/16/2023 12:42 AM] kuratius
Ah 
It says 2Gb, not 2GB, my bad


[4/16/2023 12:50 AM] kuratius
Is that for later?


[4/16/2023 12:58 AM] andi15701
kernel hack to just remap that button to another wrong button


[4/16/2023 12:58 AM] andi15701
in the original kernel


[4/16/2023 12:59 AM] andi15701
and then we have things like declaring the usb power supply as a battery


[4/16/2023 1:00 AM] andi15701
confusing most standard software...


[4/17/2023 12:22 AM] andi15701
ok, I think I have now nearly something


[4/17/2023 12:22 AM] andi15701
so maybe something to test in 1 or 2 days


[4/18/2023 12:29 AM] andi15701
andi@aktux:~/kobo/nia$ cmp arch/arm/boot/dts/imx6ull-e60u22a10.dtb ~/Downloads/out.dtb
andi@aktux:~/kobo/nia$ sha256sum ~/Downloads/out.dtb
2cfc685fcc5111c6ff3253581950715bdbc053f39c45e08134b73363f40a57bf  /home/andi/Downloads/out.dtb


[4/18/2023 12:31 AM] andi15701
cpp -I include/ arch/arm/boot/dts/imx6ull-e60u22a10.dts >imx6ull-nia-orig.dts


[4/18/2023 12:32 AM] andi15701
compare the regulator settings with

{Attachments}
/mnt/data/projects/git/conversations/media/imx6ull-nia-orig-4F64F.dts


[4/18/2023 12:34 AM] andi15701
with https://github.com/akemnade/linux  branch kobo/nia-test

{Embed}
https://github.com/akemnade/linux
GitHub - akemnade/linux: Linux kernel source tree
Linux kernel source tree. Contribute to akemnade/linux development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/linux-92DDE


[4/18/2023 12:35 AM] andi15701
arch/arm/boot/dts/imx6ull-kobo-nia.dts


[4/18/2023 12:43 AM] andi15701
search for ricoh619 or rc5t619


[4/18/2023 4:23 PM] andi15701
can you just compare these two things as a second pair of eyes?


[4/18/2023 4:35 PM] andi15701
then we can try to boot that thing


[4/18/2023 4:48 PM] andi15701
and then put that into a device package for pmOS


[4/18/2023 4:53 PM] andi15701
dcdc1_reg: DCDC1 {
                                regulator-min-microvolt = <1400000>;
                                regulator-max-microvolt = <1400000>;
                                regulator-name = "DCDC1";
                                regulator-always-on;
                                regulator-boot-on;
                                regulator-state-mem {
                                        regulator-on-in-suspend;
                                        regulator-suspend-microvolt = <900000>;
                                };
                        };


[4/18/2023 4:53 PM] andi15701
vs.


[4/18/2023 4:54 PM] andi15701
ricoh619_dcdc1_reg: regulator@0 {
                        reg = <0>;
                        regulator-min-microvolt = <1400000>;
                        regulator-max-microvolt = <1400000>;
                        regulator-compatible = "ricoh619_dc1";
                        regulator-always-on;
                        regulator-boot-on;
                        regulator-state-mem {
                                regulator-on-in-suspend;
                                regulator-suspend-microvolt = <900000>;
                        };
                };


[4/18/2023 4:54 PM] andi15701
this is equal, the declaration format just has changed


[4/18/2023 5:17 PM] andi15701
so change form regulator-compatible to regulator-name is sane, same for ricoh619_dc -> DCDC, ricoh619_ldo -> LDO


[4/18/2023 5:25 PM] andi15701
the only thing which could realitically be changed would the order of numbers


[4/18/2023 9:00 PM] kuratius
reg = <0>;
Is this line new?


[4/18/2023 9:03 PM] andi15701
that is old


[4/18/2023 9:03 PM] andi15701
and not needed for the in-tree driver


[4/18/2023 9:04 PM] andi15701
the pattern is the same for the other regulators


[4/18/2023 9:04 PM] kuratius
What's the format for this?
ricoh619_dcdc1_reg: regulator@0 

Regulartype:whatisafterthecolon


[4/18/2023 9:06 PM] andi15701
label: type@address-at-bus


[4/18/2023 9:06 PM] andi15701
label is used for referencing  it


[4/18/2023 9:06 PM] kuratius
dcdc1_reg: DCDC1 this doesnt have an address?


[4/18/2023 9:06 PM] andi15701
no because it does not have bus semantics


[4/18/2023 9:06 PM] kuratius
I see


[4/18/2023 9:07 PM] kuratius
so do you think this can be tried?


[4/18/2023 9:07 PM] andi15701
the driver in the 4.1.15 is different than in the mainline kernel


[4/18/2023 9:07 PM] kuratius
sorry for not replying to this, are you asking me to compare the settings written there?


[4/18/2023 9:08 PM] andi15701
yes, that settings with the one in my git


[4/18/2023 9:08 PM] kuratius
I mean, can we change these settings and then try to boot something or is there other stuff still needed? I realize that you basically did all the work on this, don't worry


[4/18/2023 9:08 PM] andi15701
just have a second pair of eines


[4/18/2023 9:08 PM] kuratius
to look for typos?


[4/18/2023 9:09 PM] kuratius
I wouldn't know how the setting files work beyond being able to spot inconsistent syntax


[4/18/2023 9:09 PM] andi15701
yes, just inconsistencies


[4/18/2023 9:09 PM] andi15701
so regulator-name mismatch with the labelname


[4/18/2023 9:09 PM] kuratius
then I cant see anything that you havent already pointed out


[4/18/2023 9:10 PM] andi15701
dcdc1_reg: DCDC1 { regulator-name="DCDC2" }


[4/18/2023 9:11 PM] andi15701
would be bad


[4/18/2023 9:11 PM] kuratius
I see, in what sense?


[4/18/2023 9:11 PM] kuratius
would it destroy the device or just not boot?


[4/18/2023 9:11 PM] andi15701
it could destroy


[4/18/2023 9:12 PM] kuratius
I see


[4/18/2023 9:12 PM] kuratius
well, it looks good for now and if it goes wrong it's not that big of a deal


[4/18/2023 9:12 PM] andi15701
I did the conversion mostly by search/replace


[4/18/2023 9:12 PM] andi15701
so chances are very low


[4/18/2023 9:12 PM] andi15701
so are you able to compile that branch?


[4/18/2023 9:13 PM] andi15701
with kobo_defconfig?


[4/18/2023 9:13 PM] kuratius
should I look at the entire file or only these settings specifically?


[4/18/2023 9:13 PM] andi15701
or rather kobo_usbnfs_defconfig


[4/18/2023 9:13 PM] andi15701
only those regulator things


[4/18/2023 9:13 PM] andi15701
the other ones are not that critical


[4/18/2023 9:14 PM] kuratius
where is kobo_defconfig? Do I download the branch and it's part of that, or is it a separate tool?


[4/18/2023 9:14 PM] andi15701
andi@aktux:~/kobo/kernel$ ls -l arch/arm/configs/kobo_*
-rw-r--r-- 1 andi andi 8854 Apr 17 22:51 arch/arm/configs/kobo_defconfig
-rw-r--r-- 1 andi andi 8301 Apr 17 22:51 arch/arm/configs/kobo_usbnfs_defconfig


[4/18/2023 9:15 PM] andi15701
so you would do make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- kobo_usbnfs_defconfig zImage modules dtbs


[4/18/2023 9:16 PM] andi15701
so you clone that git repository


[4/18/2023 9:16 PM] andi15701
checkout kobo/nia-test


[4/18/2023 9:16 PM] andi15701
and try to compile that


[4/18/2023 9:28 PM] kuratius
kk


[4/18/2023 9:28 PM] kuratius
CROSS_COMPILE=arm-linux-gnueabihf- 
is this meant to be CROSS_COMPILE=arm-linux-gnueabihf?


[4/18/2023 9:30 PM] andi15701
with dash


[4/18/2023 9:30 PM] andi15701
CC              = $(CROSS_COMPILE)gcc


[4/18/2023 9:30 PM] andi15701
arm-linux-gnueabihf-gcc


[4/18/2023 9:30 PM] andi15701
and we have that command


[4/18/2023 9:34 PM] kuratius
I see


[4/18/2023 9:35 PM] kuratius
do I need a lot of ram for this? downloading the branch on my pi 400 atm, if it's gonna crash it's better to ask


[4/18/2023 9:36 PM] andi15701
some GB are enough


[4/18/2023 9:37 PM] andi15701
512MB as on the Kobo Clara is not


[4/18/2023 9:37 PM] kuratius
4GB


[4/18/2023 9:37 PM] andi15701
that is more than enough


[4/18/2023 9:38 PM] andi15701
hardest thing is git


[4/18/2023 9:38 PM] andi15701
itself


[4/18/2023 9:38 PM] andi15701
the git operations take a considerable amount of RAM


[4/18/2023 9:38 PM] kuratius
I know stuff like LLVM takes like 16GB so I was worried about the kernel being similar


[4/18/2023 9:39 PM] kuratius
I'm downloading using ```git clone --branch kobo/nia-test --single-branch https://github.com/akemnade/linux.git``` but it's taking a while


[4/18/2023 9:49 PM] andi15701
if you have clang installed: make ARCH=arm LLVM=-13 zImage modules dtbs


[4/18/2023 9:50 PM] andi15701
replace -13 by your clang-version


[4/18/2023 9:50 PM] andi15701
and make sure that ld.lld is also available


[4/18/2023 9:51 PM] kuratius
I can install clang, shouldn't be an issue


[4/18/2023 9:51 PM] andi15701
does not matter which one is installed


[4/18/2023 9:51 PM] andi15701
either some 32bit arm gcc


[4/18/2023 9:51 PM] andi15701
or clang + ld.lld


[4/18/2023 9:52 PM] kuratius
kk


[4/18/2023 10:20 PM] kuratius
fails


[4/18/2023 10:20 PM] kuratius
one se


[4/18/2023 10:20 PM] kuratius
*sec


[4/18/2023 10:20 PM] kuratius
do I need to modify a file in the repo?


[4/18/2023 10:21 PM] kuratius
I tried this command ```make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- kobo_usbnfs_defconfig zImage modules dtbs
```


[4/18/2023 10:21 PM] kuratius
make: nothing to do for target zImage


[4/18/2023 10:23 PM] andi15701
excatly the same commands works here


[4/18/2023 10:23 PM] andi15701
you are in the right directory?


[4/18/2023 10:23 PM] kuratius
sec


[4/18/2023 10:24 PM] kuratius
/home/pi/nia/linux/arch/arm/configs


[4/18/2023 10:24 PM] andi15701
cd /home/pi/nia/linux


[4/18/2023 10:24 PM] andi15701
and do it there


[4/18/2023 10:25 PM] kuratius
```cd /home/pi/nia/linux
pi@raspberrypi:~/nia/linux $ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- kobo_usbnfs_defconfig zImage modules dtbs
  HOSTCC  scripts/basic/fixdep
  HOSTCC  scripts/kconfig/conf.o
  HOSTCC  scripts/kconfig/confdata.o
  HOSTCC  scripts/kconfig/expr.o
  LEX     scripts/kconfig/lexer.lex.c
/bin/sh: 1: flex: not found
make[2]: *** [scripts/Makefile.host:9: scripts/kconfig/lexer.lex.c] Fehler 127
make[1]: *** [Makefile:697: kobo_usbnfs_defconfig] Fehler 2
make: *** [Makefile:362: __build_one_by_one] Fehler 2
pi@raspberrypi:~/nia/linux $ 
```


[4/18/2023 10:25 PM] andi15701
apt-get install flex bison bc


[4/18/2023 10:25 PM] kuratius
also do I need to change the cross_compile option since pi400 is already an arm architecture?


[4/18/2023 10:25 PM] kuratius
kk


[4/18/2023 10:26 PM] andi15701
I think arm64 != arm


[4/18/2023 10:27 PM] andi15701
do you have that arm-linux-gnueabihf-gcc installed?


[4/18/2023 10:28 PM] kuratius
how do I check?


[4/18/2023 10:28 PM] kuratius
pi400 can run 32 bit software usually


[4/18/2023 10:28 PM] andi15701
is that command available?


[4/18/2023 10:28 PM] kuratius
dont think so


[4/18/2023 10:28 PM] kuratius
but this is available arm-linux-gnueabihf-pkg-config


[4/18/2023 10:29 PM] andi15701
ok, just try without cross-compile


[4/18/2023 10:30 PM] andi15701
and check file type of the files generated


[4/18/2023 10:30 PM] andi15701
vmscan.o: ELF 32-bit LSB relocatable, ARM, EABI5 version 1 (SYSV), not stripped


[4/18/2023 10:31 PM] kuratius
what command do I use to check the type?


[4/18/2023 10:31 PM] kuratius
vmscan?


[4/18/2023 10:31 PM] kuratius
wait no


[4/18/2023 10:31 PM] kuratius
.o is a file ending for compiled libraries right?


[4/18/2023 10:32 PM] andi15701
yes


[4/18/2023 10:32 PM] andi15701
file something.o


[4/18/2023 10:32 PM] andi15701
to check if something sane is generated


[4/18/2023 10:32 PM] kuratius
CC      scripts/mod/empty.o
gcc: error: unrecognized argument in option ‘-mabi=aapcs-linux’
gcc: note: valid arguments to ‘-mabi=’ are: ilp32 lp64
gcc: error: unrecognized command-line option ‘-mfpu=vfp’
gcc: error: unrecognized command-line option ‘-mtp=cp15’
gcc: error: unrecognized command-line option ‘-msoft-float’
make[2]: *** [scripts/Makefile.build:250: scripts/mod/empty.o] Fehler 1
make[1]: *** [Makefile:1281: prepare0] Fehler 2
make: *** [Makefile:362: __build_one_by_one] Fehler 2


[4/18/2023 10:32 PM] andi15701
ok, that one is not good


[4/18/2023 10:32 PM] andi15701
so either


[4/18/2023 10:32 PM] andi15701
apt-get install arm-linux-gnueabihf-gcc


[4/18/2023 10:33 PM] andi15701
or apt-get install clang ld.llvm (do not know the exact packet names)


[4/18/2023 10:38 PM] kuratius
apt-get install gcc-arm-linux-gnueabihf
this worked


[4/18/2023 10:38 PM] kuratius
sec


[4/18/2023 10:40 PM] kuratius
compiling


[4/18/2023 10:49 PM] kuratius
HOSTCC  certs/extract-cert
certs/extract-cert.c:21:10: fatal error: openssl/bio.h: Datei oder Verzeichnis nicht gefunden
   21 | #include <openssl/bio.h>
      |          ^~~~~~~~~~~~~~~
compilation terminated.
make[3]: *** [scripts/Makefile.host:111: certs/extract-cert] Fehler 1
make[2]: *** [scripts/Makefile.build:500: certs] Fehler 2
make[1]: *** [Makefile:2005: .] Fehler 2
make: *** [Makefile:362: __build_one_by_one] Fehler 2


[4/18/2023 10:49 PM] kuratius
missing cert


[4/18/2023 10:49 PM] andi15701
apt-get install libssl-dev


[4/18/2023 10:50 PM] andi15701
andi@aktux:~/kobo/kernel$ grep quiet\" init/main.c 
early_param("quiet", quiet_kernel);


[4/18/2023 10:50 PM] andi15701
and rename that thing


[4/18/2023 10:50 PM] andi15701
the "quiet"


[4/18/2023 10:51 PM] andi15701
because some stupid u-boots add quiet to the commandline without asking


[4/18/2023 10:52 PM] kuratius
where is the file  and line that needs to be renamed?


[4/18/2023 10:52 PM] andi15701
in the kernel


[4/18/2023 10:52 PM] andi15701
init/main.c


[4/18/2023 10:52 PM] kuratius
kk


[4/18/2023 10:52 PM] andi15701
and the early_param line


[4/18/2023 10:53 PM] andi15701
so if u-boot appends quiet to the commandline the kernel will just not understand that


[4/18/2023 10:53 PM] andi15701
and happily prints out debug messages


[4/18/2023 10:53 PM] andi15701
so we know what's going on


[4/18/2023 10:54 PM] kuratius
rename to what? or just comment out?


[4/18/2023 10:54 PM] andi15701
e.g.


[4/18/2023 10:54 PM] andi15701
early_param("quiettt", quiet_kernel);


[4/18/2023 10:55 PM] kuratius
early_param("debug", debug_kernel);
early_param("quiettt", quiet_kernel);
this good?


[4/18/2023 10:55 PM] andi15701
yes


[4/18/2023 11:44 PM] andi15701
what we need next: a sd card with the original hidden partition stuff


[4/18/2023 11:45 PM] andi15701
and a small (lets. say 64MB) ext2 oder ext4 (formatted with -O ^64bit) partition behind the hidden stuff


[4/18/2023 11:45 PM] andi15701
but not today anymore


[4/18/2023 11:59 PM] kuratius
LZO     arch/arm/boot/compressed/piggy_data
/bin/sh: 1: lzop: not found
make[3]: *** [arch/arm/boot/compressed/Makefile:161: arch/arm/boot/compressed/piggy_data] Fehler 127
make[3]: *** Datei „arch/arm/boot/compressed/piggy_data“ wird gelöscht
make[2]: *** [arch/arm/boot/Makefile:58: arch/arm/boot/compressed/vmlinux] Fehler 2
make[1]: *** [arch/arm/Makefile:297: zImage] Fehler 2
make: *** [Makefile:362: __build_one_by_one] Fehler 2


[4/18/2023 11:59 PM] kuratius
probably need to install lzop?


[4/18/2023 11:59 PM] andi15701
yes


[4/18/2023 11:59 PM] kuratius
installed and compiling again


[4/19/2023 12:00 AM] kuratius
I have an image


[4/19/2023 12:00 AM] kuratius
also have a secondary sd card I can use, no need to write anything to the original


[4/19/2023 12:02 AM] kuratius
should I use gparted or would it be better to use a command line tool? gparted sometimes makes partitions root only when formatting stuff, it's annoying but can be dealt with


[4/19/2023 12:39 AM] kuratius
compiled successfully


[4/19/2023 6:49 PM] andi15701
does not matter too much, it is just important to have it formatted with -O  ^64bit


[4/19/2023 6:51 PM] andi15701
we need the kernel, the devicetree (imx6sl-kobo-nia.dtb) on it as a first step


[4/19/2023 7:15 PM] andi15701
so we can find out how u-boot behaves


[4/19/2023 10:31 PM] kuratius
so I format an sd card, put xyz partitions on it, copy some partition from the original sd, and then?


[4/19/2023 10:32 PM] kuratius
also which partition has the hidden stuff?


[4/19/2023 10:32 PM] andi15701
there is a gap before the first partition on the original sdcard


[4/19/2023 10:33 PM] kuratius
what's the best way to copy that gap? a dd command with an offset?


[4/19/2023 10:36 PM] andi15701
well, just dd if=backup-image.img bs=512 count=49152 of=/dev/sdX


[4/19/2023 10:36 PM] andi15701
or just clone the whole sdcard


[4/19/2023 10:37 PM] kuratius
I'll try cloning the sd card


[4/19/2023 10:37 PM] kuratius
sec


[4/20/2023 12:17 AM] kuratius
cloning is done, took a while


[4/20/2023 12:17 AM] kuratius
will check what partitions are on it


[4/20/2023 12:19 AM] kuratius
```
Disk /dev/sdb: 14,84 GiB, 15931539456 bytes, 31116288 sectors
Disk model: STORAGE DEVICE  
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xb6844f2f

Device     Boot   Start      End  Sectors  Size Id Type
/dev/sdb1         49152   573440   524289  256M 83 Linux
/dev/sdb2        573441  1097729   524289  256M 83 Linux
/dev/sdb3       1097730 15491070 14393341  6,9G  b W95 FAT32
```


[4/20/2023 12:50 PM] andi15701
so for a first check you can just use/format one of the existing


[4/20/2023 1:12 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/2023-04-20-130928_1600x900_scrot-F5EA5.png


[4/20/2023 1:13 PM] kuratius
after formatting then copy the kernel somewhere?


[4/20/2023 1:13 PM] kuratius
probably sdb1?


[4/20/2023 1:14 PM] kuratius
or how does the thing know where to find and load the kernel?


[4/20/2023 1:15 PM] kuratius
is this the kernel we built?

{Attachments}
/mnt/data/projects/git/conversations/media/vmlinux-F50C7.o


[4/20/2023 2:16 PM] andi15701
zImage


[4/20/2023 2:16 PM] andi15701
arch/arm/boot/zImage


[4/20/2023 2:16 PM] andi15701
arch/arm/boot/dts/imx6ull-kobo-nia.dtb


[4/20/2023 2:44 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/zImage-5408F


[4/20/2023 2:49 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/imx6ull-kobo-nia-4566D.dts


[4/20/2023 2:49 PM] kuratius
wait no


[4/20/2023 2:49 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/imx6ull-kobo-nia-72438.dtb


[4/20/2023 3:10 PM] kuratius
copy to sdb1?


[4/20/2023 3:13 PM] kuratius
or am I supposed to use a dd command like here?
https://discord.com/channels/809205711778480158/830961435122991155/1021124746542321775


[4/20/2023 3:15 PM] kuratius
During the boot process, I assume it reads the hidden sector, does it start looking for the kernel after that? Does it expect the kernel to be in a specific location?


[4/20/2023 3:32 PM] andi15701
we need to teach u-boot what to do


[4/20/2023 3:32 PM] andi15701
that can be automated


[4/20/2023 3:32 PM] andi15701
more about that later


[4/20/2023 3:33 PM] kuratius
kk


[4/20/2023 3:33 PM] andi15701
you can study the device-kobo-clara pmOS package for details


[4/20/2023 3:33 PM] andi15701
but you can copy it to sdb1


[4/20/2023 5:29 PM] szybet
Are you guys using mainline kernel for the nia?


[4/20/2023 6:44 PM] andi15701
yes


[4/20/2023 6:45 PM] andi15701
uboot-script-mainline.cmd


[4/20/2023 6:46 PM] andi15701
setenv bootargs console=ttymxc0,115200

# This must be called first, otherwise bootz does not work correctly.
# The actual kernel is loaded over this below.
load_ntxkernel

echo Loading kernel
load mmc 0:1 0x80800000 vmlinuz

echo Loading DTB
load mmc 0:1 0x83000000 imx6sll-kobo-clarahd.dtb

echo Loading initrd
load mmc 0:1 0x85000000 uInitrd

echo Booting kernel
bootz 0x80800000 0x85000000 0x83000000


[4/20/2023 6:46 PM] andi15701
something like that should work in the u-boot commandline


[4/20/2023 6:47 PM] andi15701
bootz 0x80800000 - 0x83000000


[4/20/2023 6:47 PM] andi15701
in the last line


[4/20/2023 6:47 PM] andi15701
and skip everything about uInitrd


[4/20/2023 6:48 PM] andi15701
so break into commandline and paste given lines


[4/20/2023 7:02 PM] andi15701
that thing is from the Kobo Clara pmOS package


[4/20/2023 7:14 PM] szybet
So he is willing to test it?


[4/20/2023 7:15 PM] andi15701
yes


[4/20/2023 7:18 PM] andi15701
the general theory about u-boot is:


[4/20/2023 7:19 PM] andi15701
there is some list of variables, called environment, there is a compiled-in version and usually also a version read from somewhere


[4/20/2023 7:20 PM] andi15701
the latter can usually be written separately using the saveenv command


[4/20/2023 7:21 PM] andi15701
the two important variables are: bootargs: parameters for the kernel, and bootcmd: a list of commands to execute to boot the system


[4/20/2023 7:22 PM] andi15701
that means, getting kernel devicetree and possibly devicetree into memory


[4/20/2023 7:22 PM] andi15701
and then bootz is called


[4/20/2023 7:22 PM] andi15701
or bootm, depending on format


[4/20/2023 7:22 PM] andi15701
to actually boot the system loaded into memory


[4/20/2023 7:57 PM] kuratius
(I'll have to go through this later, have to finish something for uni first, but is this a file I need to edit? Where do I find it?)


[4/20/2023 7:59 PM] andi15701
I just pasted the contents


[4/20/2023 8:00 PM] andi15701
first try them (with the obvious adaptations) on the u-boot cmdline


[4/21/2023 8:21 PM] andi15701
any progress here?


[4/21/2023 8:22 PM] kuratius
I'll get to it now
Copy zImage to sdb1 (as a file?), then where do I find the uboot cmdline?


[4/21/2023 8:22 PM] andi15701
there is some countdown at boot


[4/21/2023 8:22 PM] andi15701
on the serial console


[4/21/2023 8:23 PM] andi15701
you break into commandline by hitting a key


[4/21/2023 8:23 PM] kuratius
k will try


[4/21/2023 8:35 PM] kuratius
I copied the dtb and zImage files to the first partition with sudo cp zImage /path/to/partition and sudo cp imx6ull-kobo-nia.dtb /path/to/partition
then I tried to boot and got this log

{Attachments}
/mnt/data/projects/git/conversations/media/bootlog-8C979.txt


[4/21/2023 8:36 PM] andi15701
Hit any key to stop autoboot:  0


[4/21/2023 8:36 PM] andi15701
you were not fast enough


[4/21/2023 8:36 PM] kuratius
k


[4/21/2023 8:38 PM] kuratius
I'm not that fast


[4/21/2023 8:39 PM] kuratius
it zips by in 0.1 seconds


[4/21/2023 8:39 PM] szybet
it booted?


[4/21/2023 8:39 PM] andi15701
just hit enter before that appears


[4/21/2023 8:39 PM] andi15701
and hold it


[4/21/2023 8:43 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-DDA81.txt


[4/21/2023 8:44 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-325FA.txt


[4/21/2023 8:44 PM] andi15701
yes, that is nice


[4/21/2023 8:45 PM] andi15701
now we need this


[4/21/2023 8:45 PM] andi15701
with the obviously adaptations


[4/21/2023 8:46 PM] andi15701
keep load_ntxkernel


[4/21/2023 8:46 PM] andi15701
but of course not the clara devicetree


[4/21/2023 8:46 PM] andi15701
but the nia one


[4/21/2023 8:47 PM] kuratius
can I edit it and paste?


[4/21/2023 8:47 PM] andi15701
perhaps line by line


[4/21/2023 8:48 PM] andi15701
line by line is ok


[4/21/2023 8:48 PM] kuratius
im holdinng the serial connection, so i kind of have to d it onehanded


[4/21/2023 8:49 PM] andi15701
when we know how this u-boot behaves, it can be automated (and later we can use a more recent u-boot


[4/21/2023 8:51 PM] szybet
any cool reasons to use a more up to date one?


[4/21/2023 8:52 PM] andi15701
we can play around more easily with buttons, accept recent filesystems


[4/21/2023 8:53 PM] andi15701
on the imx6sl I only get deep sleep in recent kernels with a more recent one


[4/21/2023 8:53 PM] andi15701
less traps


[4/21/2023 8:53 PM] andi15701
if playing around with it


[4/21/2023 8:53 PM] kuratius
setenv bootargs console=ttymxc0,115200

# This must be called first, otherwise bootz does not work correctly.
# The actual kernel is loaded over this below.
load_ntxkernel

echo Loading kernel
load mmc 0:1 0x80800000 zImage

echo Loading DTB
load mmc 0:1 0x83000000 imx6ull-kobo-nia.dtb

echo Loading initrd
load mmc 0:1 0x85000000 uInitrd

echo Booting kernel
bootz 0x80800000 0x85000000 0x83000000


[4/21/2023 8:54 PM] kuratius
sec


[4/21/2023 8:54 PM] andi15701
not appending quiet to commantline


[4/21/2023 8:54 PM] andi15701
withou initrd


[4/21/2023 8:54 PM] andi15701
and bootz 0x80800000 - 0x83000000


[4/21/2023 9:02 PM] kuratius
Fastboot: Normal                                                                
Hit any key to stop autoboot:  0                                                
RC5T619_watchdog(0,0)                                                           
eBR-1A #                                                                        
eBR-1A #                                                                        
            ÿ                                                                   
Unknown command 'üãûÏ°þþÃü°ÎøÎïüï°ÎøÎïüï°ÎøÎïüï°ÎøÎ' - try 'help'               
eBR-1A # setenv bootargs console=ttymxc0,115200                                 
eBR-1A # load_ntxkernel                                                         
mmc read 0x80800000 0x800 0x2c00                                                
                                                                                
MMC read: dev # 0, block # 2048, count 11264 ... 11264 blocks read: OK          
eBR-1A # echo Loading kernel                                                    
Loading kernel                                                                  
eBR-1A # load mmc 0:1 0x80800000 vmlinuz                                        
** File not found vmlinuz **                                                    
eBR-1A # echo Loading DTB                                                       
Loading DTB                                                                     
eBR-1A # load mmc 0:1 0x83000000 imx6ull-kobo-nia.dtb                           
** File not found imx6ull-kobo-nia.dtb **                                       
eBR-1A #


[4/21/2023 9:02 PM] kuratius
can we disable fastboot?


[4/21/2023 9:03 PM] andi15701
I think it does not matter


[4/21/2023 9:03 PM] andi15701
ls mmc 0:1 /


[4/21/2023 9:04 PM] kuratius
?


[4/21/2023 9:04 PM] andi15701
command for u-boot


[4/21/2023 9:04 PM] andi15701
to check what is there


[4/21/2023 9:05 PM] andi15701
and of course you do not need the lines with echo


[4/21/2023 9:06 PM] andi15701
just check whether it can access the mmc


[4/21/2023 9:10 PM] kuratius
it might be ignoring enter


[4/21/2023 9:11 PM] andi15701
or the device went off


[4/21/2023 9:11 PM] andi15701
load mmc 0:1 0x80800000 vmlinuz  <-- if the keep the file as zImage, we call need to call it zImage here also


[4/21/2023 9:12 PM] kuratius
eBR-1A # ls mmc 0:1 /                                                           
<DIR>       1024 .                                                              
<DIR>       1024 ..                                                             
<DIR>      12288 lost+found


[4/21/2023 9:12 PM] andi15701
well, no files there..


[4/21/2023 9:13 PM] andi15701
so something is wrong with your card


[4/21/2023 9:13 PM] kuratius
sec


[4/21/2023 9:13 PM] andi15701
something stupid during copying


[4/21/2023 9:14 PM] andi15701
btw: mmc 0:1  = partition 1 on the first (here we start with 0) sd/mmc


[4/21/2023 9:15 PM] andi15701
btw: ums 0 mmc 0


[4/21/2023 9:16 PM] andi15701
should export the card as usb mass storage


[4/21/2023 9:17 PM] kuratius
ima copy the files to all the partitions


[4/21/2023 9:19 PM] kuratius
do I need to modify bootz here?


[4/21/2023 9:19 PM] andi15701
as said:  bootz 0x80800000 - 0x83000000


[4/21/2023 9:20 PM] andi15701
we try first without initrd


[4/21/2023 9:22 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-15F2A.txt


[4/21/2023 9:25 PM] andi15701
6.527730] imx6ul-pinctrl 2290000.iomuxc-snvs: pin MX6ULL_PAD_SNVS_TAMPER3 s
[    6.540191] imx6ul-pinctrl 2290000.iomuxc-snvs: pin-5 (gpio-keys) status -22 
[    6.547416] imx6ul-pinctrl 2290000.iomuxc-snvs: could not request pin 5 (MX6s


[4/21/2023 9:25 PM] andi15701
I would like to see this ungarbled


[4/21/2023 9:25 PM] andi15701
@Szybet any dmesg after boot?


[4/21/2023 9:26 PM] andi15701
it is also there in the vendor kernel


[4/21/2023 9:27 PM] andi15701
snvs_rtc 20cc000.snvs:snvs-rtc-lp: registered as rtc0    grrr


[4/21/2023 9:27 PM] andi15701
but that is easy to fix


[4/21/2023 9:27 PM] kuratius
I can try again with a bigger window, it got cut off


[4/21/2023 9:27 PM] andi15701
log to file


[4/21/2023 9:27 PM] kuratius
how


[4/21/2023 9:28 PM] kuratius
bash syntax?


[4/21/2023 9:28 PM] andi15701
what are you using?


[4/21/2023 9:28 PM] kuratius
minicom


[4/21/2023 9:28 PM] kuratius
window went blank after resizing


[4/21/2023 9:28 PM] kuratius
ima start over


[4/21/2023 9:29 PM] andi15701
ctrl-a l


[4/21/2023 9:29 PM] kuratius
sudo minicom -D /dev/serial0 >>bootLog.txt this good?


[4/21/2023 9:29 PM] kuratius
too late


[4/21/2023 9:30 PM] andi15701
well, you want to see it on the screen


[4/21/2023 9:30 PM] kuratius
but for next time what would that do?


[4/21/2023 9:30 PM] andi15701
it asks for a file


[4/21/2023 9:30 PM] andi15701
to save things


[4/21/2023 9:30 PM] kuratius
I see


[4/21/2023 9:30 PM] kuratius
so I can use it to log after looking?


[4/21/2023 9:30 PM] andi15701
did it appear on usb?


[4/21/2023 9:31 PM] kuratius
did what?


[4/21/2023 9:31 PM] andi15701
the nia


[4/21/2023 9:31 PM] kuratius
havent connected usb


[4/21/2023 9:31 PM] kuratius
will check


[4/21/2023 9:33 PM] kuratius
nope


[4/21/2023 9:33 PM] kuratius
any way starting over now


[4/21/2023 9:33 PM] andi15701
it should appear shortly during boot


[4/21/2023 9:34 PM] andi15701
Ctrl+a l


[4/21/2023 9:34 PM] andi15701
you do that before anything interesting might appear


[4/21/2023 9:34 PM] andi15701
then it asks for a filename


[4/21/2023 9:37 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/minicom-82D0B.cap


[4/21/2023 9:39 PM] kuratius
(this is the default filename)


[4/21/2023 9:39 PM] andi15701
yes, nice


[4/21/2023 9:39 PM] andi15701
[    6.709529] imx6ul-pinctrl 2290000.iomuxc-snvs: pin MX6ULL_PAD_SNVS_TAMPER3 already requested by 21f8000.i2c; cannot claim for gpio-keys
[    6.722086] imx6ul-pinctrl 2290000.iomuxc-snvs: pin-5 (gpio-keys) status -22
[    6.729281] imx6ul-pinctrl 2290000.iomuxc-snvs: could not request pin 5 (MX6ULL_PAD_SNVS_TAMPER3) from group gpio_snvs_keys_grp  on device 2290000.iomuxc-snvs


[4/21/2023 9:39 PM] andi15701
Netronix what are you doing?!


[4/21/2023 9:40 PM] kuratius
netronix?


[4/21/2023 9:40 PM] andi15701
the OEM behind the boards


[4/21/2023 9:41 PM] kuratius
is this a mistake?


[4/21/2023 9:41 PM] kuratius
if so, what did they do?


[4/21/2023 9:41 PM] andi15701
duplicatly assigned pins


[4/21/2023 9:41 PM] andi15701
this seems to work by chance


[4/21/2023 9:42 PM] andi15701
just because by chance things are probed in the right may


[4/21/2023 9:51 PM] andi15701
ok, so what we have now:


[4/21/2023 9:51 PM] andi15701
a fresh kernel booting


[4/21/2023 9:51 PM] andi15701
with the following issues: it uses a wrong rtc


[4/21/2023 9:51 PM] andi15701
that key message


[4/21/2023 9:52 PM] andi15701
wifi seems not to be found


[4/21/2023 9:52 PM] andi15701
... and it does not find a root filesystem


[4/21/2023 9:59 PM] kuratius
is that due to me formatting the partitions?


[4/21/2023 9:59 PM] andi15701
well, you have not installed anything..


[4/21/2023 9:59 PM] andi15701
that was expected


[4/21/2023 10:00 PM] andi15701
and there:  setenv bootargs console=ttymxc0,115200


[4/21/2023 10:00 PM] andi15701
you need to append root=/dev/mmcblk0pX or something like that


[4/21/2023 10:00 PM] andi15701
or use nfs or create the initrd


[4/21/2023 10:01 PM] andi15701
next step towards pmOS integration would be to create a device package for it


[4/21/2023 10:02 PM] andi15701
i will prepare something


[4/21/2023 10:02 PM] kuratius
which one would you recommend?


[4/21/2023 10:03 PM] kuratius
if the first is easier, how do I know what the sd card is called?


[4/21/2023 10:03 PM] kuratius
mmc something something?


[4/21/2023 10:03 PM] kuratius
and what is the initrd for?


[4/21/2023 10:03 PM] andi15701
depends on the distribution used


[4/21/2023 10:03 PM] andi15701
helping to get root mounted usually


[4/21/2023 10:04 PM] andi15701
so if root is encrypted


[4/21/2023 10:04 PM] andi15701
it needs to popup a password dialog


[4/21/2023 10:12 PM] szybet
niaudio repo, old folder propably


[4/21/2023 10:18 PM] andi15701
thanks


[4/21/2023 11:26 PM] andi15701
so if you feel not confident with creating a rootfs somewhere


[4/21/2023 11:27 PM] andi15701
lets continue with


[4/21/2023 11:27 PM] andi15701
pmOS directly


[4/21/2023 11:27 PM] andi15701
cd .local/var/pmbootstrap/cache_git/pmaports
git remote add ak https://gitlab.com/akemnade/pmaports
git fetch ak
git checkout kobo-nia-test

{Embed}
https://gitlab.com/akemnade/pmaports
Andreas Kemnade / pmaports · GitLab
postmarketOS package build recipes
/mnt/data/projects/git/conversations/media/icon_mobile-2040A.png


[4/21/2023 11:28 PM] andi15701
I am  just test-building


[4/21/2023 11:48 PM] andi15701
there seem to be some problems


[4/22/2023 12:37 AM] andi15701
ok, it seems to produce a sane image here


[4/22/2023 12:38 AM] andi15701
so if that is done (and maybe any earlier tries to create something for the nia) are deleted


[4/22/2023 12:38 AM] andi15701
pmbootstrap init


[4/22/2023 12:38 AM] andi15701
should show the nia


[4/22/2023 12:39 AM] andi15701
pmbootstrap install --sdcard /dev/sdX should install it


[4/22/2023 12:40 AM] andi15701
what is expected to work: networking via usb (the nia will have 172.16.42.1 and gives addresses via dhcp)


[4/22/2023 12:40 AM] andi15701
rtc


[4/22/2023 12:40 AM] andi15701
charge state


[4/22/2023 12:40 AM] andi15701
backlight (I defined two, which one is working?)


[4/22/2023 12:41 AM] andi15701
buttons?


[4/22/2023 12:41 AM] andi15701
the led


[4/22/2023 12:44 AM] andi15701
there needs to be one quirk in the touchscreen driver, not added yet


[4/22/2023 12:45 AM] andi15701
and not fully verified the sy7636


[4/22/2023 12:45 AM] andi15701
so I disabled it for now


[4/22/2023 12:45 AM] andi15701
so no picture yet...


[4/22/2023 12:45 AM] andi15701
and now I am tired


[4/22/2023 12:46 AM] andi15701
maybe tomorrow evening


[4/23/2023 12:06 AM] andi15701
that pmbootstrap install command needs again some clone of the original sdcard, since it does not install u-boot now


[4/23/2023 7:53 PM] kuratius
can I already run this directly?


[4/23/2023 7:53 PM] kuratius
or do I need a file from you or wait for a pullrequest to some repo that is used by pmboostrap?


[4/23/2023 7:54 PM] kuratius
or run an update command?


[4/23/2023 7:56 PM] andi15701
you do not need to wait for the pull request, but you need to check out my test branch


[4/23/2023 7:57 PM] andi15701
in ~/.local/var/pmbootstrap/cache_git/pmaports


[4/23/2023 7:57 PM] kuratius
I already downlaoded the branch right? so I need to update the data presumably, can I just run the checkout command again?


[4/23/2023 7:58 PM] kuratius
git pull?


[4/23/2023 7:58 PM] kuratius
this is what we did earlier


[4/23/2023 7:59 PM] andi15701
so you have done this?


[4/23/2023 7:59 PM] kuratius
ah I havent


[4/23/2023 7:59 PM] kuratius
will do now


[4/23/2023 8:02 PM] kuratius
```git checkout kobo-nia-test
error: Die folgenden unversionierten Dateien im Arbeitsverzeichnis würden durch
den Checkout überschrieben werden:
    device/testing/device-kobo-nia/APKBUILD
    device/testing/device-kobo-nia/deviceinfo
Bitte verschieben oder entfernen Sie diese, bevor Sie Branches wechseln.
Abbruch
```
it's telling me to either move or delete these files because they would be deleted by the checkout


[4/23/2023 8:02 PM] andi15701
git clean -xfd


[4/23/2023 8:03 PM] kuratius
now run pmbootstrap init?


[4/23/2023 8:03 PM] andi15701
yes


[4/23/2023 8:04 PM] kuratius
same directory or a different one?


[4/23/2023 8:04 PM] andi15701
probably just home


[4/23/2023 8:04 PM] andi15701
maybe pmbootstrap status first


[4/23/2023 8:04 PM] andi15701
and then pmbootstrap init


[4/23/2023 8:04 PM] kuratius
```pmbootstrap status
[20:04:41] *** CONFIG ***
[20:04:41] Device: qemu-amd64 (x86_64, "QEMU amd64")
[20:04:41] Kernel: stable
[20:04:41] User Interface: weston
[20:04:41] 
[20:04:41] *** GIT REPOS ***
[20:04:41] Path: /home/pi/.local/var/pmbootstrap/cache_git
[20:04:41] - pmaports (kobo-nia-test)
[20:04:41] 
[20:04:41] *** CHECKS ***
[20:04:41] [NOK] pmaports: not on official channel branch
[20:04:41] 
[20:04:41] *** CHECKLIST ***
[20:04:41] - pmaports: consider checking out: master, v22.12, v22.06, v21.12, v21.06, v21.03, v20.05
[20:04:41] - Run 'pmbootstrap status' to verify that all is resolved
```


[4/23/2023 8:05 PM] andi15701
well, no problem


[4/23/2023 8:05 PM] andi15701
and now pmbootstrap init


[4/23/2023 8:05 PM] kuratius
pmbootstrap init
[20:05:21] Location of the 'work' path. Multiple chroots (native, device arch, device rootfs) will be created in there.
[20:05:21] Work path [/home/pi/.local/var/pmbootstrap]: 
[20:05:24] NOTE: pmaports path: /home/pi/.local/var/pmbootstrap/cache_git/pmaports
[20:05:24] Choose the postmarketOS release channel.
[20:05:24] Available (7):
[20:05:24] * edge: Rolling release / Most devices / Occasional breakage: https://postmarketos.org/edge
[20:05:24] * v22.12: Latest release / Recommended for best stability
[20:05:24] * v22.06: Old release (unsupported)
[20:05:24] * v21.12: Old release (unsupported)
[20:05:24] * v21.06: Old release (unsupported)
[20:05:24] * v21.03: Old release (unsupported)
[20:05:24] * v20.05: Old release (unsupported)
[20:05:24] Channel [edge]:

{Embed}
https://postmarketos.org/edge
postmarketOS // edge
Aiming for a 10 year life-cycle for smartphones


[4/23/2023 8:05 PM] kuratius
edge again?


[4/23/2023 8:05 PM] andi15701
edge


[4/23/2023 8:05 PM] andi15701
yes


[4/23/2023 8:06 PM] kuratius
vendor kobo?


[4/23/2023 8:06 PM] andi15701
yes


[4/23/2023 8:06 PM] kuratius
user interface?


[4/23/2023 8:07 PM] andi15701
xfce4 maybe, but just console would also be enough, we are not there yet


[4/23/2023 8:07 PM] andi15701
so the first run will only be a text console anyways


[4/23/2023 8:08 PM] kuratius
is it better to choose console in this case?


[4/23/2023 8:08 PM] kuratius
does it it matter at all?


[4/23/2023 8:09 PM] kuratius
[20:06:32] User interface [weston]: xfce4
[20:07:55] Additional options: extra free space: 0 MB, boot partition size: 256 MB, parallel jobs: 5, ccache per arch: 5G, sudo timer: False, mirror: http://mirror.postmarketos.org/postmarketos/
[20:07:55] Change them? (y/n) [n]:


[4/23/2023 8:09 PM] andi15701
it should not matter


[4/23/2023 8:09 PM] kuratius
kk


[4/23/2023 8:09 PM] andi15701
n


[4/23/2023 8:09 PM] kuratius
extra packages?


[4/23/2023 8:10 PM] andi15701
n


[4/23/2023 8:11 PM] kuratius
build outdated packages?


[4/23/2023 8:11 PM] andi15701
y


[4/23/2023 8:11 PM] kuratius
[20:11:17] Build outdated packages during 'pmbootstrap install'? (y/n) [y]: y
[20:11:43] WARNING: The chroots and git repositories in the work dir do not get updated automatically.
[20:11:43] Run 'pmbootstrap status' once a day before working with pmbootstrap to make sure that everything is up-to-date.
[20:11:43] DONE!


[4/23/2023 8:12 PM] kuratius
I'll get the sdcard, delete the kernels we put on it, then run the install command


[4/23/2023 8:12 PM] kuratius
that correct?


[4/23/2023 8:13 PM] andi15701
you do not need to delete anything


[4/23/2023 8:13 PM] andi15701
on it


[4/23/2023 8:13 PM] kuratius
oh ok


[4/23/2023 8:13 PM] andi15701
it will be deleted anyways


[4/23/2023 8:13 PM] andi15701
just the space before the first partition is kept


[4/23/2023 8:13 PM] kuratius
kk


[4/23/2023 8:16 PM] kuratius
```pmbootstrap install --sdcard /dev/sda
[20:14:49] *** (1/4) PREPARE NATIVE CHROOT ***
[20:14:51] Update package index for aarch64 (4 file(s))
[20:14:52] Download http://dl-cdn.alpinelinux.org/alpine/edge/main/aarch64/apk-tools-static-2.14.0_rc1-r0.apk
[20:14:53] (native) install alpine-base
[20:15:04] (native) install cryptsetup util-linux parted
[20:15:07] *** (2/4) CREATE DEVICE ROOTFS ("kobo-nia") ***
[20:15:09] (rootfs_kobo-nia) install alpine-base
[20:15:17] (native) install abuild build-base ccache git
[20:16:42] (native) generate abuild keys
[20:16:46] ERROR: Could not find export JOBS= line in /home/pi/.local/var/pmbootstrap/chroot_native/etc/abuild.conf
[20:16:46] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details. ```


[4/23/2023 8:17 PM] kuratius
(sda is correct, I checked)


[4/23/2023 8:17 PM] kuratius
Disk /dev/mmcblk0: 29,72 GiB, 31914983424 bytes, 62333952 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x55f330a9

Device         Boot  Start      End  Sectors  Size Id Type
/dev/mmcblk0p1        8192   532479   524288  256M  c W95 FAT32 (LBA)
/dev/mmcblk0p2      532480 62333951 61801472 29,5G 83 Linux


Disk /dev/sda: 14,84 GiB, 15931539456 bytes, 31116288 sectors
Disk model: STORAGE DEVICE  
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x7ce3ce47

Device     Boot   Start      End  Sectors  Size Id Type
/dev/sda1         49152   573440   524289  256M 83 Linux
/dev/sda2        573441  1097729   524289  256M 83 Linux
/dev/sda3       1097730 15491070 14393341  6,9G  b W95 FAT32


[4/23/2023 8:19 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-2E997.txt


[4/23/2023 8:21 PM] kuratius
is the git rep missing files?


[4/23/2023 8:21 PM] kuratius
or do I need to install something?


[4/23/2023 8:24 PM] kuratius
If I am reading the error right then I need to edit the config file and add a line that says export JOBS=  but what am I supposed to write after?


[4/23/2023 8:25 PM] andi15701
I have seen that also, not sure where it comes from


[4/23/2023 8:25 PM] andi15701
but you can just add that line


[4/23/2023 8:25 PM] andi15701
JOBS=how many things should be compiled in parallel


[4/23/2023 8:26 PM] kuratius
I see


[4/23/2023 8:26 PM] kuratius
JOBS=1 then?


[4/23/2023 8:26 PM] andi15701
probably 3


[4/23/2023 8:26 PM] kuratius
is this for compilation on the device I am running pmbootstrap with or n the nia?


[4/23/2023 8:26 PM] andi15701
often you say just how many cores you have


[4/23/2023 8:27 PM] andi15701
on the device running pmbootstrap


[4/23/2023 8:27 PM] kuratius
k


[4/23/2023 8:38 PM] kuratius
it's building some clara.apk file, is that supposed to take a while?


[4/23/2023 8:39 PM] kuratius
(also the cpu usage is weird, it seems to use almost no cpu (measured via htop) but the system still isnt very responsive)


[4/23/2023 8:39 PM] andi15701
yes, the kernel is compiled


[4/23/2023 8:40 PM] kuratius
pmbootstrap install --sdcard /dev/sda
[20:29:21] *** (1/4) PREPARE NATIVE CHROOT ***
[20:29:29] (native) install cryptsetup util-linux parted
[20:29:31] *** (2/4) CREATE DEVICE ROOTFS ("kobo-nia") ***
[20:29:35] (native) install bash bc bison devicepkg-dev findutils flex gmp-dev lzop mpc1-dev mpfr-dev openssl-dev perl
[20:29:41] (native) build armv7/linux-kobo-clara-mainline-6.1.12-r1.apk
[20:39:30] NOTE: The failed command's output is above the ^^^ line in the log file: /home/pi/.local/var/pmbootstrap/log.txt
[20:39:30] ERROR: Command failed (exit code 1): (native) % cd /home/pmos/build; busybox su pmos -c CARCH=armv7 SUDO_APK='abuild-apk --no-progress' GOCACHE=/home/pmos/.cache/go-build HOME=/home/pmos abuild -D postmarketOS -d
[20:39:30] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.


[4/23/2023 8:41 PM] andi15701
so what says the log?


[4/23/2023 8:41 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-B3D02.txt


[4/23/2023 8:44 PM] andi15701
nasty


[4/23/2023 8:44 PM] andi15701
hostcc incompatibility


[4/23/2023 8:46 PM] kuratius
do I need to install a different compiler or build on a 32 bit os?


[4/23/2023 8:47 PM] kuratius
I can install 32 bit raspbian but I'd need to redo everything


[4/23/2023 8:47 PM] andi15701
what gcc version do you have?


[4/23/2023 8:48 PM] kuratius
gcc --version
gcc (Debian 10.2.1-6) 10.2.1 20210110
Copyright (C) 2020 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.


[4/23/2023 8:48 PM] andi15701
grrr, that version is part of pmOS/alpine


[4/23/2023 8:48 PM] kuratius
or do I need to call the crosscompiler gcc?


[4/23/2023 8:48 PM] kuratius
so I change the gcc or do something else?


[4/23/2023 8:49 PM] andi15701
what happens here: gcc allows for plugins to be used during compilation


[4/23/2023 8:50 PM] andi15701
and these plugin code is somehow incompatible with the gcc being used (and I think it is some gcc used by pmbootstrap)


[4/23/2023 8:50 PM] andi15701
perhaps nobody compiled a kernel for pmOS on arm64 yet


[4/23/2023 8:51 PM] kuratius
🤣


[4/23/2023 8:51 PM] andi15701
since a critical gcc change...


[4/23/2023 8:51 PM] andi15701
I try to turn these things off


[4/23/2023 8:53 PM] kuratius
so next step is turning off a plugin, changing compiler, or compiling on 32 bit ?


[4/23/2023 8:53 PM] kuratius
or compiling on x86?


[4/23/2023 8:55 PM] kuratius
arm-linux-gnueabihf-gcc --version
arm-linux-gnueabihf-gcc (Debian 10.2.1-6) 10.2.1 20210110
Copyright (C) 2020 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.


[4/23/2023 8:56 PM] andi15701
the compiler in ~/.local/var/pmbootstrap/chroot_native/ is the problem


[4/23/2023 8:56 PM] kuratius
can I replace it?


[4/23/2023 8:56 PM] kuratius
or will that cause more issues?


[4/23/2023 8:56 PM] kuratius
also should we open an issue about this?


[4/23/2023 8:57 PM] kuratius
on some pmboostrap repo?


[4/23/2023 8:57 PM] andi15701
git pull


[4/23/2023 8:57 PM] andi15701
for first


[4/23/2023 8:57 PM] andi15701
opening an issue is good


[4/23/2023 8:57 PM] andi15701
git pull in pmaports


[4/23/2023 8:58 PM] andi15701
but lets first try to get something compiled


[4/23/2023 8:58 PM] kuratius
pi@raspberrypi:~/.local/var/pmbootstrap/cache_git/pmaports $ 
here?


[4/23/2023 8:58 PM] andi15701
yes


[4/23/2023 8:58 PM] szybet
what how


[4/23/2023 8:59 PM] andi15701
probably everyone doing kernel dev is doing it on x64/x86


[4/23/2023 8:59 PM] kuratius
did git pull, changed back to home directory, running install command again


[4/23/2023 9:00 PM] andi15701
pmbootstrap status I think


[4/23/2023 9:00 PM] kuratius
ok sec


[4/23/2023 9:00 PM] andi15701
and then the install again


[4/23/2023 9:00 PM] kuratius
pmbootstrap status
[21:00:28] *** CONFIG ***
[21:00:28] Device: kobo-nia (armv7, "Kobo Nia")
[21:00:28] Extra packages: n
[21:00:28] User Interface: xfce4
[21:00:28] 
[21:00:28] *** GIT REPOS ***
[21:00:28] Path: /home/pi/.local/var/pmbootstrap/cache_git
[21:00:28] - pmaports (kobo-nia-test)
[21:00:28] 
[21:00:28] *** CHECKS ***
[21:00:28] [NOK] pmaports: not on official channel branch
[21:00:28] 
[21:00:28] *** CHECKLIST ***
[21:00:28] - pmaports: consider checking out: master, v22.12, v22.06, v21.12, v21.06, v21.03, v20.05
[21:00:28] - Run 'pmbootstrap status' to verify that all is resolved


[4/23/2023 9:00 PM] andi15701
ok


[4/23/2023 9:02 PM] kuratius
what did you change btw?


[4/23/2023 9:02 PM] andi15701
-- a/device/testing/linux-kobo-clara-mainline/config-kobo-clara-mainline.armv7
+++ b/device/testing/linux-kobo-clara-mainline/config-kobo-clara-mainline.armv7
@@ -642,8 +642,8 @@ CONFIG_HAVE_ARCH_PFN_VALID=y
 CONFIG_ARCH_HAS_GCOV_PROFILE_ALL=y
 # end of GCOV-based kernel profiling
 
-CONFIG_HAVE_GCC_PLUGINS=y
-CONFIG_GCC_PLUGINS=y
+# CONFIG_HAVE_GCC_PLUGINS is not set
+# CONFIG_GCC_PLUGINS is not set
 # CONFIG_GCC_PLUGIN_LATENT_ENTROPY is not set
 # end of General architecture-dependent options


[4/23/2023 9:03 PM] kuratius
so just deactivate the plugins?what are the plugins used for?


[4/23/2023 9:03 PM] kuratius
memory profiling?


[4/23/2023 9:07 PM] andi15701
various, here it is many various analysis


[4/23/2023 9:08 PM] andi15701
commit 189af4657186da08a2e79fb8e906cfd82b2ccddc
Author: Ard Biesheuvel <ardb@kernel.org>
Date:   Thu Dec 6 09:32:57 2018 +0100

    ARM: smp: add support for per-task stack canaries
    
    On ARM, we currently only change the value of the stack canary when
    switching tasks if the kernel was built for UP. On SMP kernels, this
    is impossible since the stack canary value is obtained via a global
    symbol reference, which means
    a) all running tasks on all CPUs must use the same value
    b) we can only modify the value when no kernel stack frames are live
       on any CPU, which is effectively never.
    
    So instead, use a GCC plugin to add a RTL pass that replaces each
    reference to the address of the __stack_chk_guard symbol with an
    expression that produces the address of the 'stack_canary' field
    that is added to struct thread_info. This way, each task will use
    its own randomized value.


[4/23/2023 9:08 PM] andi15701
that is some kernel hardening


[4/23/2023 9:08 PM] andi15701
feature


[4/23/2023 9:09 PM] kuratius
against reading process memory through an exploit?


[4/23/2023 9:10 PM] andi15701
detect messing on the stack


[4/23/2023 9:11 PM] andi15701
which can be part of an exploit


[4/23/2023 9:12 PM] andi15701
just a marker, if it is there than everything is ok


[4/23/2023 9:12 PM] andi15701
if not, than something went out of order


[4/23/2023 9:16 PM] kuratius
pmbootstrap install --sdcard /dev/sda
[21:00:48] *** (1/4) PREPARE NATIVE CHROOT ***
[21:00:55] (native) install cryptsetup util-linux parted
[21:00:56] *** (2/4) CREATE DEVICE ROOTFS ("kobo-nia") ***
[21:01:01] (native) install bash bc bison devicepkg-dev findutils flex gmp-dev lzop mpc1-dev mpfr-dev openssl-dev perl
[21:01:02] (native) build armv7/linux-kobo-clara-mainline-6.1.12-r1.apk
[21:09:51] NOTE: The failed command's output is above the ^^^ line in the log file: /home/pi/.local/var/pmbootstrap/log.txt
[21:09:51] ERROR: Command failed (exit code 1): (native) % cd /home/pmos/build; busybox su pmos -c CARCH=armv7 SUDO_APK='abuild-apk --no-progress' GOCACHE=/home/pmos/.cache/go-build HOME=/home/pmos abuild -D postmarketOS -d
[21:09:51] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.


[4/23/2023 9:17 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-80C58.txt


[4/23/2023 9:18 PM] kuratius
from earlier:
pi@raspberrypi:~/.local/var/pmbootstrap/cache_git/pmaports $ git pull
Hinweis: Es wird davon abgeraten zu Pullen, ohne anzugeben, wie mit abweichenden
Hinweis: Branches umgegangen werden soll. Sie können diese Nachricht unterdrücken,
Hinweis: indem Sie einen der folgenden Befehle ausführen, bevor der nächste Pull
Hinweis: ausgeführt wird:
Hinweis: 
Hinweis:   git config pull.rebase false  # Merge (Standard-Strategie)
Hinweis:   git config pull.rebase true   # Rebase
Hinweis:   git config pull.ff only       # ausschließlich Vorspulen
Hinweis: 
Hinweis: Sie können statt "git config" auch "git config --global" nutzen, um
Hinweis: einen Standard für alle Repositories festzulegen. Sie können auch die
Hinweis: Option --rebase, --no-rebase oder --ff-only auf der Kommandozeile nutzen,
Hinweis: um das konfigurierte Standardverhalten pro Aufruf zu überschreiben.
warning: Umleitung nach https://gitlab.com/akemnade/pmaports.git/
remote: Enumerating objects: 13, done.
remote: Counting objects: 100% (13/13), done.
remote: Compressing objects: 100% (7/7), done.
remote: Total 7 (delta 5), reused 0 (delta 0), pack-reused 0
Entpacke Objekte: 100% (7/7), 719 Bytes | 21.00 KiB/s, fertig.
Von https://gitlab.com/akemnade/pmaports
   331c52325..c70e0bd4a  kobo-nia-test -> ak/kobo-nia-test
Aktualisiere 331c52325..c70e0bd4a
Fast-forward
 device/testing/linux-kobo-clara-mainline/APKBUILD                         | 2 +-
 device/testing/linux-kobo-clara-mainline/config-kobo-clara-mainline.armv7 | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

{Embed}
https://gitlab.com/akemnade/pmaports.git/
Andreas Kemnade / pmaports · GitLab
postmarketOS package build recipes
/mnt/data/projects/git/conversations/media/icon_mobile-2040A.png

{Embed}
https://gitlab.com/akemnade/pmaports
Andreas Kemnade / pmaports · GitLab
postmarketOS package build recipes
/mnt/data/projects/git/conversations/media/icon_mobile-2040A.png


[4/23/2023 9:19 PM] andi15701
ok, it is using the arm64-gcc to compile arm32 stuff


[4/23/2023 9:20 PM] andi15701
do you have some x64/x86 hw availaible to try it there


[4/23/2023 9:21 PM] kuratius
technically yes but how much work do I need to redo?


[4/23/2023 9:21 PM] kuratius
just redownload the branch, install some packages?


[4/23/2023 9:21 PM] andi15701
well install pmbootstrap again


[4/23/2023 9:21 PM] andi15701
redownload the branch


[4/23/2023 9:21 PM] andi15701
pmbootstrap init


[4/23/2023 9:22 PM] kuratius
will try


[4/23/2023 9:22 PM] andi15701
pmbootstrap install


[4/23/2023 9:22 PM] andi15701
on the arm64 machine probably reset the branch to master


[4/23/2023 9:23 PM] andi15701
do pmbootstrap zap


[4/23/2023 9:23 PM] andi15701
pmbootstrap init (for Kobo Clara HD)


[4/23/2023 9:23 PM] andi15701
and then pmbootstrap build linux-kobo-clara-mainline --force


[4/23/2023 9:23 PM] andi15701
and write a bug report based on that output


[4/23/2023 9:24 PM] andi15701
to the original pmaports repo


[4/23/2023 9:25 PM] kuratius
pi@raspberrypi:~/.local/var/pmbootstrap/cache_git/pmaports $ git checkout master
Zu Branch 'master' gewechselt
Ihr Branch ist auf demselben Stand wie 'origin/master'.
pi@raspberrypi:~/.local/var/pmbootstrap/cache_git/pmaports $ git reset --hard
HEAD ist jetzt bei 372287e23 oneplus-instantnoodlep: new device (MR 3993)
pi@raspberrypi:~/.local/var/pmbootstrap/cache_git/pmaports $


[4/23/2023 9:26 PM] kuratius
pmbootstrap zap

[21:25:42] Remove /home/pi/.local/var/pmbootstrap/chroot_native? (y/n) [n]: 
[21:25:42] Remove /home/pi/.local/var/pmbootstrap/chroot_rootfs_kobo-nia? (y/n) [n]: y
[21:25:59] % rm -rf /home/pi/.local/var/pmbootstrap/chroot_rootfs_kobo-nia
[21:25:59] Cleared up ~8 MB of space
pi@raspberrypi:~ $


[4/23/2023 9:26 PM] andi15701
zap both


[4/23/2023 9:26 PM] andi15701
y to both things


[4/23/2023 9:26 PM] andi15701
we want a clean bug report


[4/23/2023 9:27 PM] kuratius
done


[4/23/2023 9:28 PM] kuratius
mainline or downstream?


[4/23/2023 9:28 PM] andi15701
mainline


[4/23/2023 9:29 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-90EC7.txt


[4/23/2023 9:29 PM] andi15701
just console


[4/23/2023 9:31 PM] kuratius
running the build command


[4/23/2023 9:32 PM] kuratius
will install pmbootstrap on my laptop sec


[4/23/2023 9:35 PM] kuratius
pmbootstrap build linux-kobo-clara-mainline --force
[21:31:08] (native) install alpine-base
[21:31:17] (native) install abuild build-base ccache git
[21:32:34] ERROR: Could not find export JOBS= line in /home/pi/.local/var/pmbootstrap/chroot_native/etc/abuild.conf
[21:32:34] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.
 one sec


[4/23/2023 9:36 PM] kuratius
added the jobs line


[4/23/2023 9:48 PM] kuratius
also the install script seems to be a bit broken, setting the locale is weird


[4/23/2023 9:48 PM] kuratius
(this is on the x86 machine tho)

{Attachments}
/mnt/data/projects/git/conversations/media/message-445A4.txt


[4/23/2023 9:50 PM] kuratius
this is the log for the arm64

{Attachments}
/mnt/data/projects/git/conversations/media/message-BC853.txt


[4/23/2023 9:50 PM] kuratius
where do I post it?


[4/23/2023 9:52 PM] andi15701
https://gitlab.com/postmarketOS/pmaports/-/issues

{Embed}
https://gitlab.com/postmarketOS/pmaports/-/issues
Issues · postmarketOS / pmaports · GitLab
postmarketOS package build recipes
/mnt/data/projects/git/conversations/media/icon_mobile-9A834.png


[4/23/2023 9:53 PM] andi15701
I will then comment on it


[4/23/2023 10:01 PM] kuratius
https://gitlab.com/postmarketOS/pmaports/-/issues/2082

{Embed}
https://gitlab.com/postmarketOS/pmaports/-/issues/2082
Compiling an image for Kobo Clara fails on arm64 (pi400 on raspberr...
Describe your issue  What's the expected behaviour? The compilation finishes successfully ...
/mnt/data/projects/git/conversations/media/icon_mobile-9A834.png


[4/23/2023 10:02 PM] kuratius
wrong log file sec


[4/23/2023 10:04 PM] kuratius
fixed


[4/23/2023 10:09 PM] andi15701
commented on that


[4/23/2023 10:09 PM] kuratius
👍


[4/23/2023 10:22 PM] kuratius
dumb question but does postmarketOS have an x86 build?


[4/23/2023 10:22 PM] kuratius
then I could install it on an sd card and try it on a steam deck (it has a touchscreen)


[4/23/2023 10:23 PM] kuratius
(also the compilation my laptop is still running)


[4/23/2023 10:28 PM] kuratius
[22:26:41] *** (3/4) PREPARE INSTALL BLOCKDEVICE ***
[22:26:42] ERROR: /dev/sdb3 is mounted! Will not attempt to format this!
[22:26:42] See also: <https://postmarketos.org/troubleshooting>
probably need to unmount without losing /dev/sdb


[4/23/2023 10:29 PM] andi15701
some automount was active


[4/23/2023 10:29 PM] kuratius
[22:29:34] ERROR: Unable to find the first partition of /dev/sdb, expected it to be at /dev/sdb1!
[22:29:34] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.


[4/23/2023 10:30 PM] kuratius
(I unmounted by clicking the eject button in the file browser)


[4/23/2023 10:30 PM] andi15701
which might eject the whole disk


[4/23/2023 10:30 PM] andi15701
instead of just unmounting it


[4/23/2023 10:31 PM] andi15701
so re-insert that thing


[4/23/2023 10:32 PM] kuratius
reinserted, right clicked on partitions, chose unmount instead of eject for each


[4/23/2023 10:32 PM] kuratius
not sure if that did it


[4/23/2023 10:32 PM] kuratius
but we will see


[4/23/2023 10:34 PM] kuratius
what would you normally use to unmount?


[4/23/2023 10:35 PM] kuratius
will try the sd soon-ish


[4/23/2023 10:39 PM] andi15701
I disabled all that automount stuff


[4/23/2023 10:39 PM] andi15701
or if in doubt, I use text console


[4/23/2023 10:40 PM] kuratius
it doesnt boot


[4/23/2023 10:40 PM] kuratius
did the installer delete the hidden partition?


[4/23/2023 10:40 PM] andi15701
no serial output at all?


[4/23/2023 10:41 PM] kuratius
no power led either


[4/23/2023 10:41 PM] andi15701
that one is software-controlled


[4/23/2023 10:41 PM] kuratius
i got the pwer led with the kernel we tested before


[4/23/2023 10:42 PM] kuratius
have to check if the battery is empty or I broke something


[4/23/2023 10:42 PM] kuratius
sec


[4/23/2023 10:43 PM] andi15701
yes, with the kernel but not by u-boot itself


[4/23/2023 10:43 PM] andi15701
or it maybe did not power down completely


[4/23/2023 10:44 PM] kuratius
ok booted with my other sd


[4/23/2023 10:45 PM] kuratius
checking battery then powering off


[4/23/2023 10:46 PM] andi15701
check for u-boot existence


[4/23/2023 10:46 PM] andi15701
cmp -i 1024 /dev/sdX nia-backup-img


[4/23/2023 10:47 PM] andi15701
where /dev/sdX is your pmOS sd card


[4/23/2023 10:52 PM] kuratius
pi@raspberrypi:/media/pi/1f78c1b1-7c66-4b48-8cab-7d3ff113ebc3/backup $ sudo cmp -i 1024 /dev/sda koboBackup.img 
/dev/sda koboBackup.img sind verschieden: Byte 1, Zeile 1
pi@raspberrypi:/media/pi/1f78c1b1-7c66-4b48-8cab-7d3ff113ebc3/backup $


[4/23/2023 10:53 PM] andi15701
ouch


[4/23/2023 10:56 PM] andi15701
reproducing


[4/23/2023 11:01 PM] andi15701
things get destroyed until 0x2600


[4/23/2023 11:02 PM] andi15701
so do a dd if=nia-backup.img bs=512 seek=2 skip=2  count=2048 of=/dev/sdX


[4/23/2023 11:03 PM] andi15701
no


[4/23/2023 11:03 PM] andi15701
1024 instead of 2048


[4/23/2023 11:03 PM] andi15701
otherwise we will overwrite u-boot env


[4/23/2023 11:04 PM] andi15701
yes, one of the next steps will be also installing u-boot


[4/23/2023 11:07 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/minicom-2-C504D.cap


[4/23/2023 11:09 PM] andi15701
do you have also access via usb?


[4/23/2023 11:09 PM] andi15701
so it is a good point to log in


[4/23/2023 11:09 PM] andi15701
and explore things


[4/23/2023 11:10 PM] kuratius
it shows in file explorer but says device cant be opened


[4/23/2023 11:11 PM] andi15701
network access


[4/23/2023 11:11 PM] kuratius
mtp device cannot be opened


[4/23/2023 11:11 PM] andi15701
ssh


[4/23/2023 11:11 PM] kuratius
address?


[4/23/2023 11:11 PM] andi15701
you should have a new network device


[4/23/2023 11:11 PM] andi15701
172.16.42.1


[4/23/2023 11:12 PM] andi15701
it should distribute an address to your computer


[4/23/2023 11:12 PM] andi15701
so act as a dhcp server


[4/23/2023 11:12 PM] kuratius
I have a million "mtp device >>001,073<< cannot be opened" popups


[4/23/2023 11:13 PM] kuratius
well 3


[4/23/2023 11:13 PM] kuratius
they refuse to open


[4/23/2023 11:14 PM] andi15701
that is as expected


[4/23/2023 11:14 PM] kuratius
only difference is 73 changes to 74 and 75


[4/23/2023 11:14 PM] kuratius
I disconnected the device but cant close the popups


[4/23/2023 11:14 PM] kuratius
now I can


[4/23/2023 11:14 PM] kuratius
weird


[4/23/2023 11:15 PM] kuratius
try again?


[4/23/2023 11:15 PM] andi15701
1363382.711419] usb 1-2.2: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[1363382.711425] usb 1-2.2: Product: PINE64 PinePhone
[1363382.711430] usb 1-2.2: Manufacturer: PINE64
[1363382.711434] usb 1-2.2: SerialNumber: postmarketOS
[1363382.715113] rndis_host 1-2.2:1.0 usb0: register 'rndis_host' at usb-0000:00:14.0-2.2, RNDIS device, 62:37:d2:86:60:6d


[4/23/2023 11:15 PM] andi15701
you should have something like this


[4/23/2023 11:15 PM] andi15701
in your host dmesg


[4/23/2023 11:16 PM] kuratius
[1161240.051275] usb 1-1.1: new high-speed USB device number 78 using xhci_hcd
[1161240.153005] usb 1-1.1: New USB device found, idVendor=18d1, idProduct=d001, bcdDevice= 6.01
[1161240.153026] usb 1-1.1: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[1161240.153032] usb 1-1.1: Product: Kobo Nia
[1161240.153037] usb 1-1.1: Manufacturer: Kobo
[1161240.153042] usb 1-1.1: SerialNumber: postmarketOS
[1161240.158350] rndis_host 1-1.1:1.0 usb0: register 'rndis_host' at usb-0000:01:00.0-1.1, RNDIS device, a2:54:c2:2d:65:bc


[4/23/2023 11:16 PM] andi15701
ifconfig usb0


[4/23/2023 11:17 PM] kuratius
ifconfig usb0
usb0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.16.42.2  netmask 255.255.255.0  broadcast 172.16.42.255
        inet6 fe80::4ef1:b96:d0c4:71c7  prefixlen 64  scopeid 0x20<link>
        ether 0e:f0:69:a0:5b:7c  txqueuelen 1000  (Ethernet)
        RX packets 14  bytes 1300 (1.2 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 41  bytes 7675 (7.4 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0


[4/23/2023 11:18 PM] andi15701
so you should be able to ssh into the nia (172.16.42.1) now


[4/23/2023 11:18 PM] andi15701
using the user account you created during installation


[4/23/2023 11:18 PM] andi15701
and root via sudo


[4/23/2023 11:19 PM] kuratius
ssh dk-x86@172.16.42.1
The authenticity of host '172.16.42.1 (172.16.42.1)' can't be established.
ECDSA key fingerprint is SHA256:La96gvfnXXb3PfxAxO0uc93HK6KI6rbsdFUTot14B2U.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '172.16.42.1' (ECDSA) to the list of known hosts.
dk-x86@172.16.42.1's password: 
Connection reset by 172.16.42.1 port 22


[4/23/2023 11:20 PM] kuratius
ping 172.16.42.1
PING 172.16.42.1 (172.16.42.1) 56(84) bytes of data.
64 bytes from 172.16.42.1: icmp_seq=1 ttl=64 time=0.359 ms
64 bytes from 172.16.42.1: icmp_seq=2 ttl=64 time=0.323 ms
64 bytes from 172.16.42.1: icmp_seq=3 ttl=64 time=0.311 ms
64 bytes from 172.16.42.1: icmp_seq=4 ttl=64 time=0.419 ms
64 bytes from 172.16.42.1: icmp_seq=5 ttl=64 time=0.356 ms
c64 bytes from 172.16.42.1: icmp_seq=6 ttl=64 time=1.28 ms
64 bytes from 172.16.42.1: icmp_seq=7 ttl=64 time=0.388 ms
c64 bytes from 172.16.42.1: icmp_seq=8 ttl=64 time=0.419 ms
64 bytes from 172.16.42.1: icmp_seq=9 ttl=64 time=0.401 ms
64 bytes from 172.16.42.1: icmp_seq=10 ttl=64 time=0.402 ms
64 bytes from 172.16.42.1: icmp_seq=11 ttl=64 time=0.386 ms
^C
--- 172.16.42.1 ping statistics ---
11 packets transmitted, 11 received, 0% packet loss, time 10187ms
rtt min/avg/max/mdev = 0.311/0.458/1.283/0.262 ms


[4/23/2023 11:20 PM] andi15701
hmm, interesting


[4/23/2023 11:20 PM] andi15701
ssh dk-x86@172.16.42.1 "dmesg"


[4/23/2023 11:21 PM] kuratius
ssh dk-x86@172.16.42.1 "ls /"
dk-x86@172.16.42.1's password: 
bin
boot
dev
etc
home
lib
lost+found
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var


[4/23/2023 11:22 PM] kuratius
any way to stop the popups??


[4/23/2023 11:23 PM] kuratius
was able to log in ssh dk-x86@172.16.42.1 
dk-x86@172.16.42.1's password: 
Welcome to postmarketOS! o/

This distribution is based on Alpine Linux.
First time using postmarketOS? Make sure to read the cheatsheet in the wiki:

-> https://postmarketos.org/cheatsheet

You may change this message by editing /etc/motd.
kobo-nia:~$


[4/23/2023 11:23 PM] kuratius
popups still keep happening though


[4/23/2023 11:23 PM] kuratius
also cant type anything


[4/23/2023 11:24 PM] kuratius
pi@raspberrypi:~ $ ssh dk-x86@172.16.42.1 
dk-x86@172.16.42.1's password: 
Welcome to postmarketOS! o/

This distribution is based on Alpine Linux.
First time using postmarketOS? Make sure to read the cheatsheet in the wiki:

-> https://postmarketos.org/cheatsheet

You may change this message by editing /etc/motd.
kobo-nia:~$ client_loop: send disconnect: Broken pipe


[4/23/2023 11:24 PM] andi15701
hmm, login via serial


[4/23/2023 11:26 PM] kuratius
it's bootlooping


[4/23/2023 11:26 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/minicom-2-4BCED.cap


[4/23/2023 11:28 PM] andi15701
nasty


[4/23/2023 11:30 PM] kuratius
it loads the kernel then shows a login shell then resets and reloads the kernel again


[4/23/2023 11:33 PM] andi15701
more tomorrow


[4/23/2023 11:34 PM] kuratius
kk


[4/23/2023 11:34 PM] andi15701
maybe some watchdog


[4/23/2023 11:34 PM] andi15701
@Szybet: what is the way to compile factory u-boot here (sources, defconfig)?


[4/23/2023 11:37 PM] szybet
https://github.com/Szybet/niAudio/blob/main/inkbox.md

{Embed}
https://github.com/Szybet/niAudio/blob/main/inkbox.md
niAudio/inkbox.md at main · Szybet/niAudio
Kobo nia ereader with audio added. Contribute to Szybet/niAudio development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/niAudio-613C3


[4/24/2023 7:35 PM] andi15701
```CPU:   Freescale i.MX6ULL rev1.1 at 396MHz
CPU:   Commercial temperature grade (0C to 95C) at 38C
Reset cause: POR
```


[4/24/2023 7:35 PM] andi15701
does not look like any thermal issue on the SoC


[4/24/2023 7:35 PM] andi15701
that is good


[4/24/2023 7:35 PM] andi15701
POR = power on reset


[4/24/2023 7:36 PM] andi15701
so some reset triggered by the pmic


[4/24/2023 9:51 PM] andi15701
just building on my side


[4/24/2023 9:52 PM] kuratius
how did you fix the watchdog issue?


[4/24/2023 9:52 PM] andi15701
I am not sure if it is one


[4/24/2023 9:52 PM] andi15701
two things:


[4/24/2023 9:52 PM] andi15701
first we want u-boot not appending quiet


[4/24/2023 9:52 PM] andi15701
so we see a bit more what happens


[4/24/2023 9:53 PM] andi15701
second: ldortc1 stays on on szybet's device


[4/24/2023 9:54 PM] kuratius
is there any serial output when booting the default koboOS?
is that worth looking at?


[4/24/2023 9:54 PM] andi15701
if I understand the kernel correctly, unused regulators are turned off after some time


[4/24/2023 9:54 PM] andi15701
and that might trigger a reboot


[4/24/2023 9:54 PM] andi15701
so lets force ldortc1 to stay on


[4/24/2023 9:55 PM] andi15701
quiet is not totally quiet but there is some output, but not much


[4/24/2023 9:56 PM] andi15701
the loglevel must be low enough


[4/24/2023 9:56 PM] andi15701
dmesg on a running system gives more output


[4/24/2023 9:56 PM] andi15701
but that is a bit nasty when things reboot every now and then


[4/24/2023 9:58 PM] andi15701
btw: you should add the device to https://wiki.postmarketos.org/wiki/Devices

{Embed}
https://wiki.postmarketos.org/wiki/Devices
Devices


[4/24/2023 9:59 PM] kuratius
even though we aren't finished?


[4/24/2023 9:59 PM] andi15701
yes


[4/24/2023 9:59 PM] andi15701
you can set it to non-booting


[4/24/2023 9:59 PM] andi15701
but collect links, pictures and other infos


[4/24/2023 10:19 PM] andi15701
ok, so I pushed the stuff to my pmaports repo


[4/24/2023 10:19 PM] andi15701
so checkout and pull that branch again


[4/24/2023 10:20 PM] andi15701
and do a pmbootstrap build device-kobo-nia --force


[4/24/2023 10:20 PM] andi15701
on your laptop again


[4/24/2023 10:21 PM] andi15701
and then the usual pmbootstrap init ; pmbootstrap install --sdcard /dev/sdX


[4/24/2023 10:21 PM] andi15701
u-boot is now build too


[4/24/2023 10:23 PM] kuratius
will I need to rewrite the initial partition again?


[4/24/2023 10:23 PM] kuratius
(also, building now)


[4/24/2023 10:24 PM] andi15701
just take the pmOS sdcard as is


[4/24/2023 10:24 PM] kuratius
kk


[4/24/2023 10:24 PM] andi15701
and no need to rewrite anything


[4/24/2023 10:24 PM] kuratius
any idea why it overwrote the partition the other time?


[4/24/2023 10:24 PM] andi15701
u-boot gets installed


[4/24/2023 10:24 PM] andi15701
did not debug it


[4/24/2023 10:26 PM] kuratius
in gparted, when not resizing a partition, it leaves unformatted space alone right?


[4/24/2023 10:26 PM] andi15701
not sure what is used there


[4/24/2023 10:26 PM] andi15701
I would use sfdisk


[4/24/2023 10:27 PM] andi15701
for any automated partitioning task


[4/24/2023 10:27 PM] kuratius
also I remember we copied only part of the hidden partition, why doesnt it make sense to copy everything?


[4/24/2023 10:27 PM] kuratius
you mentioned uboot


[4/24/2023 10:27 PM] andi15701
there is a piece in between which gets changed


[4/24/2023 10:28 PM] andi15701
during installation


[4/24/2023 10:28 PM] andi15701
intentionally


[4/24/2023 10:28 PM] andi15701
so we can copy everything only *before* running install


[4/24/2023 10:28 PM] andi15701
but not afterwards


[4/24/2023 10:29 PM] andi15701
deviceinfo_sd_embed_firmware="u-boot/kobo-nia/u-boot.imx:2,u-boot/kobo-nia/u-boot-env.bin:1536"


[4/24/2023 10:29 PM] andi15701
that is what happens


[4/24/2023 10:29 PM] kuratius
what's the command for rewriting the hidden partition? Imo it might make sense to do that if the install changes it


[4/24/2023 10:30 PM] andi15701
that are several things there


[4/24/2023 10:31 PM] andi15701
so now the install should not delete anything there


[4/24/2023 10:31 PM] andi15701
which is required


[4/24/2023 10:31 PM] andi15701
the above line means:


[4/24/2023 10:31 PM] andi15701
dd if=u-boot/kobo-nia/u-boot.imx bs=512 seek=2 of=/dev/sdX


[4/24/2023 10:32 PM] andi15701
dd if=u-boot/kobo-nia/u-boot-env.bin bs=512 seek=1536 of=/dev/sdX


[4/24/2023 10:33 PM] andi15701
at the end of the day, we will only need the waveform from the original image there


[4/24/2023 10:39 PM] kuratius
build is done


[4/24/2023 10:39 PM] kuratius
sec


[4/24/2023 10:39 PM] andi15701
so, u-boot-nia and the kernel were build?


[4/24/2023 10:43 PM] kuratius
will post log in a sec


[4/24/2023 10:45 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-18C4B.txt


[4/24/2023 10:47 PM] andi15701
hmm. kernel was not rebuilt


[4/24/2023 10:47 PM] andi15701
so also pmbootstrap build linux-kobo-clara-mainline --force


[4/24/2023 10:48 PM] andi15701
oh,


[4/24/2023 10:48 PM] andi15701
it was built


[4/24/2023 10:48 PM] andi15701
everything fine


[4/24/2023 10:50 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-164DE.txt


[4/24/2023 10:51 PM] kuratius
I think it mounted something during the formatting, is that related to this?


[4/24/2023 10:52 PM] andi15701
maybe, just try to unmount everything


[4/24/2023 10:52 PM] andi15701
and try agin


[4/24/2023 10:52 PM] kuratius
I selected the option to overwrite previous install also


[4/24/2023 10:52 PM] kuratius
kk


[4/24/2023 10:53 PM] kuratius
I waited for the mount message, then immediately unmounted


[4/24/2023 10:54 PM] kuratius
should probably figure out how to prevent the mounting after only one partition was formatted


[4/24/2023 10:54 PM] kuratius
(this time it continued past the error)


[4/24/2023 10:55 PM] kuratius
it finished


[4/24/2023 10:55 PM] kuratius
now try it on the nia?


[4/24/2023 10:55 PM] andi15701
yes


[4/24/2023 10:56 PM] andi15701
and don't forget to capture things


[4/24/2023 10:58 PM] kuratius
no led


[4/24/2023 10:59 PM] andi15701
so no output at all?


[4/24/2023 11:00 PM] kuratius
yes but I think it's in the borked state again, one sec


[4/24/2023 11:04 PM] kuratius
(insert normal sd-> doesnt boot)
(connect to charger with normal sd-> boots)


[4/24/2023 11:04 PM] kuratius
ima shutdown and swap sds to the pmOS sd


[4/24/2023 11:06 PM] kuratius
no led


[4/24/2023 11:06 PM] kuratius
are you sure we shouldnt rewrite the hidden partition?


[4/24/2023 11:08 PM] andi15701
no serial output?


[4/24/2023 11:08 PM] kuratius
stays dead


[4/24/2023 11:08 PM] andi15701
hmm, ok,


[4/24/2023 11:09 PM] andi15701
long key press


[4/24/2023 11:09 PM] andi15701
>10s


[4/24/2023 11:09 PM] andi15701
to ensure it is off


[4/24/2023 11:09 PM] andi15701
replug just usb


[4/24/2023 11:09 PM] kuratius
done


[4/24/2023 11:09 PM] andi15701
sorry


[4/24/2023 11:09 PM] andi15701
sdcard out


[4/24/2023 11:09 PM] andi15701
and then usb connection


[4/24/2023 11:10 PM] kuratius
pull sd card, then disconnect usb?


[4/24/2023 11:11 PM] andi15701
power on without sd card


[4/24/2023 11:11 PM] andi15701
and just usb connected


[4/24/2023 11:11 PM] andi15701
and then


[4/24/2023 11:11 PM] andi15701
uuu .local/var/pmbootstrap/chroot_rootfs_kobo-nia/usr/share/u-boot/kobo-nia/u-boot.imx


[4/24/2023 11:12 PM] kuratius
how do I tell if it's on without led or serial?


[4/24/2023 11:12 PM] andi15701
long press should turn it off


[4/24/2023 11:13 PM] andi15701
we first want to check whether u-boot is ok


[4/24/2023 11:13 PM] szybet
Could be helpfull: if the cpu cant detect an sd card, it outputs a single 0 bit to serial ( just changes states )

Well to check if it still works, and the issue is not somewhere else


[4/24/2023 11:13 PM] kuratius
I can boot my cloned nickelSD fine


[4/24/2023 11:14 PM] kuratius
well "fine" in the sense that I have to connect it to a charger first


[4/24/2023 11:15 PM] kuratius
does the single bit show on minicom?


[4/24/2023 11:15 PM] szybet
Not on battery?


[4/24/2023 11:15 PM] szybet
Nope, a gui app cant remember


[4/24/2023 11:15 PM] kuratius
the sd image or the hidden partition gets borked by the install script I think


[4/24/2023 11:16 PM] szybet
This sounds bad


[4/24/2023 11:16 PM] kuratius
how would I read it then


[4/24/2023 11:16 PM] szybet
Disconnect the battery - click power button for 10s and then try to boot nickel


[4/24/2023 11:16 PM] szybet
The app is maybe called moserial


[4/24/2023 11:16 PM] andi15701
we do not need


[4/24/2023 11:16 PM] andi15701
lets just try the usb boot


[4/24/2023 11:16 PM] kuratius
nickel boots


[4/24/2023 11:17 PM] andi15701
without sd card


[4/24/2023 11:17 PM] andi15701
ok, disconnect usb


[4/24/2023 11:17 PM] andi15701
disconnect batery


[4/24/2023 11:18 PM] andi15701
remove sd card


[4/24/2023 11:18 PM] andi15701
reconnect battery


[4/24/2023 11:18 PM] andi15701
reconnect usb


[4/24/2023 11:18 PM] andi15701
and try that uuu line


[4/24/2023 11:19 PM] kuratius
can I avoid disconnecting the battery?


[4/24/2023 11:20 PM] kuratius
also what package is uuu?


[4/24/2023 11:20 PM] szybet
Use a toothstick to do it


[4/24/2023 11:20 PM] kuratius
pi@raspberrypi:~ $ uuu
bash: uuu: Kommando nicht gefunden.


[4/24/2023 11:20 PM] szybet
Uboot-tools


[4/24/2023 11:20 PM] andi15701
mfgtools


[4/24/2023 11:20 PM] kuratius
like I said nickel boots fine


[4/24/2023 11:20 PM] andi15701
uuu


[4/24/2023 11:21 PM] szybet
Noy without battery you said


[4/24/2023 11:22 PM] andi15701
disconnecting battery would reset the pmic


[4/24/2023 11:23 PM] andi15701
and probaly restore some stuff


[4/24/2023 11:25 PM] kuratius
pi@raspberrypi:/media/pi/1f78c1b1-7c66-4b48-8cab-7d3ff113ebc3/backup $ sudo cmp -i 1024 /dev/sda koboBackup.img 
/dev/sda koboBackup.img sind verschieden: Byte 38, Zeile 1


[4/24/2023 11:26 PM] andi15701
because we install a modified u-boot


[4/24/2023 11:27 PM] kuratius
I thought uboot only starts at like offset 1024?


[4/24/2023 11:28 PM] andi15701
yes


[4/24/2023 11:28 PM] kuratius
offsets are in bytes?


[4/24/2023 11:28 PM] andi15701
yes


[4/24/2023 11:28 PM] andi15701
for cmp


[4/24/2023 11:28 PM] kuratius
then byte 38 is before


[4/24/2023 11:28 PM] andi15701
1024+38


[4/24/2023 11:29 PM] andi15701
-i tells to stat at 1024


[4/24/2023 11:29 PM] kuratius
ah


[4/24/2023 11:29 PM] kuratius
one sec


[4/24/2023 11:29 PM] andi15701
lets first test the u-boot


[4/24/2023 11:29 PM] kuratius
sudo cmp /dev/sda koboBackup.img 
/dev/sda koboBackup.img sind verschieden: Byte 1, Zeile 1


[4/24/2023 11:31 PM] andi15701
the mbr


[4/24/2023 11:32 PM] kuratius
what's the next step for that?


[4/24/2023 11:32 PM] andi15701
that uuu line


[4/24/2023 11:32 PM] kuratius
with or without sd?


[4/24/2023 11:32 PM] andi15701
without


[4/24/2023 11:32 PM] kuratius
pi@raspberrypi:~ $ sudo apt install mfgtools
Paketlisten werden gelesen… Fertig
Abhängigkeitsbaum wird aufgebaut… Fertig
Statusinformationen werden eingelesen… Fertig
E: Paket mfgtools kann nicht gefunden werden.


[4/24/2023 11:32 PM] andi15701
on debian it is called uuu


[4/24/2023 11:32 PM] andi15701
maybe there too


[4/24/2023 11:33 PM] kuratius
oh there is a uuu package


[4/24/2023 11:33 PM] kuratius
installed it


[4/24/2023 11:33 PM] kuratius
sec


[4/24/2023 11:33 PM] andi15701
$ apt-get source uuu
Reading package lists... Done
Picking 'mfgtools' as source package instead of 'uuu'


[4/24/2023 11:34 PM] andi15701
needs to run as root


[4/24/2023 11:34 PM] andi15701
or with udev rules


[4/24/2023 11:34 PM] andi15701
to set permissions


[4/24/2023 11:34 PM] kuratius
does uboot tools contain it?


[4/24/2023 11:35 PM] andi15701
no


[4/24/2023 11:35 PM] andi15701
at least not on debian


[4/24/2023 11:35 PM] kuratius
so can I use uuu directly or do I need mfgtools?


[4/24/2023 11:35 PM] andi15701
you can use it directly


[4/24/2023 11:35 PM] kuratius
k


[4/24/2023 11:36 PM] andi15701
mfgtools is just the name of the source package


[4/24/2023 11:37 PM] kuratius
this command?


[4/24/2023 11:37 PM] andi15701
as root


[4/24/2023 11:37 PM] kuratius
while connected via usb?


[4/24/2023 11:37 PM] andi15701
yes


[4/24/2023 11:38 PM] kuratius
sudo uuu .local/var/pmbootstrap/chroot_rootfs_kobo-nia/usr/share/u-boot/kobo-nia/u-boot.imx
uuu (Universal Update Utility) for nxp imx chips -- lib1.4.77

Wait for Known USB Device Appear...
Error: fail open file: >.local/var/pmbootstrap/chroot_rootfs_kobo-nia/usr/share/u-boot/kobo-nia/u-boot.imx


[4/24/2023 11:39 PM] kuratius
pi@raspberrypi:~ $ sudo uuu .local/var/pmbootstrap/chroot_rootfs_kobo-nia/usr/share/u-boot/kobo-nia/u-boot.imx
uuu (Universal Update Utility) for nxp imx chips -- lib1.4.77

Wait for Known USB Device Appear...
Error: fail open file: >.local/var/pmbootstrap/chroot_rootfs_kobo-nia/usr/share/u-boot/kobo-nia/u-boot.imx


pi@raspberrypi:~ $ lsusb
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 069: ID 04d9:0007 Holtek Semiconductor, Inc. Raspberry Pi Internal Keyboard
Bus 001 Device 104: ID 05e3:0723 Genesys Logic, Inc. GL827L SD/MMC/MS Flash Card Reader
Bus 001 Device 096: ID 093a:2510 Pixart Imaging, Inc. Optical Mouse
Bus 001 Device 106: ID 15a2:0080 Freescale Semiconductor, Inc. i.MX 6ULL SystemOnChip in RecoveryMode
Bus 001 Device 003: ID 2109:3431 VIA Labs, Inc. Hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
pi@raspberrypi:~ $


[4/24/2023 11:39 PM] andi15701
Bus 001 Device 106: ID 15a2:0080 Freescale Semiconductor, Inc. i.MX 6ULL SystemOnChip in RecoveryMode


[4/24/2023 11:39 PM] andi15701
that is your friend


[4/24/2023 11:39 PM] kuratius
sudo uuu .local/var/pmbootstrap/chroot_rootfs_kobo-nia/usr/share/u-boot/kobo-nia/u-boot.imx
uuu (Universal Update Utility) for nxp imx chips -- lib1.4.77

Wait for Known USB Device Appear...
Error: fail open file: >.local/var/pmbootstrap/chroot_rootfs_kobo-nia/usr/share/u-boot/kobo-nia/u-boot.imx


[4/24/2023 11:40 PM] andi15701
1661958.695816] usb 1-2.2: new high-speed USB device number 76 using xhci_hcd
[1661958.797137] usb 1-2.2: New USB device found, idVendor=1fc9, idProduct=0128, bcdDevice= 0.01
[1661958.797163] usb 1-2.2: New USB device strings: Mfr=1, Product=2, SerialNumber=0
[1661958.797174] usb 1-2.2: Product: SE Blank 6SLL
[1661958.797183] usb 1-2.2: Manufacturer:    NXP    SemiConductor Inc 
[1661958.801803] hid-generic 0003:1FC9:0128.0006: hiddev2,hidraw0: USB HID v1.10 Device [   NXP    SemiConductor Inc  SE Blank 6SLL] on usb-0000:00:14.0-2.2/input0


[4/24/2023 11:40 PM] andi15701
so why it is not there


[4/24/2023 11:40 PM] andi15701
what is there?


[4/24/2023 11:40 PM] kuratius
where was that log again?


[4/24/2023 11:41 PM] andi15701
I mean check what is in that chroot


[4/24/2023 11:41 PM] andi15701
you are in your home dir?


[4/24/2023 11:42 PM] kuratius
pi@raspberrypi:~ $ ls .local/var/pmbootstrap/
apk.static         cache_ccache_aarch64  cache_go       config_abuild    packages
cache_apk_aarch64  cache_ccache_armv7    cache_http     config_apk_keys  tmp
cache_apk_armv7    cache_distfiles       cache_rust     images_netboot   version
cache_appstream    cache_git             chroot_native  log.txt          workdir.cfg
pi@raspberrypi:~ $


[4/24/2023 11:42 PM] kuratius
oooh


[4/24/2023 11:42 PM] kuratius
I need to be on the laptop?


[4/24/2023 11:42 PM] andi15701
yes


[4/24/2023 11:42 PM] andi15701
it was created during installation


[4/24/2023 11:42 PM] andi15701
there


[4/24/2023 11:43 PM] kuratius
sudo uuu .local/var/pmbootstrap/chroot_rootfs_kobo-nia/usr/share/u-boot/kobo-nia/u-boot.imx
uuu (Universal Update Utility) for nxp imx chips -- lib1.4.193

Success 1    Failure 0                                                         
                                                                                
                                                                                
1:1      2/ 2 [Done                                  ] SDP: done


[4/24/2023 11:43 PM] andi15701
any output now on serial?


[4/24/2023 11:44 PM] kuratius
dunno?


[4/24/2023 11:44 PM] kuratius
the serialport is on the pi


[4/24/2023 11:44 PM] andi15701
so long press that the device is off


[4/24/2023 11:45 PM] kuratius
done


[4/24/2023 11:45 PM] kuratius
disappeared from lsusb


[4/24/2023 11:46 PM] kuratius
connect serial, then short press power button?


[4/24/2023 11:46 PM] andi15701
and execute uuu


[4/24/2023 11:46 PM] andi15701
yes


[4/24/2023 11:47 PM] kuratius
uuuh


[4/24/2023 11:47 PM] andi15701
after uuu is finished the u-boot banner should pop up


[4/24/2023 11:47 PM] andi15701
you can just copy that .imx file over to the raspberry


[4/24/2023 11:47 PM] andi15701
if you want to avoid mess


[4/24/2023 11:48 PM] kuratius
k


[4/24/2023 11:55 PM] kuratius
am I supposed to something to get serial after the uuu command?


[4/24/2023 11:55 PM] andi15701
yes


[4/24/2023 11:56 PM] andi15701
@Szybet: should that produce a working u-boot? https://gitlab.com/akemnade/pmaports/-/commit/85c92ec17bbd9ee3fc3d493ae66099801d3a175f

{Embed}
https://gitlab.com/akemnade/pmaports/-/commit/85c92ec17bbd9ee3fc3d493ae66099801d3a175f
add u-boot for nia (without auto-appending quiet) (85c92ec1) · Comm...
postmarketOS package build recipes
/mnt/data/projects/git/conversations/media/icon_mobile-2040A.png


[4/24/2023 11:56 PM] kuratius
pi@raspberrypi:/media/pi/1f78c1b1-7c66-4b48-8cab-7d3ff113ebc3/kobo-nia $ sudo uuu u-boot.imx
uuu (Universal Update Utility) for nxp imx chips -- lib1.4.77

Success 1    Failure 0                                                                
                                                                                       
                                                                                       
1:13     2/ 2 [Done                                  ] SDP: done


[4/24/2023 11:57 PM] kuratius
pi@raspberrypi:/media/pi/1f78c1b1-7c66-4b48-8cab-7d3ff113ebc3/kobo-nia $ sudo uuu u-boot.imx
uuu (Universal Update Utility) for nxp imx chips -- lib1.4.77

Success 0    Failure 1                                                                
                                                                                       
                                                                                       
1:13     1/ 2 [HID(W):LIBUSB_ERROR_TIMEOUT           ] SDP: boot -f "u-boot.imx"       


pi@raspberrypi:/media/pi/1f78c1b1-7c66-4b48-8cab-7d3ff113ebc3/kobo-nia $


[4/24/2023 11:57 PM] kuratius
if I run it a second time I get this


[4/24/2023 11:57 PM] andi15701
and on your serial line?


[4/24/2023 11:58 PM] kuratius
nothing


[4/24/2023 11:59 PM] andi15701
ok, so u-boot is bad


[4/24/2023 11:59 PM] andi15701
dd if=nia-backup.img bs=512 skip=2 count=1024 of=u-boot-orig.imx


[4/24/2023 11:59 PM] andi15701
uuu u-boot-orig.imx


[4/25/2023 12:01 AM] andi15701
pressing long to power off first


[4/25/2023 12:02 AM] kuratius
pi@raspberrypi:/media/pi/1f78c1b1-7c66-4b48-8cab-7d3ff113ebc3 $ sudo dd if=backup/koboBackup.img bs=512 skip=2 count=1024 of=kobo-nia/u-boot-orig.imx
1024+0 Datensätze ein
1024+0 Datensätze aus
524288 Bytes (524 kB, 512 KiB) kopiert, 0,0256204 s, 20,5 MB/s


[4/25/2023 12:04 AM] andi15701
explanation, u-boot was started


[4/25/2023 12:04 AM] andi15701
but nothing did really turn off usb


[4/25/2023 12:04 AM] andi15701
and nothing really listens anymore to usb input


[4/25/2023 12:05 AM] andi15701
so you need to power off


[4/25/2023 12:06 AM] kuratius
pi@raspberrypi:/media/pi/1f78c1b1-7c66-4b48-8cab-7d3ff113ebc3/kobo-nia $ sudo uuu u-boot-orig.imx
uuu (Universal Update Utility) for nxp imx chips -- lib1.4.77

Success 1    Failure 0                                                                
                                                                                       
                                                                                       
1:13     2/ 2 [Done                                  ] SDP: done


[4/25/2023 12:06 AM] kuratius
not getting serial


[4/25/2023 12:12 AM] kuratius
serial woorks fine on nickel


[4/25/2023 12:12 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/minicom-3-515CC.cap


[4/25/2023 12:17 AM] andi15701
one last try: for this evening/night


[4/25/2023 12:18 AM] kuratius
one more try with uuu?


[4/25/2023 12:18 AM] kuratius
or something else?


[4/25/2023 12:18 AM] andi15701
no, original u-boot + pmos


[4/25/2023 12:18 AM] andi15701
on sd


[4/25/2023 12:19 AM] andi15701
d if=nia-backup.img bs=512 seek=2 skip=2  count=1024  of=/dev/sdX (uSD with pmos)


[4/25/2023 12:23 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/minicom-4-5F2EF.cap


[4/25/2023 12:24 AM] kuratius
bootlooping


[4/25/2023 12:24 AM] kuratius
I think


[4/25/2023 12:24 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/minicom-4-0C9A3.cap


[4/25/2023 12:25 AM] andi15701
so just power off


[4/25/2023 12:25 AM] kuratius
was the uuu command expected to give serial output?


[4/25/2023 12:25 AM] andi15701
yes


[4/25/2023 12:26 AM] andi15701
at least until here:


[4/25/2023 12:26 AM] andi15701
-Boot 2016.03-00075-g4c12101031 (Apr 19 2022 - 17:27:17 +0800)

CPU:   Freescale i.MX6ULL rev1.1 at 396MHz
CPU:   Commercial temperature grade (0C to 95C) at 34C
Reset cause: POR
Board: MX6ULL NTX
I2C:   ready
DRAM:  256 MiB


[4/25/2023 12:27 AM] andi15701
so just run nickel to ensure things get fully charged again


[4/25/2023 12:29 AM] kuratius
any idea what is causing the bootlooping?


[4/25/2023 12:29 AM] andi15701
not really, without proper logging


[4/25/2023 12:30 AM] andi15701
so if we somehow cannot build u-boot


[4/25/2023 12:30 AM] andi15701
we must reapply the quiettt thing on the kernel


[4/25/2023 12:32 AM] kuratius
weird thing: nickel says 99 % battery but 1.4 hours until full


[4/25/2023 12:32 AM] kuratius
??


[4/25/2023 12:33 AM] andi15701
so let it just charge


[4/25/2023 12:34 AM] andi15701
and I need to "charge" too


[4/25/2023 12:34 AM] kuratius
xD


[4/25/2023 12:35 AM] kuratius
thanks for your help


[4/25/2023 12:35 AM] kuratius
do you think it drained the battery from one of your previous attempts?


[4/25/2023 12:35 AM] kuratius
would that cause the bootlooping?


[4/25/2023 12:36 AM] kuratius
is nickel misreading the battery?


[4/25/2023 12:36 AM] andi15701
can be a combination


[4/25/2023 12:37 AM] andi15701
having the device in a state where it looks off


[4/25/2023 12:37 AM] andi15701
but was not


[4/25/2023 12:37 AM] andi15701
so first rule out the battery


[4/25/2023 12:37 AM] kuratius
that shouldnt affec the uuu attempt right?


[4/25/2023 12:38 AM] kuratius
cause that was with usb power


[4/25/2023 12:38 AM] andi15701
yes, it should not


[4/25/2023 12:41 AM] kuratius
I'll prepare an sdcard with 32bit raspberry pi OS in case it's useful for anything


[4/25/2023 12:45 AM] kuratius
https://wiki.postmarketos.org/wiki/Troubleshooting:boot

{Embed}
https://wiki.postmarketos.org/wiki/Troubleshooting:boot
Troubleshooting:boot


[4/25/2023 12:47 AM] andi15701
telnet into initramfs might be interesting, but we need to get the kernel verbose


[4/25/2023 12:47 AM] andi15701
and finally I need some sleep


[4/25/2023 12:48 AM] kuratius
kk


[4/25/2023 8:48 AM] andi15701
pmbootstrap kconfig edit linux-kobo-clara-mainline


[4/25/2023 8:51 AM] andi15701
boot options->Kernel command line type->Always use the default kernel command string


[4/25/2023 8:52 AM] andi15701
and then pmbootstrap build linux-kobo-clara-mainline --force


[4/25/2023 8:53 AM] andi15701
and create the sd card as usual including copying back the original u-boot


[4/25/2023 8:55 AM] andi15701
then no u-boot can append "quiet" to the commandline


[4/25/2023 9:31 AM] kuratius
clara or nia?


[4/25/2023 9:32 AM] andi15701
clara


[4/25/2023 9:32 AM] andi15701
common kernel of every ebookreader supported by pmOS


[4/25/2023 9:53 AM] kuratius
do I need a git pull?


[4/25/2023 9:54 AM] kuratius
(assume not, but just in case)


[4/25/2023 10:06 AM] kuratius
disabled automount cause it kept causing issues


[4/25/2023 10:07 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-8F972.txt


[4/25/2023 10:07 AM] kuratius
now just write the uboot again?


[4/25/2023 10:07 AM] kuratius
sec


[4/25/2023 10:08 AM] kuratius
this right?


[4/25/2023 10:08 AM] andi15701
yes


[4/25/2023 10:08 AM] andi15701
u-boot is a separate contruction site


[4/25/2023 10:14 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/minicom-5-BF37F.cap


[4/25/2023 10:15 AM] kuratius
also I think power button long press doesnt shut it down


[4/25/2023 10:18 AM] kuratius
is it worth pulling the sd card and trying to write an image without overwriting uboot?


[4/25/2023 10:23 AM] andi15701
that is definitively not the issue, the question regarding u-boot is 1. why do the uuu attempts not work, 2. why do the self-compiled versions of the vendor u-boot not work


[4/25/2023 10:23 AM] andi15701
just do not let your nia lying around bootlooping, maybe we can continue in the evening


[4/25/2023 10:24 AM] andi15701
may add PMOS_NO_OUTPUT_REDIRECT to the kernel command line (via that kconfig edit thing)


[4/25/2023 10:26 AM] kuratius
inserted nickelSD, will boot then shut down properly


[4/25/2023 10:27 AM] kuratius
@Szybet have you ever used uuu with your nia?


[4/25/2023 10:29 AM] szybet
I remember something


[4/25/2023 10:29 AM] szybet
But for what?


[4/25/2023 10:29 AM] szybet
#porting nia thread, there is everything


[4/25/2023 10:32 AM] kuratius
@andi should I install this directly? https://github.com/nxp-imx/mfgtools

{Embed}
https://github.com/nxp-imx/mfgtools
GitHub - nxp-imx/mfgtools: Freescale/NXP I.MX Chip image deploy tools.
Freescale/NXP I.MX Chip image deploy tools. Contribute to nxp-imx/mfgtools development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/mfgtools-58260


[4/25/2023 10:32 AM] kuratius
did you get serial output when doing that?


[4/25/2023 10:32 AM] kuratius
we didnt


[4/25/2023 10:34 AM] kuratius
https://discord.com/channels/809205711778480158/943711473341960253/944303393562853456


[4/25/2023 10:36 AM] kuratius
did you use uuu or did you end up using the alternative commands tux told you?


[4/25/2023 10:42 AM] szybet
https://discord.com/channels/809205711778480158/943711473341960253/944535015335800883


[4/25/2023 10:42 AM] szybet
Pretty much this


[4/25/2023 10:42 AM] szybet
I dont think any command to boot uboot without flashing it worked


[4/25/2023 10:42 AM] szybet
Kernel too


[4/25/2023 10:47 AM] andi15701
but you managed to replace u-boot by something self-compiled. That is important to know. I think that the old uboot does not like new compliers or something... I think the next step is just the PMOS_NO_OUTPUT_REDIRECT stuff to increase output


[4/25/2023 7:15 PM] kuratius
where do I change that?


[4/25/2023 7:24 PM] kuratius
https://wiki.postmarketos.org/wiki/Troubleshooting:kernel#How_can_I_boot_the_kernel_with_some_specific_arguments.3F

{Embed}
https://wiki.postmarketos.org/wiki/Troubleshooting:kernel
Troubleshooting:kernel


[4/25/2023 7:25 PM] kuratius
where is defconfig?


[4/25/2023 8:03 PM] andi15701
pmbootstrap kconfig edit linux-kobo-clara-mainline


[4/25/2023 8:04 PM] andi15701
near where you changed stuff for enforcing the commandline form kernel config


[4/25/2023 8:14 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/kernel-C1459.png


[4/25/2023 8:14 PM] kuratius
here?


[4/25/2023 8:14 PM] andi15701
no


[4/25/2023 8:15 PM] kuratius
I dont see anything that looks right in boot options


[4/25/2023 8:15 PM] kuratius
this?


[4/25/2023 8:15 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-90681.png


[4/25/2023 8:15 PM] andi15701
default kernel commandline string


[4/25/2023 8:15 PM] andi15701
in boot options


[4/25/2023 8:16 PM] andi15701
append it


[4/25/2023 8:16 PM] andi15701
so console=ttymxc0,115200 PMOS_NO_OUTPUT_REDIRECT


[4/25/2023 8:16 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-3A656.png


[4/25/2023 8:16 PM] kuratius
without the comma?


[4/25/2023 8:17 PM] andi15701
no comma between 115200 and PMOS


[4/25/2023 8:17 PM] andi15701
space


[4/25/2023 8:17 PM] andi15701
yes


[4/25/2023 8:17 PM] andi15701
and


[4/25/2023 8:18 PM] kuratius
and?


[4/25/2023 8:18 PM] andi15701
device drivers->voltage and current regulator support->regulator debug support


[4/25/2023 8:19 PM] kuratius
is that for the boot looping?


[4/25/2023 8:19 PM] andi15701
more info


[4/25/2023 8:19 PM] andi15701
more output


[4/25/2023 8:19 PM] andi15701
that is our current goal


[4/25/2023 8:20 PM] andi15701
we have won something without the quiet thing


[4/25/2023 8:20 PM] kuratius
changed it


[4/25/2023 8:21 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-04EBF.png


[4/25/2023 8:22 PM] andi15701
yes


[4/25/2023 8:22 PM] kuratius
the freescale regulator settings are not relevant right now right?


[4/25/2023 8:22 PM] andi15701
they are enbled


[4/25/2023 8:22 PM] andi15701
that is fine


[4/25/2023 8:23 PM] andi15701
ricoh_watchdog disable in


[4/25/2023 8:23 PM] kuratius
where?


[4/25/2023 8:24 PM] andi15701
.local/var/pmbootstrap/cache_git/pmaports/device/testing/device-kobo-nia/uboot-script.cmd


[4/25/2023 8:24 PM] andi15701
after the load_ntxkernel


[4/25/2023 8:24 PM] andi15701
and then force-build both the kernel and the device package


[4/25/2023 8:25 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-9EF0D.png


[4/25/2023 8:25 PM] kuratius
what does in mean?


[4/25/2023 8:25 PM] andi15701
so add ```ricoh_watchdog disable``` there


[4/25/2023 8:25 PM] andi15701
without the in


[4/25/2023 8:25 PM] kuratius
ah


[4/25/2023 8:26 PM] andi15701
it should not be needed


[4/25/2023 8:26 PM] andi15701
but lets find out


[4/25/2023 8:26 PM] andi15701
the kernel should take over control of the watchdog


[4/25/2023 8:26 PM] andi15701
and pet it


[4/25/2023 8:26 PM] kuratius
xD


[4/25/2023 8:27 PM] kuratius
building kernel now


[4/25/2023 8:27 PM] kuratius
next doing pmbootstrap init
then pmboostrap install


[4/25/2023 8:27 PM] andi15701
are you familar with ts?


[4/25/2023 8:27 PM] kuratius
ts?


[4/25/2023 8:28 PM] andi15701
from moreutils


[4/25/2023 8:28 PM] kuratius
not at all


[4/25/2023 8:28 PM] andi15701
adds a timestamp to every line it gets on stdin


[4/25/2023 8:29 PM] andi15701
when no-one is accessing serial: stty -F /dev/ttyUSBx ispeed 115200 raw -echo ; ts </dev/ttyUSBx | tee logfile


[4/25/2023 8:29 PM] andi15701
might be interesting to see whether the runtime is constant


[4/25/2023 8:30 PM] andi15701
you can dry-run that with nickel maybe


[4/25/2023 8:57 PM] kuratius
here they talked about some skip not being necessary, does that affect us?


[4/25/2023 8:58 PM] kuratius
pi@raspberrypi:/media/pi/1f78c1b1-7c66-4b48-8cab-7d3ff113ebc3/backup $ sudo dd if=koboBackup.img bs=512 seek=2 skip=2  count=1024 of=/dev/sda


[4/25/2023 8:58 PM] andi15701
uboot must start at sector 2


[4/25/2023 8:58 PM] andi15701
that is correct


[4/25/2023 8:58 PM] szybet
well that was the problem, the skip


[4/25/2023 8:58 PM] andi15701
here we are coping from the backup


[4/25/2023 8:59 PM] szybet
https://github.com/Szybet/niAudio/blob/main/inkbox.md

{Embed}
https://github.com/Szybet/niAudio/blob/main/inkbox.md
niAudio/inkbox.md at main · Szybet/niAudio
Kobo nia ereader with audio added. Contribute to Szybet/niAudio development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/niAudio-613C3


[4/25/2023 8:59 PM] szybet
dd if=$UBOOT of=/dev/$DEVICE bs=1K seek=1


[4/25/2023 8:59 PM] andi15701
we do not need the skip if we copi 2016 or 2020 uboot.imx stuff


[4/25/2023 9:00 PM] andi15701
the pitfall is that some bootloader builds just prepend a number of zeros


[4/25/2023 9:01 PM] andi15701
I think barebox and the 2008 uboot used in imx6sl kobos


[4/25/2023 9:01 PM] andi15701
2c52425868d630a8d735a1bd6c313a35fe19910d95cf60e19caae4c0786c44a2  nia-uboot.tar.bz2


[4/25/2023 9:01 PM] andi15701
that is correct?


[4/25/2023 9:02 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/minicom-6-989AD.cap


[4/25/2023 9:06 PM] kuratius
it's not related to my setting xfc4 instead of console right?


[4/25/2023 9:06 PM] kuratius
(random thought)


[4/25/2023 9:06 PM] andi15701
try


[4/25/2023 9:06 PM] andi15701
to set console


[4/25/2023 9:10 PM] kuratius
did this contain anything interesting?


[4/25/2023 9:10 PM] andi15701
still analyzing


[4/25/2023 9:20 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/minicom-7-494C9.cap


[4/25/2023 9:22 PM] kuratius
https://discord.com/channels/809205711778480158/943711473341960253/944670757781381120 this was due to kernel size


[4/25/2023 9:22 PM] kuratius
is that relevant for us?


[4/25/2023 9:24 PM] andi15701
kernel size does not matter that


[4/25/2023 9:24 PM] andi15701
for us


[4/25/2023 9:24 PM] andi15701
it would fail during unpacking of kernel


[4/25/2023 9:24 PM] kuratius
I see


[4/25/2023 9:28 PM] andi15701
do you manage to do a ssh user@172.16.42.1 dmesg >dmesg.log ?


[4/25/2023 9:31 PM] kuratius
can I include the password in the ssh command?


[4/25/2023 9:31 PM] kuratius
I may end up too slow


[4/25/2023 9:32 PM] andi15701
well, add your ssh-key


[4/25/2023 9:33 PM] kuratius
are any of the dmesg options here helpful?


[4/25/2023 9:35 PM] andi15701
I try to build a fresh image here


[4/25/2023 9:35 PM] andi15701
on the clara


[4/25/2023 9:35 PM] andi15701
to compare logging behavior


[4/25/2023 9:36 PM] andi15701
never done any debugging on pmOS, I usually first boot things without even touching sd card


[4/25/2023 9:36 PM] andi15701
so I switched over when things were basically running


[4/25/2023 9:42 PM] kuratius
managed it


[4/25/2023 9:42 PM] kuratius
where does it write the log?


[4/25/2023 9:43 PM] andi15701
on your host filesystem


[4/25/2023 9:43 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/dmesg-2FE57.log
/mnt/data/projects/git/conversations/media/dmesg2-49091.log


[4/25/2023 9:43 PM] andi15701
the > is your host


[4/25/2023 9:44 PM] kuratius
(i logged in twice)


[4/25/2023 9:45 PM] kuratius
[    0.000000] Kernel command line: console=ttymxc0,115200 PMOS_NO_OUTPUT_REDIRECT
[    0.000000] Unknown kernel command line parameters "PMOS_NO_OUTPUT_REDIRECT", will be passed to user space.
[    0.000000] is this normal?


[4/25/2023 9:45 PM] andi15701
yes


[4/25/2023 9:46 PM] andi15701
rc5t619-rtc rc5t619-rtc: rc5t619 interrupt is disabled


[4/25/2023 9:46 PM] andi15701
that one is interesting


[4/25/2023 9:53 PM] kuratius
this contains the log that you get without an sd card btw

{Attachments}
/mnt/data/projects/git/conversations/media/minicom-8-9E93B.cap


[4/25/2023 9:56 PM] kuratius
should I try logging in and seeing how long I can watch dmesg?


[4/25/2023 9:56 PM] andi15701
I need a bit of time to think


[4/25/2023 9:56 PM] kuratius
kk


[4/25/2023 9:57 PM] andi15701
probably lets continue tomorrow


[4/25/2023 9:57 PM] andi15701
btw: I was just trying to compile a more recent u-boot


[4/25/2023 9:57 PM] andi15701
lets see


[4/25/2023 9:58 PM] kuratius
is the reason why the uboot we compiled didnt work likely to be a compiler bug?


[4/25/2023 9:58 PM] kuratius
or a programming error that was covered by a compiler bug?


[4/25/2023 9:59 PM] andi15701
maybe a programming error that was covered by a compiler optimization change


[4/25/2023 10:00 PM] andi15701
as Szybet was able to compile and run it


[4/25/2023 10:00 PM] andi15701
so the other possible reason that it needed to be signed is ruled out


[4/25/2023 10:02 PM] szybet
getting a compiler to match with software on those old system is pain


[4/25/2023 10:04 PM] szybet
trying anyways could help


[4/25/2023 10:05 PM] kuratius
is it possible to compile nickel/default kernel with a newer compiler?


[4/25/2023 10:07 PM] szybet
making it compile with the compiler that kobo provides was pain 3 days work for a c noob like me who was just googling and got the answer at the third page of google in an 2003 router kernel thing forum

so propably not, even if it would compile it could not run for no reason at all, because magic


[4/25/2023 10:08 PM] kuratius
what was the answer?


[4/25/2023 10:09 PM] andi15701
I do not think it is just worth


[4/25/2023 10:09 PM] szybet
https://github.com/Szybet/niAudio/blob/main/links.md

{Embed}
https://github.com/Szybet/niAudio/blob/main/links.md
niAudio/links.md at main · Szybet/niAudio
Kobo nia ereader with audio added. Contribute to Szybet/niAudio development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/niAudio-613C3


[4/25/2023 10:10 PM] szybet
https://forum.openwrt.org/t/build-error-gcc-10-x-solved-pls-fix-on-repo/68942

{Embed}
https://forum.openwrt.org/t/build-error-gcc-10-x-solved-pls-fix-on-repo/68942
Build error gcc 10.x (SOLVED, PLS FIX ON REPO)
During building for my minimum requirements, an error worked which requires a patch.  Error syntax  usr/bin/ld: scripts/dtc/dtc-parser.tab.o:(.bss+0x50): multiple definition of 'yylloc'; scripts/dtc/dtc-lexer.lex.o:  Fast fix:  #include "srcpos.h" #include "dtc-parser.tab.h"  extern YYLTYPE yylloc; // OLD CODE: YYLTYPE yylloc; extern bool treeso...
/mnt/data/projects/git/conversations/media/2965b316403db302c535cae40139e8c49bbad6e3-82652.png


[4/25/2023 10:10 PM] andi15701
the only thing to get us forward are sane logs


[4/25/2023 10:10 PM] szybet
ok, its 2020 but the original answer was older, i just googled the answer then to get on a forum with decent dark mode


[4/25/2023 10:11 PM] andi15701
and somewhere the loglevel gets reduced


[4/25/2023 10:13 PM] kuratius
what did we do to get a kernel without bootlooping before?


[4/25/2023 10:13 PM] andi15701
[    0.905657] DCDC1: 1400 mV, enabled
[    0.907726] DCDC2: at 3300 mV, enabled
[    0.909675] DCDC3: at 3300 mV, enabled
[    0.911640] DCDC4: 1200 mV, enabled
[    0.913597] DCDC5: 1800 mV, enabled
[    0.915520] LDO1: at 3300 mV, enabled
[    0.916779] LDO2: at 3300 mV, enabled
[    0.917981] LDO3: at 1200 mV, enabled
[    0.919197] LDO4: at 1200 mV, enabled
[    0.920423] LDO5: at 3300 mV, enabled
[    0.921674] LDO6: 600 mV, enabled
[    0.922950] LDO7: at 3300 mV, enabled
[    0.924194] LDO8: 1800 mV, enabled
[    0.926141] LDO9: at 1200 mV, enabled
[    0.927358] LDO10: at 1400 mV, enabled
[    0.928589] LDORTC1: at 3300 mV, enabled
[    0.930391] LDORTC2: at 3300 mV, enabled


[4/25/2023 10:13 PM] andi15701
that is confusing


[4/25/2023 10:13 PM] kuratius
sorry I mean shell


[4/25/2023 10:13 PM] andi15701
basically bootup state


[4/25/2023 10:14 PM] andi15701
we did not have a root fs


[4/25/2023 10:14 PM] szybet
what is the problem now? u-boot or kernel? im confused


[4/25/2023 10:14 PM] andi15701
so it paniced


[4/25/2023 10:14 PM] andi15701
and just hangs


[4/25/2023 10:15 PM] andi15701
we have several problems


[4/25/2023 10:15 PM] andi15701
1. u-boot: self-compiled factory u-boot does not start, nothing booted with uuu either


[4/25/2023 10:16 PM] szybet
uuu doesnt suprise me


[4/25/2023 10:16 PM] andi15701
2. kernel logging is not set to a sane value, so we do not see enough


[4/25/2023 10:16 PM] szybet
https://github.com/Szybet/niAudio/blob/main/inkbox.md

{Embed}
https://github.com/Szybet/niAudio/blob/main/inkbox.md
niAudio/inkbox.md at main · Szybet/niAudio
Kobo nia ereader with audio added. Contribute to Szybet/niAudio development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/niAudio-613C3


[4/25/2023 10:16 PM] szybet
for u-boot


[4/25/2023 10:17 PM] szybet
maybe just try to follow the steps 1:1?


[4/25/2023 10:17 PM] andi15701
3. some kernel issues


[4/25/2023 10:18 PM] andi15701
I am checking now 2. with clara and pmOS


[4/25/2023 10:18 PM] szybet
if those don't work i can get involved in a week, because thats a bigger problem


[4/25/2023 10:19 PM] andi15701
I have now some stuff to analyze and that is nice


[4/25/2023 10:22 PM] andi15701
so I first make sure I see everything on the clara


[4/25/2023 10:34 PM] andi15701
[    9.568195] lm3630a_bl 0-0036: LM3630A backlight register OK.
[    9.573636] 8189fs: loading out-of-tree module taints kernel.
[    9.696720] rc5t619-rtc rc5t619-rtc: registered as rtc0
[    9.697508] rc5t619-rtc rc5t619-rtc: hctosys: unable to read the hardware clock
[    9.727350] rn5t618-power rn5t618-power: Fuel gauge not enabled, enabling now
[    9.727368] rn5t618-power rn5t618-power: Expect imprecise results
[   10.803113] EXT4-fs (mmcblk0p2): re-mounted. Quota mode: none.
[   31.200448] LDO1: disabling
[   31.201022] LDO4: disabling
[   31.201565] LDO9: disabling
[   31.202099] LDO10: disabling
[   31.202634] LDORTC1: disabling


[4/25/2023 10:34 PM] andi15701
for compairos on the clara


[4/25/2023 10:36 PM] kuratius
is it possible to see what these do on nickel?


[4/25/2023 10:37 PM] andi15701
dumping regulator state on nickel might be helpful


[4/25/2023 10:38 PM] kuratius
how?


[4/25/2023 10:38 PM] kuratius
I mean, how do I do it?


[4/25/2023 10:39 PM] andi15701
the theory here is that your nia reboots when after those 30-31s, regulators are turned off


[4/25/2023 10:39 PM] andi15701
which are not needed


[4/25/2023 10:39 PM] andi15701
and maybe one too much


[4/25/2023 10:44 PM] kuratius
is it possible to get a shell on nickel and get the same logs?


[4/25/2023 10:49 PM] kuratius
does the serial shell on nickel have known credentials


[4/25/2023 10:49 PM] andi15701
no credentials at all


[4/25/2023 10:49 PM] kuratius
dhcpcd[1528]: eth0: using /sys hwaddr: 58:b0:d4:bf:c6:1a                        
dhcpcd[1528]: eth0: executing `/libexec/dhcpcd-run-hooks' PREINIT               
dhcpcd[1528]: eth0: executing `/libexec/dhcpcd-run-hooks' NOCARRIER             
dhcpcd[1528]: no interfaces have a carrier                                      
dhcpcd[1528]: forking to background                                             
dhcpcd[1528]: forked to background, child pid 1540                              
                                                                                
kobo login:                                                                     
kobo login:                                                                     
kobo login:                                                                     
kobo login:


[4/25/2023 10:50 PM] andi15701
root and empty


[4/25/2023 10:57 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/minicom-8-3F49E.cap


[4/25/2023 10:57 PM] kuratius
search for dmesg


[4/25/2023 10:59 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/dmesg-nickel-0F001.log


[4/25/2023 11:00 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/dmesg-nickel-2-68874.log


[4/25/2023 11:01 PM] kuratius
watchdog timeout triggered?


[4/25/2023 11:31 PM] andi15701
PMU: bd71828_regulator_init


[4/25/2023 11:31 PM] andi15701
that is REV C kernel!


[4/25/2023 11:32 PM] kuratius
should I be worried?


[4/25/2023 11:32 PM] andi15701
no, just interesting to know


[4/25/2023 11:33 PM] kuratius
wait asus?


[4/25/2023 11:33 PM] kuratius
asus works for kobo?


[4/25/2023 11:33 PM] andi15701
hostname


[4/25/2023 11:33 PM] andi15701
of the device


[4/25/2023 11:33 PM] kuratius
Linux version 4.1.15-00463-g38afd5cea756 (gallen@gallen-ASUS-EXPERTCENTER-D900TA-D900TA) (gcc version 5.3.0 (GCC) ) #28 SMP PREEMPT Fri Sep 16 10:43:24 CST 2022
CPU: ARMv7 Processor [410fc075] revision 5 (ARMv7), cr=10c53c7d


[4/25/2023 11:33 PM] andi15701
which compiled the kernel


[4/25/2023 11:33 PM] andi15701
so they used an asus computer


[4/25/2023 11:33 PM] kuratius
ah ok


[4/25/2023 11:34 PM] andi15701
to compile the kernel


[4/25/2023 11:34 PM] kuratius
gcc version is included


[4/25/2023 11:34 PM] andi15701
RICOH619_LDORTC2: disabling
RICOH619_LDORTC1: disabling
RICOH619_LDO10: disabling
RICOH619_LDO9: disabling
RICOH619_LDO4: disabling
RICOH619_LDO3: disabling
RICOH619_LDO1: disabling
SD1_SPWR: disabling
vref-3v3: disabling


[4/26/2023 12:08 AM] andi15701
pmos-clara:~$ cat /etc/sysctl.conf 
# content of this file will override /etc/sysctl.d/*
kernel.printk=7 7 7 7


[4/26/2023 12:08 AM] andi15701
that breaks silence


[4/26/2023 12:08 AM] andi15701
so we might get the last words


[4/26/2023 12:09 AM] kuratius
so I need to edit it on the sd card?


[4/26/2023 12:09 AM] andi15701
I will just compare the regulators with the nickel dmesg output


[4/26/2023 12:15 AM] andi15701
[   11.355392] rn5t618-adc rn5t618-adc: get virq failed
[   11.355421] rn5t618-adc: probe of rn5t618-adc failed with error -22


[4/26/2023 12:15 AM] andi15701
and I think I have these ones fixed


[4/26/2023 12:16 AM] andi15701
you need to edit that and rebuild the kernel


[4/26/2023 12:16 AM] andi15701
so you can do that after installing


[4/26/2023 12:16 AM] andi15701
and you also need a git pull in the pmaports


[4/26/2023 12:16 AM] andi15701
I will tell you when I have pushed


[4/26/2023 12:16 AM] kuratius
ok


[4/26/2023 12:16 AM] andi15701
reg = <0x32>;
                interrupt-parent = <&gpio5>;
-               interrupt = <1 IRQ_TYPE_EDGE_FALLING>;
+               interrupts = <1 IRQ_TYPE_EDGE_FALLING>;
                interrupt-controller;


[4/26/2023 12:17 AM] andi15701
that is the reason


[4/26/2023 12:17 AM] andi15701
very high probably


[4/26/2023 12:18 AM] andi15701
but again, first some sleep


[4/26/2023 12:18 AM] kuratius
thank you for your hard work


[4/26/2023 10:39 PM] kuratius
do you know what all the voltage regulators are for?


[4/26/2023 10:49 PM] andi15701
for some I know, but not for all


[4/26/2023 10:49 PM] kuratius
regarding the ones you do know, why are they turned off?


[4/26/2023 10:50 PM] kuratius
and what do they do?


[4/26/2023 11:04 PM] andi15701
for the ones turned off, no idea what they do. But why they are turned off: They are marked as boot-on, but not as always on, so the regulators are turned off afterwards if they are not kept enabled by any consumer.  I think they are kept on to have time to get everything registered which might require them.


[4/26/2023 11:04 PM] andi15701
static void regulator_init_complete_work_function(struct work_struct *work)


[4/26/2023 11:04 PM] andi15701
in drivers/regulator/core.c


[4/27/2023 12:05 AM] kuratius
@andi still building?


[4/27/2023 12:05 AM] andi15701
dealing with other kernel issues


[4/27/2023 12:05 AM] kuratius
kk


[4/27/2023 12:05 AM] andi15701
i broke nokia 770


[4/27/2023 12:05 AM] andi15701
e.g.


[4/27/2023 12:05 AM] kuratius
oh


[4/27/2023 12:06 AM] andi15701
while fixing my own system


[4/27/2023 6:22 PM] szybet
do you guys still need me to extract this thing from the sd card or did you grabbed it from the image


[4/27/2023 6:31 PM] kuratius
we dont need anything from an sd card, we were just running into issues where the kernel would load and then reset, but andi says he found the solution


[4/27/2023 6:33 PM] kuratius
he got sidetracked by another issue or part of the solution was a dirty hack that broke other kernels, not sure


[4/27/2023 9:04 PM] andi15701
I upstreamed a patch to mainline kernel which totally broke several systems


[4/27/2023 9:04 PM] andi15701
independently of any ebookreader work


[4/27/2023 9:05 PM] andi15701
so I needed to clarify it was alsa a regression fix for me and help to find a good solution for everyone


[4/28/2023 5:34 PM] kuratius
@andi did you find the source of the problem you had with the other devices?


[4/28/2023 5:35 PM] andi15701
Well, I think I just need a final cleanup


[4/28/2023 5:35 PM] kuratius
kk


[4/28/2023 5:36 PM] andi15701
but meanwhile:


[4/28/2023 5:37 PM] andi15701
about the nia: wha should be fixed is the probing of  the driver for the charger/fuel gauge


[4/28/2023 5:39 PM] andi15701
either via uuu


[4/28/2023 5:39 PM] andi15701
and this u-boot deserves testing

{Attachments}
/mnt/data/projects/git/conversations/media/u-boot-dtb-81A85.imx


[4/28/2023 5:39 PM] andi15701
or via


[4/28/2023 5:40 PM] andi15701
dd if=u-boot-dtb.imx bs=512 seek=2 of=/dev/sdX


[4/28/2023 5:40 PM] andi15701
it is something 2020 based


[4/28/2023 5:41 PM] andi15701
variants work on various imx6sl or 6sll based kobos and tolinos


[4/28/2023 5:42 PM] andi15701
happily compiling with the compile included in debian bullseye


[4/28/2023 5:43 PM] andi15701
and it does not apend "quiet" to the kernel commadline


[4/28/2023 5:57 PM] kuratius
U-Boot 2020.10-00026-ge45fdb097f (Apr 27 2023 - 22:15:30 +0200)
                                                              
CPU:   Freescale i.MX6ULL rev1.1 900 MHz (running at 396 MHz) 
CPU:   Commercial temperature grade (0C to 95C) at 33C        
Reset cause: POR                                              
Model: Kobo Nia
Board: MX6ULL Kobo Nia
DRAM:  256 MiB
MMC:   FSL_SDHC: 1, FSL_SDHC: 0
Loading Environment from MMC... Card did not respond to voltage select!
*** Warning - No block device, using default environment

In:    serial
Out:   serial
Err:   serial                                                                   
Boot from USB for uuu                                                           
Hit any key to stop autoboot:  0


[4/28/2023 5:57 PM] kuratius
uuu


[4/28/2023 5:59 PM] andi15701
and now you have fastboot?


[4/28/2023 5:59 PM] kuratius
dont get a serial shell


[4/28/2023 6:00 PM] kuratius
sudo uuu u-boot-dtb.imx 
uuu (Universal Update Utility) for nxp imx chips -- lib1.4.77

Success 1    Failure 0                                                         
                                                                                
                                                                                
1:11     2/ 2 [Done                                  ] SDP: done


[4/28/2023 6:00 PM] kuratius
but there is output


[4/28/2023 6:00 PM] andi15701
that is important to know, if we ever handle 6ull devices with eMMC


[4/28/2023 6:01 PM] andi15701
one rescue option


[4/28/2023 6:05 PM] andi15701
well, expected behaviour would be that if you do not stop autoboot, it will enumerate as a fastboot device on usb


[4/28/2023 6:06 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-A4830.txt


[4/28/2023 6:06 PM] kuratius
managed to get shell


[4/28/2023 6:06 PM] kuratius
was too slow the first time


[4/28/2023 6:08 PM] kuratius
anything we can do with uuu working?


[4/28/2023 6:09 PM] kuratius
also after every attempt the device needs a full reboot, else it wont give serial output


[4/28/2023 6:09 PM] kuratius
i.e. if you get it try to boot from non-existent usb without stopping it with a keypress, it gets into a bad state


[4/28/2023 6:10 PM] kuratius
uuu command after a failed boot (letting the timer run out) seems to succeed, but doesnt result in serial output


[4/28/2023 6:10 PM] kuratius
that's what I mean by bad state


[4/28/2023 6:10 PM] kuratius
so you cant directly rerun uuu a second time if you were too slow the first time


[4/28/2023 6:14 PM] kuratius
would uuu work if the eMMC is in a bad state?


[4/28/2023 6:15 PM] kuratius
doesnt boot correctly, but does... something, so it doesnt enter recovery mode, that kind of state?


[4/28/2023 6:19 PM] andi15701
you can usually zero the whole device


[4/28/2023 6:19 PM] andi15701
or put anything on it which does not look like a bootloaer


[4/28/2023 6:20 PM] andi15701
and then you can use uuu


[4/28/2023 6:22 PM] andi15701
if you let the timer expire, usb should be there allowing to boot things with fastboot


[4/28/2023 6:23 PM] andi15701
and hopefully the same u-boot does also work on a SD


[4/28/2023 6:25 PM] andi15701
for testing kernel things I usually use uuu to boot some u-boot and then fastboot to boot a kernel and then the kernel gets its rootfs over NFS


[4/28/2023 7:19 PM] kuratius
after letting the timer expire, how would I use fastboot to test a kernel?


[4/28/2023 7:20 PM] kuratius
(I assume that's what you meant here)


[4/28/2023 8:24 PM] andi15701
[302365.008600] usb 1-2.2: New USB device found, idVendor=1fc9, idProduct=0128, bcdDevice= 0.01
[302365.008626] usb 1-2.2: New USB device strings: Mfr=1, Product=2, SerialNumber=0
[302365.008638] usb 1-2.2: Product: SE Blank 6SLL
[302365.008647] usb 1-2.2: Manufacturer:    NXP    SemiConductor Inc 
[302365.012986] hid-generic 0003:1FC9:0128.000A: hiddev0,hidraw0: USB HID v1.10 Device [   NXP    SemiConductor Inc  SE Blank 6SLL] on usb-0000:00:14.0-2.2/input0
[302378.251809] usb 1-2.2: USB disconnect, device number 38
[302378.479145] usb 1-2.2: new high-speed USB device number 39 using xhci_hcd
[302378.580326] usb 1-2.2: New USB device found, idVendor=18d1, idProduct=0d02, bcdDevice= 2.21
[302378.580352] usb 1-2.2: New USB device strings: Mfr=1, Product=2, SerialNumber=0
[302378.580363] usb 1-2.2: Product: USB download gadget
[302378.580372] usb 1-2.2: Manufacturer: U-Boot


[4/28/2023 8:24 PM] andi15701
this happens here on the clara


[4/28/2023 8:26 PM] andi15701
you can use the command ```fastboot boot some_image.img```


[4/28/2023 8:26 PM] andi15701
to boot something


[4/28/2023 8:26 PM] szybet
does it work on this newer uboot?


[4/28/2023 8:27 PM] andi15701
I use it all the time


[4/28/2023 8:27 PM] szybet
it didn't worked with the stock one, im sure


[4/28/2023 8:28 PM] andi15701
well, as always with ntx stuff, you have surprises at every corner


[4/28/2023 8:28 PM] andi15701
https://github.com/akemnade/linux/wiki/Kobo---Tolino-E-Bookreader-branches-and-status

{Embed}
https://github.com/akemnade/linux/wiki/Kobo---Tolino-E-Bookreader-branches-and-status
Kobo   Tolino E Bookreader branches and status
Linux kernel source tree. Contribute to akemnade/linux development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/linux-92DDE


[4/28/2023 8:29 PM] andi15701
that are the methods working for me


[4/28/2023 11:31 PM] andi15701
I think more tomorrow evening


[4/29/2023 12:14 AM] kuratius
kk


[4/29/2023 9:56 PM] andi15701
so, the pmaport git is updated


[4/29/2023 9:57 PM] andi15701
it should now install the new u-boot


[4/29/2023 9:57 PM] andi15701
but add that sysctl line


[4/29/2023 9:57 PM] andi15701
before booting


[4/29/2023 9:57 PM] andi15701
we want to ensure we hear the really last words of the kernel


[4/29/2023 9:58 PM] andi15701
if any bootloop occurs


[4/29/2023 10:16 PM] kuratius
in cache_git:
git reset --hard
git pull

in home directory:
pmbootstrap status 
pmbootstrap zap
pmbootstrap init
pmbootstrap build linux-kobo-clara-mainline --force
(building now)


[4/29/2023 10:16 PM] kuratius
(just writing down what I did)


[4/29/2023 10:17 PM] andi15701
during install, it should rebuild u-boot and the device package


[4/29/2023 10:18 PM] kuratius
will rewrite the hidden sector on the sd card
then when the build is done I'll do the install command


[4/29/2023 10:18 PM] kuratius
I assume I dont need to redo the uboot writing?


[4/29/2023 10:18 PM] kuratius
It'll boot now?


[4/29/2023 10:23 PM] andi15701
hopefully


[4/29/2023 10:23 PM] andi15701
the u-boot should be put in place by the pmbootstrap install command


[4/29/2023 10:35 PM] kuratius
installing now


[4/29/2023 10:40 PM] kuratius
sec


[4/29/2023 10:41 PM] kuratius
with spaces?


[4/29/2023 10:41 PM] andi15701
yes


[4/29/2023 10:42 PM] kuratius
dk@dk-ThinkPad-E560:/media/dk/pmOS_root$ cat etc/sysctl.conf 
# content of this file will override /etc/sysctl.d/*
kernel.printk=7 7 7 7


[4/29/2023 10:42 PM] kuratius
sec


[4/29/2023 10:42 PM] andi15701
yes


[4/29/2023 10:42 PM] kuratius
gonna test


[4/29/2023 10:48 PM] kuratius
led stays dead


[4/29/2023 10:48 PM] kuratius
i will rewrite uboot


[4/29/2023 10:48 PM] andi15701
but not with the original


[4/29/2023 10:49 PM] andi15701
with the one which booted with uuu


[4/29/2023 10:49 PM] kuratius
btw the pmbootstrap installer doesnt allow the sd card to be ejected, so I usually just shutdown my computer


[4/29/2023 10:50 PM] kuratius
is that a bug?


[4/29/2023 10:51 PM] andi15701
hmm, there is nothing mounted here


[4/29/2023 10:51 PM] kuratius
I'll tell you the error next time


[4/29/2023 10:52 PM] kuratius
sudo dd if=u-boot-dtb.imx bs=512 seek=2 skip=2  count=1024 of=/dev/sda
 this correct?


[4/29/2023 10:52 PM] andi15701
without seek


[4/29/2023 10:52 PM] kuratius
prob not right?


[4/29/2023 10:52 PM] kuratius
k


[4/29/2023 10:52 PM] andi15701
wrong


[4/29/2023 10:53 PM] andi15701
without skip


[4/29/2023 10:53 PM] andi15701
we want u-boot at sector 2


[4/29/2023 10:53 PM] kuratius
sudo dd if=u-boot-dtb.imx bs=512 seek=2 count=1024 of=/dev/sda


[4/29/2023 10:53 PM] andi15701
yes


[4/29/2023 10:53 PM] andi15701
sector 0 is the partition table


[4/29/2023 10:57 PM] kuratius
U-Boot 2020.10-00026-ge45fdb097f (Apr 27 2023 - 22:15:30 +0200)

CPU:   Freescale i.MX6ULL rev1.1 900 MHz (running at 396 MHz)
CPU:   Commercial temperature grade (0C to 95C) at 33C                          
Reset cause: POR                                                                
Model: Kobo Nia                                                                 
Board: MX6ULL Kobo Nia                                                          
DRAM:  256 MiB                                                                  
MMC:   FSL_SDHC: 1, FSL_SDHC: 0                                                 
Loading Environment from MMC... OK                                              
In:    serial                                                                   
Out:   serial                                                                   
Err:   serial                                                                   
Normal Boot                                                                     
Hit any key to stop autoboot:  0                                                
517 bytes read in 10 ms (49.8 KiB/s)                                            
## Executing script at 82000000                                                 
Wrong image format for "source" command                                         
=>


[4/29/2023 10:58 PM] kuratius
got a shell btw


[4/29/2023 10:59 PM] szybet
🥳


[4/29/2023 10:59 PM] kuratius
it didnt try to boot the kernel


[4/29/2023 11:00 PM] szybet
hald success


[4/29/2023 11:01 PM] andi15701
then copy in the script line by line


[4/29/2023 11:01 PM] kuratius
any idea why the installer keeps writing the wrong uboot?


[4/29/2023 11:01 PM] kuratius
which script ?


[4/29/2023 11:01 PM] andi15701
.local/var/pmbootstrap/cache_git/pmaports/device/testing/device-kobo-nia/uboot-script.cmd


[4/29/2023 11:02 PM] andi15701
that is what is loaded


[4/29/2023 11:02 PM] kuratius
can you send that as a file real quick?


[4/29/2023 11:02 PM] andi15701
setenv bootargs console=ttymxc0,115200 debug

# This must be called first, otherwise bootz does not work correctly.
# The actual kernel is loaded over this below.
# not needed anymore for new u-boot
# load_ntxkernel

echo Loading kernel
load mmc 0:1 0x80800000 vmlinuz

echo Loading DTB
load mmc 0:1 0x83000000 imx6ull-kobo-nia.dtb

echo Loading initrd
load mmc 0:1 0x85000000 uInitrd

echo Booting kernel
bootz 0x80800000 0x85000000 0x83000000


[4/29/2023 11:02 PM] andi15701
no echo


[4/29/2023 11:02 PM] kuratius
k


[4/29/2023 11:02 PM] andi15701
setenv,load and bootz


[4/29/2023 11:06 PM] andi15701
so something gets written incompletely, maybe the u-boot or the boot.scr ...


[4/29/2023 11:08 PM] kuratius
shell becomes unresponsive after a while for some reason


[4/29/2023 11:12 PM] kuratius
=> setenv bootargs console=ttymxc0,115200 debug
=> 
=> oad mmc 0:1 0x80800000 vmlinuz
Unknown command 'oad' - try 'help'
=> load mmc 0:1 0x80800000 vmlinuz
5763208 bytes read in 364 ms (15.1 MiB/s)
=> load mmc 0:1 0x83000000 imx6ull-kobo-nia.dtb                                 
30606 bytes read in 19 ms (1.5 MiB/s)                                           
=> load mmc 0:1 0x85000000 uInitrd                                              
1473390 bytes read in 117 ms (12 MiB/s)                                         
=>


[4/29/2023 11:12 PM] kuratius
got up to here


[4/29/2023 11:14 PM] kuratius
i think

{Attachments}
/mnt/data/projects/git/conversations/media/minicom-10-6A62D.cap


[4/29/2023 11:15 PM] kuratius
got shell


[4/29/2023 11:15 PM] kuratius
no bootloop


[4/29/2023 11:16 PM] kuratius
Welcome to postmarketOS                                                         
Kernel 6.1.12 on an armv7l (/dev/ttymxc0)                                       
kobo-nia login: dk-x86                                                          
Password:                                                                       
Welcome to postmarketOS! o/                                                     
                                                                                
This distribution is based on Alpine Linux.                                     
First time using postmarketOS? Make sure to read the cheatsheet in the wiki:    
                                                                                
-> https://postmarketos.org/cheatsheet                                          
                                                                                
You may change this message by editing /etc/motd.                               
kobo-nia:~$


[4/29/2023 11:16 PM] kuratius
should ssh work


[4/29/2023 11:16 PM] andi15701
yes


[4/29/2023 11:16 PM] kuratius
then I will do that


[4/29/2023 11:17 PM] kuratius
works


[4/29/2023 11:17 PM] kuratius
got ssh and no bootlooping


[4/29/2023 11:18 PM] kuratius
finally dont have to hold down serial cable 😄


[4/29/2023 11:18 PM] andi15701
you can explore /sys a bit


[4/29/2023 11:18 PM] andi15701
/sys/class/power_supply


[4/29/2023 11:18 PM] andi15701
which backlight works?


[4/29/2023 11:19 PM] andi15701
there are two in /sys/class/backlight


[4/29/2023 11:19 PM] kuratius
ls /sys/
block     class     devices   fs        module
bus       dev       firmware  kernel    power


[4/29/2023 11:19 PM] kuratius
kobo-nia:~$ ls /sys/class/
backlight     graphics      mem           regulator     usb_role
bdi           hwmon         misc          rfkill        vc
block         i2c-dev       mmc_host      rtc           video4linux
devlink       ieee80211     net           spi_master    vtconsole
dma           input         power_supply  tee           wakeup
drm           lcd           pps           thermal       watchdog
extcon        leds          ptp           tty
gpio          mdio_bus      pwm           udc


[4/29/2023 11:20 PM] kuratius
kobo-nia:~$ ls /sys/class/power_supply/
rn5t618-adp      rn5t618-battery  rn5t618-usb
kobo-nia:~$


[4/29/2023 11:20 PM] kuratius
power button led is blinking btw


[4/29/2023 11:20 PM] andi15701
ok, nice


[4/29/2023 11:20 PM] kuratius
screen backlight is off I think


[4/29/2023 11:21 PM] kuratius
are these files?


[4/29/2023 11:21 PM] andi15701
/sys/class/backlight/*/brightness


[4/29/2023 11:21 PM] andi15701
directories


[4/29/2023 11:21 PM] andi15701
do you have a wifi interface?


[4/29/2023 11:22 PM] kuratius
kobo-nia:/sys/class/power_supply$ cat /sys/class/backlight/*/brightness
0
0


[4/29/2023 11:23 PM] andi15701
write something to it


[4/29/2023 11:23 PM] kuratius
both?


[4/29/2023 11:23 PM] andi15701
yes


[4/29/2023 11:23 PM] andi15701
one should work


[4/29/2023 11:23 PM] andi15701
and one not


[4/29/2023 11:23 PM] kuratius
they're backlight_cold and backlight_warm


[4/29/2023 11:24 PM] kuratius
nia should only have cold


[4/29/2023 11:24 PM] kuratius
I'll try that one


[4/29/2023 11:25 PM] kuratius
kobo-nia:/sys/class/power_supply$ echo "1" >/sys/class/backlight/backlight_cold/
brightness 
-ash: can't create /sys/class/backlight/backlight_cold/brightness: Permission denied


[4/29/2023 11:25 PM] andi15701
sudo


[4/29/2023 11:25 PM] andi15701
and 255 is max


[4/29/2023 11:25 PM] andi15701
so something bigger


[4/29/2023 11:25 PM] andi15701
to see something


[4/29/2023 11:25 PM] kuratius
kobo-nia:/sys/class/power_supply$ sudo echo "1" >/sys/class/backlight/backlight_
cold/brightness 
-ash: can't create /sys/class/backlight/backlight_cold/brightness: Permission denied
kobo-nia:/sys/class/power_supply$


[4/29/2023 11:26 PM] andi15701
obvious


[4/29/2023 11:26 PM] andi15701
the redirect is opened before sudo is executed


[4/29/2023 11:26 PM] andi15701
so sudo sh


[4/29/2023 11:27 PM] andi15701
and then the write


[4/29/2023 11:27 PM] andi15701
or something like sudo sh -c "echo 128 >/sys/class/backlight/backlight_cold/brightness"


[4/29/2023 11:28 PM] kuratius
kobo-nia:/sys/class/power_supply$ sudo sh
/sys/class/power_supply # echo 128 >/sys/class/backlight/backlight_cold/bright
ness
/sys/class/power_supply #


[4/29/2023 11:28 PM] kuratius
does not light up


[4/29/2023 11:28 PM] kuratius
will try warm


[4/29/2023 11:29 PM] kuratius
lights up


[4/29/2023 11:30 PM] kuratius
/sys/class/power_supply # echo 244 >/sys/class/backlight/backlight_warm/bright
ness
/sys/class/power_supply #


[4/29/2023 11:30 PM] kuratius
this makes the screen light up


[4/29/2023 11:34 PM] andi15701
we do not really know that, full set of possibilities are:  a) u-boot is not compiled correctly b) pmbootstrap writes nonsense c) write gets interrupted and stays incomplete


[4/29/2023 11:35 PM] andi15701
do you have a dmesg from the kernel?


[4/29/2023 11:35 PM] kuratius
from my laptop or from the nia?


[4/29/2023 11:36 PM] andi15701
from the nia


[4/29/2023 11:36 PM] andi15701
But I think we have made progress


[4/29/2023 11:36 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-7D557.txt


[4/29/2023 11:38 PM] kuratius
I assume what's missing now is to check for issues, get screen output, get wifi working, get battery indicator working?


[4/29/2023 11:38 PM] kuratius
also what did you want me to check with wifi?


[4/29/2023 11:38 PM] andi15701
battery should work


[4/29/2023 11:39 PM] andi15701
wifi is for some reason not there


[4/29/2023 11:40 PM] kuratius
kobo-nia:~$ ls -R / | grep wifi
imx6ull-colibri-wifi-aster.dtb
imx6ull-colibri-wifi-eval-v3.dtb
imx6ull-colibri-wifi-iris-v2.dtb
imx6ull-colibri-wifi-iris.dtb
wifi-regulator
wifi_pwrseq
wifi_pwrseq
wifi-regulator
platform:20ac000.gpio--platform:wifi-regulator
platform:20ac000.gpio--platform:wifi_pwrseq
platform:wifi-regulator--platform:2190000.mmc
wifi-regulator
wifi_pwrseq
consumer:platform:wifi-regulator
consumer:platform:wifi_pwrseq
supplier:platform:wifi-regulator
/sys/devices/platform/wifi-regulator:
/sys/devices/platform/wifi-regulator/power:
/sys/devices/platform/wifi-regulator/regulator:
/sys/devices/platform/wifi-regulator/regulator/regulator.5:
/sys/devices/platform/wifi-regulator/regulator/regulator.5/power:
/sys/devices/platform/wifi_pwrseq:
/sys/devices/platform/wifi_pwrseq/power:
platform:20ac000.gpio--platform:wifi-regulator
platform:20ac000.gpio--platform:wifi_pwrseq
platform:wifi-regulator--platform:2190000.mmc
/sys/devices/virtual/devlink/platform:20ac000.gpio--platform:wifi-regulator:
/sys/devices/virtual/devlink/platform:20ac000.gpio--platform:wifi_pwrseq:
/sys/devices/virtual/devlink/platform:wifi-regulator--platform:2190000.mmc:
wifi-regulator
wifi_pwrseq
/sys/firmware/devicetree/base/wifi-regulator:
/sys/firmware/devicetree/base/wifi_pwrseq:
ls: can't open '/sys/kernel/debug': Permission denied
libnm-device-plugin-wifi.so
wifi
ls: can't open '/var/db/sudo': Permission denied
ls: can't open '/var/lib/NetworkManager': Permission denied
ls: can't open '/var/lib/nftables': Permission denied
kobo-nia:~$


[4/29/2023 11:40 PM] kuratius
(I removed some of the error messages))


[4/29/2023 11:42 PM] andi15701
@Szybet cat /sys/kernel/debug/gpio with wifi on and with wifi off?


[4/29/2023 11:42 PM] andi15701
on inkbox or nickel


[4/29/2023 11:42 PM] andi15701
maybe debugfs needs to be mounted


[4/29/2023 11:43 PM] kuratius
was it supposed to be in the dmesg?


[4/29/2023 11:43 PM] andi15701
just wanted to look for any signs of problems


[4/29/2023 11:44 PM] andi15701
yes, I also looked for signs of wifi detection


[4/29/2023 11:45 PM] andi15701
lets continue on maybe monday or tuesday


[4/29/2023 11:46 PM] kuratius
kobo-nia:~$ sudo ls /sys/kernel/debug/
[sudo] password for dk-x86: 
bdi                 dri                 lru_gen_full        ramdisk_pages
block               extfrag             memblock            regmap
clear_warn_once     fault_around_bytes  mmc0                regulator
clk                 gpio                mmc1                sleep_time
device_component    hid                 opp                 suspend_stats
devices_deferred    ieee80211           pinctrl             ulpi
dma_buf             iio                 pm_genpd            usb
dmaengine           lru_gen             pwm                 wakeup_sources
kobo-nia:~$


[4/29/2023 11:46 PM] andi15701
we need it on the original system or on inkbox or anything else where wifi is working


[4/29/2023 11:46 PM] kuratius
dmaengine           lru_gen             pwm                 wakeup_sources
kobo-nia:~$ sudo cat /sys/kernel/debug/gpio
gpiochip0: GPIOs 0-31, parent: platform/209c000.gpio, 209c000.gpio:

gpiochip1: GPIOs 32-63, parent: platform/20a0000.gpio, 20a0000.gpio:

gpiochip2: GPIOs 64-95, parent: platform/20a4000.gpio, 20a4000.gpio:
 gpio-91  (                    |enable              ) out hi 

gpiochip3: GPIOs 96-127, parent: platform/20a8000.gpio, 20a8000.gpio:

gpiochip4: GPIOs 128-159, parent: platform/20ac000.gpio, 20ac000.gpio:
 gpio-133 (                    |GLED                ) out lo ACTIVE LOW
 gpio-135 (                    |reset               ) out lo ACTIVE LOW
 gpio-136 (                    |wifi-regulator      ) out hi ACTIVE LOW
kobo-nia:~$


[4/29/2023 11:46 PM] kuratius
kk


[4/29/2023 11:47 PM] kuratius
should I boot to nickel and do that?


[4/29/2023 11:47 PM] andi15701
you can try


[4/29/2023 11:47 PM] kuratius
or do you want to do the rest monday?


[4/29/2023 11:47 PM] andi15701
yes, probably


[4/29/2023 11:47 PM] andi15701
i will stop for today


[4/29/2023 11:48 PM] kuratius
I will boot to nickel and copy the contents of gpio


[4/29/2023 11:48 PM] andi15701
with and without wifi


[4/29/2023 11:48 PM] kuratius
also how do I modify the image to boot correctly next time?


[4/29/2023 11:48 PM] kuratius
without using serial?


[4/29/2023 11:48 PM] andi15701
lets analyze it on monday


[4/29/2023 11:48 PM] andi15701
evening


[4/29/2023 11:49 PM] kuratius
you mean airplane mode(wifi off) vs connected to a network?


[4/29/2023 11:49 PM] andi15701
at least wifi on


[4/29/2023 11:50 PM] kuratius
do I need to put a script somewhere?


[4/29/2023 11:50 PM] kuratius
I'd like to avoid doing the manual commands


[4/29/2023 11:51 PM] kuratius
it failed loading the script in the beginning right?


[4/29/2023 11:51 PM] kuratius
(sorry if it's too many questions)


[4/29/2023 11:51 PM] andi15701
it does not like the contents


[4/29/2023 11:53 PM] kuratius
is it something I can fix quickly today? like, is there a specific file I can just edit?


[4/29/2023 11:54 PM] kuratius
kobo-nia:~$ ls /boot/
boot.scr              initramfs             uImage
dtbs                  initramfs-extra       uInitrd
imx6ull-kobo-nia.dtb  lost+found            vmlinuz


[4/29/2023 11:54 PM] kuratius
one of these?


[4/29/2023 11:54 PM] kuratius
kobo-nia:~$ cat /boot/boot.scr 
'V�j�dM���x�(postmarketOS�setenv bootargs console=ttymxc0,115200 debug

# This must be called first, otherwise bootz does not work correctly.
# The actual kernel is loaded over this below.
# not needed anymore for new u-boot
# load_ntxkernel

echo Loading kernel
load mmc 0:1 0x80800000 vmlinuz

echo Loading DTB
load mmc 0:1 0x83000000 imx6ull-kobo-nia.dtb

echo Loading initrd
load mmc 0:1 0x85000000 uInitrd

echo Booting kernel
bootz 0x80800000 0x85000000 0x83000000
kobo-nia:~$


[4/29/2023 11:55 PM] kuratius
can I just delete the gibberish?


[4/30/2023 12:01 AM] kuratius
it is not clear to me if the issue is with the contents or with the filename


[4/30/2023 12:02 AM] kuratius
but I guess I can try renaming it to something else and making a new file with contents that dont have the gibberish at the beginning


[4/30/2023 12:03 AM] andi15701
the gibberish bist be there


[4/30/2023 12:03 AM] andi15701
the gibberish must be there


[4/30/2023 12:03 AM] kuratius
oh


[4/30/2023 12:04 AM] andi15701
mkimage -A arm -O linux -T script -n postmarketOS \
        -d "$srcdir/uboot-script.cmd" "$srcdir/boot.scr"


[4/30/2023 12:04 AM] andi15701
cat .local/var/pmbootstrap/cache_git/pmaports/device/testing/device-kobo-nia/APKBUILD


[4/30/2023 12:05 AM] kuratius
on my laptop?


[4/30/2023 12:05 AM] andi15701
yes


[4/30/2023 12:06 AM] andi15701
that line is executed there


[4/30/2023 12:07 AM] andi15701
in the package section of that file


[4/30/2023 12:07 AM] andi15701
to add the gibberish


[4/30/2023 12:07 AM] kuratius
I thought for a second you were asking me to execute it


[4/30/2023 12:08 AM] kuratius
do you think that line is failing somehow?


[4/30/2023 12:08 AM] kuratius
or not doing the right thing?


[4/30/2023 12:09 AM] andi15701
md5sum .local/var/pmbootstrap/chroot_rootfs_kobo-nia/boot/boot.scr 
8de827ee7c5728b07cac345d15d44c72  .local/var/pmbootstrap/chroot_rootfs_kobo-nia/boot/boot.scr


[4/30/2023 12:09 AM] andi15701
the same for you?


[4/30/2023 12:10 AM] kuratius
59e454792947d5bcf4540715e8468ce7  .local/var/pmbootstrap/chroot_rootfs_kobo-nia/boot/boot.scr


[4/30/2023 12:10 AM] kuratius
dk@dk-ThinkPad-E560:~$ md5sum .local/var/pmbootstrap/chroot_rootfs_kobo-nia/boot/boot.scr 
59e454792947d5bcf4540715e8468ce7  .local/var/pmbootstrap/chroot_rootfs_kobo-nia/boot/boot.scr
dk@dk-ThinkPad-E560:~$


[4/30/2023 12:12 AM] andi15701


{Attachments}
/mnt/data/projects/git/conversations/media/boot-B46EF.scr


[4/30/2023 12:12 AM] kuratius
can I just copy that with scp to the nia?


[4/30/2023 12:12 AM] andi15701
yes


[4/30/2023 12:12 AM] andi15701
to /boot


[4/30/2023 12:14 AM] kuratius
```scp boot.scr dk-x86@172.16.42.1:/boot/.```


[4/30/2023 12:14 AM] kuratius
like this?


[4/30/2023 12:15 AM] andi15701
maybe to tmp first and then copy with sudo


[4/30/2023 12:15 AM] andi15701
on the nia


[4/30/2023 12:16 AM] kuratius
done


[4/30/2023 12:17 AM] kuratius
kobo-nia:~$ md5sum /boot/boot.scr 
8de827ee7c5728b07cac345d15d44c72  /boot/boot.scr
kobo-nia:~$


[4/30/2023 12:17 AM] kuratius
reboot?


[4/30/2023 12:18 AM] kuratius
will connect serial again then reboot


[4/30/2023 12:19 AM] kuratius
reboot: Restarting system                                                       
                                                                                
                                                                                
U-Boot 2020.10-00026-ge45fdb097f (Apr 27 2023 - 22:15:30 +0200)                 
                                                                                
CPU:   Freescale i.MX6ULL rev1.1 900 MHz (running at 396 MHz)                   
CPU:   Commercial temperature grade (0C to 95C) at 38C                          
Reset cause: POR                                                                
Model: Kobo Nia                                                                 
Board: MX6ULL Kobo Nia                                                          
DRAM:  256 MiB                                                                  
MMC:   FSL_SDHC: 1, FSL_SDHC: 0                                                 
Loading Environment from MMC... OK                                              
In:    serial                                                                   
Out:   serial                                                                   
Err:   serial                                                                   
Normal Boot                                                                     
Hit any key to stop autoboot:  0                                                
517 bytes read in 10 ms (49.8 KiB/s)                                            
## Executing script at 82000000                                                 
Wrong image format for "source" command                                         
=>


[4/30/2023 12:19 AM] kuratius
nope


[4/30/2023 12:21 AM] kuratius
I'll turn it off and boot nickel


[4/30/2023 12:21 AM] kuratius
prob can solve this later


[4/30/2023 12:33 AM] kuratius
[root@kobo ~]# ls /sys/kernel/debug                                             
-sh: l: not found                                                               
[root@kobo ~]# å00TA) (gcc version 5.3.0 (GCC) ) #28 SMP PREEMPT Fri Sep 16 10:2
                                                                                
CPU: ARMv7 Processor [410fc075] revision 5 (ARMv7), cr=10c53c7d                 
CPU: PIPT / VIPT nonaliasing data cache, VIPT aliasing instruction cache        
Machine model: Freescale i.MX6 ULL DDR3 NTX Board                               
Memory policy: Data cache writealloc                                            
                                                                                
On node 0 totalpages: 6&j


[4/30/2023 12:34 AM] kuratius
lol I think something crashed


[4/30/2023 12:38 AM] kuratius
prob need an ssh shell, my serial port is unreliable and it's not getting better


[4/30/2023 11:01 AM] szybet
Ok, one sec or more


[4/30/2023 11:02 AM] szybet
in the meantime you can answer my curious questions:

what is stopping me from using Aura screen on the Nia ( pinout is the same, size too, only resolution )

+ is the aura refresh something problem in the eink or in software?


[4/30/2023 11:21 AM] szybet
wifi:
```
kobo:~# cat /sys/kernel/debug/gpio 
GPIOs 0-31, platform/209c000.gpio, 209c000.gpio:
 gpio-6   (gpio_elan_rst       ) out lo    
 gpio-7   (gpio_elan_intr      ) in  hi    
 gpio-13  (epdc-pwrstat        ) in  lo    

GPIOs 32-63, platform/20a0000.gpio, 20a0000.gpio:

GPIOs 64-95, platform/20a4000.gpio, 20a4000.gpio:
 gpio-78  (epdc-pmic-pwrall    ) out hi    
 gpio-88  (epdc-vcom           ) out lo    
 gpio-89  (epdc-powerup        ) out lo    
 gpio-91  (lm3630a_bl_hwen     ) out lo    

GPIOs 96-127, platform/20a8000.gpio, 20a8000.gpio:

GPIOs 128-159, platform/20ac000.gpio, 20ac000.gpio:
 gpio-128 (ricoh619_chg        ) in  hi    
 gpio-129 (ricoh619_pmic_irq   ) in  hi    
 gpio-130 (Hall                ) in  hi    
 gpio-131 (ricoh619_bat_low    ) in  hi    
 gpio-132 (Power               ) in  hi    
 gpio-133 (?                   ) out lo    
 gpio-134 (wifiint             ) in  hi    
 gpio-135 (wifirst             ) out lo    
 gpio-136 (wifipwr             ) out lo    
kobo:~# 

```


[4/30/2023 11:36 AM] szybet
turned off:
```
GPIOs 0-31, platform/209c000.gpio, 209c000.gpio:
 gpio-6   (gpio_elan_rst       ) out lo    
 gpio-7   (gpio_elan_intr      ) in  hi    
 gpio-13  (epdc-pwrstat        ) in  lo    

GPIOs 32-63, platform/20a0000.gpio, 20a0000.gpio:

GPIOs 64-95, platform/20a4000.gpio, 20a4000.gpio:
 gpio-78  (epdc-pmic-pwrall    ) out hi    
 gpio-88  (epdc-vcom           ) out lo    
 gpio-89  (epdc-powerup        ) out lo    
 gpio-91  (lm3630a_bl_hwen     ) out lo    

GPIOs 96-127, platform/20a8000.gpio, 20a8000.gpio:

GPIOs 128-159, platform/20ac000.gpio, 20ac000.gpio:
 gpio-128 (ricoh619_chg        ) in  hi    
 gpio-129 (ricoh619_pmic_irq   ) in  hi    
 gpio-130 (Hall                ) in  hi    
 gpio-131 (ricoh619_bat_low    ) in  hi    
 gpio-132 (Power               ) in  hi    
 gpio-133 (?                   ) out lo    
 gpio-134 (wifiint             ) in  lo    
 gpio-135 (wifirst             ) out lo    
 gpio-136 (wifipwr             ) out lo 
```


[5/1/2023 8:05 PM] andi15701
well, the timings are in software


[5/1/2023 8:07 PM] andi15701
so we have at least: setting vcom, fp9928 vs sy7636, display parameters


[5/1/2023 8:07 PM] andi15701
so crafting a special hwconfig


[5/1/2023 8:24 PM] andi15701
wifi turned off= that strange sdio_wifi_pwr module removed?


[5/1/2023 8:25 PM] szybet
yep


[5/1/2023 8:25 PM] szybet
well look into ipd


[5/1/2023 8:25 PM] szybet
everyuthing is there


[5/1/2023 8:26 PM] andi15701
gpio-136 (wifipwr             ) out lo: I would expect that to change


[5/1/2023 8:26 PM] szybet
um well yea


[5/1/2023 10:21 PM] andi15701
ok, u-boot looks for the script at the wrong address


[5/1/2023 10:21 PM] andi15701
you can do a git pull in the pmaports


[5/1/2023 10:21 PM] andi15701
force-rebuild kernel ad u-boot


[5/1/2023 10:21 PM] andi15701
and pmbootstrap status and instal --sdcad /dev/sdX


[5/1/2023 10:22 PM] andi15701
maybe you still need to copy the newer u-boot


[5/1/2023 10:29 PM] kuratius
pmbootstrap build linux-kobo-clara-mainline --force
[22:27:35] Update package index for x86_64 (4 file(s))
[22:27:40] (native) install alpine-base
[22:27:41] (native) install abuild build-base ccache git
[22:27:44] (native) install bash bc bison devicepkg-dev findutils flex gmp-dev lzop mpc1-dev mpfr-dev openssl-dev perl
[22:27:45] (native) install ccache-cross-symlinks gcc-armv7 g++-armv7
[22:27:47] (native) build armv7/linux-kobo-clara-mainline-6.1.12-r4.apk
[22:27:48] NOTE: The failed command's output is above the ^^^ line in the log file: /home/dk/.local/var/pmbootstrap/log.txt
[22:27:48] ERROR: Command failed (exit code 1): (native) % cd /home/pmos/build; busybox su pmos -c CARCH=armv7 SUDO_APK='abuild-apk --no-progress' CROSS_COMPILE=armv7-alpine-linux-musleabihf- CC=armv7-alpine-linux-musleabihf-gcc GOCACHE=/home/pmos/.cache/go-build HOME=/home/pmos abuild -D postmarketOS -d -f
[22:27:48] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.


[5/1/2023 10:31 PM] kuratius
this may have happened on Saturday too, I may have forgotten to read the error message


[5/1/2023 10:32 PM] andi15701
oops


[5/1/2023 10:32 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/log-7A971.txt


[5/1/2023 10:32 PM] andi15701
forgotten the checksum


[5/1/2023 10:32 PM] kuratius
how did the install command succeed if the kernel wasnt built and I zapped the previous files?


[5/1/2023 10:35 PM] andi15701
hmm, maybe you did not zap completely


[5/1/2023 10:35 PM] kuratius
could be


[5/1/2023 10:36 PM] kuratius
anyway lmk when I should pull again


[5/1/2023 10:36 PM] andi15701
do a git pull again


[5/1/2023 10:36 PM] kuratius
k


[5/1/2023 10:51 PM] andi15701
so does ipd what it should do?


[5/1/2023 10:52 PM] szybet
i meant i would also expect it to


[5/1/2023 10:52 PM] szybet
https://github.com/Kobo-InkBox/inkbox-power-daemon/blob/2a6d06657bde58950b87c03b449ce1c85e5153b8/src/wifi.cpp#L28

{Embed}
https://github.com/Kobo-InkBox/inkbox-power-daemon/blob/2a6d06657bde58950b87c03b449ce1c85e5153b8/src/wifi.cpp
inkbox-power-daemon/wifi.cpp at 2a6d06657bde58950b87c03b449ce1c85e5...
InkBox Power Daemon (IPD) source code. Contribute to Kobo-InkBox/inkbox-power-daemon development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/inkbox-power-daemon-C2D7A


[5/1/2023 10:52 PM] szybet
thats all


[5/1/2023 10:55 PM] andi15701
we might need this again


[5/1/2023 10:56 PM] andi15701
improved should be: one backlight anymore


[5/1/2023 10:56 PM] andi15701
and looking for boot.scr contents at the right address


[5/1/2023 10:56 PM] andi15701
so no serial needed for booting


[5/1/2023 10:57 PM] kuratius
nice


[5/1/2023 10:57 PM] andi15701
but I have not touched the epd stuff


[5/1/2023 10:58 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-74305.png


[5/1/2023 10:58 PM] kuratius
this is the error I get when trying to eject the sd card


[5/1/2023 10:58 PM] kuratius
remains even if I do pmbootstrap shutdown


[5/1/2023 11:00 PM] kuratius
unmounting/mounting the partitions works, but ejecting the sd card doesnt


[5/1/2023 11:05 PM] kuratius
got ssh


[5/1/2023 11:10 PM] kuratius
(I did this again, I did not check if it worked without)


[5/1/2023 11:10 PM] kuratius
what did you do differently to get a working uboot btw?


[5/1/2023 11:11 PM] kuratius
compared to the other imx files you had me try


[5/1/2023 11:12 PM] andi15701
the new u-boot is just a near mainline one of 2020.10 which is already in use for several other Kobos/Tolinos in pmOS


[5/1/2023 11:13 PM] kuratius
and the other ones were?


[5/1/2023 11:13 PM] andi15701
and I added the ram config for the nia


[5/1/2023 11:14 PM] andi15701
the kobo vendor u-boot


[5/1/2023 11:14 PM] kuratius
those arent supposed to be broken right?


[5/1/2023 11:14 PM] kuratius
the fuck are they doing


[5/1/2023 11:15 PM] kuratius
is it known if those have special tweaks to make them work compared to the vendor one?


[5/1/2023 11:16 PM] andi15701
I did them just because of too many surprises with the vendor u-boot


[5/1/2023 11:17 PM] andi15701
I will investigate rebuilding things for the other devices


[5/1/2023 11:17 PM] andi15701
perhaps the newer gcc does not like the older u-boots


[5/1/2023 11:18 PM] andi15701
now everyone just gets binary packages


[5/1/2023 11:18 PM] andi15701
if one installs for the other devices


[5/1/2023 11:18 PM] andi15701
so it does not get rebuild


[5/1/2023 11:19 PM] andi15701
I will play around with it more the next days


[5/1/2023 11:19 PM] kuratius
kk
anything I should do with ssh now?


[5/1/2023 11:19 PM] andi15701
check backlight again


[5/1/2023 11:20 PM] andi15701
cat /sys/class/power_supply/*/uevent


[5/1/2023 11:21 PM] kuratius
[sudo] password for dk-x86: 
/home/dk-x86 # echo "244" >/sys/class/backlight/backlight/brightness 
/home/dk-x86 #


[5/1/2023 11:21 PM] kuratius
works


[5/1/2023 11:21 PM] kuratius
backlight is lit


[5/1/2023 11:21 PM] kuratius
/home/dk-x86 # cat /sys/class/power_supply/*/uevent
POWER_SUPPLY_NAME=rn5t618-adp
POWER_SUPPLY_TYPE=Mains
POWER_SUPPLY_INPUT_CURRENT_LIMIT=700000
POWER_SUPPLY_VOLTAGE_NOW=1157509
POWER_SUPPLY_STATUS=Not charging
POWER_SUPPLY_ONLINE=0
POWER_SUPPLY_NAME=rn5t618-battery
POWER_SUPPLY_TYPE=Battery
POWER_SUPPLY_STATUS=Full
POWER_SUPPLY_PRESENT=1
POWER_SUPPLY_VOLTAGE_NOW=4141000
POWER_SUPPLY_CURRENT_NOW=-2000
POWER_SUPPLY_CAPACITY=100
POWER_SUPPLY_TEMP=277
POWER_SUPPLY_TIME_TO_EMPTY_NOW=1614600
POWER_SUPPLY_TECHNOLOGY=Li-ion
POWER_SUPPLY_CHARGE_CONTROL_LIMIT=500000
POWER_SUPPLY_CHARGE_FULL=898000
POWER_SUPPLY_CHARGE_NOW=897000
POWER_SUPPLY_NAME=rn5t618-usb
POWER_SUPPLY_TYPE=USB
POWER_SUPPLY_INPUT_CURRENT_LIMIT=500000
POWER_SUPPLY_VOLTAGE_NOW=5054945
POWER_SUPPLY_STATUS=Not charging
POWER_SUPPLY_USB_TYPE=[SDP] DCP CDP Unknown
POWER_SUPPLY_ONLINE=1
/home/dk-x86 #


[5/1/2023 11:23 PM] andi15701
ok, shows basically sane things


[5/2/2023 12:09 AM] kuratius
is there a shutdown command?


[5/2/2023 12:10 AM] kuratius
shutdown doesnt work


[5/2/2023 12:10 AM] kuratius
as in sudo shutdown now


[5/2/2023 12:11 AM] kuratius
I'll try poweroff


[5/2/2023 12:11 AM] kuratius
works


[5/2/2023 10:02 PM] kuratius
@andi How is the screen on a kobo connected?


[5/2/2023 10:02 PM] kuratius
gpio?


[5/2/2023 10:03 PM] kuratius
or a generic display port?


[5/2/2023 10:03 PM] kuratius
the ribbon cable kind of looks like the camera port on rpi


[5/2/2023 10:03 PM] andi15701
there is a special port for the epd


[5/2/2023 10:05 PM] andi15701
see pinctrl_epdc0 in the kernel used by pmOS


[5/2/2023 10:05 PM] andi15701
or the 4.1.15 vendor kernel


[5/2/2023 10:42 PM] kuratius
is there a file or directory with that name? I tried ls -R / grep pincrtl_epdc0 but didnt find anything.
I also tried searching in the pmaports repo, but didnt find it (also search on gitlab is not working right now)


[5/2/2023 10:43 PM] andi15701
MX6SLL_PAD_EPDC_DATA00__EPDC_DATA00     0x4100b1
                        MX6SLL_PAD_EPDC_DATA01__EPDC_DATA01     0x4100b1
                        MX6SLL_PAD_EPDC_DATA02__EPDC_DATA02     0x4100b1
                        MX6SLL_PAD_EPDC_DATA03__EPDC_DATA03     0x4100b1
                        MX6SLL_PAD_EPDC_DATA04__EPDC_DATA04     0x4100b1
                        MX6SLL_PAD_EPDC_DATA05__EPDC_DATA05     0x4100b1
                        MX6SLL_PAD_EPDC_DATA06__EPDC_DATA06     0x4100b1
                        MX6SLL_PAD_EPDC_DATA07__EPDC_DATA07     0x4100b1
                        MX6SLL_PAD_EPDC_DATA08__EPDC_DATA08     0x4100b1
                        MX6SLL_PAD_EPDC_DATA09__EPDC_DATA09     0x4100b1
                        MX6SLL_PAD_EPDC_DATA10__EPDC_DATA10     0x4100b1
                        MX6SLL_PAD_EPDC_DATA11__EPDC_DATA11     0x4100b1
                        MX6SLL_PAD_EPDC_DATA12__EPDC_DATA12     0x4100b1
                        MX6SLL_PAD_EPDC_DATA13__EPDC_DATA13     0x4100b1
                        MX6SLL_PAD_EPDC_DATA14__EPDC_DATA14     0x4100b1
                        MX6SLL_PAD_EPDC_DATA15__EPDC_DATA15     0x4100b1
                        MX6SLL_PAD_EPDC_SDCLK__EPDC_SDCLK_P     0x4100b1
                        MX6SLL_PAD_EPDC_SDLE__EPDC_SDLE  0x4100b1
                        MX6SLL_PAD_EPDC_SDOE__EPDC_SDOE  0x4100b1
                        MX6SLL_PAD_EPDC_SDSHR__EPDC_SDSHR       0x4100b1
                        MX6SLL_PAD_EPDC_SDCE0__EPDC_SDCE0       0x4100b1
                        MX6SLL_PAD_EPDC_GDCLK__EPDC_GDCLK       0x4100b1
                        MX6SLL_PAD_EPDC_GDOE__EPDC_GDOE  0x4100b1
                        MX6SLL_PAD_EPDC_GDRL__EPDC_GDRL  0x4100b1
                        MX6SLL_PAD_EPDC_GDSP__EPDC_GDSP  0x4100b1


[5/2/2023 10:43 PM] andi15701
e.g. in arch/arm/boot/dts/imx6sll-kobo-clarahd.dts


[5/2/2023 10:47 PM] kuratius
are these memory addresses for display communication?


[5/2/2023 10:47 PM] kuratius
wait no cant be


[5/2/2023 10:47 PM] kuratius
they're all the same


[5/2/2023 10:48 PM] andi15701
that are the pins required


[5/2/2023 10:48 PM] andi15701
and the pin configuration


[5/2/2023 10:49 PM] kuratius
0x4100b1 is this an address or a value?


[5/2/2023 10:50 PM] andi15701
a value


[5/2/2023 10:50 PM] kuratius
why does the pinname appear twice?


[5/2/2023 10:51 PM] andi15701
the is a double underscore between them


[5/2/2023 10:51 PM] andi15701
but you do two things here


[5/2/2023 10:51 PM] andi15701
defining the function of the pin


[5/2/2023 10:52 PM] andi15701
each pin has as a name the default function


[5/2/2023 10:52 PM] andi15701
so padname__function pad_configuration


[5/2/2023 10:52 PM] andi15701
basically


[5/2/2023 10:54 PM] andi15701
if you look in the reference manual: there is IOMUXC_SW_PAD_CTL_*


[5/2/2023 10:54 PM] andi15701
for each pad


[5/2/2023 10:54 PM] andi15701
and the value is written to that register


[5/2/2023 10:58 PM] kuratius
does the underlining of some of them have special meaning?
or is it an artifact from copying?
Where is that manual?
Are the padnames translated to an address or register with a C macro?
https://mcuxpresso.nxp.com/api_doc/dev/1315/group__iomuxc__driver.html

this has a lot of defines


[5/2/2023 10:59 PM] kuratius
sorry if it's a lot of questions


[5/2/2023 11:00 PM] andi15701
we have e.g. arch/arm/boot/dts/imx6sll-pinfunc.h


[5/2/2023 11:00 PM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/image-4D1BD.png


[5/2/2023 11:01 PM] andi15701
/*
 * The pin function ID is a tuple of
 * <mux_reg conf_reg input_reg mux_mode input_val>
 */


[5/2/2023 11:02 PM] andi15701
#define MX6SLL_PAD_REF_CLK_24M__GPIO3_IO21                        0x0018 0x02E0 0x0000 0x5 0x0


[5/2/2023 11:04 PM] andi15701
which is then read out of the dt by


[5/2/2023 11:04 PM] andi15701
drivers/pinctrl/freescale/pinctrl-imx.c


[5/2/2023 11:06 PM] andi15701
so here 0x5 (pinfunction = gpio) is written to a register with offset 0x18


[5/2/2023 11:07 PM] andi15701
and the 6th value in the dts would be written to a register with offset 0x2E0


[5/2/2023 11:13 PM] andi15701
you usually do not need every function, so to not waste space, processor vendors usually allow you to select one, so the pads are not wasted


[5/2/2023 11:15 PM] kuratius
so the display communication is via gpio?


[5/2/2023 11:15 PM] kuratius
is a gpio contact = pad here?


[5/2/2023 11:15 PM] kuratius
or am I confusing things?


[5/2/2023 11:16 PM] kuratius
(got my laptop now to look at the files you mentioned)


[5/2/2023 11:16 PM] andi15701
that gpio thing was just an example


[5/2/2023 11:16 PM] andi15701
pad = physycal contact of a smd component


[5/2/2023 11:17 PM] kuratius
smd?
where was this? somewhere in .local?


[5/2/2023 11:17 PM] andi15701
surface mounted device


[5/2/2023 11:28 PM] kuratius
arch/arm/boot/dts/imx6sll-pinfunc.h
should this be on my laptop after building the kernel?


[5/2/2023 11:28 PM] kuratius
if so, is it in .local somewhere?


[5/2/2023 11:30 PM] andi15701
in any unpacked kernel


[5/2/2023 11:30 PM] andi15701
we  have first tried on the raspi


[5/2/2023 11:30 PM] andi15701
without pmOS


[5/2/2023 11:31 PM] kuratius
I'll check, I may have deleted that one


[5/2/2023 11:31 PM] kuratius
https://github.com/akemnade/linux this repo?

{Embed}
https://github.com/akemnade/linux
GitHub - akemnade/linux: Linux kernel source tree
Linux kernel source tree. Contribute to akemnade/linux development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/linux-F5851


[5/2/2023 11:31 PM] andi15701
yes


[5/2/2023 11:32 PM] kuratius
ty


[5/5/2023 12:28 PM] andi15701
some updates: I found probably the original problem with u-boot compiling: I was a  bit blind about choosing the right defconfig for 256MB RAM. I copied and modified the clara vendor u-boot package in pmOS and cross-checked with the niAudio documentation, but I was too used to having 512 in the defconfig name, so I completely missed that difference despite of looking multiple times t it


[5/5/2023 12:28 PM] andi15701
but we have now the 2020.10 u-boot


[5/5/2023 12:30 PM] andi15701
I added some experimental epdc stuff to the nia kernel branch


[5/5/2023 12:30 PM] andi15701
mabe it works


[5/5/2023 12:30 PM] andi15701
so time for a git pull again


[5/5/2023 4:02 PM] kuratius
does this mean we no longer need to replace uboot after install? Or that we can use a more recent uboot than 2020?
I think the original uboot was something from 2016. but I dont remember if we compiled that or a more recent one


[5/5/2023 4:02 PM] kuratius
will do when I'm home


[5/5/2023 5:02 PM] andi15701
original u-boot was a heavily modified 2016.03 u-boot, pmbootstrap compiled it in a wrong way, so it did not work


[5/5/2023 5:03 PM] andi15701
then I modified the 2020.10 u-boot which is used in most ebook readers in pmOS


[5/5/2023 5:04 PM] andi15701
to also support the nia


[5/5/2023 5:04 PM] andi15701
the resulting binary is the one you tested


[5/5/2023 5:04 PM] andi15701
with uuu


[5/5/2023 5:04 PM] andi15701
and also pmbootstrap should now install such an u-boot


[5/5/2023 5:05 PM] andi15701
maybe you need also to force-rebuild u-boot-kobo-nia


[5/5/2023 5:56 PM] kuratius
New password: 
              Retype new password: 
                                   passwd: password updated successfully
                                                                        [17:55:23] NOTE: No valid keymap specified for device
[17:55:31] NOTE: The failed command's output is above the ^^^ line in the log file: /home/dk/.local/var/pmbootstrap/log.txt
[17:55:31] ERROR: Command failed (exit code 1): (rootfs_kobo-nia) % sed -i s/LANG=C.UTF-8/LANG=en_GB.UTF-8/ /etc/profile.d/locale.sh
[17:55:31] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.


[5/5/2023 5:56 PM] kuratius
from the install command


[5/5/2023 5:57 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-1EEFC.txt


[5/5/2023 5:58 PM] andi15701
(065235) [17:55:31] (rootfs_kobo-nia) % sed -i s/LANG=C.UTF-8/LANG=en_GB.UTF-8/ /etc/profile.d/locale.sh
sed: /etc/profile.d/locale.sh: No such file or directory


[5/5/2023 5:58 PM] andi15701
looks somehow unrelated


[5/5/2023 5:58 PM] andi15701
to my changes


[5/5/2023 5:59 PM] kuratius
one sec


[5/5/2023 5:59 PM] kuratius
I'll rebuild the koboa nia uboot and the kernel and then do another install


[5/5/2023 5:59 PM] kuratius
pmbootstrap build u-boot-kobo-nia --force


[5/5/2023 5:59 PM] kuratius
and post the logs


[5/5/2023 6:08 PM] kuratius
dk@dk-ThinkPad-E560:~$ pmbootstrap build u-boot-kobo-nia --force
[sudo] password for dk: 
[17:58:54] (buildroot_armv7) install alpine-base
[17:58:57] (buildroot_armv7) install abuild build-base ccache git
[17:59:07] (buildroot_armv7) install bc bison dtc flex
[17:59:12] WARNING: package musl-armv7: aport version 1.2.3_git20230411-r0 is lower than 1.2.4-r0 from the binary repository. 1.2.4-r0 will be used when installing musl-armv7. See also: <https://postmarketos.org/warning-repo2>
[17:59:12] (native) install ccache-cross-symlinks gcc-armv7 g++-armv7 crossdirect
[17:59:13] (buildroot_armv7) build armv7/u-boot-kobo-nia-2020.10-r1.apk
[18:01:01] NOTE: chroot is still active (use 'pmbootstrap shutdown' as necessary)
[18:01:01] DONE!
dk@dk-ThinkPad-E560:~$ pmbootstrap build linux-kobo-clara-mainline --force
[18:02:19] (native) install bash bc bison devicepkg-dev findutils flex gmp-dev lzop mpc1-dev mpfr-dev openssl-dev perl
[18:02:20] WARNING: package musl-armv7: aport version 1.2.3_git20230411-r0 is lower than 1.2.4-r0 from the binary repository. 1.2.4-r0 will be used when installing musl-armv7. See also: <https://postmarketos.org/warning-repo2>
[18:02:20] (native) install ccache-cross-symlinks gcc-armv7 g++-armv7
[18:02:20] (native) build armv7/linux-kobo-clara-mainline-6.1.12-r5.apk
[18:08:25] NOTE: chroot is still active (use 'pmbootstrap shutdown' as necessary)
[18:08:25] DONE!


[5/5/2023 6:09 PM] kuratius
pmbootstrap install --sdcard /dev/mmcblk0
[18:09:16] *** (1/4) PREPARE NATIVE CHROOT ***
[18:09:19] (native) install cryptsetup util-linux parted
[18:09:20] *** (2/4) CREATE DEVICE ROOTFS ("kobo-nia") ***
[18:09:22] WARNING: package postmarketos-initramfs: aport version 1.0.2-r0 is lower than 1.1.0-r0 from the binary repository. 1.1.0-r0 will be used when installing postmarketos-initramfs. See also: <https://postmarketos.org/warning-repo2>
[18:09:22] WARNING: package postmarketos-base-ui: aport version 7-r0 is lower than 8-r0 from the binary repository. 8-r0 will be used when installing postmarketos-base-ui. See also: <https://postmarketos.org/warning-repo2>
[18:09:22] WARNING: package postmarketos-base-ui: aport version 7-r0 is lower than 8-r0 from the binary repository. 8-r0 will be used when installing postmarketos-base-ui. See also: <https://postmarketos.org/warning-repo2>
[18:09:22] WARNING: package boot-deploy: aport version 0.7-r1 is lower than 0.8.1-r0 from the binary repository. 0.8.1-r0 will be used when installing boot-deploy. See also: <https://postmarketos.org/warning-repo2>
[18:09:22] (rootfs_kobo-nia) install postmarketos-base device-kobo-nia postmarketos-ui-console lang musl-locales postmarketos-base-nofde


[5/5/2023 6:09 PM] kuratius
(not done yet)


[5/5/2023 6:10 PM] kuratius
[18:09:46] (rootfs_kobo-nia) install device-kobo-nia


[5/5/2023 6:10 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-FA459.txt


[5/5/2023 6:11 PM] kuratius
should I try to roll back to the previous commit?


[5/5/2023 7:33 PM] andi15701
well,


[5/5/2023 7:33 PM] andi15701
commit 0650f9f60dcc293191105c1a64daf39f515610ab
Author: Pablo Correa Gómez <ablocorrea@hotmail.com>
Date:   Wed May 3 23:54:20 2023 +0200

    main/alpine-baselayout: do not unconditionally set locale variables
    
    So that we avoid overriding them if they already exist.
    
    Fixes #14862


[5/5/2023 7:33 PM] andi15701
diff --git a/main/alpine-baselayout/locale.sh b/main/alpine-baselayout/locale.sh
deleted file mode 100644
index bf75c082729..00000000000
--- a/main/alpine-baselayout/locale.sh
+++ /dev/null
@@ -1,3 +0,0 @@
-export CHARSET=UTF-8
-export LANG=C.UTF-8
-export LC_COLLATE=C


[5/5/2023 7:33 PM] andi15701
just wait a bit


[5/5/2023 7:34 PM] andi15701
will probably resolve by itself soon


[5/5/2023 7:35 PM] andi15701
somebody played around in alpine (aports repo)


[5/5/2023 7:35 PM] andi15701
and pmbootstrap is not synced yet


[5/5/2023 7:55 PM] andi15701
so the file locale.sh was part of package alpine-baselayout


[5/5/2023 7:55 PM] andi15701
but that was renamed


[5/5/2023 7:58 PM] andi15701
or fix it in paths like


[5/5/2023 7:58 PM] andi15701
.local/lib/python3.9/site-packages/pmbootstrap-1.50.1-py3.9.egg/pmb/install/_install.py


[5/5/2023 7:58 PM] andi15701
20locale.sh


[5/5/2023 8:44 PM] kuratius
that doesnt exist for me


[5/5/2023 8:46 PM] kuratius
dk@dk-ThinkPad-E560:~/.local/lib$ ls
python3.10


[5/5/2023 8:46 PM] kuratius
dk@dk-ThinkPad-E560:~/.local/lib/python3.10/site-packages$ ls
fitz                                 PIL
htmlmin                              Pillow-9.4.0.dist-info
htmlmin-0.1.12.dist-info             Pillow.libs
imageio                              proglog
imageio-2.22.4.dist-info             proglog-0.1.10.dist-info
imageio_ffmpeg                       PyMuPDF-1.21.1.dist-info
imageio_ffmpeg-0.4.7.dist-info       PyPDF2
japanize_matplotlib                  pypdf2-2.12.1.dist-info
japanize_matplotlib-1.1.3.dist-info  PySimpleGUI
jax                                  PySimpleGUI-4.60.4.dist-info
jax-0.4.3.dist-info                  tqdm
opt_einsum                           tqdm-4.64.1.dist-info
opt_einsum-3.3.0.dist-info           yt_dlp
pdfCropMargins                       yt_dlp-2023.3.4.dist-info
pdfCropMargins-1.1.11.dist-info


[5/5/2023 9:04 PM] andi15701
well, so pmbootstrap is globally installed?


[5/5/2023 9:04 PM] andi15701
then in /usr/local/lib/python....


[5/5/2023 9:07 PM] kuratius
dk@dk-ThinkPad-E560:~$ which pmbootstrap 
/home/dk/.local/bin/pmbootstrap


[5/5/2023 9:08 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-3F384.png


[5/5/2023 9:10 PM] kuratius
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap$ ls
apk.static           cache_go                images_netboot
cache_apk_armv7      cache_http              log.txt
cache_apk_x86_64     cache_rust              packages
cache_appstream      chroot_buildroot_armv7  tmp
cache_ccache_armv7   chroot_native           version
cache_ccache_x86_64  chroot_rootfs_kobo-nia  workdir.cfg
cache_distfiles      config_abuild
cache_git            config_apk_keys


[5/5/2023 9:10 PM] kuratius
nope


[5/5/2023 9:11 PM] kuratius
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap$ ls /usr/local/lib/python3.10/
dist-packages


[5/5/2023 9:11 PM] kuratius
dist-packages
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap$ ls /usr/local/lib/python3.10/dist-packages/
imageio                         patsy
imageio-2.22.4.dist-info        patsy-0.5.3.dist-info
imageio_ffmpeg                  proglog
imageio_ffmpeg-0.4.7.dist-info  proglog-0.1.10.dist-info
moviepy                         tqdm
moviepy-1.0.3.dist-info         tqdm-4.64.1.dist-info
mutagen                         websockets
mutagen-1.46.0.dist-info        websockets-10.3.dist-info
pandas                          yt_dlp
pandas-1.5.2.dist-info          yt_dlp-2022.11.11.dist-info


[5/5/2023 9:12 PM] kuratius
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap$ ls /usr/local/lib/
libfinal.a  libfinal.la  libfinal.so  libfinal.so.0  libfinal.so.0.8.1  pkgconfig  python3.10  R


[5/5/2023 9:13 PM] kuratius
dk@dk-ThinkPad-E560:~/pmbootstrap$ ls
aports           helpers  MANIFEST.in  pmbootstrap.py  setup.cfg  test
CONTRIBUTING.md  LICENSE  pmb          README.md       setup.py
dk@dk-ThinkPad-E560:~/pmbootstrap$


[5/5/2023 9:29 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-ED8B2.png


[5/5/2023 9:29 PM] kuratius
This is what I used to install


[5/5/2023 10:29 PM] andi15701
so it is: ~/pmbootstrap/pmb/install/_install.py


[5/5/2023 10:43 PM] kuratius
if locale_is_set:
        pmb.chroot.root(args, ["sed", "-i",
                               f"s/LANG=C.UTF-8/LANG={args.locale}/",
                               "/etc/profile.d/locale.sh"], suffix)  <-change this to 20locale.sh?


[5/5/2023 10:45 PM] kuratius
changed it to 20locale.sh


[5/5/2023 10:46 PM] kuratius
running pmbootstrap install again


[5/5/2023 10:50 PM] kuratius
it finished installing, and the sd card booted and I have ssh now


[5/5/2023 10:50 PM] kuratius
is the screen supposed to do anything?


[5/5/2023 10:52 PM] kuratius
also 20locale.sh is a really weird filename, just saying


[5/5/2023 10:53 PM] kuratius
did they change from having locale.sh to having 20 different ones?


[5/5/2023 10:58 PM] andi15701
it should display the console prompt


[5/5/2023 10:58 PM] andi15701
dmesg output?


[5/5/2023 10:58 PM] andi15701
so it booted out of the box?


[5/5/2023 10:59 PM] andi15701
after pmbootstrap install --sdcard


[5/5/2023 10:59 PM] andi15701
there is also a 10locale.sh


[5/5/2023 10:59 PM] kuratius
yes


[5/5/2023 10:59 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-74E2A.txt


[5/5/2023 11:01 PM] andi15701
i think the 20 is jus a prefix to have a defined order there


[5/5/2023 11:01 PM] kuratius
I didnt need to rewrite uboot, but the thing with it not properly dismounting the device still exists (though I suspect that's something that will probably get fixed last if ever)


[5/5/2023 11:02 PM] kuratius
as in, I shutdown my laptop because ejecting is bugged


[5/5/2023 11:03 PM] andi15701
as long as the partitions are umounted, it sould be enough


[5/5/2023 11:03 PM] kuratius
*shrugs* I'd still say it's weird behavior


[5/5/2023 11:04 PM] kuratius
I can mount the partitions again, but even then ejecting fails


[5/5/2023 11:04 PM] kuratius
so it's a really weird state


[5/5/2023 11:04 PM] andi15701
ok, found the problem


[5/5/2023 11:04 PM] andi15701
the epdc pmic is not enabled in the kernel config


[5/5/2023 11:05 PM] andi15701
enable everything with sy7636 (but not sy7636a)


[5/5/2023 11:05 PM] andi15701
in the kernel config


[5/5/2023 11:05 PM] andi15701
as module


[5/5/2023 11:05 PM] kuratius
where do I change that again?


[5/5/2023 11:05 PM] kuratius
sorry I know you told me before


[5/5/2023 11:06 PM] andi15701
pmbootstrap kconfig --edit


[5/5/2023 11:06 PM] kuratius
sec


[5/5/2023 11:06 PM] andi15701
in regulators, sensors and mfd


[5/5/2023 11:07 PM] kuratius
pmbootstrap kconfig --edit
usage: pmbootstrap kconfig [-h] {check,edit,migrate} ...
pmbootstrap kconfig: error: the following arguments are required: action_kconfig
dk@dk-ThinkPad-E560:~$


[5/5/2023 11:07 PM] andi15701
without dashes


[5/5/2023 11:07 PM] kuratius
this?


[5/5/2023 11:08 PM] kuratius
wrong message


[5/5/2023 11:08 PM] kuratius
pmbootstrap kconfig edit linux-kobo-clara-mainline
 doing this now


[5/5/2023 11:08 PM] kuratius
or should I do without linux-kobo-clara-mainline?


[5/5/2023 11:08 PM] kuratius
(am in config menu now)


[5/5/2023 11:08 PM] andi15701
with


[5/5/2023 11:09 PM] kuratius
k


[5/5/2023 11:10 PM] andi15701
Device drivers ->   --->                           │ │  
  │ │    [*]


[5/5/2023 11:10 PM] andi15701
->multifunction device drivers


[5/5/2023 11:10 PM] kuratius
I broke something


[5/5/2023 11:11 PM] kuratius
I accidentally exited the config menu, then aborted with ctrl+c and redoing it fails


[5/5/2023 11:11 PM] kuratius
pmbootstrap kconfig edit linux-kobo-clara-mainline
[23:10:23] (native) install alpine-base
[23:10:26] (native) install abuild build-base ccache git
[23:10:29] WARNING: package musl-armv7: aport version 1.2.3_git20230411-r0 is lower than 1.2.4-r0 from the binary repository. 1.2.4-r0 will be used when installing musl-armv7. See also: <https://postmarketos.org/warning-repo2>
[23:10:29] (native) install ccache-cross-symlinks gcc-armv7 g++-armv7
[23:10:31] (native) install bash bc bison devicepkg-dev findutils flex gmp-dev lzop mpc1-dev mpfr-dev openssl-dev perl ncurses-dev
[23:10:32] (native) extract kernel source
[23:10:33] NOTE: The failed command's output is above the ^^^ line in the log file: /home/dk/.local/var/pmbootstrap/log.txt
[23:10:33] ERROR: Command failed (exit code 1): (native) % cd /home/pmos/build; busybox su pmos -c HOME=/home/pmos abuild unpack
[23:10:33] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.


[5/5/2023 11:11 PM] kuratius
I did a pmbootstrap zap already


[5/5/2023 11:11 PM] kuratius
redid init also


[5/5/2023 11:12 PM] andi15701
git reset --hard in pmaports?


[5/5/2023 11:12 PM] kuratius
sec


[5/5/2023 11:13 PM] kuratius
working now


[5/5/2023 11:14 PM] kuratius
am here


[5/5/2023 11:15 PM] andi15701
and there should be some sy7636 stuff


[5/5/2023 11:17 PM] kuratius
cant find it


[5/5/2023 11:18 PM] andi15701
Silergy SY7636 EPD PMIC core


[5/5/2023 11:18 PM] andi15701
between the ti stuff


[5/5/2023 11:18 PM] kuratius
found it


[5/5/2023 11:18 PM] kuratius
ty


[5/5/2023 11:18 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-27ED7.png


[5/5/2023 11:19 PM] andi15701
M


[5/5/2023 11:19 PM] kuratius
m instead of * ?


[5/5/2023 11:19 PM] kuratius
k sec


[5/5/2023 11:19 PM] andi15701
yes


[5/5/2023 11:19 PM] andi15701
Voltage and Current Regulator Support -> Silergy SY7636 Regulator Support


[5/5/2023 11:20 PM] andi15701
also M


[5/5/2023 11:21 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-C537A.png


[5/5/2023 11:21 PM] andi15701
yes


[5/5/2023 11:22 PM] andi15701
and in Hadwae monitoring support -> Selergy SY7636 EPD temperature sensor


[5/5/2023 11:23 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-9F7B2.png


[5/5/2023 11:24 PM] andi15701
yes


[5/5/2023 11:24 PM] andi15701
ok, save and force-rebuild the kernel


[5/5/2023 11:24 PM] andi15701
and lets try agan


[5/5/2023 11:26 PM] kuratius
is there a reason why modules arent in alphabetical order?


[5/5/2023 11:26 PM] kuratius
(rebuilding now)


[5/5/2023 11:31 PM] kuratius
pmbootstrap build linux-kobo-clara-mainline --force
[23:25:43] (native) install bash bc bison devicepkg-dev findutils flex gmp-dev lzop mpc1-dev mpfr-dev openssl-dev perl
[23:25:43] WARNING: package musl-armv7: aport version 1.2.3_git20230411-r0 is lower than 1.2.4-r0 from the binary repository. 1.2.4-r0 will be used when installing musl-armv7. See also: <https://postmarketos.org/warning-repo2>
[23:25:43] (native) install ccache-cross-symlinks gcc-armv7 g++-armv7
[23:25:44] (native) build armv7/linux-kobo-clara-mainline-6.1.12-r5.apk
[23:30:48] NOTE: The failed command's output is above the ^^^ line in the log file: /home/dk/.local/var/pmbootstrap/log.txt
[23:30:48] ERROR: Command failed (exit code 1): (native) % cd /home/pmos/build; busybox su pmos -c CARCH=armv7 SUDO_APK='abuild-apk --no-progress' CROSS_COMPILE=armv7-alpine-linux-musleabihf- CC=armv7-alpine-linux-musleabihf-gcc GOCACHE=/home/pmos/.cache/go-build HOME=/home/pmos abuild -D postmarketOS -d -f
[23:30:48] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.


[5/5/2023 11:32 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-AF3FC.txt


[5/5/2023 11:32 PM] andi15701
ok, needs some more time


[5/5/2023 11:32 PM] andi15701
must clean up that thing a bit


[5/5/2023 11:33 PM] andi15701
not today anymore


[5/5/2023 11:33 PM] kuratius
kk


[5/5/2023 11:58 PM] andi15701
yes, the modules are not in mainline yet, so I kept them together to avoid merge conflicts, so a bit of lazyness


[5/6/2023 10:22 PM] andi15701
I will fist give the 6.3 kernel a try


[5/6/2023 10:22 PM] andi15701
the driver compiles there


[5/8/2023 10:58 PM] kuratius
Do you mean "would"? Was this meant as a suggestion for me?


[5/8/2023 11:17 PM] andi15701
I upgraded the kernel package in pmOS


[5/8/2023 11:18 PM] andi15701
to version 6.3


[5/8/2023 11:30 PM] andi15701
and of course I tested it before on the clara


[5/9/2023 9:16 PM] kuratius
What would I need to do to switch to the 6.3 Kernel? Or are you still working on making some adjustments so that can work?


[5/9/2023 10:07 PM] andi15701
checkout kobo-nia-6.3 in pmaports


[5/9/2023 10:07 PM] andi15701
and do a fresh install


[5/9/2023 10:11 PM] kuratius
checked out, do I need to edit the kconfig again?


[5/9/2023 10:11 PM] kuratius
(compiling kernel now, will do install when I get home)


[5/9/2023 10:11 PM] kuratius
should I do the forced recompile for the uboot too?


[5/9/2023 10:14 PM] kuratius
will assume I probably need to edit the kconfig, so I may need to recompile again


[5/9/2023 10:20 PM] kuratius
git reset --hard
HEAD is now at c9940d846 enable sy7636 in kernel
just saw this
so i dont need to redo the kconfig thing
*I think*


[5/9/2023 11:52 PM] kuratius
pmbootstrap install --sdcard /dev/mmcblk0
[23:46:53] *** (1/4) PREPARE NATIVE CHROOT ***
[23:46:56] (native) install cryptsetup util-linux parted
[23:46:56] *** (2/4) CREATE DEVICE ROOTFS ("kobo-nia") ***
[23:46:57] (rootfs_kobo-nia) install alpine-base
[23:47:01] (rootfs_kobo-nia) install postmarketos-base device-kobo-nia postmarketos-ui-console lang musl-locales postmarketos-base-nofde
[23:47:31] (rootfs_kobo-nia) install device-kobo-nia
[23:47:44] (rootfs_kobo-nia) install postmarketos-mkinitfs
[23:47:47] (rootfs_kobo-nia) mkinitfs kobo-clara-mainline
[23:47:56]  *** SET LOGIN PASSWORD FOR: 'dk-x86' ***
New password: 
              Retype new password: 
                                   passwd: password updated successfully
                                                                        [23:52:04] NOTE: No valid keymap specified for device
[23:52:09] NOTE: The failed command's output is above the ^^^ line in the log file: /home/dk/.local/var/pmbootstrap/log.txt
[23:52:09] ERROR: Command failed (exit code 1): (rootfs_kobo-nia) % sed -i s/LANG=C.UTF-8/LANG=en_GB.UTF-8/ /etc/profile.d/locale.sh
[23:52:09] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.


[5/9/2023 11:53 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-E6372.txt


[5/10/2023 12:18 AM] andi15701
https://gitlab.com/postmarketOS/pmbootstrap/-/issues/2236

{Embed}
https://gitlab.com/postmarketOS/pmbootstrap/-/issues/2236
pmbootstrap /etc/profile.d/locale.sh: no such file or directory (#2...
Describe your issue pmboostrap install fails with an error,
/mnt/data/projects/git/conversations/media/icon_mobile-6754B.png


[5/10/2023 12:45 AM] kuratius
oh right


[5/10/2023 12:45 AM] kuratius
one sec


[5/10/2023 12:52 AM] kuratius
(I redid the 20locale.sh rename thing)


[5/10/2023 12:57 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-023C8.txt


[5/10/2023 12:57 AM] kuratius
no screen output atm


[5/10/2023 12:58 AM] kuratius
did it load the driver?


[5/10/2023 1:01 AM] kuratius
(probably better to continue tomorrow anyway)


[5/10/2023 7:22 PM] andi15701
is the sy7636 device in /sys?


[5/10/2023 7:36 PM] kuratius
kobo-nia:~$ ls /sys/
block     class     devices   fs        module
bus       dev       firmware  kernel    power

kobo-nia:~$ ls /sys/devices/
armv7_cortex_a7  mmdc0            soc0             system
breakpoint       platform         software         virtual
kobo-nia:~$


[5/10/2023 7:37 PM] kuratius
kobo-nia:~$ ls -R /sys/ | grep sy7636
sy7636@62


[5/10/2023 7:37 PM] kuratius
this finds something


[5/10/2023 7:37 PM] kuratius
just dont know where the path for it is


[5/10/2023 7:39 PM] kuratius
kobo-nia:~$ ls -R -l /sys/ | grep sy7636
lrwxrwxrwx    1 root     root             0 May 10 19:37 of_node -> ../../../../../../../firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/sy7636@62
drwxr-xr-x    3 root     root             0 May 10 19:37 sy7636@62
/sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/sy7636@62:
/sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/sy7636@62/regulators:
/sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/sy7636@62/regulators/DISPLAY:
/sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/sy7636@62/regulators/V3P3:
/sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/sy7636@62/regulators/VCOM:
ls: can't open '/sys/kernel/debug': Permission denied
kobo-nia:~$


[5/10/2023 7:40 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-DEE93.txt


[5/10/2023 7:41 PM] kuratius
I forgot I already posted the dmesg before, sorry


[5/10/2023 7:45 PM] kuratius
brb


[5/10/2023 8:07 PM] andi15701
apparently a simple case error


[5/10/2023 8:07 PM] andi15701
you can pull


[5/10/2023 8:16 PM] kuratius
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/cache_git/pmaports$ git reset --hard
HEAD is now at c9940d846 enable sy7636 in kernel
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/cache_git/pmaports$ git pull
warning: redirecting to https://gitlab.com/akemnade/pmaports.git/
Already up to date.
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/cache_git/pmaports$ git pull
warning: redirecting to https://gitlab.com/akemnade/pmaports.git/
Already up to date.
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/cache_git/pmaports$

{Embed}
https://gitlab.com/akemnade/pmaports.git/
Andreas Kemnade / pmaports · GitLab
postmarketOS package build recipes
/mnt/data/projects/git/conversations/media/icon_mobile-2040A.png


[5/10/2023 8:16 PM] kuratius
is there a new commit?


[5/10/2023 8:17 PM] andi15701
well, now


[5/10/2023 8:37 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-BBBDD.txt


[5/10/2023 8:39 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-08487.txt


[5/10/2023 8:40 PM] kuratius
no screen output, but depending on what it's writing/how it's doing the refresh I might not see anything anyway since most of the screen is still black from a bookcover I had loaded on nickel


[5/10/2023 8:44 PM] kuratius
is sy7636 the original nickel driver of the nia or is it a port of the clara driver? or do they already use the same one?


[5/10/2023 8:45 PM] andi15701
there is some half-cleaned up sign mess in the driver


[5/10/2023 8:45 PM] andi15701
the clara does not use that driver


[5/10/2023 8:45 PM] andi15701
and I have apparently only fixed the get_voltage path


[5/10/2023 8:45 PM] andi15701
completely


[5/10/2023 8:47 PM] kuratius
do you happen to know where that reference manual can be found, out of curiosity?


[5/10/2023 8:47 PM] andi15701
www.nxp.com


[5/10/2023 8:48 PM] andi15701
https://www.nxp.com/products/processors-and-microcontrollers/arm-processors/i-mx-applications-processors/i-mx-6-processors/i-mx-6ull-single-core-processor-with-arm-cortex-a7-core:i.MX6ULL

{Embed}
https://www.nxp.com/products/processors-and-microcontrollers/arm-processors/i-mx-applications-processors/i-mx-6-processors/i-mx-6ull-single-core-processor-with-arm-cortex-a7-core:i.MX6ULL
i.MX 6ULL Applications Processor | Single Arm® Cortex®-A7 @ 900 MHz
The i.MX 6ULL is a power efficient and cost optimized processor family that features a single Arm Cortex-A7 core operating at speeds up to 528 MHz.


[5/10/2023 8:49 PM] kuratius
how do I check if mine is rev 0 or rev1?


[5/10/2023 8:50 PM] kuratius
was this written at the beginning of the kernel log we had earlier?


[5/10/2023 8:50 PM] kuratius
got it


[5/10/2023 8:50 PM] kuratius
rev 1 I think


[5/10/2023 8:51 PM] andi15701
[    0.034625] CPU identified as i.MX6ULL, silicon rev 1.1


[5/10/2023 8:51 PM] andi15701
the rev on that page is probably the rev of the document


[5/10/2023 9:00 PM] kuratius
does the document get watermarked?


[5/10/2023 9:00 PM] kuratius
sha1sum IMX6ULLRM.pdf 
b15d3a96c1f404f9cbcb552245fe6fcda6d948d9  IMX6ULLRM.pdf


[5/10/2023 9:01 PM] andi15701
b15d3a96c1f404f9cbcb552245fe6fcda6d948d9  IMX6ULLRM.pdf


[5/10/2023 9:01 PM] kuratius
so no


[5/10/2023 9:01 PM] kuratius
nice


[5/10/2023 9:02 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/IMX6ULLRM-FD953.pdf


[5/10/2023 9:05 PM] andi15701
the sy7636 download is crazy


[5/10/2023 9:05 PM] kuratius
what do you mean?


[5/10/2023 9:06 PM] andi15701
MY datasheet has now a marking Silergy confidential for none


[5/10/2023 9:07 PM] andi15701
register with fake company name


[5/10/2023 9:09 PM] kuratius
this one ? sha1sum IMX6ULLCEC.pdf 
735e2e42a56a7fd61c39b73b177b31ed6bc9a6b1  IMX6ULLCEC.pdf


[5/10/2023 9:09 PM] kuratius
is this a suggestion for me?


[5/10/2023 9:09 PM] andi15701
the datasheet for the sy7636


[5/10/2023 9:10 PM] kuratius
ah sec


[5/10/2023 9:10 PM] andi15701
I had done it for silergy


[5/10/2023 9:10 PM] andi15701
for nxp I  had accounts


[5/10/2023 9:10 PM] kuratius
different website I assume


[5/10/2023 9:10 PM] andi15701
yes


[5/10/2023 9:10 PM] kuratius
any easy way to compare files and strip the watermarks?


[5/10/2023 9:10 PM] andi15701
N/A is often accepted


[5/10/2023 9:11 PM] kuratius
if you think it's useful I'd download the sy7636 datasheet too so we can make a version without a watermark


[5/10/2023 9:18 PM] kuratius
https://lore.kernel.org/linux-arm-kernel/20211124235041.2840a770@aktux/ 
lol literally the first thing that popped up was from you xD


[5/10/2023 9:18 PM] kuratius
(just searched for the driver name on google)


[5/10/2023 9:18 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-08297.png


[5/10/2023 9:26 PM] andi15701
git pull again


[5/10/2023 9:44 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-34B55.txt


[5/10/2023 9:44 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-D6161.txt


[5/10/2023 10:08 PM] andi15701
one last try for today


[5/10/2023 10:31 PM] andi15701
one unitialized variable


[5/10/2023 10:50 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-046E3.txt


[5/10/2023 10:50 PM] kuratius
is the stuff in /sys useful to you?


[5/10/2023 10:50 PM] kuratius
or am I just spamming useless info?


[5/10/2023 10:51 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-BF005.txt


[5/10/2023 10:51 PM] andi15701
so all sy7636 stuff looks solved for now


[5/10/2023 10:52 PM] andi15701
so only the epdc controller itself it missing


[5/10/2023 10:54 PM] andi15701
maybe you can find out the reason yourself why the driver for the controller does not start


[5/10/2023 10:55 PM] kuratius
do I have to look at the code of the driver for that and compare it against the documentation? or do I have to find a log?


[5/10/2023 10:55 PM] andi15701
you have


[5/10/2023 10:55 PM] andi15701
/sys/bus/platform/devices/20f4000.epdc/of_node/compatible


[5/10/2023 10:56 PM] andi15701
or similar


[5/10/2023 10:56 PM] andi15701
and we need a driver matching that


[5/10/2023 10:56 PM] kuratius
this is a file?


[5/10/2023 10:57 PM] andi15701
yes


[5/10/2023 10:58 PM] andi15701
the point is that the driver is not probed


[5/10/2023 10:59 PM] kuratius
kobo-nia:~$ ls /sys/bus/platform/devices/ | grep epdc
228c000.epdc


[5/10/2023 10:59 PM] andi15701
so there kernel does for some reason not think that it matches the actual hardware


[5/10/2023 10:59 PM] andi15701
you have a modalias there


[5/10/2023 11:00 PM] kuratius
it's not getting activated/loaded? I assume probed as a word is taken from the modprobe command?


[5/10/2023 11:00 PM] andi15701
every driver as a _probe function


[5/10/2023 11:00 PM] andi15701
which gets called when there is hardware for that


[5/10/2023 11:01 PM] andi15701
and also the module gets loaded in the first place


[5/10/2023 11:02 PM] kuratius
kobo-nia:~$ cat /sys/bus/platform/devices/228c000.epdc/of_node/compatible
fsl,imx6ull-epdcfsl,imx7d-epdc


[5/10/2023 11:02 PM] andi15701
modinfo mxc_epdc_drm


[5/10/2023 11:03 PM] kuratius
kobo-nia:~$ modinfo mxc_epdc_drm
filename:       /lib/modules/6.3.0/kernel/drivers/gpu/drm/mxc-epdc/mxc_epdc_drm.ko
description:    IMX EPDC driver
license:        GPL
alias:          of:N*T*Cfsl,imx6sll-epdcC*
alias:          of:N*T*Cfsl,imx6sll-epdc
alias:          of:N*T*Cfsl,imx6sl-epdcC*
alias:          of:N*T*Cfsl,imx6sl-epdc
srcversion:     A9CAE08AD9EBC7815F433A5
depends:        
intree:         Y
vermagic:       6.3.0 mod_unload modversions ARMv7 p2v8 
kobo-nia:~$


[5/10/2023 11:03 PM] kuratius
is the number in front of .epdc supposed to be different?


[5/10/2023 11:03 PM] andi15701
cat /sys/bus/platform/devices/228c000.epdc/modalias


[5/10/2023 11:04 PM] kuratius
cat /sys/bus/platform/devices/228c000.epdc/modalias
of:NepdcT(null)Cfsl,imx6ull-epdcCfsl,imx7d-epdc


[5/10/2023 11:05 PM] andi15701
and generally you can do modprobe $(cat /sys/bus/......./modalias)


[5/10/2023 11:05 PM] andi15701
and the driver will be loaded


[5/10/2023 11:06 PM] andi15701
epdc: epdc@0228c000 {
                                compatible = "fsl,imx6ull-epdc", "fsl,imx7d-epdc";


[5/10/2023 11:06 PM] andi15701
that you have in imx6ull.dtsi


[5/10/2023 11:06 PM] kuratius
modprobe $(cat /sys/bus/platform/devices/228c000.epdc/modalias)
modprobe: module of:NepdcT(null)Cfsl,imx6ull-epdcCfsl,imx7d-epdc not found in modules.dep


[5/10/2023 11:06 PM] andi15701
and in the driver


[5/10/2023 11:06 PM] andi15701
static const struct of_device_id imx_epdc_dt_ids[] = {
        { .compatible = "fsl,imx6sl-epdc", },
        { .compatible = "fsl,imx6sll-epdc", },
        { /* sentinel */ }
};
MODULE_DEVICE_TABLE(of, imx_epdc_dt_ids);

static struct platform_driver pdev = {
        .driver = {
                .name   = "mxc_epdc",
                .of_match_table = of_match_ptr(imx_epdc_dt_ids),
        },


[5/10/2023 11:07 PM] andi15701
do you spot what is missing here?


[5/10/2023 11:07 PM] andi15701
MODULE_DEVICE_TABLE generates the things in the modinfo command


[5/10/2023 11:08 PM] andi15701
and the of_match_table entry makes the kernel call the probe function in that driver if a device with the corresponding compatible is called


[5/10/2023 11:09 PM] andi15701
so what happens here: the driver says: i am only for epdc in  the imx6sl/sll SoC


[5/10/2023 11:09 PM] andi15701
but not for the 6ull


[5/10/2023 11:11 PM] kuratius
do i just need to edit the static const struct to say the same thing as whats written in the dtsi?


[5/10/2023 11:11 PM] andi15701
yes


[5/10/2023 11:13 PM] kuratius
where is the driver source code again?


[5/10/2023 11:13 PM] andi15701
drivers/gpu/drm/mxc_epdc


[5/10/2023 11:15 PM] kuratius
kernel repo?


[5/10/2023 11:17 PM] andi15701
updated the tihng again


[5/10/2023 11:17 PM] andi15701
yes kernel repo


[5/10/2023 11:18 PM] kuratius
doing a git pull for the kernel repo, then taking a look at it


[5/10/2023 11:18 PM] kuratius
do I need a git pull for pmaports?


[5/10/2023 11:18 PM] andi15701
yes


[5/10/2023 11:18 PM] kuratius
k


[5/10/2023 11:18 PM] andi15701
I have done that


[5/10/2023 11:18 PM] andi15701
now


[5/10/2023 11:18 PM] kuratius
ah ok


[5/10/2023 11:18 PM] andi15701
pma points to the kernel commit


[5/10/2023 11:22 PM] kuratius
(compiling kernel again now)


[5/10/2023 11:35 PM] kuratius
here's something weird:
they kernel repo I downloaded separately from pmaports gives this message when doing a git pull 
dk@dk-ThinkPad-E560:~/nia/linux$ git reset --hard
HEAD is now at b1f487089caf kobo nia: fix backlight
dk@dk-ThinkPad-E560:~/nia/linux$ git pull
hint: You have divergent branches and need to specify how to reconcile them.
hint: You can do so by running one of the following commands sometime before
hint: your next pull:
hint: 
hint:   git config pull.rebase false  # merge (the default strategy)
hint:   git config pull.rebase true   # rebase
hint:   git config pull.ff only       # fast-forward only
hint: 
hint: You can replace "git config" with "git config --global" to set a default
hint: preference for all repositories. You can also pass --rebase, --no-rebase,
hint: or --ff-only on the command line to override the configured default per
hint: invocation.
fatal: Need to specify how to reconcile divergent branches.
dk@dk-ThinkPad-E560:~/nia/linux$


[5/10/2023 11:36 PM] andi15701
i did a force push


[5/10/2023 11:36 PM] kuratius
I dont get how it can have divergent branches if I did a git reset


[5/10/2023 11:36 PM] kuratius
wait so the commit numbers are mismatching?


[5/10/2023 11:37 PM] andi15701
git reset --hard origin/kobo/nia-test


[5/10/2023 11:37 PM] andi15701
I put something on not of some patched 6.1 stuff


[5/10/2023 11:38 PM] andi15701
and now I  have that branch on top of something 6.3


[5/10/2023 11:38 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-297E1.txt


[5/10/2023 11:39 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-0C47C.txt


[5/10/2023 11:40 PM] andi15701
[   13.496685] mxc_epdc 228c000.epdc: Direct firmware load for imx/epdc/epdc.fw failed with error -2
[   13.496734] mxc_epdc: probe of 228c000.epdc failed with error -2


[5/10/2023 11:40 PM] kuratius
kobo-nia:~$  modinfo mxc_epdc_drm
filename:       /lib/modules/6.3.0/kernel/drivers/gpu/drm/mxc-epdc/mxc_epdc_drm.ko
description:    IMX EPDC driver
license:        GPL
alias:          of:N*T*Cfsl,imx6ull-epdcC*
alias:          of:N*T*Cfsl,imx6ull-epdc
alias:          of:N*T*Cfsl,imx6sll-epdcC*
alias:          of:N*T*Cfsl,imx6sll-epdc
alias:          of:N*T*Cfsl,imx6sl-epdcC*
alias:          of:N*T*Cfsl,imx6sl-epdc
srcversion:     624D224E4EF08F9BD5665B2
depends:        
intree:         Y
vermagic:       6.3.0 mod_unload modversions ARMv7 p2v8 
kobo-nia:~$


[5/10/2023 11:41 PM] andi15701
extract-waveform.sh


[5/10/2023 11:41 PM] kuratius
where?


[5/10/2023 11:41 PM] andi15701
on the nia


[5/10/2023 11:41 PM] andi15701
as root


[5/10/2023 11:41 PM] kuratius
yes but where is that file?


[5/10/2023 11:42 PM] kuratius
or is it already a command?


[5/10/2023 11:42 PM] andi15701
it should be installed


[5/10/2023 11:42 PM] andi15701
on the nia


[5/10/2023 11:42 PM] kuratius
is there supposed to be output?


[5/10/2023 11:42 PM] kuratius
if you need the hidden sectors, I uploaded those a bit ago


[5/10/2023 11:42 PM] andi15701
hmm, just reboot


[5/10/2023 11:42 PM] andi15701
on the nia


[5/10/2023 11:43 PM] kuratius
https://discord.com/channels/809205711778480158/809205711778480162/1101183600768057485


[5/10/2023 11:43 PM] kuratius
rebooting sec


[5/10/2023 11:43 PM] kuratius
kobo-nia:~$ extract-waveform.sh
kobo-nia:~$ extract-waveform.sh 
kobo-nia:~$ ls
kobo-nia:~$ ls
kobo-nia:~$


[5/10/2023 11:43 PM] kuratius
for reference


[5/10/2023 11:45 PM] kuratius
kobo-nia:~$ extract-waveform.sh 
kobo-nia:~$ ls
kobo-nia:~$


[5/10/2023 11:45 PM] kuratius
rebooted


[5/10/2023 11:45 PM] kuratius
extract-waveform.sh does autocomplete if I press tab after writing extract-wave


[5/10/2023 11:45 PM] kuratius
but still no output


[5/10/2023 11:46 PM] andi15701
mxc_epdc 228c000.epdc: Direct firmware load for imx/epdc/epdc.fw failed with error -2


[5/10/2023 11:46 PM] andi15701
is that gone?


[5/10/2023 11:46 PM] andi15701
in the dmesg


[5/10/2023 11:46 PM] andi15701
is there something in /lib/firmware/imx/epdc?


[5/10/2023 11:46 PM] kuratius
kobo-nia:~$ dmesg | grep mxc
[    0.000000] Kernel command line: console=ttymxc0,115200 debug
[    0.000038] clocksource: mxc_timer1: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 79635851949 ns
[    0.107164] clocksource: Switched to clocksource mxc_timer1
[    0.667807] 2020000.serial: ttymxc0 at MMIO 0x2020000 (irq = 192, base_baud = 5000000) is a IMX
[    0.667938] printk: console [ttymxc0] enabled
[    1.290181] 21ec000.serial: ttymxc2 at MMIO 0x21ec000 (irq = 193, base_baud = 5000000) is a IMX
[   13.594462] mxc_epdc 228c000.epdc: EPDC pix format: 400
[   13.595614] [drm] Initialized mxc_epdc 1.0.0 20201007 for 228c000.epdc on minor 0
[   13.609275] mxc_epdc 228c000.epdc: Mode: 1024 x 758
[   13.613363] mxc_epdc 228c000.epdc: Unable to get an accurate EPDC pix clkdesired = 80000000, actual = 72605042
[   15.187947] mxc_epdc 228c000.epdc: [drm] fb0: mxc_epdcdrmfb frame buffer device
kobo-nia:~$


[5/10/2023 11:47 PM] andi15701
do you have a console login displayed at the screen?


[5/10/2023 11:47 PM] kuratius
yes


[5/10/2023 11:47 PM] kuratius
practically unreadable but yes


[5/10/2023 11:47 PM] andi15701
unreadable because small?


[5/10/2023 11:47 PM] andi15701
or low contrast?


[5/10/2023 11:48 PM] kuratius
low contrast I think, but let me get better light


[5/10/2023 11:48 PM] kuratius
(but small also)


[5/10/2023 11:48 PM] kuratius
it's white text against a grey background


[5/10/2023 11:49 PM] kuratius
instead of black background


[5/10/2023 11:50 PM] kuratius
what did this do?


[5/10/2023 11:51 PM] andi15701
it created the epdc.fw file from the hidden partitions stuff, but probably that was already done automatically


[5/10/2023 11:52 PM] andi15701
during initial boot


[5/10/2023 11:52 PM] kuratius
so this file was missing and that was why the driver didnt load and errored out?


[5/10/2023 11:52 PM] andi15701
yes


[5/10/2023 11:53 PM] kuratius
is it possible that I got the wrong hidden partition stuff and that's why the contrast is bad, or is the driver reading something wrong or is there a setting that needs to be changed on the driver? or is the low contrast just a display setting issue unrelated to the driver?


[5/10/2023 11:54 PM] kuratius
like maybe a fast refresh mode or something


[5/10/2023 11:54 PM] kuratius
sorry if I am bombarding you with questions


[5/10/2023 11:55 PM] andi15701
first, the temperature reading does not work correctly now


[5/10/2023 11:56 PM] andi15701
so a room temperature of 20 degrees c is assumed


[5/10/2023 11:56 PM] kuratius
so my room temp might be sightly different, and that changes the viscosity of the display fluid?


[5/10/2023 11:57 PM] andi15701
yes


[5/10/2023 11:57 PM] kuratius
and so it needs different voltages for that temp?


[5/10/2023 11:57 PM] andi15701
a different section of the waveform file is used


[5/10/2023 11:59 PM] kuratius
I have a thermostat that says 22 degrees


[5/10/2023 11:59 PM] andi15701
but a few degrees (< 5) should not matter, there are ranges


[5/10/2023 11:59 PM] andi15701
so no problem


[5/10/2023 11:59 PM] andi15701
so the trouble has to be researched a bit more


[5/11/2023 12:00 AM] kuratius
the degrees are in celsius right?


[5/11/2023 12:00 AM] andi15701
yes


[5/11/2023 12:00 AM] kuratius
if they were in kelvin that'd have caused a large difference


[5/11/2023 12:01 AM] andi15701
And the driver used on nickel on the clara does not work with negative values


[5/11/2023 12:01 AM] andi15701
so it behaves as in high temperature


[5/11/2023 12:01 AM] andi15701
bad picture, first I thought I had destroyed my clara


[5/11/2023 12:02 AM] andi15701
is contrast for the cursor the same?


[5/11/2023 12:02 AM] andi15701
as for the text?


[5/11/2023 12:03 AM] kuratius
cursor stopped


[5/11/2023 12:03 AM] kuratius
it was blinking before


[5/11/2023 12:03 AM] kuratius
will reboot


[5/11/2023 12:04 AM] andi15701
and maybe it is time to play around with xfce4


[5/11/2023 12:05 AM] kuratius
cursor contrast is different


[5/11/2023 12:05 AM] kuratius
it becomes fully black


[5/11/2023 12:05 AM] andi15701
so it is only a problem with the first initial refresh or something


[5/11/2023 12:05 AM] kuratius
whiteness of the cursor is the same as text


[5/11/2023 12:06 AM] kuratius
it blinks white black white or white grey black white, I cant tell properly cause it's too fast


[5/11/2023 12:08 AM] kuratius
I can try to do another install with xfce4 if you think that's a good idea


[5/11/2023 12:08 AM] andi15701
yes


[5/11/2023 12:08 AM] kuratius
k


[5/11/2023 12:08 AM] andi15701
maybe you need to reboot once


[5/11/2023 12:08 AM] andi15701
after the install


[5/11/2023 12:08 AM] kuratius
k


[5/11/2023 12:08 AM] andi15701
but I think we made good progress


[5/11/2023 12:30 AM] kuratius
chose xfce4 
first boot, screen was stuck on old console screen, but not blinking (so probably screen wasnt active), then second boot it became blank and now I have a desktop interface with very bad contrast


[5/11/2023 12:31 AM] kuratius
also touchscreen probably isnt working I think


[5/11/2023 12:31 AM] andi15701
yes, correct


[5/11/2023 12:32 AM] kuratius
I can see a triangle on grass (Alpine logo?)


[5/11/2023 12:32 AM] kuratius
anyway rest is probably tomorrow, but just wanted to get this part out of the way


[5/11/2023 12:32 AM] andi15701
yes


[5/12/2023 9:09 AM] szybet
how far is this port of the kernel? I wonder if I go try to use the newer kernel with this diffrent pmic settings, or just go straight with this one


[5/12/2023 1:08 PM] andi15701
summary: no smoke seen yet, touchscreen needs some quirks (code is known), just to be cherry-picked, eink with drm driver is worse than on the clara, some research needed, not tried with pure fbdev driver yet


[5/12/2023 1:09 PM] andi15701
wifi: not working yet


[5/12/2023 1:10 PM] andi15701
probbaly just an issue with the gpios


[5/12/2023 1:10 PM] andi15701
usb ssh works


[5/12/2023 1:10 PM] andi15701
rtc works


[5/12/2023 1:10 PM] andi15701
led works


[5/12/2023 1:11 PM] szybet
can i help somehow ( while using inkbox, not the other one )? to make the process quicker?


[5/12/2023 1:12 PM] szybet
I have on my nia exposed serial & sd card slot so it would be easy


[5/12/2023 1:16 PM] andi15701
can you check the state of the wifi power module during that cat /sys/kernel/debug/gpio thing


[5/12/2023 1:16 PM] andi15701
so is it really removed


[5/12/2023 1:16 PM] andi15701
or added


[5/12/2023 1:16 PM] szybet
I already did i think?


[5/12/2023 1:16 PM] szybet
check it once more?


[5/12/2023 1:17 PM] andi15701
the output looks insane, so to rule out that Inkbox wifi powerup/down does not fully work


[5/12/2023 1:17 PM] andi15701
so just manual rmmod/insmod


[5/12/2023 1:18 PM] szybet
we do that


[5/12/2023 1:18 PM] szybet
well okay i will look into it


[5/12/2023 1:18 PM] szybet
besides that?


[5/12/2023 1:19 PM] andi15701
lets talk later


[5/12/2023 1:27 PM] szybet
well call me if anything is needed, I have time finally


[5/13/2023 9:58 AM] andi15701
register dumps of the sy7636 would be interesting


[5/13/2023 10:57 AM] szybet
Over I2C?


[5/14/2023 5:14 PM] andi15701
yes


[5/16/2023 6:46 PM] andi15701
and I think repeating the installation process here will also help you to understand some things better


[5/16/2023 6:46 PM] andi15701
no matter with what rootfs you are doing it


[5/16/2023 6:48 PM] andi15701
and it is basically the same as documented for clara inkbox


[5/22/2023 12:05 AM] szybet
```
kobo:~# cat /sys/kernel/debug/gpio 
GPIOs 0-31, platform/209c000.gpio, 209c000.gpio:
 gpio-6   (gpio_elan_rst       ) out lo    
 gpio-7   (gpio_elan_intr      ) in  hi    
 gpio-13  (epdc-pwrstat        ) in  lo    

GPIOs 32-63, platform/20a0000.gpio, 20a0000.gpio:

GPIOs 64-95, platform/20a4000.gpio, 20a4000.gpio:
 gpio-78  (epdc-pmic-pwrall    ) out hi    
 gpio-88  (epdc-vcom           ) out lo    
 gpio-89  (epdc-powerup        ) out lo    
 gpio-91  (lm3630a_bl_hwen     ) out lo    

GPIOs 96-127, platform/20a8000.gpio, 20a8000.gpio:

GPIOs 128-159, platform/20ac000.gpio, 20ac000.gpio:
 gpio-128 (ricoh619_chg        ) in  hi    
 gpio-129 (ricoh619_pmic_irq   ) in  hi    
 gpio-130 (Hall                ) in  hi    
 gpio-131 (ricoh619_bat_low    ) in  hi    
 gpio-132 (Power               ) in  hi    
 gpio-133 (?                   ) out lo    
 gpio-134 (wifiint             ) in  lo    
 gpio-135 (wifirst             ) out lo    
 gpio-136 (wifipwr             ) out lo    
kobo:~# 
```
clean inkbox boot


[5/22/2023 12:10 AM] szybet
```
kobo:~# cat /sys/kernel/debug/gpio 
GPIOs 0-31, platform/209c000.gpio, 209c000.gpio:
 gpio-6   (gpio_elan_rst       ) out lo    
 gpio-7   (gpio_elan_intr      ) in  hi    
 gpio-13  (epdc-pwrstat        ) in  lo    

GPIOs 32-63, platform/20a0000.gpio, 20a0000.gpio:

GPIOs 64-95, platform/20a4000.gpio, 20a4000.gpio:
 gpio-78  (epdc-pmic-pwrall    ) out hi    
 gpio-88  (epdc-vcom           ) out lo    
 gpio-89  (epdc-powerup        ) out lo    
 gpio-91  (lm3630a_bl_hwen     ) out lo    

GPIOs 96-127, platform/20a8000.gpio, 20a8000.gpio:

GPIOs 128-159, platform/20ac000.gpio, 20ac000.gpio:
 gpio-128 (ricoh619_chg        ) in  hi    
 gpio-129 (ricoh619_pmic_irq   ) in  hi    
 gpio-130 (Hall                ) in  hi    
 gpio-131 (ricoh619_bat_low    ) in  hi    
 gpio-132 (Power               ) in  hi    
 gpio-133 (?                   ) out lo    
 gpio-134 (wifiint             ) in  lo    
 gpio-135 (wifirst             ) out lo    
 gpio-136 (wifipwr             ) out lo    
kobo:~# 
```
turned off after turning on


[5/31/2023 1:57 PM] kuratius
What was the idea behind knowing the gpio pin states? Is there a sequence of pin commands that need to be sent out to turn on the wifi chip? Is that sequence documented? Or is that all already handled by the driver?


[5/31/2023 7:26 PM] andi15701
something like that, yes


[5/31/2023 7:29 PM] andi15701
@Szybet I do not see the module actions here: to be completely sure; do  ```  rmmod sdio_wifi_pwr ; lsmod ;  cat /sys/kernel/debug/gpio ;  insmod /path/to/sdio_wifi_pwr.ko ; lsmod ; cat /sys/kernel/debug/gpio ```


[5/31/2023 7:34 PM] szybet
😐


[5/31/2023 7:34 PM] szybet
for the 4 time, yes sure i will do it soon


[5/31/2023 8:11 PM] andi15701
reg_sd1_vmmc: wifi-regulator {
                compatible = "regulator-fixed";
                regulator-name = "SD1_SPWR";
                regulator-min-microvolt = <3000000>;
                regulator-max-microvolt = <3000000>;
                gpio = <&gpio5 8 GPIO_ACTIVE_LOW>;
#if 0
                wifidis-gpio = <&gpio4 23 GPIO_ACTIVE_HIGH>;
                wifirst-gpio = <&gpio5 7 GPIO_ACTIVE_HIGH>;
                wifiint-gpio = <&gpio5 6 GPIO_ACTIVE_HIGH>;
#endif


[5/31/2023 8:11 PM] andi15701
we have this thing


[5/31/2023 8:11 PM] andi15701
and apparently no wifidis


[5/31/2023 8:11 PM] andi15701
and the #if 0 thing is kobo specific


[5/31/2023 8:12 PM] andi15701
wifi_pwrseq: wifi_pwrseq {
                compatible = "mmc-pwrseq-simple";
                post-power-on-delay-ms = <20>;
                reset-gpios = <&gpio5 7 GPIO_ACTIVE_LOW>;
        };


[5/31/2023 8:12 PM] andi15701
maybe it is just the ACTIVE_LOW


[5/31/2023 8:12 PM] andi15701
which should be ACTIVE_HIGH


[5/31/2023 8:12 PM] andi15701
but reset in active high is extremely unusual


[5/31/2023 8:14 PM] andi15701
about the display: using plain console and doing a gray gradient on /dev/fb0


[5/31/2023 8:14 PM] andi15701
would be interesting


[5/31/2023 9:41 PM] kuratius
do I need to reflash with console instead of xfce or is there a faster way?


[5/31/2023 9:41 PM] kuratius
I assume I would need to disable normal screen output either way to write to the framebuffer, so it might be the same process for both console mode and xfce mode


[5/31/2023 9:42 PM] andi15701
well, you can just disable nodm


[5/31/2023 9:42 PM] andi15701
or lightdm


[5/31/2023 9:42 PM] andi15701
in the init scripts


[5/31/2023 9:44 PM] kuratius
ssh into it>find location of init scripts>edit>reboot>perform writes to famebuffer


[5/31/2023 9:44 PM] kuratius
?


[5/31/2023 9:44 PM] andi15701
yes


[5/31/2023 9:46 PM] andi15701
```/* found by experimentation, reduced number of levels of gray */
static void epdc_from_rgb_shift(struct drm_rect *clip, void *vaddr, int pitch, u8 *dst, int dst_pitch)
{
        unsigned int x, y;

        dst += clip->y1 * dst_pitch;

        for (y = clip->y1; y < clip->y2; y++, dst += dst_pitch) {
                u32 *src;
                src = vaddr + (y * pitch);
                src += clip->x1;
                for (x = clip->x1; x < clip->x2; x++) {
                        u8 r = (*src & 0x00ff0000) >> 16;
                        u8 g = (*src & 0x0000ff00) >> 8;
                        u8 b =  *src & 0x000000ff;

                        /* ITU BT.601: Y = 0.299 R + 0.587 G + 0.114 B */
                        u8 gray = (3 * r + 6 * g + b) / 10;
                        dst[x] = (gray >> 2) | 0xC0;
                        src++;
                }
        }
}
```


[5/31/2023 9:47 PM] andi15701
I do not trust that function too much


[5/31/2023 9:47 PM] andi15701
in the kernel


[5/31/2023 9:48 PM] andi15701
maybe we do not need the shift here


[5/31/2023 9:53 PM] kuratius
ssh'ed into it


[5/31/2023 9:53 PM] kuratius
where are the init scripts?


[5/31/2023 9:53 PM] kuratius
/boot?


[5/31/2023 9:55 PM] kuratius
/etc/init or /etc/init.d ?


[5/31/2023 9:55 PM] kuratius
kobo-nia:~$ ls /etc/init.d
acpid                      multipathd
agetty                     net-online
alsa                       netmount
binfmt                     networking
bluetooth                  networkmanager
bootmisc                   networkmanager-dispatcher
cgroups                    nftables
chronyd                    ntpd
consolefont                numlock
crond                      osclock
dbus                       polkit
deferred-initcalls         procfs
devfs                      pulseaudio
dmcrypt                    rdate
dmesg                      rfkill
dnsmasq                    root
elogind                    runsvdir
extract-waveform           s6-svscan
firstboot                  save-keymaps
fsck                       save-termencoding
functions.sh               savecache
haveged                    seedrng
hostname                   sleep-inhibitor
hwclock                    sshd
hwdrivers                  staticroute
kill-pbsplash              swap
killprocs                  swapfile
klogd                      swclock
lightdm                    sysctl
loadkeys                   sysfs
loadkmap                   sysfsconf
local                      syslog
localmount                 termencoding
loopback                   udev
machine-id                 udev-postmount
mdev                       udev-settle
modloop                    udev-trigger
modules                    watchdog
mount-ro                   wpa_cli
mtab                       wpa_supplicant
multipath                  zram-init
kobo-nia:~$ ls /etc/init
lightdm.conf


[5/31/2023 9:56 PM] andi15701
just booting my pmos system


[5/31/2023 9:56 PM] kuratius
kk


[5/31/2023 9:59 PM] andi15701
sudo rc-update del lightdm


[5/31/2023 10:00 PM] andi15701
/etc/runlevels/default/lightdm


[5/31/2023 10:02 PM] andi15701
that one is removed by the command


[5/31/2023 10:02 PM] andi15701
sudo rc-update add lightdm default


[5/31/2023 10:02 PM] andi15701
would restore it


[5/31/2023 10:08 PM] kuratius
done, rebooting


[5/31/2023 10:08 PM] kuratius
am back on console


[5/31/2023 10:09 PM] kuratius
I assume the console would still be writing to the framebuffer, dont I need to disable those writes to do my own?


[5/31/2023 10:09 PM] andi15701
nq


[5/31/2023 10:09 PM] andi15701
no


[5/31/2023 10:09 PM] andi15701
now lets use the fbi


[5/31/2023 10:10 PM] andi15701
e.g.


[5/31/2023 10:12 PM] kuratius
(I assume you're figuring out how to use the fbi?)


[5/31/2023 10:13 PM] szybet
https://tenor.com/view/penguin-fbi-eating-chips-this-is-interesting-gif-17852480

{Embed}
https://tenor.com/view/penguin-fbi-eating-chips-this-is-interesting-gif-17852480
/mnt/data/projects/git/conversations/media/penguin-fbi-28C0C.png


[5/31/2023 10:14 PM] andi15701
fbi = tool to display an image on a framebuffer


[5/31/2023 10:14 PM] andi15701
probably also a lot of alternatives around


[5/31/2023 10:15 PM] szybet
stock kernel uses a more generic framebuffer, so fbink is not needed?


[5/31/2023 10:16 PM] kuratius
is dumping the framebuffer useful?


[5/31/2023 10:17 PM] andi15701
convert -size 1024x758 gradient:white-black gray-gradient.png


[5/31/2023 10:17 PM] andi15701
drm driver uses generic interface


[5/31/2023 10:17 PM] andi15701
so the special ioctls will fail


[5/31/2023 10:18 PM] andi15701
as long as fbink does not choke if those ioctl fail, it should also work


[5/31/2023 10:19 PM] kuratius
scp dk-x86@172.16.42.1:/dev/fb0 framebufferdump
dk-x86@172.16.42.1's password: 
this did not work
hexdump /dev/fb0 gave me something


[5/31/2023 10:19 PM] andi15701
pmos-clara:~$ apk search fbi
directfb-1.7.7-r6
fbida-2.14-r4
fbida-doc-2.14-r4
fbida-exiftran-2.14-r4
fbida-fbgs-2.14-r4
fbida-fbi-2.14-r4
fbida-ida-2.14-r4
heirloom-doctools-191015-r3


[5/31/2023 10:19 PM] andi15701
I do not think it is useful


[5/31/2023 10:20 PM] andi15701
```cat /dev/zero >/dev/fb0 ```or ```cat /dev/zero | tr '\0' '\xff' >/dev/fb0 ```


[5/31/2023 10:21 PM] andi15701
might also be interesting


[5/31/2023 10:22 PM] kuratius
I have the file, will copy it to the nia, then I assume I need to use apk to install one of those?


[5/31/2023 10:22 PM] andi15701
yes


[5/31/2023 10:22 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/gray-gradient-4895D.png


[5/31/2023 10:22 PM] kuratius
does my nia have internet?


[5/31/2023 10:23 PM] andi15701
well, you can use the connection to your desktop for internet


[5/31/2023 10:23 PM] andi15701
until wifi is fixed


[5/31/2023 10:23 PM] szybet
~~dump the content into base64 to the console, easiest and stupidiest way~~


[5/31/2023 10:24 PM] kuratius
I used scp


[5/31/2023 10:25 PM] kuratius
kobo-nia:~$ cat /dev/zero >/dev/fb0
cat: write error: No space left on device


[5/31/2023 10:25 PM] andi15701
on your desktop otherwise: echo 1 >/proc/sys/net/ipv4/ip_forward ; iptables -t nat -I POSTROUTING -o wlanX (or whatever is your outgoing interface name) -j MASQUERADE


[5/31/2023 10:26 PM] andi15701
on the nia:  add the default route


[5/31/2023 10:26 PM] andi15701
and set the nameserver to something generic


[5/31/2023 10:27 PM] kuratius
iwconfig
lo        no wireless extensions.

enp0s31f6  no wireless extensions.

wlp1s0    IEEE 802.11  ESSID: *snip*


[5/31/2023 10:28 PM] kuratius
this ?  echo 1 >/proc/sys/net/ipv4/ip_forward ; iptables -t nat -I POSTROUTING -o wlps1s0


[5/31/2023 10:28 PM] kuratius
will this be permanent or until reboot?


[5/31/2023 10:28 PM] andi15701
until reboot


[5/31/2023 10:28 PM] andi15701
-j MASQUERADE


[5/31/2023 10:28 PM] andi15701
at the end


[5/31/2023 10:29 PM] andi15701
that enables forwarding data


[5/31/2023 10:29 PM] andi15701
and replace the address of the nia with the address of your laptop in the outgoing packets


[5/31/2023 10:30 PM] andi15701
and convert it back on the other side


[5/31/2023 10:30 PM] kuratius
dk@dk-ThinkPad-E560:~$ echo 1 >/proc/sys/net/ipv4/ip_forward ; iptables -t nat -I POSTROUTING -o wlps1s0 -j MASQUERADE
bash: /proc/sys/net/ipv4/ip_forward: Permission denied
iptables v1.8.7 (nf_tables): Could not fetch rule set generation id: Permission denied (you must be root)

dk@dk-ThinkPad-E560:~$ sudo echo 1 >/proc/sys/net/ipv4/ip_forward ; iptables -t nat -I POSTROUTING -o wlps1s0 -j MASQUERADE
bash: /proc/sys/net/ipv4/ip_forward: Permission denied
iptables v1.8.7 (nf_tables): Could not fetch rule set generation id: Permission denied (you must be root)


[5/31/2023 10:31 PM] andi15701
sudo bash  might be simplier


[5/31/2023 10:31 PM] andi15701
now only echo is executed with root rights


[5/31/2023 10:31 PM] andi15701
and /proc... is opened with normal user rights


[5/31/2023 10:31 PM] kuratius
```dk@dk-ThinkPad-E560:~$ sudo sh
[sudo] password for dk: 
# echo 1 >/proc/sys/net/ipv4/ip_forward ; iptables -t nat -I POSTROUTING -o wlp1s0 -j MASQUERADE
#```


[5/31/2023 10:32 PM] andi15701
transferring files via serial: you have x/y/zmodem


[5/31/2023 10:33 PM] andi15701
often even in u-boot


[5/31/2023 10:33 PM] kuratius
what do I need on the nia now?


[5/31/2023 10:33 PM] kuratius
should I use serial instead of the usb network connection?


[5/31/2023 10:33 PM] andi15701
route add default gw 172.16.42.2


[5/31/2023 10:33 PM] andi15701
no


[5/31/2023 10:34 PM] kuratius
run this on the nia?


[5/31/2023 10:34 PM] andi15701
yes


[5/31/2023 10:34 PM] andi15701
with sudo probably


[5/31/2023 10:34 PM] andi15701
and then try to ping out


[5/31/2023 10:34 PM] andi15701
like ping 9.9.9.9


[5/31/2023 10:35 PM] kuratius
doesnt do anything


[5/31/2023 10:36 PM] kuratius
kobo-nia:~$ ifconfig
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:104 errors:0 dropped:0 overruns:0 frame:0
          TX packets:104 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:7956 (7.7 KiB)  TX bytes:7956 (7.7 KiB)

usb0      Link encap:Ethernet  HWaddr B2:F8:14:91:65:65  
          inet addr:172.16.42.1  Bcast:172.16.255.255  Mask:255.255.0.0
          inet6 addr: fe80::b0f8:14ff:fe91:6565/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1985 errors:0 dropped:0 overruns:0 frame:0
          TX packets:3045 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:133556 (130.4 KiB)  TX bytes:3557765 (3.3 MiB)

kobo-nia:~$


[5/31/2023 10:36 PM] kuratius
kobo-nia:~$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8): 56 data bytes
^C
--- 8.8.8.8 ping statistics ---
19 packets transmitted, 0 packets received, 100% packet loss


[5/31/2023 10:37 PM] kuratius
kobo-nia:~$ sudo route add default gw 172.16.42.2
 this is what I tried


[5/31/2023 10:40 PM] kuratius
aah


[5/31/2023 10:40 PM] kuratius
typo


[5/31/2023 10:40 PM] kuratius
sec


[5/31/2023 10:41 PM] kuratius
works now


[5/31/2023 10:42 PM] kuratius
doing a sudo apk update


[5/31/2023 10:42 PM] kuratius
kobo-nia:~$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8): 56 data bytes
64 bytes from 8.8.8.8: seq=0 ttl=42 time=21.593 ms
64 bytes from 8.8.8.8: seq=1 ttl=42 time=20.209 ms
64 bytes from 8.8.8.8: seq=2 ttl=42 time=22.209 ms
64 bytes from 8.8.8.8: seq=3 ttl=42 time=21.560 ms
64 bytes from 8.8.8.8: seq=4 ttl=42 time=24.125 ms
64 bytes from 8.8.8.8: seq=5 ttl=42 time=20.622 ms
64 bytes from 8.8.8.8: seq=6 ttl=42 time=20.464 ms
64 bytes from 8.8.8.8: seq=7 ttl=42 time=20.553 ms
64 bytes from 8.8.8.8: seq=8 ttl=42 time=20.685 ms
64 bytes from 8.8.8.8: seq=9 ttl=42 time=20.028 ms
64 bytes from 8.8.8.8: seq=10 ttl=42 time=20.928 ms
^C
--- 8.8.8.8 ping statistics ---
11 packets transmitted, 11 packets received, 0% packet loss
round-trip min/avg/max = 20.028/21.179/24.125 ms
kobo-nia:~$ sudp apk update
-ash: sudp: not found
kobo-nia:~$ sudo apk update
[sudo] password for dk-x86: 
fetch http://mirror.postmarketos.org/postmarketos/master/armv7/APKINDEX.tar.gz
WARNING: updating http://mirror.postmarketos.org/postmarketos/master: temporary error (try again later)
fetch http://dl-cdn.alpinelinux.org/alpine/edge/main/armv7/APKINDEX.tar.gz
WARNING: updating http://dl-cdn.alpinelinux.org/alpine/edge/main: temporary error (try again later)
fetch http://dl-cdn.alpinelinux.org/alpine/edge/community/armv7/APKINDEX.tar.gz
WARNING: updating http://dl-cdn.alpinelinux.org/alpine/edge/community: temporary error (try again later)
fetch http://dl-cdn.alpinelinux.org/alpine/edge/testing/armv7/APKINDEX.tar.gz
WARNING: updating http://dl-cdn.alpinelinux.org/alpine/edge/testing: temporary error (try again later)
2023-05-10 10:12:19.665948 [http://mirror.postmarketos.org/postmarketos/master]
v3.18.0-43-gd600fbc3369 [http://dl-cdn.alpinelinux.org/alpine/edge/main]
v3.18.0-38-g5514ff22960 [http://dl-cdn.alpinelinux.org/alpine/edge/community]
v3.18.0-34-g4a6a96511d5 [http://dl-cdn.alpinelinux.org/alpine/edge/testing]
0 unavailable, 4 stale; 26711 distinct packages available
kobo-nia:~$


[5/31/2023 10:42 PM] kuratius
is this supposed to happen?


[5/31/2023 10:42 PM] andi15701
no dns?


[5/31/2023 10:43 PM] andi15701
echo nameserver 9.9.9.9 | sudo tee /etc/resolv.conf


[5/31/2023 10:43 PM] kuratius
works now


[5/31/2023 10:44 PM] kuratius
kobo-nia:~$ sudo apk update
fetch http://mirror.postmarketos.org/postmarketos/master/armv7/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/main/armv7/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/community/armv7/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/edge/testing/armv7/APKINDEX.tar.gz
2023-05-31 06:28:11.406148 [http://mirror.postmarketos.org/postmarketos/master]
v3.18.0-1978-g79035b1afd5 [http://dl-cdn.alpinelinux.org/alpine/edge/main]
v3.18.0-1980-g240c7ea1d77 [http://dl-cdn.alpinelinux.org/alpine/edge/community]
v3.18.0-1976-g6e1c2423572 [http://dl-cdn.alpinelinux.org/alpine/edge/testing]
OK: 27205 distinct packages available
kobo-nia:~$ apk search fbi
directfb-1.7.7-r7
fbida-2.14-r4
fbida-doc-2.14-r4
fbida-exiftran-2.14-r4
fbida-fbgs-2.14-r4
fbida-fbi-2.14-r4
fbida-ida-2.14-r4
kobo-nia:~$


[5/31/2023 10:44 PM] andi15701
so fbida-fbi is probably the thing you need


[5/31/2023 10:46 PM] kuratius
sudo apk add fbida-fbi-2.14-r4
 ?


[5/31/2023 10:49 PM] andi15701
yes


[5/31/2023 10:49 PM] kuratius
btw this is the hexdump of the framebuffer

{Attachments}
/mnt/data/projects/git/conversations/media/fbhexdump-11FB9


[5/31/2023 10:49 PM] kuratius
I know you said it's not useful but I thought it might be neat to look at it with a normal screen


[5/31/2023 10:50 PM] kuratius
kobo-nia:~$ sudo apk add fbida-fbi-2.14-r4
ERROR: unable to select packages:
  fbida-fbi-2.14-r4 (no such package):
    required by: world[fbida-fbi-2.14-r4]
kobo-nia:~$ sudo apk add fbida-fbi-2.14-r4


[5/31/2023 10:50 PM] kuratius
confused


[5/31/2023 10:50 PM] andi15701
sorry


[5/31/2023 10:51 PM] andi15701
without version


[5/31/2023 10:51 PM] andi15701
sudo apk add fbida-fbi


[5/31/2023 10:51 PM] kuratius
kobo-nia:~$ sudo apk add fbida-fbi
The following NEW packages will be installed:
  fbida-fbi giflib
Need to download 60 KiB of packages.
After this operation, 128 KiB of additional disk space will be used.
Do you want to continue [Y/n]? 
(1/2) Installing giflib (5.2.1-r5)
(2/2) Installing fbida-fbi (2.14-r4)
Executing busybox-1.36.0-r9.trigger
OK: 851 MiB in 614 packages
kobo-nia:~$


[5/31/2023 10:53 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-713C3.txt


[5/31/2023 10:53 PM] kuratius
works


[5/31/2023 10:53 PM] kuratius
will take a photo, sec


[5/31/2023 10:53 PM] kuratius
kobo-nia:~$ ls
Desktop            fbhexdump          gray-gradient.png
kobo-nia:~$ fbi gray-gradient.png 
using "DejaVu Sans Mono-16", pixelsize=16.67 file=/usr/share/fonts/dejavu/DejaVuSansMono.ttf
trying drm: /dev/dri/card0 ...
ioctl VT_GETMODE: Not a tty
NOTICE: No vt switching available on terminal.
NOTICE: Not started from linux console?  CONFIG_VT=n?


[5/31/2023 10:56 PM] andi15701
fbi -T 1 gray-gradient.png


[5/31/2023 10:57 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/20230531_225601-21B1F.jpg


[5/31/2023 10:57 PM] kuratius
This is without T 1


[5/31/2023 10:57 PM] kuratius
What does that option do?


[5/31/2023 10:57 PM] andi15701
yes, ok if it works


[5/31/2023 10:57 PM] kuratius
Anyway, black seems to be gray


[5/31/2023 10:57 PM] andi15701
selects a virtual console


[5/31/2023 10:58 PM] kuratius
for what purpose?


[5/31/2023 10:58 PM] kuratius
ah the error I posted would go away?


[5/31/2023 10:59 PM] kuratius
in case that blocked execution?


[5/31/2023 10:59 PM] andi15701
so if a keyboard would be there, you could then switch with alt+fX


[5/31/2023 10:59 PM] andi15701
to something else


[5/31/2023 10:59 PM] kuratius
I see


[5/31/2023 10:59 PM] kuratius
what does this look like on your clara?


[5/31/2023 11:00 PM] andi15701
full black to white with steps


[5/31/2023 11:01 PM] andi15701
more steps


[5/31/2023 11:03 PM] andi15701
dst[x] = (gray >> 2) | 0xC0;


[5/31/2023 11:03 PM] kuratius
is the screen in some sort of 4-level mode?


[5/31/2023 11:03 PM] andi15701
maybe that line needs tweaking


[5/31/2023 11:03 PM] andi15701
for whatever reason it is


[5/31/2023 11:05 PM] kuratius
is the normal mode 16?


[5/31/2023 11:05 PM] kuratius
or some multiple of 4?


[5/31/2023 11:05 PM] kuratius
maybe something gets shifted wrong?


[5/31/2023 11:08 PM] andi15701
I would expect 16


[5/31/2023 11:09 PM] kuratius
this says reduced number of levels of gray


[5/31/2023 11:09 PM] andi15701
but not 4


[5/31/2023 11:10 PM] andi15701
it is should still have black


[5/31/2023 11:12 PM] kuratius
0xff (255, maybe black) -> 0x0f (15, may be gray) ?


[5/31/2023 11:12 PM] kuratius
(just as an example, the shift in this example is probably wrong)


[5/31/2023 11:14 PM] andi15701
maybe dst[x] = (gray & 0xF0) is right


[5/31/2023 11:16 PM] andi15701
but not today anymore


[5/31/2023 11:16 PM] kuratius
kk


[5/31/2023 11:17 PM] andi15701
the background is here: I am skipping the PXP here which does some magic, but that looks like a nightmare in upstreaming


[5/31/2023 11:18 PM] andi15701
I can merge together the other driver for comparison which does not skip PXP and requires the special ioctls used by fbink


[5/31/2023 11:21 PM] kuratius
pxp is  a driver and ioctls are special functions for talking to it?


[5/31/2023 11:21 PM] kuratius
or something?


[5/31/2023 11:31 PM] kuratius
is this a byte that gets transmitted?
so for example in this example it would refresh the entire screen with gray and zero the last 4 bits so that it maps 256 to 16 colors, while for the old one it just shifted by 2, resulting in black becoming gray instead of reducing the amount of levels


[5/31/2023 11:33 PM] kuratius
how many pixels does every byte control?


[5/31/2023 11:33 PM] kuratius
1 or more?


[5/31/2023 11:34 PM] andi15701
at that place, one byte per pixel


[5/31/2023 11:35 PM] andi15701
that byte is processed by the epdc into something called working buffer, where we have 16bit per pixel, also containing history


[5/31/2023 11:35 PM] andi15701
and that is just in combination with the waveform data to update the screen


[5/31/2023 11:36 PM] kuratius
the screen I recently bought had every byte controlling 8 pixels (and their code example doesnt work right, it results in this, I decoded it manually, it's supposed to be a pillow advertisement)

{Attachments}
/mnt/data/projects/git/conversations/media/AJFCJaVkyucH-sBL1ai0F7RVSaWjHaltJKlUUrW3dg-1FD77.png


[5/31/2023 11:37 PM] kuratius
400x300 screen, has a micropython code example that runs on a pi pico and the hardcoded sample image is 15000 bytes (so, times 8 is 120000=400x300 pixel)


[5/31/2023 11:38 PM] kuratius
probably a bit off-topic though


[5/31/2023 11:39 PM] kuratius
since it's a different eink screen


[5/31/2023 11:40 PM] kuratius
(this is the screen from the openbook project, I bougt just the screen to play around with it, didnt build the openbook and might not finish it)


[5/31/2023 11:40 PM] kuratius
will see about contacting the support of the manufacturer


[5/31/2023 11:40 PM] kuratius
maybe it's just a defective screen


[5/31/2023 11:40 PM] kuratius
or a bad contact somewhere with the pico gpios


[6/1/2023 1:18 AM] kuratius
BTW was interrupting fbi with ctrl c supposed to result in a segfault?


[6/1/2023 1:19 AM] kuratius
It is weird to end a program by making it crash


[6/1/2023 7:24 AM] andi15701
PXP: Pixel pipeline, a module in the SoC doing color transformations, alpha blending and also (on 6sll and 6ull some waveform magic)


[6/1/2023 7:25 AM] andi15701
chapter 41.8 in the 6ULL manual


[6/1/2023 7:26 AM] andi15701
ioctl: talking from userspace with devices, other than direct reads/writes


[6/5/2023 11:08 PM] andi15701
https://wiki.postmarketos.org/wiki/Compiling_kernels_with_envkernel.sh

{Embed}
https://wiki.postmarketos.org/wiki/Compiling_kernels_with_envkernel.sh
Compiling kernels with envkernel.sh


[6/5/2023 11:08 PM] andi15701
how to speed up experimenting with different kernels


[6/6/2023 6:10 PM] kuratius
I asssume I need to set this up so that I can make my own modifications for the display driver and test them relatively quickly?


[6/6/2023 6:11 PM] kuratius
or is this about the wifi thing?


[6/6/2023 6:11 PM] kuratius
or just in general as useful information to have?


[6/6/2023 6:11 PM] andi15701
So we do not need to update the kernel package in pmaports


[6/6/2023 6:12 PM] andi15701
to make testing faster


[6/6/2023 6:12 PM] andi15701
in general


[6/6/2023 6:14 PM] kuratius
so selecting a kernel -> clara kernel 
preparing the source directory -> download clara kernel, apply patches (if any)
compile kernel ->just run the commands there
run the kernel ->just run the commands there to flash it


[6/6/2023 6:15 PM] andi15701
yes


[6/6/2023 6:16 PM] kuratius
should I try this now?


[6/10/2023 11:16 AM] kuratius
is there an easy way to replace/modify this function for debugging purposes? so that only a binary has to be recompiled for testing?


[6/10/2023 11:17 AM] kuratius
or do we need to modify the kernel every time?


[6/10/2023 9:08 PM] kuratius
I should probably look at fbink


[6/11/2023 10:59 PM] kuratius
may not be super useful, but I compiled fbink on the nia and ran it

{Attachments}
/mnt/data/projects/git/conversations/media/message-34232.txt


[6/12/2023 12:46 PM] kuratius
is there a reason we cant use this function? ```
+static void epdc_from_rgb_clear_lower_nibble(struct drm_rect *clip,
+                         void *vaddr, int pitch,
+                         u8 *dst, int dst_pitch)
+{
+    unsigned int x, y;
+
+    dst += clip->y1 * dst_pitch;
+
+    for (y = clip->y1; y < clip->y2; y++, dst += dst_pitch) {
+        u32 *src;
+
+        src = vaddr + (y * pitch);
+        src += clip->x1;
+        for (x = clip->x1; x < clip->x2; x++) {
+            u8 r = (*src & 0x00ff0000) >> 16;
+            u8 g = (*src & 0x0000ff00) >> 8;
+            u8 b =  *src & 0x000000ff;
+
+            /* ITU BT.601: Y = 0.299 R + 0.587 G + 0.114 B */
+            u8 gray = (3 * r + 6 * g + b) / 10;
+
+            /*
+             * done in Tolino 3.0.x kernels via PXP_LUT_AA
+             * needed for 5 bit waveforms
+             */
+
+            dst[x] = gray & 0xF0;
+            src++;
+        }
+    }
+} ```


[6/12/2023 12:47 PM] kuratius
https://lore.kernel.org/lkml/20220206080016.796556-1-andreas@kemnade.info/T/


[6/12/2023 1:41 PM] kuratius
so the bitwise or would copy the last 6 bits of whatever value is left after the bitshift
so there should be 6 bits left for displaying gray values (is this a contradiction? the other function mentions 5 bit stuff)
since the operation in the other function is identical

{Attachments}
/mnt/data/projects/git/conversations/media/image-EA759.png


[6/12/2023 1:41 PM] kuratius
also I made this

{Attachments}
/mnt/data/projects/git/conversations/media/z6GHJIkKZCeeeYZcnJyPDDDzl27BgdHR309vaSmZlJ-E65F0.png


[6/12/2023 1:46 PM] kuratius
(there might be some mistakes with this, I'll play around some more)


[6/12/2023 1:58 PM] kuratius
```
import numpy as np
import matplotlib.pyplot as plt
plt.figure(dpi=200, facecolor="w")
gray=np.linspace(0,2**8-1,2**8) #generates array with values 0 to 2^8-1, total 2^8 values


output=[int(color)>>2 for color in gray]
plt.plot(gray,output ,label="gray >>2 ")

output=[(int(color)>>2)&0xF0 for color in gray]
plt.plot(gray,output, label="(gray >> 2) & 0xF0")


output=[(int(color)>>2)&0x0F for color in gray]
plt.plot(gray,output, label="(gray >> 2)& 0x0F")
plt.legend()




putput=[((int(color)>>2) | 0xC0) for color in gray]
plt.plot(gray,output, label="(gray >> 2) | 0xC0")

output=[((int(color)>>2) | 0xC0)-0xC0 for color in gray]
#plt.plot(gray,output, label="bit wise or 0xC0 but shifted")
plt.legend()
plt.xlabel("gray")
plt.ylabel("value written to dst[x]")
```


[6/12/2023 1:59 PM] kuratius
wtf

{Attachments}
/mnt/data/projects/git/conversations/media/1JZWZkuXbr022elpaVyu90mVQQAwNHcAIAAFjKoUOH-2B429.png


[6/12/2023 2:00 PM] kuratius
I'll assume src is a 32 bit px value from the image


[6/12/2023 2:01 PM] kuratius
(just talking to myself)


[6/12/2023 2:01 PM] kuratius
nope


[6/12/2023 2:01 PM] kuratius
that is weird


[6/12/2023 2:10 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-289FE.png


[6/12/2023 2:10 PM] kuratius
so it's a 32 bit int that stores all 3 colors concatenated


[6/12/2023 2:16 PM] kuratius
it also returns a unique value for every pixel
but this value is not a 0 to 255 value, it is just a 192 to 255 value


[6/12/2023 2:16 PM] kuratius
so basically 6 bit value, i.e. 63 colors


[6/12/2023 2:17 PM] kuratius
that should be wrong for 16-level greyscale mode


[6/12/2023 2:17 PM] kuratius
since 63 is 2**6-1


[6/12/2023 2:46 PM] kuratius
assuming it was still a byte per pixel, then it should be fine to just leave out the bitwise OR


[6/12/2023 3:07 PM] kuratius
```
import numpy as np
import matplotlib.pyplot as plt
plt.figure(dpi=200, facecolor="w")
x=np.linspace(0,2**32-1,2**8)
for src in x:
    r=(int(src) & 0x00ff0000) >> 16

    g = (int(src) & 0x0000ff00) >> 8

    b=int(src) & 0x000000ff
    gray = (3 * r + 6 * g + b) // 10
    print(r,g,b, " -> ",gray, " -> " , (gray >>2) & 0xF0)

#(3*((int(src) & 0x00ff0000) >> 16)+6*((int(src) & 0x0000ff00) >> 8)+int(src) & 0x000000ff)//10
    
y=[(((3*((int(src) & 0x00ff0000) >> 16)+6*((int(src) & 0x0000ff00) >> 8)+(int(src) & 0x000000ff))//10) >>2) | 0xC0 for src in x]
plt.plot(x,y, label="gray >>2 | 0xC0")
plt.legend()
    
y=[(((3*((int(src) & 0x00ff0000) >> 16)+6*((int(src) & 0x0000ff00) >> 8)+(int(src) & 0x000000ff))//10) >>2) & 0xF0 for src in x]
plt.plot(x,y, label="gray >>2 & 0xF0")

    
y=[(((3*((int(src) & 0x00ff0000) >> 16)+6*((int(src) & 0x0000ff00) >> 8)+(int(src) & 0x000000ff))//10) >>2) & 0xFF for src in x]
plt.plot(x,y, label="gray >>2 & 0xFF")
plt.legend()

    
y=[(((3*((int(src) & 0x00ff0000) >> 16)+6*((int(src) & 0x0000ff00) >> 8)+(int(src) & 0x000000ff))//10) >>2) & 0x0F for src in x]
plt.plot(x,y, label="gray >>2 & 0x0F")
plt.legend()


y=[(((3*((int(src) & 0x00ff0000) >> 16)+6*((int(src) & 0x0000ff00) >> 8)+(int(src) & 0x000000ff))//10) )&0xF0  for src in x]
plt.plot(x,y, label="gray & 0xF0")

y=[(((3*((int(src) & 0x00ff0000) >> 16)+6*((int(src) & 0x0000ff00) >> 8)+(int(src) & 0x000000ff))//10) )&0x0F  for src in x]
plt.plot(x,y, label="gray & 0x0F")
plt.legend()```


[6/12/2023 3:07 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/8d6KznGmv6yQAAAABJRU5ErkJggg-D4E52.png


[6/12/2023 3:07 PM] kuratius
I would say the purple line looks right


[6/12/2023 3:12 PM] kuratius
the other ones either cover a wrong range (0 zo 63 or 192 to 255) or have the wrong levels


[6/12/2023 3:19 PM] kuratius
if it were the case that the display needs a 6 bit value then it should be possible to run 64 level greyscale


[6/12/2023 3:20 PM] kuratius
if it were the case that it needs a 5 bit value (like in the comment of the other function) then it should only run 32 level greyscale


[6/12/2023 4:29 PM] kuratius
one sec, (255, 255,255) should map to a 24 bit value


[6/12/2023 4:29 PM] kuratius
will redo


[6/12/2023 4:31 PM] kuratius
doesnt change anything


[6/13/2023 11:50 AM] andi15701
maybe we can


[6/13/2023 11:55 AM] andi15701
on the clara we cant


[6/13/2023 11:56 AM] andi15701
on every mx6sl device we can


[6/13/2023 11:59 AM] andi15701
not oring |0xc0 keeps some history and causes ugly distortions on the clara


[6/13/2023 11:59 AM] andi15701
FBInk: I will put together another kernel


[6/13/2023 12:00 PM] andi15701
which should fully work with FBInk


[6/13/2023 7:30 PM] andi15701
feel free to play around with the 0xC0 thing


[6/13/2023 7:31 PM] andi15701
we need to modify the kernel each time


[6/13/2023 7:31 PM] andi15701
with some luck, just exchanging the module might work


[6/13/2023 7:32 PM] ninuje
random idea: vcom issue, waveform issue, waveform mode issue


[6/13/2023 7:32 PM] ninuje
IIRC, the Nia supports Eclipse waveforms


[6/13/2023 7:32 PM] ninuje
so the blob might be different, and/or the indexes


[6/13/2023 7:32 PM] ninuje
The display bus width may also be different from what you're used to


[6/13/2023 7:33 PM] ninuje
(can check via the NTX HWConfig blob, or ntx_hwconfig)


[6/13/2023 7:33 PM] kuratius
I don't actually know where to look for that function, so that's step 1 .

Step 2 is either running a modified  build script or the steps from the wiki article you linked


[6/13/2023 7:34 PM] kuratius
If I had to guess Nia is in a 16 color mode and we are only are inputting a 6 bit value to something that expects 8 bits
That'd be my guess


[6/13/2023 7:34 PM] ninuje
(i.e., if you were actually ending up using DU4 instead of GC, that would do what you're seeing pretty much spot on)


[6/13/2023 7:35 PM] andi15701
drivers/gpu/drm/mxc-epdc/epdc_update.c


[6/13/2023 7:36 PM] kuratius
Does an eclipse waveform have special properties?

What's DU4/GC?


[6/13/2023 7:37 PM] szybet
what


[6/13/2023 7:37 PM] szybet
what propblem is here going on


[6/13/2023 7:38 PM] kuratius
(Please interpret  this as me asking what an eclipse waveform is)


[6/13/2023 7:38 PM] ninuje
They're the white-on-black optimized ones


[6/13/2023 7:38 PM] ninuje
(i.e., nightmode)


[6/13/2023 7:38 PM] ninuje
Which involved a minor bit of driver churn, and quite possibly more churn in the waveform blob format


[6/13/2023 7:40 PM] ninuje
And in the process, they introduced a DU4 mode (unrelated to eclipse), but it's a 4-color mode


[6/13/2023 7:40 PM] kuratius
churn being modifications?


[6/13/2023 7:40 PM] ninuje
Yes


[6/13/2023 7:40 PM] andi15701
so i updated the nia test branch


[6/13/2023 7:40 PM] andi15701
you can now proceed according to the wiki


[6/13/2023 7:41 PM] andi15701
ommit 24762ed56e18568839865d61d99540261f897464 (HEAD -> kobo/nia-test, mygithub/kobo/nia-test)
Author: Andreas Kemnade <andreas@kemnade.info>
Date:   Tue Jun 13 19:39:48 2023 +0200

    test waveform lower 4bit


[6/13/2023 7:41 PM] ninuje
0xAA & 0x55 being the aforementioned "colors" in addition to 0x00 & 0xFF for those modes


[6/13/2023 7:42 PM] kuratius
But black would still be black


[6/13/2023 7:42 PM] ninuje
i.e., ntx_hwconfig -l -s /dev/mmcblk0


[6/13/2023 7:42 PM] ninuje
Yes


[6/13/2023 7:42 PM] kuratius
We have 4 levels of gray and no black


[6/13/2023 7:43 PM] ninuje
Oh, missed that 😉


[6/13/2023 7:43 PM] andi15701
lets just check that fix


[6/13/2023 7:43 PM] ninuje
vcom might still be relevant, though, as it can murder contrast


[6/13/2023 7:43 PM] andi15701
do you manage to compile the kernel or should I update the pmaports?


[6/13/2023 7:44 PM] kuratius
When I have a blinking cursor the cursor swaps between white grey black rapidly


[6/13/2023 7:44 PM] andi15701
the first one would be a quicker turnaround


[6/13/2023 7:44 PM] kuratius
I will try at least once, it's probably worth learning


[6/13/2023 7:45 PM] kuratius
Might be useful for future stuff too


[6/13/2023 7:45 PM] andi15701
yes


[6/13/2023 7:46 PM] kuratius
That's why I think it's probably not voltage


[6/13/2023 7:46 PM] kuratius
But anyway kernel first


[6/13/2023 7:48 PM] kuratius
I have the kernel repo downloaded, and I have pulled to get the latest commit


[6/13/2023 7:48 PM] kuratius
sec looking at wiki


[6/13/2023 7:49 PM] andi15701
if (priv->rev >= 30) {
                if (priv->buf_pix_fmt == EPDC_FORMAT_BUF_PIXEL_FORMAT_P5N) {
                        /* 110 00101 0101 0100*/
                        epdc_write(priv, EPDC_WB_FIELD2, 0xc554);
                        /* 101 00000 0000 0100*/
                        epdc_write(priv, EPDC_WB_FIELD1, 0xa004);
                } else {
                        /* 110 00101 0101 0100*/
                        epdc_write(priv, EPDC_WB_FIELD2, 0xc443);
                        /* 101 00000 0000 0100*/
                        epdc_write(priv, EPDC_WB_FIELD1, 0xa003);
                }
        }


[6/13/2023 7:49 PM] andi15701
that is also a scary piece of code


[6/13/2023 7:50 PM] andi15701
I would really like to understand what I am really doing there.


[6/13/2023 7:51 PM] andi15701
documentation is catastrophic


[6/13/2023 7:52 PM] kuratius
envkernel.sh is where?


[6/13/2023 7:53 PM] andi15701
pmbootstrap/helpers/envkernel.sh


[6/13/2023 7:53 PM] kuratius
ty


[6/13/2023 7:54 PM] kuratius
cd nia/linux/ 
../../pmbootstrap/helpers/enkernel.sh

like this?


[6/13/2023 7:54 PM] andi15701
yes


[6/13/2023 7:54 PM] andi15701
23.4.7 Working Buffer Field Setting (EPDC_WB_FIELD0)
specify the pixel fields mapping from working buffer to lut index : WB[FROM
+LEN:FROM] =>LUT [TO+LEN:TO]
Address: 228_C000h base + 60h offset = 228_C060h
   Bit    31   30     29     28      27     26   25 24 23 22    21    20 19 18     17   16
    R
    W
                              FIXED                             Reserved         USE_FIXED
Reset     0    0      0      0       0      0    0  0  0  0     0      0 0  0      0    0
   Bit    15   14     13     12      11     10    9  8  7  6     5     4 3   2     1    0
    R
    W
             USAGE                        FROM               TO                LEN
Reset     1    0      0      0       1      0    1  0  1  0     1      0 0  1      0    1


[6/13/2023 7:55 PM] andi15701
EPDC_WB_FIELD0 field descriptions
   Field                                                     Description
  31–24   used to either force field into a fixed value, or compare to wb field to mask off the pixel
  FIXED
  23–18   This field is reserved.
     -    Reserved
  17–16   usage of the FIXED value
USE_FIXED
          00    NO_FIXED — not using FIXED field
          01    USE_FIXED — set this field to a FIXED value which specified by FIXED[31:24]
          10    NE_FIXED — mask off this pixel if this field is non equal to FIXED[31:24]
          11    EQ_FIXED — mask off this pixel if this field is equal to FIXED[31:24]
  15–13   000    NOT_USED — NOT USED
 USAGE    011    PARTIAL — PARTIAL (won't contribute to lut lookup index)
          100    LUT — LUT
          101    CP — CP
          110    NP — NP
          111    PTS — PTS
   12–8   Source Field's LSB
  FROM
    7–4   Target Field's LSB
    TO
   LEN    Field length minus 1 (0x0 means length=1, 0xf means length=16)


[6/13/2023 7:55 PM] kuratius
is the source command from the wiki article doing something special?


[6/13/2023 7:55 PM] andi15701
so what is CP, what NP


[6/13/2023 7:56 PM] andi15701
well, source means the script is exactly executed as it would be typed in the shell


[6/13/2023 7:56 PM] andi15701
if you would execute it without source


[6/13/2023 7:57 PM] andi15701
env variables set would only affect that subshell being started for execution of the script


[6/13/2023 7:57 PM] andi15701
so if you set like CC=something


[6/13/2023 7:57 PM] kuratius
dk@dk-ThinkPad-E560:~/nia/linux$ source ../../pmbootstrap/helpers/envkernel.sh 
Initializing Alpine chroot (details: 'pmbootstrap log')
[sudo] password for dk: 
pmbootstrap envkernel.sh activated successfully.
 * kernel source:  /home/dk/nia/linux
 * output folder:  /home/dk/nia/linux/.output
 * architecture:   arm (kobo-nia is armv7)
 * cross compile:  armv7-alpine-linux-musleabihf-gcc (Alpine 12.2.1_git20220924-r10)
 * aliases: make, kernelroot, pmbootstrap, pmbroot, run-script (see 'type make' etc.)
 * run 'deactivate' to revert all env changes
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$


[6/13/2023 7:58 PM] andi15701
looks sane


[6/13/2023 7:59 PM] kuratius
def config is where?


[6/13/2023 8:00 PM] andi15701
.local/var/pmbootstrap/cache_git/pmaports/device/testing/linux-kobo-clara-mainline/config-kobo-clara-mainline.armv7


[6/13/2023 8:03 PM] kuratius
is there  a filename I should use for the copy?

{Attachments}
/mnt/data/projects/git/conversations/media/message-56D5F.txt


[6/13/2023 8:03 PM] kuratius
or is it arbitrary?


[6/13/2023 8:03 PM] kuratius
(this is output from pressing tab so I can see the files there)


[6/13/2023 8:04 PM] kuratius
kobo_defconfig maybe?


[6/13/2023 8:06 PM] kuratius
probably arbitrary


[6/13/2023 8:07 PM] kuratius
called it kobo_nia_defconfig


[6/13/2023 8:08 PM] kuratius
running make


[6/13/2023 8:10 PM] andi15701
I do not think you need the post-make.sh thing


[6/13/2023 8:10 PM] andi15701
You will not have the wifi driver


[6/13/2023 8:10 PM] andi15701
but that is another contruction side


[6/13/2023 8:11 PM] kuratius
dtbtool needed?


[6/13/2023 8:11 PM] kuratius
or also not?


[6/13/2023 8:11 PM] kuratius
aaah


[6/13/2023 8:11 PM] kuratius
nevermind


[6/13/2023 8:11 PM] kuratius
they are the same


[6/13/2023 8:12 PM] kuratius
I'll wait for the compile and then do the next step with pmbootstrap and the sd card


[6/13/2023 8:12 PM] andi15701
and I will have a swim in the nearby river


[6/13/2023 8:13 PM] kuratius
I cant tell if you're serious or making some kind of joke


[6/13/2023 8:13 PM] kuratius
anyway have fun


[6/13/2023 8:15 PM] kuratius
pmbootstrap build --envkernel linux-kobo-clara-mainline
pmbootstrap sideload linux-kobo-clara-mainline
pmbootstrap flasher flash_kernel (with sd card connected?)


[6/13/2023 8:15 PM] kuratius
does this look right?


[6/13/2023 8:16 PM] kuratius
or a pmboostrap install command with the path to the sd card?


[6/13/2023 8:16 PM] kuratius
It seems like the flasher would need to know the sd card wouldnt it?


[6/13/2023 8:31 PM] kuratius
do you know what pts is?


[6/13/2023 8:33 PM] kuratius
CP and NP isnt something like color primaries and non primaries right?


[6/13/2023 9:53 PM] andi15701
sideload should be enough


[6/13/2023 10:00 PM] kuratius
pmbootstrap build --envkernel linux-kobo-clara-mainline running this now


[6/13/2023 10:00 PM] kuratius
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ pmbootstrap build --envkernel linux-kobo-clara-mainline
[21:59:23] WARNING: package devicepkg-dev: aport version 0.14.3-r0 is lower than 0.14.3-r1 from the binary repository. 0.14.3-r1 will be used when installing devicepkg-dev. See also: <https://postmarketos.org/warning-repo2>
[21:59:24] WARNING: package binutils-armv7: aport version 2.40-r5 is lower than 2.40-r11 from the binary repository. 2.40-r11 will be used when installing binutils-armv7. See also: <https://postmarketos.org/warning-repo2>
[21:59:24] (native) install bash bc bison devicepkg-dev findutils flex gmp-dev lzop mpc1-dev mpfr-dev openssl-dev perl binutils-armv7
[sudo] password for dk: 
[21:59:41] (native) build armv7/linux-kobo-clara-mainline-6.3.0_p20230613215921-r0.apk
[22:00:03] NOTE: The failed command's output is above the ^^^ line in the log file: /home/dk/.local/var/pmbootstrap/log.txt
[22:00:03] ERROR: Command failed (exit code 1): (native) % cd /home/pmos/build; busybox su pmos -c CARCH=armv7 CHOST=armv7 CBUILD=x86_64 SUDO_APK='abuild-apk --no-progress' HOME=/home/pmos abuild rootpkg
[22:00:03] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$


[6/13/2023 10:01 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-B2DA9.txt


[6/13/2023 10:01 PM] kuratius
check if the sideload command works


[6/13/2023 10:02 PM] andi15701
damn


[6/13/2023 10:02 PM] andi15701
it searches for the wifi thing


[6/13/2023 10:02 PM] kuratius
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ pmbootstrap sideload linux-kobo-clara-mainline
[22:02:26] Copying packages to dk-x86@172.16.42.1
^C
Caught KeyboardInterrupt, exiting …
 ooooh


[6/13/2023 10:02 PM] kuratius
one sec


[6/13/2023 10:02 PM] kuratius
didnt realize it needed to be via ssh


[6/13/2023 10:03 PM] andi15701
packaging did not work


[6/13/2023 10:03 PM] andi15701
install -Dm644 "$_rtl8189fs_dir"/8189fs.ko "$pkgdir/lib/modules/$(make -s O="$_outdir" ARCH="$_carch" kernelrelease)/kernel/drivers/net/wireless"


[6/13/2023 10:03 PM] kuratius
so the sideload command probably wont?


[6/13/2023 10:03 PM] andi15701
the offending line in


[6/13/2023 10:03 PM] andi15701
correct


[6/13/2023 10:04 PM] andi15701
.local/var/pmbootstrap/cache_git/pmaports/device/testing/linux-kobo-clara-mainline/APKBUILD


[6/13/2023 10:05 PM] kuratius
that is a folder right?


[6/13/2023 10:05 PM] kuratius
is this a command or a line somewhere that I need to change?


[6/13/2023 10:06 PM] kuratius
cd to this directory, then run the command?


[6/13/2023 10:09 PM] andi15701
remove it


[6/13/2023 10:09 PM] andi15701
the command


[6/13/2023 10:09 PM] andi15701
in that file


[6/13/2023 10:09 PM] kuratius
btw I did not pull pmaports again in case that matters


[6/13/2023 10:09 PM] andi15701
no problem


[6/13/2023 10:09 PM] andi15701
the packaging part expects the wifi module to be built


[6/13/2023 10:09 PM] andi15701
which does not happen


[6/13/2023 10:10 PM] andi15701
in our manual build now


[6/13/2023 10:11 PM] kuratius
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ pmbootstrap build --envkernel linux-kobo-clara-mainline
[22:11:01] WARNING: package devicepkg-dev: aport version 0.14.3-r0 is lower than 0.14.3-r1 from the binary repository. 0.14.3-r1 will be used when installing devicepkg-dev. See also: <https://postmarketos.org/warning-repo2>
[22:11:01] WARNING: package binutils-armv7: aport version 2.40-r5 is lower than 2.40-r11 from the binary repository. 2.40-r11 will be used when installing binutils-armv7. See also: <https://postmarketos.org/warning-repo2>
[22:11:01] (native) install bash bc bison devicepkg-dev findutils flex gmp-dev lzop mpc1-dev mpfr-dev openssl-dev perl binutils-armv7
[22:11:01] (native) build armv7/linux-kobo-clara-mainline-6.3.0_p20230613221058-r0.apk
[22:11:03] NOTE: chroot is still active (use 'pmbootstrap shutdown' as necessary)
[22:11:03] DONE!


[6/13/2023 10:11 PM] kuratius
sideload now?


[6/13/2023 10:11 PM] andi15701
yes


[6/13/2023 10:11 PM] kuratius
with reader connected via ssh?


[6/13/2023 10:12 PM] kuratius
well usb


[6/13/2023 10:12 PM] andi15701
yes


[6/13/2023 10:12 PM] kuratius
k sec


[6/13/2023 10:13 PM] kuratius
oh it needs internet


[6/13/2023 10:13 PM] kuratius
sec


[6/13/2023 10:14 PM] kuratius
wait no


[6/13/2023 10:14 PM] kuratius
it doesnt


[6/13/2023 10:14 PM] kuratius
nice


[6/13/2023 10:15 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-372D2.txt


[6/13/2023 10:15 PM] kuratius
reboot?


[6/13/2023 10:16 PM] andi15701
yes


[6/13/2023 10:17 PM] kuratius
fully black screen


[6/13/2023 10:17 PM] kuratius
with white text


[6/13/2023 10:18 PM] kuratius
white or gray text


[6/13/2023 10:18 PM] kuratius
cant tell


[6/13/2023 10:18 PM] kuratius
but easier to read than before


[6/13/2023 10:18 PM] andi15701
and the grayscale image?


[6/13/2023 10:18 PM] kuratius
sec


[6/13/2023 10:19 PM] kuratius
looks better


[6/13/2023 10:19 PM] kuratius
give me a sec


[6/13/2023 10:21 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/20230613_222054-3C238.jpg


[6/13/2023 10:22 PM] kuratius
what did you change the function to?


[6/13/2023 10:24 PM] andi15701
ommit 24762ed56e18568839865d61d99540261f897464 (mygithub/kobo/nia-test, kobo/nia-test)
Author: Andreas Kemnade <andreas@kemnade.info>
Date:   Tue Jun 13 19:39:48 2023 +0200

    test waveform lower 4bit

diff --git a/drivers/gpu/drm/mxc-epdc/epdc_update.c b/drivers/gpu/drm/mxc-epdc/epdc_update.c
index 3a64c904ab07..38523d0e1ef7 100644
--- a/drivers/gpu/drm/mxc-epdc/epdc_update.c
+++ b/drivers/gpu/drm/mxc-epdc/epdc_update.c
@@ -848,7 +848,7 @@ int mxc_epdc_send_single_update(struct drm_rect *clip, int pitch, void *vaddr,
 {
        struct update_desc_list *upd_desc;
 
-       if (priv->rev < 30) 
+       if (1) 
                epdc_from_rgb_clear_lower_nibble(clip, vaddr, pitch,
                                                 (u8 *)priv->epdc_mem_virt,
                                                 priv->epdc_mem_width);


[6/13/2023 10:24 PM] kuratius
after interrupting there is some ghosting in the area that was black before


[6/13/2023 10:24 PM] kuratius
but that might be an issue with fbi


[6/13/2023 10:24 PM] kuratius
and not our fault


[6/13/2023 10:25 PM] andi15701
I am now wondering about a better condition there


[6/13/2023 10:25 PM] andi15701
if (!format_p5n)


[6/13/2023 10:25 PM] andi15701
maybe


[6/13/2023 10:25 PM] kuratius
I dont think fbi gives back the screen to the console correctly


[6/13/2023 10:28 PM] andi15701
but at least it seems that we have full range now


[6/13/2023 10:31 PM] kuratius
was black background white text always intended?


[6/13/2023 10:31 PM] andi15701
on console, yes


[6/13/2023 10:31 PM] kuratius
then we also had wrong colors before


[6/13/2023 10:31 PM] kuratius
or maybe I am misremembering


[6/13/2023 10:31 PM] kuratius
I thought we had black text on white background


[6/13/2023 10:32 PM] kuratius
nevermind


[6/13/2023 10:32 PM] kuratius
i looked through the chat logs


[6/13/2023 10:32 PM] kuratius
I misremembered


[6/13/2023 10:32 PM] kuratius
was grey background and white text


[6/13/2023 10:33 PM] andi15701
dev_info(priv->drm.dev, "EPDC pix format: %x\n",
                 priv->buf_pix_fmt);


[6/13/2023 10:33 PM] andi15701
do you have a dmesg?


[6/13/2023 10:34 PM] andi15701
I am interesting in just that line


[6/13/2023 10:34 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-F7FF3.txt


[6/13/2023 10:34 PM] andi15701
[   14.046666] mxc_epdc 228c000.epdc: EPDC pix format: 400


[6/13/2023 10:35 PM] kuratius
what is a TCE underrun?


[6/13/2023 10:36 PM] kuratius
also did we check dmesg with the other function?


[6/13/2023 10:37 PM] andi15701
somehow the epdc does not get data fast enough


[6/13/2023 10:38 PM] andi15701
the point is that I have 500 on the clara there


[6/13/2023 10:38 PM] andi15701
so I can fix the if


[6/13/2023 10:39 PM] andi15701
because now we break kobo clara support


[6/13/2023 10:43 PM] kuratius
EPDC pix format: 400
does this have a meaning?


[6/13/2023 10:43 PM] andi15701
whether the waveform is 4 bit or 5 bit


[6/13/2023 10:43 PM] kuratius
I see


[6/13/2023 10:44 PM] andi15701
So think next: ts support


[6/13/2023 10:44 PM] kuratius
Do you think it's worth rechecking dmesg with the function we had previously?


[6/13/2023 10:44 PM] andi15701
no


[6/13/2023 10:44 PM] kuratius
k


[6/13/2023 10:44 PM] kuratius
ts?


[6/13/2023 10:44 PM] andi15701
touchscreen


[6/13/2023 10:45 PM] kuratius
ah


[6/13/2023 10:47 PM] kuratius
does the nia have access to 5 bit waveforms?


[6/13/2023 10:48 PM] andi15701
apparently not


[6/13/2023 10:48 PM] kuratius
I see


[6/13/2023 10:49 PM] kuratius
I wonder what happens if we put 0xFF instead of 0xF0


[6/13/2023 10:50 PM] kuratius
or maybe gray & 0xF8


[6/13/2023 10:50 PM] andi15701
reset-gpios = <&gpio5 7 GPIO_ACTIVE_LOW>;


[6/13/2023 10:50 PM] andi15701
maybe that should be active high


[6/13/2023 10:50 PM] andi15701
maybe not


[6/13/2023 10:51 PM] andi15701
but that might make wifi appear


[6/13/2023 10:52 PM] andi15701
ok, I know


[6/13/2023 10:52 PM] andi15701
what is missing with wifi


[6/13/2023 10:52 PM] andi15701
but more tomorrow


[6/13/2023 10:53 PM] kuratius
kk


[6/13/2023 10:53 PM] kuratius
I might try 0xF8 and see what happens


[6/13/2023 11:02 PM] kuratius
cant see a difference


[6/13/2023 11:05 PM] kuratius
Sec


[6/13/2023 11:06 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/20230613_230505-910F2.jpg
/mnt/data/projects/git/conversations/media/20230613_2220542-25D2B.jpg


[6/13/2023 11:07 PM] kuratius
So guess only 4 bit


[6/13/2023 11:11 PM] kuratius
though I'd argue cutting cutting off the last 4 bits is probably redundant


[6/13/2023 11:11 PM] kuratius
could also do 0xFF


[6/13/2023 11:14 PM] kuratius
https://hackaday.io/project/11537-nekocal-an-e-ink-calendar/log/72153-can-you-get-32-level-grayscale-out-of-an-e-ink-display btw

{Embed}
https://hackaday.io/project/11537-nekocal-an-e-ink-calendar/log/72153-can-you-get-32-level-grayscale-out-of-an-e-ink-display
Can you get 32 level grayscale out of an E-ink display? | Details |...
A quick research shows that all current commercial E-ink devices have a maximum grayscale level of 16. Is it a hardware limitation? Or is it possible to get more grayscales just like people have done on CGA, Commodore 64, GameBoy Color and many other vintage hardware that have a color limitation?

Well, the answer is yes. See my results :p



Ju...
/mnt/data/projects/git/conversations/media/7848001462176188557-F8211.jpg


[6/13/2023 11:14 PM] kuratius
probably not worth the effort but cool to know


[6/13/2023 11:16 PM] kuratius
seems to imply 5 bit color is purely a software issue


[6/13/2023 11:17 PM] kuratius
also seems interesting https://hackaday.io/project/11537-nekocal-an-e-ink-calendar/log/191001-basics-of-driving-e-paper-displays

{Embed}
https://hackaday.io/project/11537-nekocal-an-e-ink-calendar/log/191001-basics-of-driving-e-paper-displays
Basics of driving E-paper displays | Details | Hackaday.io
Introduction

Hi, how's going? I haven't written anything about this project for a long while. I was thinking about making a better version of this, that could support more displays, has an open API, support wireless communication like WiFi, LoRaWAN, etc. But I didn't have the time to pull that off. Instead, I made my code open and wrote a log t...
/mnt/data/projects/git/conversations/media/7848001462176188557-F8211.jpg


[6/14/2023 8:02 PM] kuratius
@Szybet how many levels of grey scale do you get on your nia?


[6/14/2023 8:14 PM] kuratius
I'm wondering if the default OS uses dithering to get from more gray scale levels


[6/14/2023 8:16 PM] andi15701
I plan to put together the fbdev-based driver after the touchscreen issue is solved


[6/14/2023 8:16 PM] kuratius
I also wonder if it's known where the timing is controlled


[6/14/2023 8:16 PM] andi15701
so you can experiment with fine-tuning


[6/14/2023 8:17 PM] kuratius
k


[6/14/2023 8:17 PM] kuratius
is the major difference between now and the fbdev driver that it uses the pxp? or something else?


[6/14/2023 8:19 PM] andi15701
it uses pxp and provides a special api to do more finetuning


[6/14/2023 8:19 PM] andi15701
but not the standard one


[6/14/2023 8:19 PM] andi15701
so in the longer run it is  dead end


[6/14/2023 8:27 PM] andi15701
but I think the easiest way for 32 colors would be if we would find a 5bit waveform, not using the 5th bit for some additional data for some refresh algos  (as it is done on other devices using a 5bit waveform)


[6/14/2023 8:38 PM] szybet
how do i check that


[6/14/2023 9:06 PM] kuratius
Display a test gray gradient image

I could probably install fbink on the default OS to check but I thought you might know


[6/14/2023 9:07 PM] kuratius
Example


[6/14/2023 9:17 PM] szybet
how


[6/14/2023 9:18 PM] kuratius
Presumably you have a way to display images, else you wouldn't be able to do your easter eggs

Otherwise, use fbink or install fbi


[6/14/2023 9:18 PM] kuratius
I think fbink allows displaying images


[6/14/2023 9:18 PM] kuratius
I hope I'm not wrong about that


[6/14/2023 9:19 PM] szybet
oh just a image


[6/14/2023 9:19 PM] szybet
sure


[6/14/2023 9:19 PM] szybet
tommorow


[6/14/2023 9:19 PM] kuratius
Would also be a good idea to have a screen test integrated


[6/14/2023 9:19 PM] kuratius
In general I mean


[6/14/2023 9:20 PM] kuratius
So people can check if something is wrong with the way inkbox displays on their device


[6/14/2023 9:20 PM] szybet
inkbox can display images


[6/14/2023 9:20 PM] szybet
so just loading a file


[6/14/2023 9:20 PM] szybet
¯\_(ツ)_/¯


[6/14/2023 9:21 PM] kuratius
Yeah but shipping with a gradient image by default that can be accessed using  a menu for example


[6/14/2023 9:21 PM] kuratius
Something like that


[6/14/2023 9:21 PM] kuratius
Probably not super important, but write it down somewhere


[6/14/2023 9:22 PM] kuratius
Or just directly write a function to display a gradient instead of diplaying an image


[6/14/2023 9:22 PM] kuratius
Either works


[6/14/2023 9:24 PM] szybet
diagnostics could have that


[6/14/2023 9:52 PM] ninuje
The answer will be 16, don't bother 😉


[6/14/2023 9:52 PM] ninuje
0x00, 0x11, 0x22, 0x33, ..., 0xFF


[6/14/2023 9:53 PM] ninuje
Dithering won't get you more "real" colors, but it'll make thing *look* much nicer


[6/14/2023 9:53 PM] ninuje
Especially if you dither specifically *to* this palette


[6/14/2023 9:54 PM] ninuje
(which happens automagically with ordered dithering when targeting 16c thanks to the even stride)


[6/14/2023 9:54 PM] ninuje
The PxP has dithering support (Floyd Steinberg, IIRC) and that cap is available to userland via the flags arg of the refresh ioctl, but I don't know if it's available/working on the Nia


[6/14/2023 9:55 PM] ninuje
It was on Mk. 7, for instance (e.g., Clara HD, Forma)


[6/14/2023 9:56 PM] ninuje
(It's also buggy as all hell, FWIW)


[6/14/2023 9:56 PM] ninuje
https://github.com/NiLuJe/FBInk/blob/0e3ef13149b4f6de7ce60256dfa5d2c6541e95ad/fbink.c#L2572-L2576

{Embed}
https://github.com/NiLuJe/FBInk/blob/0e3ef13149b4f6de7ce60256dfa5d2c6541e95ad/fbink.c
FBInk/fbink.c at 0e3ef13149b4f6de7ce60256dfa5d2c6541e95ad · NiLuJe/...
FrameBuffer eInker, a small tool & library to print text & images to an eInk Linux framebuffer - FBInk/fbink.c at 0e3ef13149b4f6de7ce60256dfa5d2c6541e95ad · NiLuJe/FBInk
/mnt/data/projects/git/conversations/media/FBInk-AC252


[6/14/2023 10:00 PM] kuratius
not 0x00, 0x10,... 0xF0?


[6/14/2023 10:00 PM] ninuje
Nope


[6/14/2023 10:00 PM] ninuje
0x11 is the stride


[6/14/2023 10:01 PM] kuratius
so does 0xF0 map to 0xFF or 0xEE?


[6/14/2023 10:01 PM] ninuje
(which means, yes, there's an unbalance in the white vs. black cutoff)


[6/14/2023 10:01 PM] ninuje
I'd need a kindle on hand to give you the exact LUT of the quant map


[6/14/2023 10:02 PM] ninuje
(its fbdev cmap is properly setup, unlike ntx boards ;p)


[6/14/2023 10:08 PM] kuratius
that's not immediately obvious to me


[6/14/2023 10:10 PM] kuratius
is the perceived difference between 0xEE and 0xFF different from the difference between 0x11 and 0x00?


[6/14/2023 10:12 PM] kuratius
otherwise all the levels are evenly spaced


[6/14/2023 10:23 PM] kuratius
if it is different then that should be a problem with how the screen is configured, not the amount of levels per se


[6/14/2023 10:39 PM] andi15701
0x33 vs 0x30: here only the upper bits are taken


[6/14/2023 10:39 PM] andi15701
by the controller


[6/14/2023 10:41 PM] andi15701
the & 0xF0 is only important for the 5bit waveform stuff used on imx6sl devices


[6/14/2023 10:48 PM] andi15701
convert -size 1024x758 gradient:white-black gray-gradient.png


[6/14/2023 10:53 PM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/IMG_20230614_225237-29E69.jpg


[6/14/2023 10:53 PM] kuratius
ok 16 level only


[6/14/2023 10:53 PM] kuratius
but better evenness than mine


[6/14/2023 10:54 PM] kuratius
as in, perceptually the levels look even


[6/14/2023 10:54 PM] kuratius
with the one we tested some of the gray levels blended into each other


[6/14/2023 10:55 PM] kuratius
see here


[6/15/2023 10:18 PM] andi15701
git pull on the kernel


[6/15/2023 10:18 PM] andi15701
and the envkernel method


[6/15/2023 10:18 PM] andi15701
hopefully, the wifi chip will show up


[6/15/2023 10:18 PM] andi15701
as mmc device


[6/15/2023 10:19 PM] andi15701
in /sys/bus/mmc/devices


[6/15/2023 10:30 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-2494F.txt


[6/15/2023 10:30 PM] kuratius
kobo-nia:~$ cat /sys/bus/mmc/devices/mmc
mmc0:aaaa/  mmc1:0001/
kobo-nia:~$ cat /sys/bus/mmc/devices/


[6/15/2023 10:31 PM] kuratius
kobo-nia:~$ cat /sys/bus/mmc/devices/mmc0:aaaa/
block/                hwrev                 scr
cid                   manfid                serial
csd                   name                  ssr
date                  ocr                   subsystem/
driver/               oemid                 type
dsr                   power/                uevent
erase_size            preferred_erase_size
fwrev                 rca
kobo-nia:~$ cat /sys/bus/mmc/devices/mmc1:0001/
device        info3         ocr           revision      uevent
info1         info4         power/        subsystem/    vendor
info2         mmc1:0001:1/  rca           type
kobo-nia:~$ cat /sys/bus/mmc/devices/mmc1:0001/


[6/15/2023 10:32 PM] andi15701
ok, looks nice


[6/15/2023 10:32 PM] andi15701
seems wifi is detected


[6/15/2023 10:32 PM] kuratius
which one is wifi?


[6/15/2023 10:33 PM] andi15701
the mmc1:0001 i think


[6/15/2023 10:37 PM] andi15701
[    1.617447] mmcblk0: mmc0:aaaa SC16G 14.8 GiB


[6/15/2023 10:37 PM] andi15701
yes, it is


[6/15/2023 11:20 PM] szybet
um i have doubts?


[6/15/2023 11:21 PM] kuratius
mmc0 is sd card-> mmc1 is wifi?


[6/15/2023 11:21 PM] kuratius
I thought that was the logic


[6/15/2023 11:26 PM] andi15701
yes


[6/15/2023 11:26 PM] andi15701
I added something for the touchscreen


[6/15/2023 11:27 PM] andi15701
wifi: chip is detected, but driver not there (due to this simple build process)


[6/15/2023 11:27 PM] andi15701
so a git pull again


[6/15/2023 11:28 PM] andi15701
# CONFIG_TOUCHSCREEN_EKTF2127 is not set


[6/15/2023 11:28 PM] andi15701
and that to =m


[6/15/2023 11:28 PM] andi15701
in kernel config


[6/15/2023 11:29 PM] kuratius
how do I modify that again?


[6/15/2023 11:31 PM] andi15701
edit the compiled file


[6/15/2023 11:31 PM] andi15701
the copied file


[6/15/2023 11:32 PM] andi15701
that one


[6/15/2023 11:32 PM] andi15701
and then run the make kobo_nia_defconfig command again


[6/15/2023 11:32 PM] andi15701
and compile the kernel


[6/15/2023 11:32 PM] andi15701
as usual


[6/15/2023 11:36 PM] kuratius
CONFIG_TOUCHSCREEN_EKTF2127=m is what I put into a random line


[6/15/2023 11:38 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-1EC38.txt


[6/15/2023 11:38 PM] kuratius
history


[6/15/2023 11:38 PM] kuratius
(first attempt I forgot envkernel)


[6/15/2023 11:39 PM] andi15701
you should have changed the EKTF...is not set line


[6/15/2023 11:40 PM] kuratius
oh


[6/15/2023 11:40 PM] kuratius
will redo


[6/15/2023 11:41 PM] kuratius
wait


[6/15/2023 11:41 PM] kuratius
isnt there a # in front of that?


[6/15/2023 11:41 PM] kuratius
so it's a comment anyway?


[6/15/2023 11:41 PM] kuratius
anyway, fixed the file


[6/15/2023 11:42 PM] andi15701
this "is not set" is treated a bit special


[6/15/2023 11:42 PM] andi15701
even it is a comment


[6/15/2023 11:42 PM] kuratius
recompiling


[6/15/2023 11:46 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-DDCBD.txt


[6/15/2023 11:47 PM] kuratius
kobo-nia:~$ dmesg | grep ektf
[   13.380272] input: ektf2232 as /devices/platform/soc/2100000.bus/21a0000.i2c/i2c-0/0-0015/input/input0


[6/15/2023 11:47 PM] kuratius
should I reenable xfce?


[6/15/2023 11:49 PM] kuratius
going to sleep soon


[6/15/2023 11:54 PM] andi15701
evtest


[6/15/2023 11:54 PM] andi15701
me too


[6/15/2023 11:56 PM] kuratius
kobo-nia:~$ evtest
-ash: evtest: not found
kobo-nia:~$


[6/15/2023 11:57 PM] andi15701
install it


[6/15/2023 11:57 PM] kuratius
sec


[6/15/2023 11:57 PM] andi15701
e.g. over usb


[6/15/2023 11:57 PM] andi15701
apk add evtest


[6/15/2023 11:59 PM] kuratius
(1/1) Installing evtest (1.35-r1)
Executing busybox-1.36.0-r9.trigger
OK: 950 MiB in 629 packages
kobo-nia:~$ evtest
No device specified, trying to scan all of /dev/input/event*
Not running as root, no devices may be available.
Available devices:
/dev/input/event0:    ektf2232
Select the device event number [0-0]:


[6/16/2023 12:00 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-E0461.txt


[6/16/2023 12:00 AM] kuratius
this reacts to touches


[6/16/2023 12:00 AM] kuratius
shutting it down now


[6/16/2023 6:54 PM] andi15701
does two-finger touch produce something sane?


[6/16/2023 6:56 PM] kuratius
define sane


[6/16/2023 6:57 PM] andi15701
well, two coordinates


[6/16/2023 6:58 PM] andi15701
and two fingers are recognized


[6/16/2023 6:58 PM] kuratius
will check


[6/16/2023 6:58 PM] andi15701
next I will do is updating the pmaports


[6/16/2023 6:58 PM] andi15701
so you will have the wifi driver


[6/16/2023 7:00 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-CE022.txt


[6/16/2023 7:00 PM] kuratius
this is with two fingers in opposite corners


[6/16/2023 7:00 PM] kuratius
does this look right?


[6/16/2023 7:01 PM] kuratius
I dont know how to tell if it's two fingers or one


[6/16/2023 7:01 PM] kuratius
I guess I can plot the x,y positions


[6/16/2023 7:01 PM] kuratius
sec


[6/16/2023 7:15 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/A6WNmtKCWB0CAAAAAElFTkSuQmCC-839B0.png


[6/16/2023 7:15 PM] kuratius
either I'm parsing it wrong or the output is midly insane


[6/16/2023 7:15 PM] kuratius
note that the xlim/ylims are not correct


[6/16/2023 7:16 PM] kuratius
I'll do another testrun and move a finger along the screen border and see what I get


[6/16/2023 7:22 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/l4dHy7GFAFQobjejMnqncKeSzAhcB09H8zBSwv8LFc-8BA5B.png


[6/16/2023 7:22 PM] kuratius
this is this ABS_MT_POSITION_X and ABS_MT_POSITION_Y


[6/16/2023 7:23 PM] kuratius
movement is once along the borders of the screen, then 1 diagonal movement


[6/16/2023 7:23 PM] kuratius
looks weird af


[6/16/2023 7:23 PM] kuratius
```import matplotlib.pyplot as plt
with open("testdata-filtered.txt", 'r') as f:
    lines=f.readlines()
xlist=[]
ylist=[]
for line in lines:
    i=0;
    linesplit=line.split(",");
    for token in linesplit:        
        if "ABS_MT_POSITION_X" in token:
            x=linesplit[i+1].split()[1]
            print("x",x)
            xlist.append(int(x))
        if "ABS_MT_POSITION_Y" in token:
            y=linesplit[i+1].split()[1]
            print("y",y)
            ylist.append(int(y))
            
            
        i+=1
        
print(len(xlist))
print(len(ylist))
plt.scatter(xlist[0:min(len(xlist)-4, len(ylist)-4)],ylist[0:min(len(xlist)-4, len(ylist)-4)])```


[6/16/2023 7:24 PM] kuratius
will check ABS_X and ABS_Y


[6/16/2023 7:24 PM] kuratius
if there's any particular pattern you want me to move my finger in let me know


[6/16/2023 7:26 PM] kuratius
does not look any different

{Attachments}
/mnt/data/projects/git/conversations/media/l4dHy7GFAFQobjejMnqncKeSzAhcB09H8zBSwv8LFc-018F1.png


[6/16/2023 7:26 PM] kuratius
guess I should have looked at the data, they're always identical


[6/16/2023 7:27 PM] kuratius
will try two diagonal movements


[6/16/2023 7:28 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/Dz1PZ9m2CCeeAAAAAElFTkSuQmCC-9E463.png


[6/16/2023 7:28 PM] kuratius
doesnt look too bad


[6/16/2023 7:29 PM] kuratius
the fact that the other movement doesnt come out as a rectangle is annoying though


[6/16/2023 7:29 PM] kuratius
will try tapping the screen borders


[6/16/2023 7:31 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/MrELP3HaFzGNHpA1AAAAAElFTkSuQmCC-8EF16.png


[6/16/2023 7:32 PM] kuratius
maybe it just doesnt do swipes


[6/16/2023 7:32 PM] kuratius
?


[6/16/2023 7:32 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/testdata-5DB66.txt


[6/16/2023 7:34 PM] kuratius
ideally we'd have a "tap on the square" or similar screen test tool


[6/16/2023 7:37 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/j9gVbSqJ1ZpegAAAABJRU5ErkJggg-1A25A.png


[6/16/2023 7:37 PM] kuratius
(the missing dots in the bottom right were because I had a hardcoded offset when plotting)


[6/16/2023 7:38 PM] kuratius
I guess it's sane?


[6/16/2023 7:38 PM] kuratius
disregarding swiping movements


[6/16/2023 7:39 PM] kuratius
I'll check if multitouch does anything sensible


[6/16/2023 7:42 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/wcutfZIvDrDUQAAAABJRU5ErkJggg-421DB.png


[6/16/2023 7:42 PM] kuratius
the two dots are two fingers being held still in opposite corners


[6/16/2023 7:42 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-B018F.txt


[6/16/2023 7:45 PM] kuratius
I remember reading that android touch input drivers are more accurate than the default linux ones somewhere, I wonder if someone has ported them


[6/16/2023 7:48 PM] kuratius
example of a linux device that has issues with this:
https://old.reddit.com/r/SteamDeck/comments/v0u5gs/the_actual_issues_with_steam_decks_keyboard_and/
```d) The touchscreen/trackpad driver is genuinely awful. This might warrant its own post, but the gist is that human fingers are soft, round, and flatten against a surface differently depending on angle and pressure.

Modern capacitive touchscreens/trackpads will average out the size and shape of your finger’s “area of contact” (usually circular, but it can be oval-shaped too) to determine the point you actually intended to touch.

Deck does not do this. The result is that depending on your finger’s orientation and pressure, your touches will be off by up to almost an entire centimeter. A non-keyboard symptom of this is that tapping, holding, and pressing harder on the screen will increase the surface area of your contact point—which will move the interpreted touch point around wildly, even though your finger is not actually moving. Lightly tap the same spot on the touchpad or screen in Desktop mode a handful of times and try to keep the cursor still. You can’t.

Not to mention the touch latency (especially when scrolling) is the worst of any product I’ve tried in recent memory.```

{Embed}
https://old.reddit.com/r/SteamDeck/comments/v0u5gs/the_actual_issues_with_steam_decks_keyboard_and/
r/SteamDeck - The actual issues with Steam Deck’s keyboard, and how...
429 votes and 105 comments so far on Reddit


[6/16/2023 7:51 PM] kuratius
or maybe they're same drivers and that steam deck issue was just bad hardware


[6/16/2023 7:53 PM] kuratius
anything else I should test?


[6/16/2023 7:57 PM] kuratius
maybe I just parsed the file wrong? idk


[6/16/2023 8:00 PM] kuratius
will do it again


[6/16/2023 8:02 PM] kuratius
ABS_MT_TRACKING_ID is different between these, so probably multitouch works


[6/16/2023 8:04 PM] kuratius
yeah I think the touchscreen has issues with swiping movements

{Attachments}
/mnt/data/projects/git/conversations/media/uesjBOxG8pgAAAABJRU5ErkJggg-33C43.png


[6/16/2023 8:05 PM] kuratius
it's not a phone so probably not super important


[6/16/2023 8:05 PM] kuratius
but still weird


[6/16/2023 9:27 PM] andi15701
well, I just wanted to know whether the driver works properly


[6/16/2023 11:01 PM] andi15701
and a bit of multitouch could be an issue


[6/17/2023 12:41 AM] andi15701
pushed to pmaports


[6/17/2023 12:41 AM] andi15701
so you can do it the usual way again


[6/17/2023 12:41 AM] andi15701
and hopefully have working wifi


[6/17/2023 12:59 AM] kuratius
would the sideload command work or is it better to use the usual install command?


[6/17/2023 7:49 AM] andi15701
usual install command


[6/17/2023 7:50 AM] andi15701
hmm


[6/17/2023 7:50 AM] andi15701
sildeload should work


[6/17/2023 7:50 AM] andi15701
but not the envkernel.sh stuff


[6/17/2023 11:41 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-AB5A1.txt


[6/17/2023 11:41 AM] kuratius
kobo-nia:~$ ifconfig
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

usb0      Link encap:Ethernet  HWaddr 02:76:0D:7F:41:D6  
          inet addr:172.16.42.1  Bcast:172.16.255.255  Mask:255.255.0.0
          inet6 addr: fe80::76:dff:fe7f:41d6/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:129 errors:0 dropped:0 overruns:0 frame:0
          TX packets:91 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:13578 (13.2 KiB)  TX bytes:33423 (32.6 KiB)

kobo-nia:~$


[6/17/2023 11:44 AM] kuratius
I can try the install command


[6/17/2023 11:44 AM] andi15701
do you have the 8189fs.ko module in /lib/modules ?


[6/17/2023 11:45 AM] kuratius
kobo-nia:~$ ls /lib/modules/
6.3.0
kobo-nia:~$ ls /lib/modules/6.3.0/
build                    modules.builtin.bin      modules.symbols
kernel                   modules.builtin.modinfo  modules.symbols.bin
modules.alias            modules.dep              source
modules.alias.bin        modules.dep.bin
modules.builtin          modules.order
kobo-nia:~$ ls /lib/modules/6.3.0/build 
ls: /lib/modules/6.3.0/build: No such file or directory
kobo-nia:~$ ls /lib/modules/6.3.0/kernel/
arch     crypto   drivers  fs       lib      mm       net
kobo-nia:~$ ls /lib/modules/6.3.0/kernel/lib/
crc-ccitt.ko  crypto        lzo           zlib_deflate
crc7.ko       lz4           raid6         zstd
kobo-nia:~$


[6/17/2023 11:46 AM] andi15701
find /lib/modules  -name 8189fs.ko


[6/17/2023 11:47 AM] andi15701
ok, then something did not work


[6/17/2023 11:47 AM] kuratius
kobo-nia:~$ find /lib/modules -name 8189fs.ko
kobo-nia:~$


[6/17/2023 11:47 AM] kuratius
should I try the normal install instead of sideload?


[6/17/2023 11:47 AM] andi15701
did you reset the pmaports git?


[6/17/2023 11:47 AM] kuratius
I did


[6/17/2023 11:47 AM] andi15701
and did a git pull there


[6/17/2023 11:48 AM] kuratius
waaaiit


[6/17/2023 11:48 AM] kuratius
I think I made a mistake there


[6/17/2023 11:48 AM] kuratius
<pre><font color="#4CE64C"><b>dk@dk-ThinkPad-E560</b></font>:<font color="#295FCC"><b>~/.local/var/pmbootstrap/cache_git/pmaports</b></font>$ git status
On branch kobo-nia-6.3
Your branch is behind &apos;ak/kobo-nia-6.3&apos; by 1 commit, and can be fast-forwarded.
  (use &quot;git pull&quot; to update your local branch)

nothing to commit, working tree clean
<font color="#4CE64C"><b>dk@dk-ThinkPad-E560</b></font>:<font color="#295FCC"><b>~/.local/var/pmbootstrap/cache_git/pmaports</b></font>$ 
</pre>


[6/17/2023 11:48 AM] kuratius
I did a git reset --hard


[6/17/2023 11:48 AM] kuratius
but forgot to pull again after


[6/17/2023 12:12 PM] kuratius
redid compile, redid sideload, find command doesnt find anything still


[6/17/2023 12:13 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-55096.txt


[6/17/2023 12:13 PM] kuratius
kobo-nia:~$ find /lib/modules -name 8189fs.ko
kobo-nia:~$


[6/17/2023 12:13 PM] kuratius
I will try proper install


[6/17/2023 12:16 PM] andi15701
compile using pmbootstrap buird linux-kobo-clara-mainline --force?


[6/17/2023 12:16 PM] kuratius
yes


[6/17/2023 12:18 PM] andi15701
andi@aktux:~/.local/var/pmbootstrap/packages/edge/armv7$ tar -ztvvf linux-kobo-clara-mainline-6.3.0-r5.apk 2>/dev/null | grep 818
-rw-r--r-- root/root   1465516 2023-06-17 00:20 lib/modules/6.3.0/kernel/drivers/net/wireless/8189fs.ko


[6/17/2023 12:19 PM] kuratius
should I run this?


[6/17/2023 12:20 PM] andi15701
you can try


[6/17/2023 12:21 PM] andi15701
perhaps the full path is needed in the sideload command


[6/17/2023 12:21 PM] kuratius
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/packages/edge/armv7$ tar -ztvvf linux-kobo-clara-mainline-6.3.0-r5.apk 2>/dev/null | grep 818
-rw-r--r-- root/root   1464176 2023-06-17 11:50 lib/modules/6.3.0/kernel/drivers/net/wireless/8189fs.ko
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/packages/edge/armv7$


[6/17/2023 12:21 PM] andi15701
or just copy that file over using scp and apk add it


[6/17/2023 12:21 PM] andi15701
that apk


[6/17/2023 12:21 PM] andi15701
if all fails, the full install should do the job


[6/17/2023 12:22 PM] kuratius
did the full install now


[6/17/2023 12:25 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-D3590.txt


[6/17/2023 12:25 PM] kuratius
kobo-nia:~$ find /lib/modules -name 8189fs.ko
kobo-nia:~$


[6/17/2023 12:25 PM] kuratius
I will try copying it with apk


[6/17/2023 12:26 PM] kuratius
kobo-nia:~$ ls /lib/modules/6.3.0/kernel/net/
802/        bridge/     ipv6/       netfilter/
8021q/      ipv4/       llc/        sched/
kobo-nia:~$ ls /lib/modules/6.3.0/kernel/net/


[6/17/2023 12:26 PM] kuratius
(just to check what is there before)


[6/17/2023 12:27 PM] kuratius
what command to copy the file?


[6/17/2023 12:28 PM] kuratius
do I copy the kernel or extract only the file first?


[6/17/2023 12:33 PM] kuratius
kobo-nia:~$ ls /lib/modules/6.3.0/kernel/drivers/net/
dummy.ko    macvlan.ko  phy         usb         vxlan       wireless
ipvlan      mii.ko      tun.ko      veth.ko     wireguard
kobo-nia:~$ ls /lib/modules/6.3.0/kernel/drivers/net/


[6/17/2023 12:33 PM] kuratius
btw


[6/17/2023 12:34 PM] kuratius
kobo-nia:~$ ls /lib/modules/6.3.0/kernel/drivers/net/wireless/broadcom/brcm80211
/
brcmfmac  brcmutil


[6/17/2023 12:39 PM] kuratius
also btw it still does that thing where it loads to console on first boot and loads to xfce upon second boot after install


[6/17/2023 12:39 PM] kuratius
weird


[6/17/2023 12:39 PM] kuratius
I dont remember if you said that was intended or not


[6/17/2023 12:52 PM] andi15701
well, copy over just the module


[6/17/2023 12:52 PM] andi15701
or the full apk


[6/17/2023 12:53 PM] andi15701
add install it manually via apk add


[6/17/2023 12:53 PM] andi15701
if just copying over the module you need to do a depmod


[6/17/2023 12:56 PM] kuratius
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/packages/edge/armv7$ scp linux-kobo-clara-mainline-6.3.0-r5.apk dk-x86@172.16.42.1:.
dk-x86@172.16.42.1's password: 
linux-kobo-clara-mainline-6.3.0-r5.apk        100%   10MB   1.4MB/s   00:07    
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/packages/edge/armv7$ ssh dk-x86@172.16.42.1
dk-x86@172.16.42.1's password: 
Welcome to postmarketOS! o/

This distribution is based on Alpine Linux.
First time using postmarketOS? Make sure to read the cheatsheet in the wiki:

-> https://postmarketos.org/cheatsheet

You may change this message by editing /etc/motd.
kobo-nia:~$ ls
Desktop
linux-kobo-clara-mainline-6.3.0-r5.apk
kobo-nia:~$ sudo apk add linux-kobo-clara-mainline-6.3.0-r5.apk 
[sudo] password for dk-x86:


[6/17/2023 12:56 PM] kuratius
waiting


[6/17/2023 12:56 PM] kuratius
reboot after?


[6/17/2023 12:57 PM] andi15701
nothing happens?


[6/17/2023 12:57 PM] andi15701
maybe just insmod?


[6/17/2023 12:57 PM] andi15701
or modprobe


[6/17/2023 12:57 PM] andi15701
modprobe 8189fs


[6/17/2023 12:57 PM] kuratius
it's just slow I think


[6/17/2023 12:57 PM] kuratius
now it proceeded


[6/17/2023 12:58 PM] kuratius
kobo-nia:~$ sudo apk add linux-kobo-clara-mainline-6.3.0-r5.apk 
[sudo] password for dk-x86: 

The following packages will be DOWNGRADED:
  linux-kobo-clara-mainline
After this operation, 1440 KiB of additional disk space will be used.
Do you want to continue [Y/n]? (1/1) Downgrading linux-kobo-clara-mainline (6.3.0_p20230615234309-r0 -> 6.3.0-r5)
Executing busybox-1.36.1-r1.trigger
Executing postmarketos-mkinitfs-2.1.1-r0.trigger
12:56:32.431125 Generating for kernel version: 6.3.0
12:56:32.436548 Output directory: /boot
12:56:32.438864 Unknown or no compression format set, using gzip
12:56:32.441389 == Generating initramfs ==
12:56:32.443441 - Using compression format gzip with level "default"
12:56:32.445817 - Searching for directories specified in /usr/share/mkinitfs/dirs
12:56:32.462940 -- Creating directories from: /usr/share/mkinitfs/dirs/00-initramfs-base.dirs
12:56:32.470497 - Searching for directories specified in /etc/mkinitfs/dirs
12:56:32.480850 - Searching for file lists from /usr/share/mkinitfs/files
12:56:32.486887 -- Including files from: /usr/share/mkinitfs/files/00-initramfs-base.files
12:56:32.629502 -- Including files from: /usr/share/mkinitfs/files/01-kobo-epdc-extractor.files
12:56:32.655961 -- Including files from: /usr/share/mkinitfs/files/30-postmarketos-bootsplash.files
12:56:32.708979 - Searching for file lists from /etc/mkinitfs/files
12:56:32.718585 - Searching for hook scripts from /usr/share/mkinitfs/hooks
12:56:32.723854 -- Including script: /usr/share/mkinitfs/hooks/80-start-epd.sh
12:56:32.726574 - Searching for hook scripts from /etc/mkinitfs/hooks
12:56:32.737662 - Searching for kernel modules from /usr/share/mkinitfs/modules
12:56:32.746638 -- Including modules from: /usr/share/mkinitfs/modules/00-default.modules
12:56:32.815675 - Searching for kernel modules from /etc/mkinitfs/modules
12:56:32.848383 - Writing and verifying archive:  initramfs


[6/17/2023 12:59 PM] andi15701
ok, so the file from the envkernel thing is still around


[6/17/2023 12:59 PM] andi15701
and considered newer


[6/17/2023 1:00 PM] kuratius
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/packages/edge/armv7$ ls
APKINDEX.tar.gz
device-kobo-nia-0.1-r0.apk
device-kobo-nia-0.1-r1.apk
device-kobo-nia-0.1-r2.apk
linux-kobo-clara-mainline-6.1.12-r1.apk
linux-kobo-clara-mainline-6.1.12-r2.apk
linux-kobo-clara-mainline-6.1.12-r3.apk
linux-kobo-clara-mainline-6.1.12-r4.apk
linux-kobo-clara-mainline-6.1.12-r5.apk
linux-kobo-clara-mainline-6.3.0_p20230613221058-r0.apk
linux-kobo-clara-mainline-6.3.0_p20230613225736-r0.apk
linux-kobo-clara-mainline-6.3.0_p20230615222549-r0.apk
linux-kobo-clara-mainline-6.3.0_p20230615233719-r0.apk
linux-kobo-clara-mainline-6.3.0_p20230615234309-r0.apk
linux-kobo-clara-mainline-6.3.0-r1.apk
linux-kobo-clara-mainline-6.3.0-r2.apk
linux-kobo-clara-mainline-6.3.0-r3.apk
linux-kobo-clara-mainline-6.3.0-r4.apk
linux-kobo-clara-mainline-6.3.0-r5.apk
u-boot-kobo-nia-2016.03-r0.apk
u-boot-kobo-nia-2020.10-r0.apk
u-boot-kobo-nia-2020.10-r1.apk


[6/17/2023 1:01 PM] andi15701
ok, so just rm the linux-kobo-clara-mainline-6.3.0_p2*


[6/17/2023 1:01 PM] andi15701
apparently it is considered newer


[6/17/2023 1:02 PM] kuratius
12:56:32.848383 - Writing and verifying archive:  initramfs
how long does this take?


[6/17/2023 1:03 PM] andi15701
half a minute or something


[6/17/2023 1:13 PM] kuratius
went for a shower, it's done now


[6/17/2023 1:13 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-4BC40.txt


[6/17/2023 1:13 PM] kuratius
will reboot


[6/17/2023 1:15 PM] kuratius
kobo-nia:~$ ifconfig
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:12 errors:0 dropped:0 overruns:0 frame:0
          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:864 (864.0 B)  TX bytes:864 (864.0 B)

usb0      Link encap:Ethernet  HWaddr 0E:0D:FD:02:E6:B1  
          inet addr:172.16.42.1  Bcast:172.16.255.255  Mask:255.255.0.0
          inet6 addr: fe80::b581:6040:ffb:d495/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:157 errors:0 dropped:0 overruns:0 frame:0
          TX packets:103 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:15792 (15.4 KiB)  TX bytes:18723 (18.2 KiB)

wlan0     Link encap:Ethernet  HWaddr AA:08:F0:3D:03:F1  
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

kobo-nia:~$


[6/17/2023 1:15 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-E72DC.txt


[6/17/2023 1:16 PM] kuratius
kobo-nia:~$ find /lib/modules/ -name 8189fs.ko
/lib/modules/6.3.0/kernel/drivers/net/wireless/8189fs.ko
kobo-nia:~$


[6/17/2023 1:18 PM] kuratius
based on chatlogs it took at least 5 min, possibly up to 15 min to install the apk


[6/17/2023 1:19 PM] kuratius
what should I do to test wifi?


[6/17/2023 1:24 PM] kuratius
https://wiki.alpinelinux.org/wiki/Wi-Fi

{Embed}
https://wiki.alpinelinux.org/wiki/Wi-Fi
Wi-Fi


[6/17/2023 1:24 PM] kuratius
apk add iwd


[6/17/2023 1:24 PM] kuratius
this?


[6/17/2023 1:25 PM] kuratius
will set up internet again sec


[6/17/2023 1:28 PM] kuratius
kobo-nia:~$ sudo apk add iwd
The following NEW packages will be installed:
  iwd iwd-openrc
Need to download 669 KiB of packages.
After this operation, 1416 KiB of additional disk space will be used.
Do you want to continue [Y/n]? 
(1/2) Installing iwd (2.5-r0)
ERROR: iwd-2.5-r0: temporary error (try again later)
(2/2) Installing iwd-openrc (2.5-r0)
ERROR: iwd-openrc-2.5-r0: temporary error (try again later)
2 errors; 860 MiB in 622 packages
kobo-nia:~$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8): 56 data bytes
64 bytes from 8.8.8.8: seq=0 ttl=42 time=22.332 ms
64 bytes from 8.8.8.8: seq=1 ttl=42 time=21.084 ms
64 bytes from 8.8.8.8: seq=2 ttl=42 time=21.539 ms
64 bytes from 8.8.8.8: seq=3 ttl=42 time=22.082 ms
64 bytes from 8.8.8.8: seq=4 ttl=42 time=22.476 ms
64 bytes from 8.8.8.8: seq=5 ttl=42 time=22.231 ms
64 bytes from 8.8.8.8: seq=6 ttl=42 time=23.242 ms
^C
--- 8.8.8.8 ping statistics ---
7 packets transmitted, 7 packets received, 0% packet loss
round-trip min/avg/max = 21.084/22.140/23.242 ms


[6/17/2023 1:29 PM] kuratius
was missing dns, fixed now


[6/17/2023 1:31 PM] kuratius
kobo-nia:~$ iwctl station wlan0 get-networks
this returns networks around me


[6/17/2023 1:31 PM] kuratius
iwctl station wlan0 scan
the output of this is empty


[6/17/2023 1:33 PM] kuratius
```kobo-nia:~$ iwctl station wlan0 scan
kobo-nia:~$ iwctl station wlan0 scan
Operation already in progress
kobo-nia:~$ iwctl station wlan0 scan
kobo-nia:~$ iwctl station wlan0 get-networks
                               Available networks                              
--------------------------------------------------------------------------------
      Network name                      Security            Signal
--------------------------------------------------------------------------------
      censored                         psk                 ****    
      censored                         psk                 ****    
      censored                        psk                 ****    

etc etc```


[6/17/2023 1:37 PM] andi15701
you can try to connect


[6/17/2023 1:38 PM] andi15701
or alternatively using wpa_supplicant


[6/17/2023 1:39 PM] andi15701
but it looks that things are basically working


[6/17/2023 1:41 PM] kuratius
how would do it using wpa_supplicant?


[6/17/2023 1:41 PM] andi15701
1. make sure that no iwd or other wpa_supplicant is running


[6/17/2023 1:42 PM] andi15701
or maybe try to connect to it using wpa_cli


[6/17/2023 1:42 PM] andi15701
if wpa_cli is not working: you need to kill the above-mentioned things


[6/17/2023 1:43 PM] andi15701
and run wpa_supplicant -i wlan0 -C /var/run/wpa_supplicant


[6/17/2023 1:43 PM] andi15701
wpa_cli -i wlan0


[6/17/2023 1:43 PM] andi15701
add_network


[6/17/2023 1:43 PM] andi15701
set_network 0 key_mgmt WPA-PSK


[6/17/2023 1:44 PM] andi15701
set_network 0 ssid "......"


[6/17/2023 1:44 PM] andi15701
set_network 0 psk "...."


[6/17/2023 1:44 PM] andi15701
enable_network 0


[6/17/2023 1:44 PM] andi15701
if network manager is installed, nmtui might be more handy


[6/17/2023 1:44 PM] kuratius
kobo-nia:~$ iwctl station wlan0 connect *snip*
kobo-nia:~$ iwctl station wlan0 
Invalid command

kobo-nia:~$ ifconfig
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

usb0      Link encap:Ethernet  HWaddr 0A:DE:53:EF:B3:BF  
          inet addr:172.16.42.1  Bcast:172.16.255.255  Mask:255.255.0.0
          inet6 addr: fe80::b581:6040:ffb:d495/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:542 errors:0 dropped:0 overruns:0 frame:0
          TX packets:311 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:43018 (42.0 KiB)  TX bytes:50679 (49.4 KiB)

wlan0     Link encap:Ethernet  HWaddr 22:5E:E4:5D:B3:75  
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:100 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:24305 (23.7 KiB)  TX bytes:288 (288.0 B)

kobo-nia:~$


[6/17/2023 1:45 PM] kuratius
tried iwctl first


[6/17/2023 1:45 PM] kuratius
something is still weird


[6/17/2023 1:46 PM] kuratius
ping etc doesnt work yet


[6/17/2023 1:46 PM] kuratius
I will try wpa supplicant


[6/17/2023 1:46 PM] andi15701
you need to run a dhcp client


[6/17/2023 1:46 PM] andi15701
first check network manager


[6/17/2023 1:46 PM] andi15701
iw dev wlan0


[6/17/2023 1:46 PM] andi15701
should be interesting


[6/17/2023 1:47 PM] andi15701
dhclient /udhcpc / dhcpcd


[6/17/2023 1:47 PM] andi15701
one of them


[6/17/2023 1:48 PM] kuratius
kobo-nia:~$ iw dev wlan0
-ash: iw: not found


[6/17/2023 1:49 PM] kuratius
dhclient isnt installed either I think


[6/17/2023 1:50 PM] kuratius
kobo-nia:~$ dhclient
-ash: dhclient: not found
kobo-nia:~$


[6/17/2023 1:50 PM] andi15701
but udhcpc


[6/17/2023 1:50 PM] andi15701
or dhcpcd?


[6/17/2023 1:51 PM] kuratius
kobo-nia:~$ udhcpc
udhcpc: socket(AF_INET,3,255): Operation not permitted
kobo-nia:~$


[6/17/2023 1:51 PM] andi15701
well, sudo


[6/17/2023 1:51 PM] kuratius
sec


[6/17/2023 1:52 PM] kuratius
kobo-nia:~$ sudo rc-service iwd start
[sudo] password for dk-x86: 
 * Starting iwd ...                                                       [ ok ]
kobo-nia:~$ iwctl station wlan0 connect snip
kobo-nia:~$ sudo udhcpc
udhcpc: ioctl 0x8933 failed: No such device
kobo-nia:~$ sudo udhcpc
udhcpc: ioctl 0x8933 failed: No such device
kobo-nia:~$


[6/17/2023 1:52 PM] andi15701
-i wlan0


[6/17/2023 1:52 PM] kuratius
kobo-nia:~$ sudo udhcpc -i wlan0
udhcpc: started, v1.36.1
udhcpc: broadcasting discover
udhcpc: broadcasting select for 192.168.178.122, server 192.168.178.1
udhcpc: lease of 192.168.178.122 obtained from 192.168.178.1, lease time 864000
kobo-nia:~$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8): 56 data bytes
64 bytes from 8.8.8.8: seq=0 ttl=42 time=37.570 ms
64 bytes from 8.8.8.8: seq=1 ttl=42 time=19.793 ms
^C
--- 8.8.8.8 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 19.793/28.681/37.570 ms
kobo-nia:~$


[6/17/2023 1:52 PM] kuratius
works I guess


[6/17/2023 1:53 PM] kuratius
kobo-nia:~$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8): 56 data bytes
64 bytes from 8.8.8.8: seq=0 ttl=42 time=1739.909 ms
64 bytes from 8.8.8.8: seq=1 ttl=42 time=740.444 ms
64 bytes from 8.8.8.8: seq=2 ttl=42 time=20.272 ms
64 bytes from 8.8.8.8: seq=3 ttl=42 time=20.292 ms
64 bytes from 8.8.8.8: seq=4 ttl=42 time=25.228 ms
64 bytes from 8.8.8.8: seq=5 ttl=42 time=20.553 ms
64 bytes from 8.8.8.8: seq=6 ttl=42 time=25.031 ms
64 bytes from 8.8.8.8: seq=7 ttl=42 time=19.822 ms
64 bytes from 8.8.8.8: seq=8 ttl=42 time=20.208 ms
64 bytes from 8.8.8.8: seq=9 ttl=42 time=21.100 ms
^C
--- 8.8.8.8 ping statistics ---
10 packets transmitted, 10 packets received, 0% packet loss
round-trip min/avg/max = 19.822/265.285/1739.909 ms
kobo-nia:~$


[6/17/2023 1:53 PM] kuratius
the fuck happened here


[6/17/2023 1:53 PM] kuratius
1.7 seconds


[6/17/2023 1:54 PM] andi15701
something needed to be waken up


[6/17/2023 1:54 PM] andi15701
or whatever


[6/17/2023 1:54 PM] kuratius
should I test wpa supplicant also now?


[6/17/2023 1:56 PM] kuratius
also xfce does not react right to touch inputs


[6/17/2023 1:58 PM] kuratius
there is some extremely weird thing going on where if I touch the display it shows a pulsating rectangle at the bottom of the screen


[6/17/2023 1:59 PM] kuratius
somehow managed to accidentally open a terminal with the on screen keyboard


[6/17/2023 1:59 PM] kuratius
positions are off


[6/17/2023 2:00 PM] kuratius
I cant tap on keys


[6/17/2023 2:00 PM] kuratius
sometimes if I move my finger around it accidentally hits a random key


[6/17/2023 2:03 PM] andi15701
well, you can try to calibrate the touchscreen


[6/17/2023 2:03 PM] andi15701
in general, everything seems to be roughly there


[6/17/2023 2:03 PM] andi15701
now


[6/17/2023 2:04 PM] kuratius
Tasks: 139 total,   1 running, 138 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.7 us,  3.7 sy,  0.0 ni, 95.0 id,  0.0 wa,  0.0 hi,  0.7 si,  0.0 st 
MiB Mem :    239.8 total,     14.4 free,    200.7 used,     41.1 buff/cache     
MiB Swap:      0.0 total,      0.0 free,      0.0 used.     39.1 avail Mem 

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND    
 1466 root      20   0       0      0      0 D   1.6   0.0   0:02.41 RTW_CMD_T+ 
 2960 dk-x86    20   0    3328   2688    812 R   1.3   1.1   0:00.28 top        
 2895 root      20   0       0      0      0 I   1.0   0.0   0:00.66 kworker/0+ 
 1301 root      20   0   14372   5024   3580 S   0.7   2.0   0:03.65 NetworkMa+ 
 1465 root      20   0       0      0      0 S   0.3   0.0   0:00.09 RTW_XMIT_+ 
 1142 message+  20   0    1520   1016    576 S   0.3   0.4   0:03.09 dbus-daem+ 
 1508 root      20   0  199016  39420   4904 S   0.3  16.1   0:56.35 Xorg       
   10 root      20   0       0      0      0 S   0.3   0.0   0:02.61 ksoftirqd+ 
 1747 dk-x86    20   0    4212   1972   1172 S   0.3   0.8   0:00.57 sshd       
   13 root      20   0       0      0      0 S   0.0   0.0   0:00.00 oom_reaper 
   14 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 writeback  
   15 root      20   0       0      0      0 S   0.0   0.0   0:01.50 kcompactd0 
   16 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kblockd    
   17 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 blkcg_pun+ 
    9 root      20   0       0      0      0 I   0.0   0.0   0:00.00 rcu_tasks+ 
   20 root      20   0       0      0      0 I   0.0   0.0   0:02.60 kworker/0+ 
   22 root     -51   0       0      0      0 S   0.0   0.0   0:00.00 watchdogd  
kobo-nia:~$


[6/17/2023 2:04 PM] kuratius
15-40 MB free


[6/17/2023 2:04 PM] kuratius
oof


[6/17/2023 2:04 PM] kuratius
ah well


[6/17/2023 2:05 PM] kuratius
is there a tool for that?


[6/17/2023 2:06 PM] kuratius
or do I have to parse the data from manual tests and then edit some config file?


[6/17/2023 2:09 PM] andi15701
or you can check xev


[6/17/2023 2:09 PM] kuratius
@Szybet In case you care, almost everything works in some fashion now
ram is very low
wifi works
touchscreen works but is miscalibrated
screen has full range but probably has some issues with level spacing


[6/17/2023 2:10 PM] andi15701
I can put together something with the fbdev driver


[6/17/2023 2:11 PM] andi15701
there is some tool


[6/17/2023 2:11 PM] andi15701
you probably end up with some /etc/udev/rules.d/something file


[6/17/2023 2:11 PM] kuratius
(1/1) Installing xev (1.2.5-r1)
Executing busybox-1.36.1-r1.trigger
OK: 862 MiB in 625 packages
kobo-nia:~$ xev
xev:  unable to open display ''
kobo-nia:~$


[6/17/2023 2:11 PM] andi15701
containing some LIBINPUT_ENV=something


[6/17/2023 2:11 PM] andi15701
DISPLAY=:0 xev


[6/17/2023 2:12 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-42638.txt


[6/17/2023 2:13 PM] szybet
yea i follow this thread from time to time, i know.

if any help is needed, ping me

i will make it to inkbox the moment it will be needed, or i will have the will to do it


[6/17/2023 2:14 PM] kuratius
is this supposed to react to touch input? the display reacts, but the command line output doesnt


[6/17/2023 2:15 PM] kuratius
or does xfce somehow consume the events?


[6/17/2023 2:15 PM] kuratius
how much ram does inkbox have free after boot btw?


[6/17/2023 2:20 PM] kuratius
disabled lightdm, rebooted
Tasks: 100 total,   1 running,  99 sleeping,   0 stopped,   0 zombie
%Cpu(s):  5.9 us,  5.9 sy,  0.0 ni, 88.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st 
MiB Mem :    239.8 total,    129.0 free,     61.8 used,     61.9 buff/cache     
MiB Swap:      0.0 total,      0.0 free,      0.0 used.    178.0 avail Mem


[6/17/2023 2:21 PM] kuratius
are those 60MB drivers or is the kernel that big?


[6/17/2023 2:31 PM] andi15701
well, there might be something still wrong in the driver


[6/17/2023 2:31 PM] andi15701
about coordinates


[6/17/2023 2:33 PM] andi15701
xev gets x11 events


[6/17/2023 2:33 PM] andi15701
when its window is in focus


[6/17/2023 2:34 PM] kuratius
I was running it via ssh so that may explain some parts


[6/17/2023 2:41 PM] kuratius
I wonder if there are options for stripping down the kernel


[6/17/2023 2:43 PM] kuratius
Just in terms of ram usage


[6/17/2023 5:54 PM] kuratius
May also be interesting https://pkgs.postmarketos.org/package/master/postmarketos/x86/postmarketos-ui-lxqt


[6/17/2023 5:59 PM] kuratius
Also note to self I was supposed to start working on the nia port wiki article for postmarketOS


[6/17/2023 8:45 PM] kuratius
Is it worth looking into stuff like buildroot or linux from scratch?
I'm seeing some references that fitting the kernel into 2-8MB is possible

Also apparently there is a gcc option to optimize for binary size that could be tried


[6/17/2023 8:45 PM] kuratius
gcc -Os


[6/17/2023 9:46 PM] kuratius
https://bootlin.com/pub/conferences/2017/jdll/opdenacker-embedded-linux-in-less-than-4mb-of-ram/opdenacker-embedded-linux-in-less-than-4mb-of-ram.pdf
also seems interesting


[6/17/2023 10:11 PM] kuratius
This is probably all very nia-specific tweaks since other ereaders all have 512MB or greater


[6/18/2023 8:09 PM] kuratius
btw apparently the wifi disconnects and reconnects, with a new device name every time


[6/18/2023 8:09 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-EAA28.png


[6/18/2023 8:10 PM] szybet
diffrent IP you mean


[6/18/2023 8:10 PM] kuratius
no


[6/18/2023 8:10 PM] kuratius
devicename


[6/18/2023 8:10 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-4E1E0.png


[6/18/2023 8:10 PM] szybet
hmmm okay


[6/18/2023 8:11 PM] kuratius
I left it running over night and my sister got somewhere between 20-40 mails that a new device is on the network


[6/18/2023 8:12 PM] kuratius
she doesnt live here anymore but apparently at one point we set up the router to send mails to my mom's mail address if there is a change


[6/18/2023 8:12 PM] kuratius
and my sister has guardianship of my mom so she does everything


[6/18/2023 8:12 PM] kuratius
(multiple sclerosis)


[6/18/2023 10:10 PM] andi15701
well, we can optimize for size


[6/18/2023 10:10 PM] andi15701
the kernel


[6/18/2023 10:11 PM] andi15701
and turn some things of, maybe, but most optional things are modules anyways


[6/18/2023 10:11 PM] andi15701
there are also some experiments using awesomewm


[6/18/2023 10:11 PM] andi15701
and ebookreaders


[6/18/2023 10:12 PM] andi15701
https://github.com/bjesus/air

{Embed}
https://github.com/bjesus/air
GitHub - bjesus/air: Awesome Interface for e-Readers
Awesome Interface for e-Readers. Contribute to bjesus/air development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/air-03909


[6/18/2023 11:41 PM] kuratius
https://github.com/Luukdegram/juicebox
This states that it has no dependencies except x11
Is this likely to work?

{Embed}
https://github.com/Luukdegram/juicebox
GitHub - Luukdegram/juicebox: Tiled Window Manager written in Zig
Tiled Window Manager written in Zig. Contribute to Luukdegram/juicebox development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/juicebox-071CA


[6/18/2023 11:41 PM] kuratius
(it's not an interface, I know, just looking at stuff for now)


[6/19/2023 12:09 AM] kuratius
what's the easy stuff?
The document/presentation I linked  a little bit up seems to mention a few:
gcc -Os
LTO
thumb instruction set
make tinyconfig (not sure what this is actually supposed to do, and if it would work for this)
this got it from 80 MB to 60MB in his test, so a 25 % size saving
Are there other things you know of?


[6/19/2023 12:10 AM] kuratius
has anyone benchmarked the ram usage on this? If not do you think it's worth doing?


[6/19/2023 6:59 AM] andi15701
gcc -Os = CONFIG_OPTIMIZE_FOR_SIZE


[6/19/2023 12:18 PM] kuratius
I.e. 
make CONFIG_OPTIMIZE_FOR_SIZE?
Or is that supposed to be a command?


[6/19/2023 5:38 PM] kuratius
I assume I probably need to go through the previous kernel build steps and modify the make command


[6/19/2023 6:45 PM] andi15701
it is in kernel configuration


[6/19/2023 6:46 PM] andi15701
so the kconf things


[6/19/2023 6:46 PM] andi15701
not command line


[6/19/2023 9:04 PM] kuratius
trying pmbootstrap kconfig edit linux-kobo-clara-mainline


[6/19/2023 9:05 PM] kuratius
here?


[6/19/2023 9:05 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-9D85B.png


[6/19/2023 9:06 PM] kuratius
found this also

{Attachments}
/mnt/data/projects/git/conversations/media/image-A89C0.png


[6/19/2023 9:07 PM] kuratius
aww no options


[6/19/2023 9:33 PM] andi15701
yes that first one


[6/19/2023 9:35 PM] kuratius
also apparently it's possible to build xfce with -Os too


[6/19/2023 9:36 PM] kuratius
does the kernel config do that already or does pmOS' build system do that somewhere else?


[6/19/2023 9:36 PM] kuratius
https://docs.xfce.org/xfce/4.12/building


[6/19/2023 9:36 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-1DF66.png


[6/19/2023 10:01 PM] kuratius
the sideload said it freed around 1.5Mb of disk space, I know that's not how much it uses in ram but it might not be ideal


[6/19/2023 10:09 PM] kuratius
without lightdm, with the smaller kernel
MiB Mem :    239.8 total,    133.8 free,     58.4 used,     60.5 buff/cache     
MiB Swap:      0.0 total,      0.0 free,      0.0 used.    181.4 avail Mem


[6/19/2023 10:10 PM] kuratius
with lightdm it's still like 10Mb free, I guess that just takes a lot of ram


[6/19/2023 10:10 PM] kuratius
probably not worth looking into optimizing that part


[6/19/2023 10:10 PM] kuratius
and just use an app/program with a gui instead of a DE


[6/19/2023 10:13 PM] kuratius
question: Is there some region of memory reserved for other stuff?
 239.8 total,

{Attachments}
/mnt/data/projects/git/conversations/media/image-5EFF2.png


[6/19/2023 10:14 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-DE342.png


[6/19/2023 10:15 PM] kuratius
or is this something that is not configured correctly in uboot?


[6/19/2023 10:15 PM] kuratius
or some other cause that I am overlooking?


[6/19/2023 10:20 PM] kuratius
I remember that the ram value we used was initially wrong, I wonder if it's undershooting by a little


[6/19/2023 10:21 PM] kuratius
U-Boot 2020.10-00026-ge45fdb097f (Apr 27 2023 - 22:15:30 +0200)

CPU:   Freescale i.MX6ULL rev1.1 900 MHz (running at 396 MHz)
CPU:   Commercial temperature grade (0C to 95C) at 38C
Reset cause: POR
Model: Kobo Nia
Board: MX6ULL Kobo Nia
DRAM:  256 MiB


[6/19/2023 10:21 PM] kuratius
weird


[6/19/2023 10:22 PM] kuratius
it seems set correctly here


[6/19/2023 10:22 PM] kuratius
(I looked through the chat logs from before)


[6/19/2023 10:36 PM] kuratius
also what was the stuff you mentioned before about preparing something with fbdev driver and fbink? would any of that still be interesting now that we have full range?


[6/19/2023 10:36 PM] kuratius
was this about screen in general or in relation to the touchscreen?


[6/19/2023 10:42 PM] kuratius
kobo-nia:~$ cat /proc/meminfo
MemTotal:         245572 kB
MemFree:          139548 kB
MemAvailable:     189684 kB
Buffers:           10268 kB
Cached:            47832 kB
SwapCached:            0 kB
Active:            56624 kB
Inactive:          23936 kB
Active(anon):      26436 kB
Inactive(anon):     1120 kB
Active(file):      30188 kB
Inactive(file):    22816 kB
Unevictable:           0 kB
Mlocked:               0 kB
HighTotal:             0 kB
HighFree:              0 kB
LowTotal:         245572 kB
LowFree:          139548 kB
SwapTotal:             0 kB
SwapFree:              0 kB
Dirty:                 4 kB
Writeback:             0 kB
AnonPages:         22472 kB
Mapped:            20264 kB
Shmem:              5096 kB
KReclaimable:       5232 kB
Slab:              11204 kB
SReclaimable:       5232 kB
SUnreclaim:         5972 kB
KernelStack:         784 kB
PageTables:          644 kB
SecPageTables:         0 kB
NFS_Unstable:          0 kB
Bounce:                0 kB
WritebackTmp:          0 kB
CommitLimit:      122784 kB
Committed_AS:      41596 kB
VmallocTotal:     770048 kB
VmallocUsed:        4996 kB
VmallocChunk:          0 kB
Percpu:               64 kB
CmaTotal:          65536 kB
CmaFree:           61660 kB
kobo-nia:~$


[6/19/2023 10:44 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-AE01E.png


[6/19/2023 10:44 PM] kuratius
seems wonky


[6/19/2023 10:45 PM] kuratius
is it worth trying to write a program that reads from that address or is that just not going to work to due memory virtualization and other stuff?


[6/19/2023 10:45 PM] kuratius
or is some other hardware component using that memory?


[6/19/2023 10:45 PM] kuratius
or did kobo lie?


[6/19/2023 10:46 PM] kuratius
or is uboot somehow taking this space?


[6/19/2023 10:49 PM] kuratius
I guess it would be relevant for the gray level spacing being uneven


[6/19/2023 11:41 PM] szybet
@tux-linux its 16 max


[6/19/2023 11:41 PM] szybet
no point in setting 32???


[6/19/2023 11:43 PM] tux_linux
32 makes x11 work on glo hd


[6/19/2023 11:43 PM] tux_linux
do not ask me why


[6/19/2023 11:43 PM] tux_linux
i know as much about fb depths as the current political situation in poland


[6/19/2023 11:44 PM] szybet
oh yea, its fucked


[6/19/2023 11:44 PM] szybet
;-;


[6/20/2023 7:39 AM] andi15701
[    0.000000] Memory: 176348K/262144K available (9216K kernel code, 1080K rwdata, 2576K rodata, 1024K init, 386K bss, 20260K reserved, 65536K cma-reserved, 0K highmem)


[6/20/2023 7:40 AM] andi15701
reserved: I think initramfs is in there


[6/20/2023 7:41 AM] andi15701
cma-reserved: that can probably be reduced


[6/20/2023 7:42 AM] andi15701
CONFIG_CMA_SIZE_MBYTES=64


[6/20/2023 7:43 AM] andi15701
Maybe 16 is an interesting value


[6/20/2023 7:44 AM] andi15701
9216K kernel code: that can be shrunk a bit by -Os


[6/20/2023 12:20 PM] kuratius
262144 KiB would be 256 MiB so that makes more sense


[6/20/2023 12:56 PM] kuratius
do you know where this is?


[6/20/2023 3:23 PM] kuratius
https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html#index-flto-902
Do you know why the flto flag is not available in the kconfig dialog?

{Embed}
https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html
Optimize Options (Using the GNU Compiler Collection (GCC))
Optimize Options (Using the GNU Compiler Collection (GCC))


[6/20/2023 3:23 PM] kuratius
nobody added it?


[6/20/2023 6:55 PM] szybet
hmmm do you guys here have problems with touch?


[6/20/2023 7:06 PM] kuratius
the driver is miscalibrated (range and offset) and it also has issues with swiping movements, other stuff is recognized correctly


[6/20/2023 7:06 PM] kuratius
here I parsed some of the evtest data


[6/20/2023 7:07 PM] kuratius
(it is not possible to use this in a sensible fashion yet)


[6/20/2023 7:08 PM] kuratius
the parsed data makes sense, just the driver doesnt tell the position to the os correctly


[6/20/2023 7:10 PM] kuratius
part of the issue with the responsiveness could that the system was using swap on the sd card


[6/20/2023 7:10 PM] kuratius
wait no


[6/20/2023 7:10 PM] kuratius
I went through the log, it wasnt swapping yet


[6/20/2023 7:11 PM] kuratius
but still not very responsive


[6/20/2023 7:16 PM] szybet
The touch is not very accurate, even on nickel


[6/20/2023 7:16 PM] szybet
Thats what i wanted to say


[6/20/2023 7:18 PM] kuratius
I will boot nickel when I get home


[6/20/2023 7:18 PM] kuratius
is this a new issue for you?


[6/20/2023 7:18 PM] kuratius
or has it always been that way?


[6/20/2023 7:18 PM] kuratius
I have not noticed anything super weird with mine so far


[6/20/2023 7:19 PM] kuratius
but I have not used it as an ereader beyond testing plato and koreader for a bit


[6/20/2023 7:19 PM] kuratius
koreader actually worked better than on my kindle lol


[6/20/2023 7:24 PM] andi15701
you can search with /something


[6/20/2023 7:24 PM] andi15701
in the kernel menuconfig


[6/20/2023 7:24 PM] szybet
For my nia, always, maybe its a bit better on nickel because of better ui, but still


[6/20/2023 7:25 PM] kuratius
tried that, didnt find an exact match


[6/20/2023 7:25 PM] kuratius
just stuff that looked like documentation


[6/20/2023 7:25 PM] kuratius
will try again and take a screenshot


[6/20/2023 7:26 PM] szybet
@Kitkat / Szybet ( sometimes ) has a kobo nia c, and didnt have issues on nickel


[6/20/2023 7:26 PM] andi15701
> Search (CMA_SIZE) ────────────────────────────────────────────────────────────────────────────────────┐
  │ Symbol: CMA_SIZE_MBYTES [=64]                                                                                                                                                         │  
  │ Type  : integer                                                                                                                                                                       │  
  │ Defined at kernel/dma/Kconfig:146                                                                                                                                                     │  
  │   Prompt: Size in Mega Bytes                                                                                                                                                          │  
  │   Depends on: DMA_CMA [=y] && !CMA_SIZE_SEL_PERCENTAGE [=n]                                                                                                                           │  
  │   Location:                                                                                                                                                                           │  
  │     -> Library routines                                                                                                                                                               │  
  │       -> DMA Contiguous Memory Allocator (DMA_CMA [=y])                                                                                                                               │  
  │ (1)     -> Size in Mega Bytes (CMA_SIZE_MBYTES [=64])                                                                                                                                 │  
  │


[6/20/2023 7:26 PM] szybet
Maybe its just my finger? I dont know really


[6/20/2023 7:27 PM] kuratius
found it now


[6/20/2023 7:27 PM] kuratius
ty


[6/20/2023 7:27 PM] szybet
Btw you have a nia "a* right?


[6/20/2023 7:27 PM] kuratius
I think same board revision as you but newer production date


[6/20/2023 7:27 PM] kuratius
not sure how to tell if it's a?


[6/20/2023 7:30 PM] szybet
Depends on the pmic


[6/20/2023 7:30 PM] szybet
You can send a picture of the board and i will tell you


[6/20/2023 7:31 PM] kuratius
I sent one a while ago


[6/20/2023 7:31 PM] kuratius
if you want to know now, just search


[6/20/2023 7:31 PM] kuratius
not home


[6/20/2023 7:32 PM] andi15701
you have a


[6/20/2023 7:32 PM] szybet
@andi what about supporting the c model with this kernel?


[6/20/2023 7:32 PM] andi15701
easy


[6/20/2023 7:32 PM] szybet
There is a driver for the newer pmic?


[6/20/2023 7:33 PM] andi15701
yes, it seems actually backported from mainline


[6/20/2023 7:33 PM] szybet
Cool


[6/20/2023 7:33 PM] szybet
I will soon ( 3 weeks, idk? ) try to port the c to inkbox, so i can do this for pm os too


[6/20/2023 8:46 PM] kuratius
without lightdm and with 16MB cma:
MiB Mem :    239.8 total,    133.8 free,     58.7 used,     60.3 buff/cache     
MiB Swap:      0.0 total,      0.0 free,      0.0 used.    181.1 avail Mem 

will try with lightdm next


[6/20/2023 8:52 PM] kuratius
I think this freed like 10 MB maybe?
This is weird
You'd think going from 64MB cma to 16MB would free more


[6/20/2023 8:52 PM] kuratius
is this cma for graphics?


[6/20/2023 8:52 PM] kuratius
if so it might resize automatically if more is needed


[6/20/2023 8:52 PM] kuratius
I guess at least it gets us more cache


[6/20/2023 8:58 PM] andi15701
cma is used for anything needed huge continuous memory blocks


[6/20/2023 8:58 PM] andi15701
to avoid trouble because only fragmented stuff is available


[6/20/2023 8:59 PM] andi15701
CmaTotal:          65536 kB
CmaFree:           61660 kB


[6/20/2023 8:59 PM] andi15701
/proc/meminfo


[6/20/2023 8:59 PM] andi15701
that was without x


[6/20/2023 9:02 PM] andi15701
more cache is also nice


[6/20/2023 9:04 PM] kuratius
I sometimes get it that it selects a word next to the one I want to select even when the center of my finger is dead on


[6/20/2023 9:04 PM] kuratius
also sometimes light short touches dont register


[6/20/2023 9:04 PM] szybet
well not that bad


[6/20/2023 9:05 PM] szybet
its more being accurate, like clicking a button


[6/20/2023 9:06 PM] kuratius
buttons work fine


[6/20/2023 9:07 PM] kuratius
also I dont fully get why koreader works better than on my jailbroken kindle


[6/20/2023 9:07 PM] kuratius
sec let me double check


[6/20/2023 9:09 PM] kuratius
ya the interface looks different


[6/20/2023 9:09 PM] kuratius
I guess I'll risk losing my jailbreak on the kindle and try to update koreader over the air


[6/20/2023 9:12 PM] kuratius
menu is different too


[6/20/2023 9:13 PM] kuratius
i see now


[6/20/2023 9:13 PM] kuratius
kindle version is 11 2022


[6/20/2023 9:14 PM] kuratius
kobo is 01 2023


[6/20/2023 9:37 PM] kuratius
@NiLuJe Do you setting causes this behaviour difference?

{Attachments}
/mnt/data/projects/git/conversations/media/20230620_213602-DC3D4.jpg


[6/20/2023 9:37 PM] kuratius
Tapping on a word


[6/20/2023 9:37 PM] kuratius
Kindle requires a second  tap for the dictionary in koreader


[6/20/2023 9:46 PM] kuratius
Gestire settings are identical


[6/20/2023 9:50 PM] ninuje
Can't recall when the JP highlight plug-in was implemented


[6/20/2023 9:50 PM] ninuje
So comparisons on diff versions are kinda meaningless


[6/20/2023 9:51 PM] ninuje
Note that there is a setting for tweaking the single word highlight behavior


[6/20/2023 9:51 PM] ninuje
To make it show the hl pop-up or go straight to dict


[6/20/2023 9:52 PM] ninuje
Multi word always go to pop-up iirc


[6/20/2023 9:53 PM] kuratius
I updated both to 05 2023


[6/20/2023 9:53 PM] kuratius
before taking the screenshot


[6/20/2023 9:53 PM] ninuje
Gear > taps and gestures > long press on text


[6/20/2023 9:53 PM] kuratius
behavior doesnt change


[6/20/2023 9:54 PM] ninuje
In a doc


[6/20/2023 9:54 PM] kuratius
setting is identical on both


[6/20/2023 9:54 PM] kuratius
sec


[6/20/2023 9:55 PM] kuratius
Aaand the kindle just crashed


[6/20/2023 9:55 PM] ninuje
Check if the jp plug-in is enabled (or test on lgc).


[6/20/2023 9:56 PM] kuratius
Crashed koreader, back to kindle menu


[6/20/2023 9:56 PM] ninuje
OOM, probably (no framework helps with that, but a Kindle is heavily memory constrained)


[6/20/2023 9:57 PM] ninuje
Especially on even halfway recent FW versions


[6/20/2023 9:57 PM] kuratius
Kindle is 512 MB, kobo is 256


[6/20/2023 9:57 PM] kuratius
Is their fw that bad?


[6/20/2023 9:57 PM] tux_linux
sometimes


[6/20/2023 9:57 PM] ninuje
It needs all that ram.


[6/20/2023 9:57 PM] ninuje
Java + react


[6/20/2023 9:58 PM] ninuje
Note that the Nia is the only pos with 256MB, everything else is better 😉


[6/20/2023 10:01 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/20230620_215823-89431.jpg


[6/20/2023 10:02 PM] kuratius
Identical sttings


[6/20/2023 10:03 PM] kuratius
Changing the setting to dictionary doesnt do anything


[6/20/2023 10:04 PM] kuratius
Jp support plugin is installed

{Attachments}
/mnt/data/projects/git/conversations/media/20230620_215742-D4E03.jpg


[6/20/2023 10:07 PM] kuratius
Kindle crashed again


[6/20/2023 10:08 PM] kuratius
What's kobos stuff written in?


[6/20/2023 10:09 PM] tux_linux
qt


[6/20/2023 10:09 PM] tux_linux
and sh


[6/20/2023 10:53 PM] ninuje
Try on LGC to make sure it's not something CJK specific breaking the single word assumption


[6/20/2023 10:53 PM] kuratius
How do I do that?


[6/20/2023 10:53 PM] ninuje
I have no experience with the JP plug-in myself, so I can't say if it has any bearing on that


[6/20/2023 10:54 PM] ninuje
Latin/Greek/Cyrillic


[6/20/2023 10:54 PM] ninuje
Meaning another book not in Japanese ;0


[6/20/2023 11:01 PM] kuratius
Works with English books I think


[6/20/2023 11:01 PM] kuratius
There it isnt broken


[6/20/2023 11:01 PM] kuratius
Just, the dictionary lookup takes a while


[6/20/2023 11:01 PM] kuratius
Longer than on kobo JP


[6/20/2023 11:19 PM] kuratius
v2023.05.1 is the version on kindle


[6/20/2023 11:19 PM] kuratius
same on kobo now


[6/20/2023 11:30 PM] kuratius
was also broken on 2022.11


[6/21/2023 12:19 PM] andi15701
leds {
                        compatible = "rohm,bd71828-leds";

                        led-1 {
                                rohm,led-compatible = "bd71828-grnled";
                                function = LED_FUNCTION_INDICATOR;
                                color = <LED_COLOR_ID_GREEN>;
                        };
                        led-2 {
                                rohm,led-compatible = "bd71828-ambled";
                                function = LED_FUNCTION_CHARGING;
                                color = <LED_COLOR_ID_AMBER>;
                        };
                };


[6/21/2023 12:19 PM] andi15701
out of the devicetree from nia c


[6/21/2023 12:19 PM] andi15701
do these leds really exist?


[6/21/2023 12:20 PM] szybet
um not really


[6/21/2023 12:20 PM] szybet
how do i check


[6/21/2023 12:21 PM] andi15701
try to play around with the things in /sys/class/leds/


[6/21/2023 12:39 PM] szybet
whats the point


[6/21/2023 12:39 PM] szybet
i dont see any other leds


[6/21/2023 12:39 PM] szybet
like, psychical diodes


[6/21/2023 1:30 PM] kuratius
Might be small or one of the leds is multicolored


[6/21/2023 1:31 PM] szybet
doubts


[6/21/2023 1:34 PM] kuratius
The led on a pi pico is rainbow colored for example,  it can change color arbitrarily


[6/21/2023 1:34 PM] szybet
its an ereader


[6/21/2023 1:34 PM] szybet
from a big company


[6/21/2023 1:35 PM] szybet
there is no reason for them to use a colored led that is more expensive, and not use the colors


[6/21/2023 1:40 PM] kuratius
Example


[6/21/2023 1:40 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/20230621_133921-D7862.mp4


[6/21/2023 1:40 PM] kuratius
I think in Hardware it's actually 4 different leds crammed together


[6/21/2023 1:41 PM] szybet
its called RGB with a possible additional white led


[6/21/2023 1:43 PM] kuratius
Thst said device tree on nia had a non functional warmlight + normal front light, andnthey were swapped so (wrong names) I think they just don't update anything


[6/21/2023 1:53 PM] andi15701
the main point is that I do not want to have anything in the devicetree which is non-functional


[6/21/2023 1:53 PM] andi15701
or better non-existent


[6/21/2023 2:14 PM] szybet
Ok, i have a terminal on the nia c in nickel using koreader


[6/21/2023 2:14 PM] szybet
anything more to test, show?


[6/21/2023 2:15 PM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/message-0146E.txt


[6/21/2023 2:15 PM] szybet
sys structyre


[6/21/2023 2:16 PM] szybet
```
[root@kobo ~]# cd /sys/class/leds/
[root@kobo leds]# ls
GLED    mmc0::  mmc1::
```


[6/21/2023 2:20 PM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/message-21A9F.txt


[6/21/2023 2:20 PM] szybet
those are partitions


[6/21/2023 2:20 PM] szybet
there are no leds here


[6/21/2023 2:20 PM] szybet
https://github.com/Kobo-InkBox/inkbox/issues/47

{Embed}
https://github.com/Kobo-InkBox/inkbox/issues/47
Kobo Nia: diagnostics mode on installation  · Issue #47 · Kobo-InkB...
Hi 👋🏻 I've flashed the storage of my Kobo Nia, everything worked smoothly. When turning the device on for the first time and since then, I always end up in inkbox Diagnostics and Recovery - it ...
/mnt/data/projects/git/conversations/media/47-A39D7


[6/21/2023 2:20 PM] szybet
And writing to them does nothing


[6/21/2023 2:21 PM] szybet
my only quess is that those are boot and recovery partition, and the led starts blinking when they are used, no idea otherwise


[6/21/2023 2:27 PM] szybet
do you want the device tree, or do you have it already?


[6/21/2023 4:09 PM] andi15701
I have the devicetree


[6/21/2023 4:09 PM] andi15701
so /sys/class/leds/GLED does also not work?


[6/21/2023 4:54 PM] szybet
it does


[6/21/2023 4:54 PM] szybet
only it works


[6/23/2023 11:47 AM] ninuje
GLED might be the power button's led?

{Reactions}
👍 

[6/23/2023 11:48 AM] ninuje
(that vaguely rings a bell re: ntx things and power buttons)


[6/23/2023 11:48 AM] ninuje
(hasn't been green for a long stretch of devices ;p)


[6/25/2023 3:39 AM] tux_linux
probably


[6/25/2023 7:23 PM] kuratius
@andi Is there a way to turn on LTO when compiling the kernel?


[6/25/2023 7:23 PM] kuratius
or would it  be pointless?


[6/25/2023 7:24 PM] kuratius
I still havent understood why this has no options listed for selection


[6/25/2023 7:29 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-C29A0.png


[6/25/2023 7:29 PM] kuratius
do I need to use clang to compile the kernel?


[6/25/2023 7:29 PM] kuratius
would that even work?


[6/25/2023 7:34 PM] kuratius
mentioning it because there seem to be several references to clang when searching LTO in the kconfig search dialog


[6/25/2023 8:16 PM] andi15701
kernel should compile with clang


[6/25/2023 8:17 PM] andi15701
I do not think, LTO is that important


[6/26/2023 1:47 PM] szybet
@andi what is the tolino clone of the kobo aura 2?


[6/26/2023 4:45 PM] ninuje
Linux LTO is Clang only right now, IIRC


[6/26/2023 4:45 PM] ninuje
(might only be thinLTO, too, can't recall)


[6/26/2023 4:47 PM] kuratius
Where do I tell it to use clang as the compiler?


[6/26/2023 4:49 PM] ninuje
You don't (not in KConfig, at least)


[6/26/2023 4:49 PM] ninuje
KConfig just picks up the compiler you're using to build it


[6/26/2023 4:51 PM] kuratius
I understand that LTO takes way longer to compile,  but I'd like to try it and see if it makes a big difference (and hopefully LTO  kernel isnt buggy)


[6/26/2023 4:54 PM] kuratius
I guess I can try the method for manually compiling the kernel from the repo, but I think that means I lose cma and -Os changes. 
Clang doesn't use the same syntax as gcc does it?


[6/26/2023 4:55 PM] kuratius
Here


[6/26/2023 4:55 PM] andi15701
make LLVM=-13 (or whatever your version prefix is)  ARCH=arm


[6/26/2023 4:55 PM] andi15701
probably totally manual


[6/26/2023 4:55 PM] andi15701
and use O=.output


[6/26/2023 4:55 PM] andi15701
an mentioned there


[6/26/2023 4:59 PM] andi15701
andi@aktux:~/kobo/kernel/arch$ grep -R ARCH_SUPPORTS_LTO_CLANG *
arm64/Kconfig:    select ARCH_SUPPORTS_LTO_CLANG if CPU_LITTLE_ENDIAN
arm64/Kconfig:    select ARCH_SUPPORTS_LTO_CLANG_THIN
Kconfig:config ARCH_SUPPORTS_LTO_CLANG
Kconfig:config ARCH_SUPPORTS_LTO_CLANG_THIN
Kconfig:    depends on ARCH_SUPPORTS_LTO_CLANG
Kconfig:    depends on HAS_LTO_CLANG && ARCH_SUPPORTS_LTO_CLANG_THIN
um/Kconfig:    select ARCH_SUPPORTS_LTO_CLANG
um/Kconfig:    select ARCH_SUPPORTS_LTO_CLANG_THIN
x86/Kconfig:    select ARCH_SUPPORTS_LTO_CLANG
x86/Kconfig:    select ARCH_SUPPORTS_LTO_CLANG_THIN


[6/26/2023 4:59 PM] andi15701
no chance


[6/26/2023 4:59 PM] andi15701
not supported on arm32


[6/26/2023 5:03 PM] ninuje
Oh, right, didn't think of that


[6/26/2023 5:03 PM] ninuje
nobody cares about arm32 anymore ;p


[6/26/2023 5:03 PM] ninuje
certainly Google doesn't, and they're the driving force behind LTO kernels


[6/26/2023 5:04 PM] kuratius
Ah well, thank you for checking


[6/26/2023 5:07 PM] szybet
why is such a think architecture restricted


[6/26/2023 5:10 PM] ninuje
Because LTO can break things in fun and interesting ways, and is not trivial to implement right, especially on a codebase so complex and critical


[6/26/2023 5:13 PM] szybet
understandable


[6/26/2023 11:15 PM] andi15701
&i2c4 {
        clock-frequency = <100000>;
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_i2c4 &pinctrl_rohm_gpio &pinctrl_snvs_rohm_gpio>;
        status = "okay";

    bd71828: bd71828-i2c@4b {
        reg = <0x4b>;
        compatible = "rohm,bd71828";
                gpio_int = <&gpio5 1 GPIO_ACTIVE_LOW>;


[6/26/2023 11:16 PM] andi15701
that we have in the rev c devicetree


[6/26/2023 11:16 PM] andi15701
#include "rohmbd71828_mx6ull.dtsi"


[6/26/2023 11:16 PM] andi15701
&bd71828
{
    #address-cells = <1>;
    #size-cells = <0>;

        pmic: pmic@4b {
                compatible = "rohm,bd71828";
                reg = <0x4b>;

                #interrupt-parent = <&gpio1>;
                #interrupts = <29 IRQ_TYPE_LEVEL_LOW>;


[6/26/2023 11:17 PM] andi15701
so what happens now:  the &bd71828 {} stuff is inserted into the thing labeled with bd71828


[6/26/2023 11:18 PM] andi15701
generating this kind of mess


[6/26/2023 11:18 PM] andi15701
i2c@021f8000 {
                #address-cells = <0x00000001>;
                #size-cells = <0x00000000>;
                compatible = "fsl,imx6ul-i2c", "fsl,imx21-i2c";
                reg = <0x021f8000 0x00004000>;
                interrupts = <0x00000000 0x00000023 0x00000004>;
                clocks = <0x00000001 0x0000009f>;
                status = "okay";
                clock-frequency = <0x000186a0>;
                pinctrl-names = "default";
                pinctrl-0 = <0x00000032 0x00000033 0x00000034>;
                bd71828-i2c@4b {
                    reg = <0x0000004b>;
                    compatible = "rohm,bd71828";
                    gpio_int = <0x00000035 0x00000001 0x00000001>;
                    gpio_wdogb = <0x00000036 0x0000000b 0x00000001>;
                    rohm,charger-sense-resistor-ohms = <0x01406f40>;
                    #address-cells = <0x00000001>;
                    #size-cells = <0x00000000>;
                    pmic@4b {
                        compatible = "rohm,bd71828";
                        reg = <0x0000004b>;


[6/26/2023 11:19 PM] andi15701
so everything below pmic@4b belongs into the top node


[6/26/2023 11:19 PM] andi15701
but it is not there


[6/26/2023 11:19 PM] andi15701
the whole stuff is inored


[6/26/2023 11:20 PM] andi15701
inclusive regulator status


[6/26/2023 11:21 PM] kuratius
Ignored?


[6/26/2023 11:21 PM] andi15701
ye


[6/26/2023 11:21 PM] andi15701
yes


[6/26/2023 11:21 PM] andi15701
total mess


[6/26/2023 11:23 PM] andi15701
so ntx seems just to have replaced regulator initialisation with direct writes to the regulator registers...


[6/26/2023 11:23 PM] andi15701
head->scratch()


[6/27/2023 12:39 PM] andi15701
I am cleaning up stuff a bit


[6/27/2023 12:39 PM] andi15701
to prepare a) for 6.4 update


[6/27/2023 12:39 PM] andi15701
and b) put together another branch containing the fbdev driver


[6/27/2023 12:40 PM] andi15701
that resulting kernel should basically run on the Clara, the Nia A and C with gfx output


[6/27/2023 12:40 PM] andi15701
with FBInk

{Reactions}
👍 

[6/27/2023 2:09 PM] tux_linux
Should I use it to port inkbox once my Clara arrives?


[6/27/2023 2:10 PM] szybet
as you say that, should we use the same kernel source with just diffrent configs?


[6/27/2023 2:11 PM] kuratius
from what I remember the idea was that as long as the devicetree dtb is set up correctly, newer kernels should just work


[6/27/2023 2:12 PM] kuratius
but I dont really know the details and this is probably oversimplifying


[6/27/2023 2:12 PM] kuratius
apparently ntx doesnt know how to do that correctly so they end up doing dirty hacks to compensate that cause kernel incompatibility etc


[6/27/2023 2:13 PM] kuratius
(possibly I am also wrong about this is in some way, so please correct me if so)


[6/27/2023 3:14 PM] andi15701
well, same kernel binary, you just need to make sure that the correct devicetree is loaded


[6/27/2023 3:15 PM] andi15701
devicetrees and kernel update: it is best to update the devicetrees at the same time,


[6/27/2023 3:17 PM] andi15701
stock devicetree vs. newer: the format must match what the kernel drivers expect. And if drivers are not upstream, things might change, so the 4.1.15 devicetrees cannot be used as-is on near mainline stuff


[6/27/2023 3:18 PM] andi15701
esp. the ricoh619/rc5t619 stuff is very different


[6/28/2023 10:26 PM] andi15701
I have put together


[6/28/2023 10:26 PM] andi15701
a kobo/merged-6.3 branch


[6/28/2023 10:27 PM] andi15701
which should run on nia/nia-c (with limitation)/clara/some other imx6sl devices

{Reactions}
👍 

[7/2/2023 8:31 PM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/image-EC76E.png


[7/2/2023 8:31 PM] szybet
weird serial logs?...


[7/2/2023 8:39 PM] kuratius
C or A?


[7/2/2023 8:39 PM] szybet
A


[7/2/2023 8:39 PM] szybet
mine


[7/2/2023 8:45 PM] kuratius
Same in dmesg?


[7/2/2023 8:46 PM] kuratius
Otherwise I have to connect serial again. I do not remember seeing that exact error.
You're testing pmOS atm?


[7/2/2023 8:47 PM] szybet
no, inkbox after hours of developing audio for it


[7/2/2023 8:47 PM] szybet
( so usb host )


[7/2/2023 8:47 PM] szybet
idk if related


[7/2/2023 8:55 PM] szybet
cant find it, propably yes


[7/2/2023 8:55 PM] kuratius
demesg | grep sy7636


[7/2/2023 8:56 PM] szybet
after 10h of programming audio i turned my brain of


[7/2/2023 8:56 PM] szybet
anyway


[7/2/2023 8:56 PM] szybet
```
kobo:/# dmesg | grep sy7636
[40202.209447] sy7636_get_temperature():temperature = 30,reg=0x1e
[40290.949379] sy7636_get_temperature():temperature = 30,reg=0x1e
[40601.329495] sy7636_get_temperature():temperature = 30,reg=0x1e
[40601.888954] sy7636_wait_power_good():fault occurs "UVP at VEE rail"
[40601.908928] sy7636_wait_power_good():fault occurs "UVP at VEE rail"
[40601.928854] sy7636_wait_power_good():fault occurs "UVP at VEE rail"
[40668.459319] sy7636_get_temperature():temperature = 30,reg=0x1e
[40756.939461] sy7636_get_temperature():temperature = 30,reg=0x1e
[40836.039509] sy7636_get_temperature():temperature = 30,reg=0x1e
[40897.969382] sy7636_get_temperature():temperature = 30,reg=0x1e
[40957.999428] sy7636_get_temperature():temperature = 30,reg=0x1e
[41018.019403] sy7636_get_temperature():temperature = 30,reg=0x1e
[41232.769502] sy7636_get_temperature():temperature = 30,reg=0x1e
[41302.949517] sy7636_get_temperature():temperature = 30,reg=0x1e
[41362.979336] sy7636_get_temperature():temperature = 30,reg=0x1e
[41423.569424] sy7636_get_temperature():temperature = 30,reg=0x1e
[41573.839395] sy7636_get_temperature():temperature = 30,reg=0x1e
[41634.899318] sy7636_get_temperature():temperature = 30,reg=0x1e
[41695.799305] sy7636_get_temperature():temperature = 30,reg=0x1e
[41756.009480] sy7636_get_temperature():temperature = 30,reg=0x1e
[41817.399301] sy7636_get_temperature():temperature = 30,reg=0x1e
[41877.409294] sy7636_get_temperature():temperature = 30,reg=0x1e
[41937.419308] sy7636_get_temperature():temperature = 30,reg=0x1e
[41998.499316] sy7636_get_temperature():temperature = 30,reg=0x1e
[42108.449325] sy7636_get_temperature():temperature = 30,reg=0x1e
kobo:/# 

```


[7/2/2023 8:56 PM] szybet
hm...


[7/2/2023 8:57 PM] kuratius
Then I don't think we have had that happen, but it might only happen if the device is on for very long?


[7/2/2023 8:58 PM] kuratius
Demesg was usually  chrcked shortly after boot


[7/2/2023 8:58 PM] kuratius
40k seconds is like 11 hours


[7/2/2023 8:59 PM] szybet
🥴


[7/2/2023 8:59 PM] szybet
also: i have usb host, and pmic is on "dont charge battery but use this power to not use the battery"


[7/2/2023 8:59 PM] kuratius
What does that work look like? Do you have to handle fourier transform stuff or only usb communication or something?


[7/2/2023 9:00 PM] szybet
fourier what


[7/2/2023 9:00 PM] kuratius
No idea how to reproduce that setting


[7/2/2023 9:01 PM] szybet
its just a report, maybe nothing wrong


[7/2/2023 9:01 PM] kuratius
Math stuff for audio adjustments like compression and frequency filtering


[7/2/2023 9:01 PM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/IMG_20230702_210012-C488A.jpg


[7/2/2023 9:01 PM] szybet
this is how my setup looks like


[7/2/2023 9:02 PM] szybet
i use only wav files, and a library to read metadata and then i write the file to the audio output


[7/2/2023 9:02 PM] szybet
i dont think there is any of that


[7/2/2023 9:02 PM] szybet
i'm not a math guy


[7/2/2023 9:02 PM] szybet
so no way to replicate this mess


[7/2/2023 9:03 PM] kuratius
Pmic can't be changed in software?


[7/2/2023 9:03 PM] szybet
what?


[7/2/2023 9:03 PM] kuratius
The setting


[7/2/2023 9:04 PM] szybet
what setting


[7/2/2023 9:04 PM] kuratius
I assume mine is usually on charge battery or something when connected, yours is a setting to skip that?


[7/2/2023 9:04 PM] szybet
yep


[7/2/2023 9:05 PM] szybet
it uses usb power as main power, and the battery only if usb doesnt supply that much


[7/2/2023 9:05 PM] szybet
doesnt charge the battery


[7/2/2023 9:06 PM] kuratius
Probably wait for andi and then we will, either know what it is, or what to do for a proper comparison between pmOS and inkbox for this


[7/2/2023 9:07 PM] szybet
I dont want to bother you too much with this, propably not important anyway


[7/2/2023 9:09 PM] kuratius
Have you considered testing your audio thing on pmOS?


[7/2/2023 9:10 PM] szybet
it needs an app to be launched on every power connection


[7/2/2023 9:10 PM] szybet
after that, its a regular usb hub


[7/2/2023 9:11 PM] kuratius
Basically my idea was checking if you can repro the error on pmOS yourself


[7/2/2023 9:12 PM] kuratius
Then you can conclude if the driver from npx ntx or whatever is configured wrong


[7/2/2023 9:24 PM] szybet
i will port the kernel to inkbox anyway


[7/2/2023 9:24 PM] szybet
as soon as you will be ready


[7/2/2023 9:44 PM] kuratius
me ready for what?


[7/2/2023 9:44 PM] kuratius
sorry I'm confused


[7/2/2023 9:45 PM] tux_linux
broken epdc?


[7/2/2023 9:45 PM] andi15701
battery low


[7/2/2023 9:45 PM] andi15701
?


[7/2/2023 9:45 PM] tux_linux
nice


[7/2/2023 9:45 PM] tux_linux
oh yes


[7/2/2023 9:46 PM] kuratius
Also apparently I forgot that sy7636 is the epdc and not anything related to power


[7/2/2023 9:46 PM] andi15701
sy7636 is not the epdc


[7/2/2023 9:46 PM] andi15701
but a separate chip to provide power to the epd


[7/2/2023 9:46 PM] kuratius
oh


[7/2/2023 9:46 PM] kuratius
thank you


[7/2/2023 9:49 PM] szybet
as it, kernel, sorry


[7/2/2023 9:49 PM] szybet
it works?


[7/2/2023 9:49 PM] szybet
67%?


[7/2/2023 10:14 PM] andi15701
that should be enough


[7/4/2023 8:16 PM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/message-A877A.txt


[7/4/2023 8:16 PM] szybet
its pretty frequent


[7/4/2023 8:16 PM] szybet
lately


[7/4/2023 8:16 PM] szybet
maybe he doesnt like the spiked of power that audio makes?


[7/5/2023 1:48 PM] andi15701
maybe


[7/5/2023 1:49 PM] andi15701
but the key point is that maybe the capacity might not work that well


[7/5/2023 1:49 PM] andi15701
the capacity measurement/calculation


[7/5/2023 1:50 PM] szybet
its related? interesting


[7/5/2023 1:50 PM] szybet
i will check today if the touch is still accurate


[7/5/2023 1:50 PM] andi15701
battery capacity


[7/5/2023 1:50 PM] szybet
oh


[7/5/2023 1:51 PM] andi15701
I think the touch has a separate power supply


[7/5/2023 1:51 PM] szybet
doesnt it just read voltage?


[7/5/2023 1:51 PM] andi15701
so noise should be filtered


[7/5/2023 1:51 PM] szybet
4.2V - 100% 3.2V - 0%?


[7/5/2023 1:51 PM] andi15701
no


[7/5/2023 1:52 PM] szybet
so how then


[7/5/2023 1:53 PM] andi15701
voltage alone will give heavy capacity differences if you just unplug charger


[7/5/2023 1:53 PM] szybet
fair point - it drops


[7/5/2023 1:53 PM] andi15701
so the next best thing is to correct voltage by the internal resistance of the battery


[7/5/2023 1:54 PM] andi15701
and all the wires towards measurent


[7/5/2023 1:54 PM] andi15701
so you need current


[7/5/2023 1:55 PM] andi15701
and the pmic has a fuel gauge, so it integrates the current measurements


[7/5/2023 1:55 PM] andi15701
that comes with its own problems


[7/5/2023 1:55 PM] andi15701
it is drifting, because errors sum up over time


[7/5/2023 1:56 PM] andi15701
so it needs to be aligned at full charge, etc


[7/5/2023 1:57 PM] andi15701
so what does the driver do: all of the above + turing off fuel gauge sometime and expecting a fixed current in certain operating conditions


[7/5/2023 1:57 PM] andi15701
and calculate with that fixed current


[7/5/2023 1:58 PM] andi15701
well, it is 7000 lines of code


[7/5/2023 1:58 PM] andi15701
undigestable


[7/5/2023 2:03 PM] szybet
my god


[7/5/2023 2:03 PM] szybet
okay


[7/5/2023 2:03 PM] szybet
sounds scary


[7/5/2023 2:06 PM] andi15701
as long as you are dealing with slow discharging, just reading voltage might be helpful


[7/5/2023 2:07 PM] andi15701
and you can also cheat: if you do not display a charging state while charging, nobody will notice capacity jumps


[7/6/2023 10:42 PM] szybet
what are current issues with kobo nia on mainline?


[7/6/2023 10:42 PM] szybet
does wifi work? what about the greyscale?


[7/6/2023 10:42 PM] szybet
also touch?


[7/6/2023 10:43 PM] szybet
i'm ready to port the A model and mainline to inkbox, but i fear those issues as a downgrade


[7/6/2023 11:20 PM] kuratius
Wifi works, but there is weird stuff where it kept disconnecting and reconnecting with a new devicename all the time, but that may be because I started the wifi driver manually and used iwd or something instead of the other option (wpa supplicant)

Greyscale has full range, but there may be an issue where some colors don't have the correct separation and I don't know if that's cause we cut something 8ff or some other reason


[7/6/2023 11:21 PM] kuratius
Touch driver works and gives somewhat sensible output, but it is calibrated wrong so it's not usable


[7/6/2023 11:22 PM] kuratius
Fixing the Touch driver just requires tweaking how the Touch driver output is mapped to screen coordinates


[7/6/2023 11:24 PM] kuratius
Wifi idk what is causing it

Greyscale probably  needs a bit more debugging, but it's not really something that's super import; andi said he was preparing an fbdev driver, so that may affect that too


[7/6/2023 11:25 PM] kuratius
If you have a spare sd, preparing a pmOS sd is quick and painless  for the most part


[7/6/2023 11:25 PM] kuratius
Just need to clone andis nia branch


[7/6/2023 11:28 PM] kuratius
ideally whatever andi was cooking would fix both Touch and the greyscale evenness issue


[7/6/2023 11:31 PM] kuratius
A friend of mine might buy a page 2 to use as a vnc screen, I wonder if inkbox or pmOS is better for that


[7/7/2023 6:35 PM] szybet
well


[7/7/2023 6:35 PM] szybet
i will start when its all working


[7/8/2023 6:57 PM] andi15701
wifi: check if there are multiple programs try to manage it


[7/8/2023 6:57 PM] andi15701
multple wpa_supplicants running


[7/8/2023 6:58 PM] andi15701
or both wpa_supplicant and iwd


[7/8/2023 7:11 PM] kuratius
I haven't set up wpa supplicant
I will tell you a list of commands I used to connect using iwd, sec


[7/8/2023 7:12 PM] andi15701
it might be installed


[7/8/2023 7:12 PM] andi15701
double check if the process is running


[7/8/2023 7:21 PM] kuratius
128 sudo rc-service iwd start
 129 iwctl station wlan0 connect DK-Wlan-2G
 130 sudo udhcpc -i wlan0
these are the commands I would run on startup


[7/8/2023 7:22 PM] kuratius
is rc-service likely to start multiple iwd instances?


[7/8/2023 7:22 PM] andi15701
probably not


[7/8/2023 7:22 PM] kuratius
how do I check if wpa_supplicant running?


[7/8/2023 7:22 PM] andi15701
ps auxww | grep wpa


[7/8/2023 7:22 PM] kuratius
kobo-nia:~$ ps auxww | grep wpa
root      1275  0.0  0.2    796   512 ?        S    19:14   0:00 supervise-daemon wpa_supplicant --start --respawn-delay 2 --respawn-max 5 --respawn-period 1800 /sbin/wpa_supplicant -- -u -Dnl80211,wext
root      1277  0.0  1.0   4984  2496 ?        Ss   19:14   0:00 /sbin/wpa_supplicant -u -Dnl80211,wext
dk-x86    2095  0.0  0.2   1328   708 pts/0    S+   19:21   0:00 grep wpa
kobo-nia:~$


[7/8/2023 7:23 PM] kuratius
this is after fresh boot


[7/8/2023 7:23 PM] kuratius
I did not start iwd again


[7/8/2023 7:25 PM] kuratius
(I assume rc-service is not like systemd where it starts a service permanently, at least I think that starting a service that way will keep reloading it on boot)


[7/8/2023 7:26 PM] kuratius
or maybe I am confusing systemctl with systemd


[7/8/2023 7:26 PM] andi15701
it is running


[7/8/2023 7:27 PM] andi15701
so do you have nm-anything?


[7/8/2023 7:27 PM] andi15701
programms staring with nm


[7/8/2023 7:28 PM] kuratius
kobo-nia:~$ ps auxww | grep nm
dk-x86    2396  0.0  0.3   1328   752 pts/0    S+   19:27   0:00 grep nm
kobo-nia:~$


[7/8/2023 7:28 PM] andi15701
nm<tab>


[7/8/2023 7:28 PM] kuratius
apparently the difference is between using enable and start as the keyword for systemctl, just googled it


[7/8/2023 7:29 PM] kuratius
kobo-nia:~$ nm
nm                    nmcli                 nmtui-edit
nm-applet             nmeter                nmtui-hostname
nm-connection-editor  nmtui
nm-online             nmtui-connect
kobo-nia:~$ nm


[7/8/2023 7:29 PM] andi15701
shutdown iwd


[7/8/2023 7:29 PM] andi15701
and try nmtui-connect


[7/8/2023 7:30 PM] kuratius
kobo-nia:~$ sudo rc-service iwd stop
[sudo] password for dk-x86: 
 * WARNING: iwd is already stopped
kobo-nia:~$


[7/8/2023 7:30 PM] kuratius
do you mean wpa_supplicant?


[7/8/2023 7:31 PM] andi15701
no


[7/8/2023 7:31 PM] andi15701
nm* are commands belonging to network-manager


[7/8/2023 7:31 PM] andi15701
which talks via dbus to wpa_supplicant


[7/8/2023 7:32 PM] kuratius
will crop it better sec


[7/8/2023 7:32 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-D5B52.png


[7/8/2023 7:34 PM] kuratius
this is after entering nmtui-connect


[7/8/2023 7:34 PM] kuratius
should wifi appear here?


[7/8/2023 7:34 PM] kuratius
or is this just active connections?


[7/8/2023 7:43 PM] kuratius
I will check if normal wifi still works


[7/8/2023 7:45 PM] kuratius
did I compile a kernel without wifi somehow?


[7/8/2023 7:45 PM] kuratius
kobo-nia:~$ sudo rc-service iwd start
[sudo] password for dk-x86: 
 * Starting iwd ...                                                       [ ok ]
kobo-nia:~$ sudo rc-service wpa_supplicant stop
 * Stopping WPA Supplicant ...                                            [ ok ]
kobo-nia:~$ iwctl station wlan0 connect DK-Wlan-2G
Device wlan0 not found.
kobo-nia:~$


[7/8/2023 7:46 PM] kuratius
I guess I must have


[7/8/2023 7:48 PM] kuratius
will reboot and if it's not back I will assume I need to sideload again


[7/8/2023 7:48 PM] kuratius
no idea how that happened


[7/8/2023 7:49 PM] kuratius
still gone


[7/8/2023 8:02 PM] kuratius
last thing I modified was the stuff with -Os and cma


[7/8/2023 8:33 PM] andi15701
wifi was not available if sideloaded


[7/8/2023 8:34 PM] andi15701
or better: if created via envkernel


[7/8/2023 8:49 PM] kuratius
I guess it must be loading the envkernel kernel somehow


[7/8/2023 8:49 PM] kuratius
I thought we deleted that


[7/8/2023 8:50 PM] kuratius
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/packages/edge/armv7$ ls
APKINDEX.tar.gz
device-kobo-nia-0.1-r0.apk
device-kobo-nia-0.1-r1.apk
device-kobo-nia-0.1-r2.apk
linux-kobo-clara-mainline-6.1.12-r1.apk
linux-kobo-clara-mainline-6.1.12-r2.apk
linux-kobo-clara-mainline-6.1.12-r3.apk
linux-kobo-clara-mainline-6.1.12-r4.apk
linux-kobo-clara-mainline-6.1.12-r5.apk
linux-kobo-clara-mainline-6.3.0_p20230613221058-r0.apk
linux-kobo-clara-mainline-6.3.0_p20230613225736-r0.apk
linux-kobo-clara-mainline-6.3.0_p20230615222549-r0.apk
linux-kobo-clara-mainline-6.3.0_p20230615233719-r0.apk
linux-kobo-clara-mainline-6.3.0_p20230615234309-r0.apk
linux-kobo-clara-mainline-6.3.0-r1.apk
linux-kobo-clara-mainline-6.3.0-r2.apk
linux-kobo-clara-mainline-6.3.0-r3.apk
linux-kobo-clara-mainline-6.3.0-r4.apk
linux-kobo-clara-mainline-6.3.0-r5.apk
u-boot-kobo-nia-2016.03-r0.apk
u-boot-kobo-nia-2020.10-r0.apk
u-boot-kobo-nia-2020.10-r1.apk
dk@dk-ThinkPad-E560:~/.local/var/pmbootstrap/packages/edge/armv7$


[7/8/2023 8:53 PM] kuratius
I deleted a bunch of these, must have deleted one too many, sideload is now doing the kernel compile again


[7/8/2023 8:55 PM] kuratius
the process I followed was git reset --hard, git pull in pmaports 
pmbootstrap zap
pmbootstrap init
pmbootstrap build linux-kobo-clara-mainline --force 
pmboostrap sideload linux-kobo-clara-mainline


[7/8/2023 9:20 PM] kuratius
yep it's back now


[7/8/2023 9:25 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-10C9E.png


[7/8/2023 9:37 PM] kuratius
this is without iwd running


[7/8/2023 9:37 PM] kuratius
so I suppose the theory about wpa supplicant was probably correct


[7/8/2023 9:39 PM] kuratius
so do we disable wpa_supplicant, or make it default to it or something else?


[7/8/2023 9:43 PM] andi15701
well, it is your choice, just do not run both


[7/8/2023 11:23 PM] szybet
Coool


[7/8/2023 11:23 PM] szybet
What about the main concern


[7/8/2023 11:23 PM] szybet
Touchscreen


[7/8/2023 11:43 PM] kuratius
is there a config file I can edit for the touchscreen?


[7/8/2023 11:45 PM] kuratius
it's likely very easy to remap things if I know what range of values the system is expected to get from the driver


[7/9/2023 1:51 PM] andi15701
well, touchscreen coordinates should match display coordinates


[7/9/2023 1:51 PM] andi15701
so check what you get in the corners


[7/9/2023 2:02 PM] kuratius
what corner is 0?
display coordinates=pixel indices?


[7/9/2023 2:03 PM] kuratius
like, max should be this?

{Attachments}
/mnt/data/projects/git/conversations/media/image-CCB29.png


[7/9/2023 2:04 PM] andi15701
yes, it has to be translated to it


[7/9/2023 2:04 PM] kuratius
the values output by the driver are much bigger than that


[7/9/2023 2:04 PM] kuratius
around 1800x1200


[7/9/2023 2:05 PM] kuratius
I just dont know where to plug the conversion constant


[7/9/2023 2:06 PM] andi15701
https://wiki.postmarketos.org/index.php?title=Screen_Calibration&mobileaction=toggle_view_desktop

{Embed}
https://wiki.postmarketos.org/index.php?title=Screen_Calibration&mobileaction=toggle_view_desktop
Index.php


[7/9/2023 2:06 PM] kuratius
probably something like ```x=758/1200*x 
y=1024/1800*y``` (probably not exactly 1800 and 1200 , but yout get the point)


[7/9/2023 2:08 PM] andi15701
/etc/udev/rules.d/99-touch.rules 
ATTRS{name}=="Neonode zForce touchscreen", ENV{LIBINPUT_CALIBRATION_MATRIX}="0 1 0 -1 0 1"


[7/9/2023 2:08 PM] andi15701
you can have something like that


[7/9/2023 2:09 PM] andi15701
that is rotation


[7/9/2023 2:09 PM] szybet
rotation is managed by udev?...


[7/9/2023 2:09 PM] kuratius
If I can enter a matrix it should be able to do both rotation and rescaling at once


[7/9/2023 2:10 PM] kuratius
does it have to be an integer or does it work with floats?


[7/9/2023 2:11 PM] kuratius
if no float support we need to separate multiplication and division


[7/9/2023 2:12 PM] andi15701
I think it can use floats


[7/9/2023 2:12 PM] kuratius
is this supposed to be a 2x2 matrix or a 2x3 matrix?


[7/9/2023 2:13 PM] andi15701
2x3


[7/9/2023 2:13 PM] andi15701
this works if libinput is used


[7/9/2023 2:13 PM] andi15701
to read out the stuff


[7/9/2023 2:13 PM] kuratius
why 3? is the input a 3d vector?


[7/9/2023 2:13 PM] kuratius
I thought it was a 2d screen


[7/9/2023 2:14 PM] andi15701
for translation


[7/9/2023 2:14 PM] andi15701
2x2 can only do rotation + scaling


[7/9/2023 2:14 PM] kuratius
ooh


[7/9/2023 2:14 PM] kuratius
so it's a 2x2 matrix+offset vector


[7/9/2023 2:14 PM] kuratius
not a 2x3 matrix


[7/9/2023 2:14 PM] kuratius
k


[7/9/2023 2:18 PM] andi15701
kernel itself can swap and invert coordinates


[7/9/2023 2:20 PM] andi15701
if evdev xorg driver is used


[7/9/2023 2:20 PM] andi15701
Option "Calibration" "min-x max-x min-y max-y"


[7/9/2023 2:20 PM] andi15701
in xorg.conf can be used


[7/9/2023 2:21 PM] andi15701
or setting a property via xinput


[7/9/2023 2:41 PM] szybet
maybe do it via kernel?...


[7/9/2023 2:41 PM] szybet
we dont use libinput / xorg mainly


[7/9/2023 3:48 PM] andi15701
that was a long war...


[7/9/2023 3:48 PM] andi15701
which was lost


[7/9/2023 3:48 PM] andi15701
so what is accepted: give out min/max values


[7/9/2023 3:48 PM] andi15701
of touch screen


[7/9/2023 3:48 PM] szybet
so how do we do it for inkbox, when platform plugin uses evdev?


[7/9/2023 3:49 PM] andi15701
and give out orientation


[7/9/2023 3:49 PM] andi15701
I think you can take min/max values from evdev


[7/9/2023 3:50 PM] andi15701
and than calibrate upon that


[7/9/2023 3:50 PM] szybet
😔


[7/9/2023 3:50 PM] szybet
propably no chance


[7/9/2023 3:50 PM] szybet
we would need to do that for xorg and platform plugin


[7/9/2023 3:51 PM] andi15701
it has to be rechecked


[7/9/2023 3:52 PM] andi15701
how much work is left


[7/9/2023 3:52 PM] andi15701
btw: basically same mood for sensor orientation


[7/9/2023 3:52 PM] andi15701
you can ask the kernel for a matrix


[7/9/2023 3:53 PM] andi15701
to process the data


[7/9/2023 3:53 PM] andi15701
but you get the original data from the kernel


[7/9/2023 3:53 PM] szybet
for now we will go with the stock kernel and try it


[7/9/2023 3:54 PM] szybet
maybe later migrate to this one


[7/9/2023 3:55 PM] andi15701
/**
 * struct input_absinfo - used by EVIOCGABS/EVIOCSABS ioctls
 * @value: latest reported value for the axis.
 * @minimum: specifies minimum value for the axis.
 * @maximum: specifies maximum value for the axis.


[7/9/2023 4:03 PM] andi15701
long war = January 2015 to June 2017


[7/9/2023 4:21 PM] szybet
:(


[7/9/2023 4:38 PM] kuratius
this udev rule doesnt exist
should I follow the process mentioned on the wiki article using weston instead of xfce or try  to create this file and see if it doesn anything?


[7/9/2023 4:47 PM] kuratius
kobo-nia:~$ ls /etc/udev/rules.d
kobo-nia:~$


[7/9/2023 6:37 PM] andi15701
in the end we should have something like that


[7/9/2023 6:38 PM] andi15701
it has to be created


[7/9/2023 8:51 PM] andi15701
so you probably have to create such a rule file


[7/9/2023 8:53 PM] kuratius
The end of the wiki article mentions that the file has to have a specific name including the touchscreen driver or something, is that outdated or can I use the name you used?


[7/9/2023 8:54 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/Screenshot_20230709-205413_Firefox-506B9.png


[7/9/2023 8:54 PM] kuratius
I don't know what logs it's referring to


[7/9/2023 8:54 PM] kuratius
Oh wait


[7/9/2023 8:55 PM] kuratius
syslog right above maybe


[7/9/2023 8:57 PM] kuratius
logread -f  | grep touch

and

logread -f | grep weston doesnt return anything, will reboot with lightdm on and see if that changes


[7/9/2023 8:59 PM] kuratius
nope still doesnt change


[7/9/2023 9:03 PM] kuratius
https://gitlab.com/postmarketOS/pmbootstrap/-/issues/182
github link on the wiki is dead, this is probably what it should point to

{Embed}
https://gitlab.com/postmarketOS/pmbootstrap/-/issues/182
Default WL_CALIBRATION (#182) · Issues · postmarketOS / pmbootstrap...
It looks like most phones are very close to being calibrated already and I think the calibrations are already done in the touchscreen controller themselves. For...
/mnt/data/projects/git/conversations/media/icon_mobile-6754B.png


[7/9/2023 9:12 PM] kuratius
kobo-nia:~$ ls /etc/udev/rules.d
99-touch.rules
kobo-nia:~$ cat 
^C
kobo-nia:~$ cat /etc/udev/rules.d/99-touch.rules 
ATTRS{name}=="Neonode zForce touchscreen", ENV{LIBINPUT_CALIBRATION_MATRIX}="0.568,0,0,0,0.631,0"
kobo-nia:~$ 
yeah I dont enjoy doing this blind, I will see if a kernel with weston builds


[7/9/2023 9:13 PM] andi15701
elan_ektf2127 probably


[7/9/2023 9:13 PM] andi15701
as a name


[7/9/2023 9:13 PM] andi15701
you could leave out that name


[7/9/2023 9:13 PM] andi15701
but


[7/9/2023 9:13 PM] andi15701
then tomorrow comes Szybet


[7/9/2023 9:14 PM] andi15701
and attaches even more fancy input devices


[7/9/2023 9:14 PM] andi15701
and wonders why things are screwed up


[7/9/2023 9:15 PM] andi15701
I think you can look up names from /proc/bus/input/devices


[7/9/2023 9:16 PM] kuratius
kobo-nia:~$ cat /proc/bus/input/devices
I: Bus=0018 Vendor=0000 Product=0000 Version=0000
N: Name="ektf2232"
P: Phys=
S: Sysfs=/devices/platform/soc/2100000.bus/21a0000.i2c/i2c-0/0-0015/input/input0
U: Uniq=
H: Handlers=event0 
B: PROP=2
B: EV=b
B: KEY=400 0 0 0 0 0 0 0 0 0 0
B: ABS=2608000 3


[7/9/2023 9:16 PM] andi15701
thet you have the name


[7/9/2023 9:16 PM] kuratius
kobo-nia:~$ sudo vi /etc/udev/rules.d/99-touch.rules
kobo-nia:~$ cat /etc/udev/rules.d/99-touch.rules 
ATTRS{name}=="ektf2232", ENV{LIBINPUT_CALIBRATION_MATRIX}="0.568,0,0,0,0.631,0"
kobo-nia:~$


[7/9/2023 9:17 PM] szybet
udev, form what i understand affects only libinput?


[7/9/2023 9:17 PM] kuratius
these numbers are placeholders for the time being, could be wrong


[7/9/2023 9:17 PM] szybet
im asking overall


[7/9/2023 9:19 PM] andi15701
SUBSYSTEM=="input", ATTRS{phys}=="spi0.0/input-ts", ENV{WL_CALIBRATION}="1.094563 -0.020949 -34.586121 0.009427 -1.148506 503.816956", ENV{LIBINPUT_CALIBRATION_MATRIX}="1.109179 0.000000 -0.055283 0.000000 -1.192340 1.081266 0.000000 0.000000 1.000000"


[7/9/2023 9:19 PM] andi15701
you could add other things there as well


[7/9/2023 9:19 PM] andi15701
from n900 things


[7/9/2023 9:20 PM] andi15701
I need to lookup that topic again


[7/9/2023 9:20 PM] andi15701
fortunately, the cyttsp5 stuff is not affected


[7/9/2023 9:20 PM] andi15701
and gives out the right thing out of the box


[7/9/2023 9:21 PM] andi15701
zforce_ts might need rotation


[7/9/2023 9:24 PM] kuratius
also with the current calibration (0,0) is bottom left


[7/9/2023 9:24 PM] kuratius
should it be top left or something?


[7/9/2023 9:25 PM] kuratius
is just going through the calibration tool in weston likely to work?


[7/9/2023 9:25 PM] kuratius
this is touching bottom left 
Event: time 1688930600.578182, type 3 (EV_ABS), code 0 (ABS_X), value 36
Event: time 1688930600.578182, type 3 (EV_ABS), code 1 (ABS_Y), value 57


[7/9/2023 9:25 PM] andi15701
might be enough


[7/9/2023 9:26 PM] kuratius
ok then I will make an image with weston


[7/9/2023 9:26 PM] kuratius
sideloading isnt likely to work for that right?


[7/9/2023 9:26 PM] andi15701
well you can install anything directly via wifi


[7/9/2023 9:26 PM] kuratius
current image is xfce


[7/9/2023 9:26 PM] kuratius
ah


[7/9/2023 9:27 PM] kuratius
will try sudo apk add weston


[7/9/2023 9:27 PM] kuratius
also apparently wifi still disconnects randomly


[7/9/2023 9:27 PM] kuratius
super weird


[7/9/2023 9:28 PM] kuratius
kobo-nia:~$ sudo rc-service wpa_supplicant stop
I did this


[7/9/2023 9:28 PM] andi15701
well, you need wpa_supplicant


[7/9/2023 9:28 PM] andi15701
if you use the nmt-stuff


[7/9/2023 9:28 PM] kuratius
I used iwd again


[7/9/2023 9:29 PM] kuratius
after running evtest my wifi connection was gone


[7/9/2023 9:29 PM] andi15701
I had not much success on tho kobo with iwd


[7/9/2023 9:29 PM] kuratius
I did sudo apk add evtest
evtest
ctrl+c 
then sudo apk add weston returned an io error


[7/9/2023 9:32 PM] kuratius
nmtui-connect says it's not authorized to control networking


[7/9/2023 9:32 PM] kuratius
sudo works


[7/9/2023 9:35 PM] kuratius
--- google.com ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 20.371/191.886/533.993 ms
kobo-nia:~$ sudo apk add weston-calibrator
ERROR: unable to select packages:
  weston-calibrator (no such package):
    required by: world[weston-calibrator]
kobo-nia:~$ sudo apk add weston
After this operation, 0 B of additional disk space will be used.
OK: 949 MiB in 645 packages
kobo-nia:~$


[7/9/2023 9:35 PM] kuratius
(I already ran apk add weston once before)


[7/9/2023 9:36 PM] kuratius
kobo-nia:~$ weston-calibrator
-ash: weston-calibrator: not found
kobo-nia:~$


[7/9/2023 9:36 PM] kuratius
guess I have to redo the install process with weston


[7/9/2023 9:37 PM] andi15701
apk add postmarketos-ui-weston


[7/9/2023 9:37 PM] kuratius
[21:37:07] Available user interfaces (13): 
[21:37:07] * none: Bare minimum OS image for testing and manual customization. The "console" UI should be selected if a graphical UI is not desired.
[21:37:07] * asteroid: (Wayland) Smartwatch UI from AsteroidOS
[21:37:07] * console: Console environment, with no graphical/touch UI
[21:37:07] * fbkeyboard: Plain framebuffer console with touchscreen keyboard support
[21:37:07] * gnome: (Wayland) Gnome Shell
[21:37:07] * gnome-mobile: (Wayland) Gnome Shell patched to adapt better to phones (Experimental)
[21:37:07] * i3wm: (X11) Tiling WM (keyboard required)
[21:37:07] * lxqt: (X11) Lightweight Qt Desktop Environment (stylus recommended)
[21:37:07] * mate: (X11) MATE Desktop Environment, fork of GNOME2 (stylus recommended)
[21:37:07] * plasma-desktop: (X11/Wayland) KDE Desktop Environment (works well with tablets)
[21:37:07] * shelli: Plain console with touchscreen gesture support
[21:37:07] * sxmo-de-dwm: Simple Mobile: Mobile environment based on SXMO and running on dwm
[21:37:07] * sxmo-de-sway: Simple Mobile: Mobile environment based on SXMO and running on sway
[21:37:07] * xfce4: (X11) Lightweight desktop (stylus recommended)
[21:37:07] NOTE: 6 user interfaces are not available. If device supports GPU acceleration, set "deviceinfo_gpu_accelerated" to make UIs available. See: <https://wiki.postmarketos.org/wiki/Deviceinfo_reference
[21:37:07] User interface [xfce4]: weston
[21:37:10] ERROR: Invalid user interface specified, please type in one from the list above.
[21:37:10] User interface [xfce4]:

{Embed}
https://wiki.postmarketos.org/wiki/Deviceinfo_reference
Deviceinfo reference


[7/9/2023 9:37 PM] kuratius
will try this sec


[7/9/2023 9:38 PM] kuratius
kobo-nia:~$ weston-calibrator
error: XDG_RUNTIME_DIR is invalid or not set in the environment.
failed to connect to Wayland display: No such file or directory
failed to create display: No such file or directory
kobo-nia:~$


[7/9/2023 9:38 PM] kuratius
lightdm with xfce is still running


[7/9/2023 9:38 PM] kuratius
should I disable it?


[7/9/2023 9:39 PM] kuratius
this is from pmbootstrap init btw


[7/9/2023 9:42 PM] kuratius
wiki article mentions tslib, will try installing that


[7/9/2023 9:42 PM] kuratius
kobo-nia:~$ sudo apk add tslib
After this operation, 0 B of additional disk space will be used.
OK: 951 MiB in 654 packages
kobo-nia:~$ tslib
-ash: tslib: not found
kobo-nia:~$


[7/9/2023 9:43 PM] kuratius
kobo-nia:~$ apk search tslib
htslib-1.17-r1
htslib-dev-1.17-r1
htslib-doc-1.17-r1
htslib-static-1.17-r1
htslib-tools-1.17-r1
py3-rtslib-2.1_p75-r2
py3-rtslib-pyc-2.1_p75-r2
tslib-1.22-r1
tslib-dev-1.22-r1
tslib-doc-1.22-r1
kobo-nia:~$


[7/9/2023 9:44 PM] kuratius
tslib-dev exists


[7/9/2023 9:44 PM] kuratius
kobo-nia:~$ sudo apk add tslib-1.22-r1 
ERROR: unable to select packages:
  tslib-1.22-r1 (no such package):
    required by: world[tslib-1.22-r1]
kobo-nia:~$ sudo apk add tslib-1.22
ERROR: unable to select packages:
  tslib-1.22 (no such package):
    required by: world[tslib-1.22]
kobo-nia:~$ sudo apk add tslib-dev
The following NEW packages will be installed:
  tslib-dev
Need to download 4149 B of packages.
After this operation, 32 KiB of additional disk space will be used.
Do you want to continue [Y/n]? 
(1/1) Installing tslib-dev (1.22-r1)
OK: 951 MiB in 655 packages
kobo-nia:~$


[7/9/2023 9:46 PM] andi15701
if you want to use weston


[7/9/2023 9:46 PM] andi15701
you first need to start the environment


[7/9/2023 9:46 PM] andi15701
weston --tty 3


[7/9/2023 9:46 PM] andi15701
or something like that


[7/9/2023 9:47 PM] kuratius
can I disable lightdm for the time being?


[7/9/2023 9:47 PM] andi15701
yes


[7/10/2023 4:02 AM] kuratius
Something urgent came up and I got sidetracked, sorry will do the rest tomorrow


[7/10/2023 10:59 PM] kuratius
kobo-nia:~$ weston --tty 3
Date: 2023-07-10 CEST
[22:59:32.102760576] weston 12.0.1
               https://wayland.freedesktop.org
               Bug reports to: https://gitlab.freedesktop.org/wayland/weston/issues/
               Build: 12.0.1
[22:59:32.1714315873] Command line: weston --tty 3
[22:59:32.1702305850] OS: Linux, 6.3.0, #6-postmarketOS Sat Jul  8 20:03:58 UTC 2023, armv7l
[22:59:32.808334126] Flight recorder: enabled
[22:59:32.980575588] fatal: environment variable XDG_RUNTIME_DIR is not set.
Refer to your distribution on how to get it, or
http://www.freedesktop.org/wiki/Specifications/basedir-spec
on how to implement it.
kobo-nia:~$

{Embed}
https://gitlab.freedesktop.org/wayland/weston/issues/
Issues · wayland / weston · GitLab
A lightweight and functional Wayland compositor
/mnt/data/projects/git/conversations/media/twitter_card-570ddb06edf56a2312253c5872489-B0E6E.jpg


[7/10/2023 11:01 PM] kuratius
btw if I edit the config file manually (or obtain the correct one via weston-calibrator or similar tools) and find the correct settings via trial and error, do I just need 
225 sudo vi /etc/udev/rules.d/99-touch.rules
 226 sudo udevadm control --reload
 227 udevadm trigger
this?


[7/10/2023 11:20 PM] kuratius
https://github.com/kreijack/xlibinput_calibrator trying to compile this atm

{Embed}
https://github.com/kreijack/xlibinput_calibrator
GitHub - kreijack/xlibinput_calibrator: Touch calibrator for libinput
Touch calibrator for libinput. Contribute to kreijack/xlibinput_calibrator development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/xlibinput_calibrator-CDF1A


[7/10/2023 11:23 PM] kuratius
compiled it, but getting an error about the display


[7/10/2023 11:25 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ ./xlibinput_calibrator --list-devices
ERROR: can't open display ':0'
kobo-nia:~/xlibinput_calibrator/src$


[7/10/2023 11:29 PM] szybet
You need xorg


[7/10/2023 11:29 PM] szybet
You propably run it from ssh


[7/10/2023 11:29 PM] szybet
Try xhost command


[7/10/2023 11:29 PM] szybet
Or export display command


[7/10/2023 11:29 PM] szybet
🫡


[7/10/2023 11:29 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ xhost
-ash: xhost: not found


[7/10/2023 11:30 PM] szybet
On arch linux xorg-tools??


[7/10/2023 11:30 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ sudo apk add xorg-tools
[sudo] password for dk-x86: 
ERROR: unable to select packages:
  xorg-tools (no such package):
    required by: world[xorg-tools]
kobo-nia:~/xlibinput_calibrator/src$ apk search xorg-tools
kobo-nia:~/xlibinput_calibrator/src$


[7/10/2023 11:31 PM] kuratius
export display command is what command?


[7/10/2023 11:31 PM] kuratius
surely not "export display"?


[7/10/2023 11:32 PM] kuratius
xinit does something


[7/10/2023 11:32 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ xinit

/usr/libexec/Xorg.wrap: Only console users are allowed to run the X server
xinit: giving up
xinit: unable to connect to X server: Connection refused
xinit: server error
kobo-nia:~/xlibinput_calibrator/src$ sudo xinit


X.Org X Server 1.21.1.8
X Protocol Version 11, Revision 0
Current Operating System: Linux kobo-nia 6.3.0 #6-postmarketOS Sat Jul  8 20:03:58 UTC 2023 armv7l
Kernel command line: console=ttymxc0,115200 debug
 
Current version of pixman: 0.42.2
    Before reporting problems, check http://wiki.x.org
    to make sure that you have the latest version.
Markers: (--) probed, (**) from config file, (==) default setting,
    (++) from command line, (!!) notice, (II) informational,
    (WW) warning, (EE) error, (NI) not implemented, (??) unknown.
(==) Log file: "/var/log/Xorg.0.log", Time: Mon Jul 10 23:32:20 2023
(==) Using system config directory "/usr/share/X11/xorg.conf.d"
MESA-LOADER: failed to open mxc_epdc: Error loading shared library /usr/lib/xorg/modules/dri/mxc_epdc_dri.so: No such file or directory (search paths /usr/lib/xorg/modules/dri, suffix _dri)
xinit: Unable to run program "xterm": No such file or directory
Specify a program on the command line or make sure that /usr/bin
is in your path.

xinit: connection to X server lost

waiting for X server to shut down ..(II) Server terminated successfully (0). Closing log file.

kobo-nia:~/xlibinput_calibrator/src$


[7/10/2023 11:33 PM] kuratius
makes the screen flash funny


[7/10/2023 11:34 PM] kuratius
I'll reboot with lightdm on and see what happens


[7/10/2023 11:35 PM] kuratius
also installing xterm


[7/10/2023 11:36 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ ./xlibinput_calibrator --list-devices
ERROR: cannot find a valid DISPLAY to open
kobo-nia:~/xlibinput_calibrator/src$


[7/10/2023 11:36 PM] kuratius
funny error


[7/10/2023 11:39 PM] kuratius
also wifi now autoconnects after I used nmtui-connect once


[7/10/2023 11:39 PM] kuratius
so no need to redo the wifi connection after  a reboot


[7/10/2023 11:39 PM] szybet
Network manager works in the background


[7/10/2023 11:40 PM] kuratius
with iwd I had to enter 3 different commands cause it wasnt started automatically and it didnt autoconnect I think


[7/10/2023 11:40 PM] kuratius
but anyway


[7/10/2023 11:40 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ sudo xinit
[sudo] password for dk-x86: 


X.Org X Server 1.21.1.8
X Protocol Version 11, Revision 0
Current Operating System: Linux kobo-nia 6.3.0 #6-postmarketOS Sat Jul  8 20:03:58 UTC 2023 armv7l
Kernel command line: console=ttymxc0,115200 debug
 
Current version of pixman: 0.42.2
    Before reporting problems, check http://wiki.x.org
    to make sure that you have the latest version.
Markers: (--) probed, (**) from config file, (==) default setting,
    (++) from command line, (!!) notice, (II) informational,
    (WW) warning, (EE) error, (NI) not implemented, (??) unknown.
(==) Log file: "/var/log/Xorg.0.log", Time: Mon Jul 10 23:40:25 2023
(==) Using system config directory "/usr/share/X11/xorg.conf.d"
MESA-LOADER: failed to open mxc_epdc: Error loading shared library /usr/lib/xorg/modules/dri/mxc_epdc_dri.so: No such file or directory (search paths /usr/lib/xorg/modules/dri, suffix _dri)


[7/10/2023 11:41 PM] kuratius
this works and gives some display output


[7/10/2023 11:42 PM] kuratius
xlibinput calibrator still complains about the no valid display part


[7/10/2023 11:42 PM] kuratius
got it


[7/10/2023 11:42 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ sudo ./xlibinput_calibrator --display=:0
[sudo] password for dk-x86:


[7/10/2023 11:42 PM] kuratius
this worked


[7/10/2023 11:42 PM] kuratius
just tried random stuff


[7/10/2023 11:43 PM] kuratius
it successfully ran the calibration sequence


[7/10/2023 11:44 PM] kuratius
asked me to tap on specific positions and everything


[7/10/2023 11:44 PM] kuratius
now just need to find where the config file is


[7/10/2023 11:46 PM] kuratius
github readme says it writes the config automatically


[7/10/2023 11:46 PM] kuratius
no idea where, but will enable lightdm and reboot see if stuff works now


[7/10/2023 11:48 PM] kuratius
also it apparently has an option to save the output to a file


[7/10/2023 11:48 PM] kuratius
neat


[7/10/2023 11:52 PM] kuratius
....why is the x11 server on xfce4 not running on :0??


[7/10/2023 11:52 PM] andi15701
well create a libinput rules file


[7/10/2023 11:53 PM] andi15701
and xfce4 on :0 probably you needed to set XAUTHORITY


[7/10/2023 11:53 PM] andi15701
too


[7/10/2023 11:54 PM] kuratius
where do I set that? when calling the xinput calibrator?


[7/10/2023 11:56 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ sudo ./xlibinput_calibrator --display=:0 --
output-file-x11-config=touch-config.txt
[sudo] password for dk-x86: 
Writing xorg.conf calibration data to 'touch-config.txt'

Section "InputClass"
    Identifier    "calibration"
    MatchProduct    "ektf2232"
    Option        "CalibrationMatrix"    "0.025618 0.897819 -0.030481 -1.627177 -0.101816 1.169231 0.000000 0.000000 1.000000 "
EndSection

kobo-nia:~/xlibinput_calibrator/src$


[7/10/2023 11:56 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ cat touch-config.txt 

Section "InputClass"
    Identifier    "calibration"
    MatchProduct    "ektf2232"
    Option        "CalibrationMatrix"    "0.025618 0.897819 -0.030481 -1.627177 -0.101816 1.169231 0.000000 0.000000 1.000000 "
EndSection

kobo-nia:~/xlibinput_calibrator/src$


[7/10/2023 11:57 PM] kuratius
this is by doing sudo xinit 
then opening another ssh session and doing sudo ./xlibinput_calibrator --display=:0 --
output-file-x11-config=touch-config.txt
and then following the steps


[7/10/2023 11:58 PM] kuratius
(tapping the indicated 4 points on the screen)


[7/10/2023 11:59 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ sudo ./xlibinput_calibrator --display=:0 --
output-file-xinput-cmd=touch-config-xinput.txt
Writing calibration script to 'touch-config-xinput.txt'

       xinput set-float-prop "ektf2232" "libinput Calibration Matrix" \
            -0.014768 0.912615 -0.030991 -1.911903 0.100375 \
            1.098285 0.000000 0.000000 1.000000

kobo-nia:~/xlibinput_calibrator/src$ cat touch-config-xinput.txt 

       xinput set-float-prop "ektf2232" "libinput Calibration Matrix" \
            -0.014768 0.912615 -0.030991 -1.911903 0.100375 \
            1.098285 0.000000 0.000000 1.000000

kobo-nia:~/xlibinput_calibrator/src$ 
also did this one


[7/11/2023 12:08 AM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ cat /etc/udev/rules.d/99-touch.rules 
ATTRS{name}=="ektf2232", ENV{LIBINPUT_CALIBRATION_MATRIX}="0.568,0,0,0,0.631,0"
kobo-nia:~/xlibinput_calibrator/src$ 

this is a file I created manually


[7/11/2023 12:08 AM] kuratius
I could try just entering the values from the xinput calibrator, but they use different formats


[7/11/2023 12:10 AM] kuratius
-0.014768,0.912615,-0.030991,-1.911903,0.100375,1.098285 will try just entering this and see if it gets me anyhwere


[7/11/2023 5:55 PM] andi15701
hmm, that looks like rotation


[7/11/2023 5:56 PM] andi15701
and rotation is kernel job


[7/11/2023 9:51 PM] andi15701
what does evtest say about maximum dimensions?


[7/11/2023 9:51 PM] andi15701
does that rules file have any effect?


[7/11/2023 9:56 PM] szybet
to my knowledge it shouldt have


[7/11/2023 9:56 PM] szybet
we use in inkbox udev rules to say libinput to not touch some devices - and this doesnt affect evdev


[7/11/2023 10:02 PM] kuratius
is that in the log when you run evtest or does it need special options? if it's in the log, see here


[7/11/2023 10:03 PM] andi15701
it is in the log


[7/11/2023 10:03 PM] andi15701
Event code 53 (ABS_MT_POSITION_X)
      Value      0
      Min        0
      Max     1919
    Event code 54 (ABS_MT_POSITION_Y)
      Value      0
      Min        0
      Max     1435


[7/11/2023 10:04 PM] andi15701
so in theory we should be able to calculate the matrix from that


[7/11/2023 10:04 PM] andi15701
or the userspace should to it by itself


[7/11/2023 10:06 PM] andi15701
so we have:  first row: 0 0.9 0 second row: -1.9  0 1


[7/11/2023 10:06 PM] andi15701
this somehow looks like rotation


[7/11/2023 10:07 PM] kuratius
> 1024/1919
> 0.5336112558624283
> >>> 758/1435
> 0.5282229965156794


[7/11/2023 10:08 PM] kuratius
why are the coefficients so nearly the same but there it is 0.9 and -1.9?


[7/11/2023 10:08 PM] kuratius
that's weird


[7/11/2023 10:09 PM] kuratius
rotation by 90 degrees would just swap some coordinates and change signs


[7/11/2023 10:10 PM] andi15701
rotatation + scaling


[7/11/2023 10:10 PM] andi15701
but does not make sense yet to me


[7/11/2023 10:11 PM] kuratius
e.g. anti clockwise 90 degree rotation is [[0,1], [-1,0]]


[7/11/2023 10:12 PM] kuratius
wait sec


[7/11/2023 10:13 PM] kuratius
that's clockwise I think


[7/11/2023 10:13 PM] kuratius
anti clockwise is [[0,-1],[1,0]]


[7/11/2023 10:14 PM] kuratius
[[cos(alpha), -sin(alpha)],[sin(alpha), cos(alpha]]


[7/11/2023 10:15 PM] andi15701
and then you need translation after that


[7/11/2023 10:15 PM] andi15701
because you rotate around (0,0) and that is not in the middle


[7/11/2023 10:16 PM] kuratius
the offset output by the calibration program is tiny


[7/11/2023 10:16 PM] kuratius
maybe it's not working right


[7/11/2023 10:17 PM] kuratius
bottom left corner is (0,0) according to evtest btw


[7/11/2023 10:18 PM] kuratius
micro usb is towards the right


[7/11/2023 10:20 PM] kuratius
bottom left tap :
```Event: time 1689106807.644336, type 3 (EV_ABS), code 0 (ABS_X), value 42
Event: time 1689106807.644336, type 3 (EV_ABS), code 1 (ABS_Y), value 67
```


[7/11/2023 10:21 PM] kuratius
top left
```Event: time 1689106859.446147, type 3 (EV_ABS), code 0 (ABS_X), value 1253
Event: time 1689106859.446147, type 3 (EV_ABS), code 1 (ABS_Y), value 75```


[7/11/2023 10:23 PM] kuratius
top right
Event: time 1689106992.102175, type 3 (EV_ABS), code 0 (ABS_X), value 1305
Event: time 1689106992.102175, type 3 (EV_ABS), code 1 (ABS_Y), value 1853


[7/11/2023 10:23 PM] kuratius
where does the OS expect (0,0) to be? top left?


[7/11/2023 10:26 PM] andi15701
where gfx output (0,0) is


[7/11/2023 10:27 PM] kuratius
I thought that was top left, but maybe I am confusing something


[7/11/2023 10:27 PM] andi15701
if no rotation is set


[7/11/2023 10:28 PM] andi15701
well , look the orientation of xfce or commandline prompt


[7/11/2023 10:28 PM] andi15701
so the touchscreen has to be rotated


[7/11/2023 10:28 PM] andi15701
and that is kernel job


[7/11/2023 10:29 PM] andi15701
and providing min/max


[7/11/2023 10:30 PM] kuratius
xfce orientation is such that the screen is readable normally if the microusb is on the right


[7/11/2023 10:30 PM] kuratius
same for command line


[7/11/2023 10:35 PM] andi15701
Documentation/devicetree/bindings/input/touchscreen/touchscreen.yaml


[7/11/2023 10:35 PM] andi15701
in kernel


[7/11/2023 10:36 PM] andi15701
some touchscreen-swap-x-y has to be added


[7/11/2023 10:36 PM] andi15701
and maybe some invert


[7/11/2023 10:37 PM] andi15701
touchscreen_apply_prop_to_x_y


[7/11/2023 10:37 PM] andi15701
in drivers/input/touchscreen.c


[7/11/2023 10:37 PM] andi15701
does the math


[7/11/2023 10:38 PM] kuratius
if we are multiplying by a matrix  and adding a vector anyway, is it important that the kernel does some parts or should we just put everything in the kernel?


[7/11/2023 10:42 PM] andi15701
well, step by step


[7/11/2023 10:43 PM] andi15701
lets first get the orientation correct


[7/11/2023 10:43 PM] andi15701
the parameters should go into the kernel


[7/11/2023 11:42 PM] kuratius
awful naming, but this  basically curve fits the offset and the matrix for the coordinate transformation


[7/11/2023 11:43 PM] kuratius
also there is probably a bug with it


[7/11/2023 11:43 PM] kuratius
sec


[7/11/2023 11:55 PM] kuratius
```import numpy as np
x_max=1435
y_max=1919

xmax_new=758

x1=[0, #bottom left
x_max,   #top left
x_max, #top right
0] #bottom right
x2=[0,#bottom left
0, #top left
y_max, #top right
y_max] #bottom right

y=[758,
0,
0,
758]


Ax=np.array([x1,x2, np.ones(len(x1))]).T

A=np.dot((np.linalg.inv(Ax.T@Ax)@Ax.T),y)




ymax_new=1024

y_max
y=[0,
0,
1024,
1024]


Ay=np.array([ x1,x2, np.ones(len(x1))]).T

B=np.dot((np.linalg.inv(Ay.T@Ay)@Ay.T),y)


matrix=np.array([[A[0], A[1]],[B[0],B[1]]])
offset=np.array([A[2],B[2]])


def transform(matrix,offset, x,y):
    return np.dot(matrix,np.array([x,y]))+offset

transform(matrix, offset, 0,y_max)

```


[7/11/2023 11:56 PM] kuratius
this is correct now


[7/11/2023 11:56 PM] kuratius
matrix [[-5.28222997e-01  8.32667268e-17]
 [-1.66533454e-16  5.33611256e-01]]


[7/11/2023 11:56 PM] kuratius
offset [7.58000000e+02 5.68434189e-14]


[7/11/2023 11:58 PM] szybet
If this is just a complicated offset - that is the same for all coordinates - then i might have a solution

In micro processors ( arduino ) ADC measurements are not perfect, they need many steps to make it better - a quick hack is to make a excel spread sheet with gathered values and actual values and apply a function that will calculate a formula, that applied to the result will make it more precise

It could maybe be applied to this too?

Its called lineage regression? Polish wikipedia page:
https://pl.wikipedia.org/wiki/Regresja_liniowa

{Embed}
https://pl.wikipedia.org/wiki/Regresja_liniowa
Regresja liniowa
Regresja liniowa – w modelowaniu statystycznym, metody oparte o liniowe kombinacje zmiennych i parametrów dopasowujących model do danych. Dopasowana linia lub krzywa regresji reprezentuje oszacowaną wartość oczekiwaną zmiennej 
  
    y
    y
   przy konkretnych wartościach innej zmiennej lub zmiennych 
  
    
      x
      .
    
    x.
   W n...
/mnt/data/projects/git/conversations/media/1200px-Regresja_liniowa_%25E2%2580%2593_pr-DF859.png


[7/11/2023 11:58 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-0F698.png


[7/11/2023 11:59 PM] kuratius
that is what I did


[7/11/2023 11:59 PM] kuratius
but better


[7/11/2023 11:59 PM] szybet
Whoa cool


[7/11/2023 11:59 PM] szybet
How better


[7/11/2023 11:59 PM] kuratius
https://en.wikipedia.org/wiki/Polynomial_regression

{Embed}
https://en.wikipedia.org/wiki/Polynomial_regression
Polynomial regression
In statistics, polynomial regression is a form of regression analysis in which the relationship between the independent variable x and the dependent variable y is modelled as an nth degree polynomial in x. Polynomial regression fits a nonlinear relationship between the value of x and the corresponding conditional mean of y, denoted E(y |x). Alth...


[7/11/2023 11:59 PM] kuratius
multilinear version


[7/12/2023 12:00 AM] szybet
Another complicated math thing, cool


[7/12/2023 12:00 AM] kuratius
A=np.dot((np.linalg.inv(Ax.T@Ax)@Ax.T),y)


[7/12/2023 12:00 AM] szybet
i will save it, could help with arduino 🥴


[7/12/2023 12:00 AM] szybet
Thanks


[7/12/2023 12:00 AM] kuratius
this line is from the wiki article


[7/12/2023 12:00 AM] kuratius
my naming scheme may be super confusing


[7/12/2023 12:00 AM] kuratius
for the coordinates I mean


[7/12/2023 12:01 AM] kuratius
I will change it to make it similar to the wiki articke


[7/12/2023 12:13 AM] kuratius
```import numpy as np
x_max=1435
y_max=1919

xmax_new=758

x1=[0, #bottom left
x_max,   #top left
x_max, #top right
0] #bottom right
x2=[0,#bottom left
0, #top left
y_max, #top right
y_max] #bottom right

y=[xmax_new, 
0,
0,
xmax_new]


X=np.array([x1,x2, np.ones(len(x1))]).T

beta_x=np.dot(np.linalg.inv(X.T@X)@X.T,y)




ymax_new=1024

y=[0,
0,
ymax_new,
ymax_new]


X=np.array([ x1,x2, np.ones(len(x1))]).T
print(X.shape)
print(np.shape(y))
beta_y=np.dot(np.linalg.inv(X.T@X)@X.T,y)


matrix=np.array([[beta_x[0], beta_x[1]],[beta_y[0],beta_y[1]]])
offset=np.array([beta_x[2],beta_y[2]])


def transform(matrix,offset, x,y):
    return np.dot(matrix,np.array([x,y]))+offset

transform(matrix, offset, 0,0)```


[7/12/2023 12:13 AM] kuratius
beta is the beta from the wiki article


[7/12/2023 12:13 AM] kuratius
y is the y from the wiki article


[7/12/2023 12:13 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/43206aff0ea7e9df27870715d4912fe2d5b16b98-F7C15.png


[7/12/2023 12:16 AM] kuratius
this is based on the guess that the screen expects top left to be (0,0) and bottom right to be (758,1024)


[7/12/2023 12:18 AM] kuratius
note that doing it this way is not optimal for performance, it results in gigantic matrices that need to be inverted


[7/12/2023 12:18 AM] kuratius
there is a second way that has a lot of sums but way smaller matrices


[7/12/2023 12:20 AM] kuratius
https://mathworld.wolfram.com/LeastSquaresFittingPolynomial.html

{Embed}
https://mathworld.wolfram.com/LeastSquaresFittingPolynomial.html
Least Squares Fitting--Polynomial -- from Wolfram MathWorld
Generalizing from a straight line (i.e., first degree polynomial) to a kth degree polynomial  y=a_0+a_1x+...+a_kx^k,  (1)   the residual is given by  R^2=sum_(i=1)^n[y_i-(a_0+a_1x_i+...+a_kx_i^k)]^2.  (2)   The partial derivatives (again dropping superscripts) are (partial(R^2))/(partiala_0) = -2sum_(i=1)^(n)[y-(a_0+a_1x+...+a_kx^k)]=0 (3)  (par...
/mnt/data/projects/git/conversations/media/share-21050.png


[7/12/2023 12:21 AM] kuratius
both can be derived by doing least squares fitting, i.e. defining an error function based on sum of squared error and minimizing it


[7/12/2023 12:22 AM] kuratius
needs calculus but isnt complicated if you know how to find the minimum of a function


[7/12/2023 12:24 AM] kuratius
come to think of it, are kindles portrait or landscape by default?


[7/12/2023 12:36 AM] kuratius
I cant tell if the config file isnt being read or if my assumption of about the origin of the gfx coordinates was wrong


[7/12/2023 12:40 AM] kuratius
@andi on your clara, where is the origin for evtest events (bottom left?)  and where is the origin for the gfx coordinates?


[7/12/2023 8:45 AM] andi15701
if usb socket is on the right side, both are top left


[7/12/2023 8:45 AM] andi15701
on the shine2 things are different


[7/12/2023 8:46 AM] andi15701
there we have a 90 degree rotation


[7/12/2023 8:46 AM] andi15701
but there is no difference in scaling


[7/12/2023 9:34 AM] kuratius
How do I check if the config file is being read?


[7/12/2023 9:40 AM] kuratius
kobo-nia:~$ libinput list-devices
Device:           ektf2232
Kernel:           /dev/input/event0
Group:            1
Seat:             seat0, default
Capabilities:     touch 
Tap-to-click:     n/a
Tap-and-drag:     n/a
Tap drag lock:    n/a
Left-handed:      n/a
Nat.scrolling:    n/a
Middle emulation: n/a
Calibration:      identity matrix
Scroll methods:   none
Click methods:    none
Disable-w-typing: n/a
Disable-w-trackpointing: n/a
Accel profiles:   n/a
Rotation:         0.0

kobo-nia:~$


[7/12/2023 9:40 AM] kuratius
... it is not being read


[7/12/2023 9:49 AM] kuratius
kobo-nia:/etc/udev/rules.d$ cat 99-ektf2232.rules 
ATTRS{name}=="ektf2232", ENV{LIBINPUT_CALIBRATION_MATRIX}="-0.528,0,758,0,0.5336,0"
kobo-nia:/etc/udev/rules.d$


[7/12/2023 9:49 AM] kuratius
I would like to test this configuration


[7/12/2023 9:50 AM] kuratius
should I rename it? putting touch instead of ektf2232 didnt work


[7/12/2023 9:52 AM] szybet
its elan something


[7/12/2023 9:52 AM] szybet
running udev with debug info will show you the devices names


[7/12/2023 9:52 AM] szybet
there is also a libinput command that will give you those


[7/12/2023 9:52 AM] kuratius
als why doesnt xinput work??


[7/12/2023 9:53 AM] szybet
udev daemon with debug config once more


[7/12/2023 9:53 AM] szybet
they really have excelent logs


[7/12/2023 9:54 AM] kuratius
so what's the command?


[7/12/2023 9:54 AM] kuratius
... you mean this? https://discord.com/channels/809205711778480158/1095426950811619418/1128591616127553537


[7/12/2023 9:55 AM] szybet
um cant remember, maybe this

killall udevd
udevd -D 

something like that?


[7/12/2023 9:55 AM] szybet
yes


[7/12/2023 9:55 AM] szybet
why is the name diffrent


[7/12/2023 9:57 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-F853B.txt


[7/12/2023 10:00 AM] szybet
what rule you added?


[7/12/2023 10:01 AM] kuratius
99-ektf something something


[7/12/2023 10:01 AM] kuratius
but libinput still thinks it doesnt have a calibration


[7/12/2023 10:01 AM] kuratius
so...


[7/12/2023 10:01 AM] kuratius
it is not being read


[7/12/2023 10:01 AM] szybet
`Reading rules file: /etc/udev/rules.d/99-ektf2232.rules`


[7/12/2023 10:01 AM] szybet
it is


[7/12/2023 10:01 AM] kuratius
I know


[7/12/2023 10:01 AM] kuratius
but that is clearly a lie


[7/12/2023 10:02 AM] szybet
what is the content once more?


[7/12/2023 10:02 AM] kuratius
here


[7/12/2023 10:02 AM] andi15701
libinput


[7/12/2023 10:02 AM] szybet
as for logic try:
`ATTRS{device}=="ektf2232", ENV{LIBINPUT_CALIBRATION_MATRIX}="-0.528,0,758,0,0.5336,0"`


[7/12/2023 10:03 AM] andi15701
or add some RUN attribute


[7/12/2023 10:03 AM] andi15701
but also check with libinput tool


[7/12/2023 10:03 AM] andi15701
whether it reports correct things


[7/12/2023 10:03 AM] kuratius
kobo-nia:/etc/udev/rules.d$ libinput 99-ektf2232.rules 
libinput: 99-ektf2232.rules is not installed
kobo-nia:/etc/udev/rules.d$


[7/12/2023 10:09 AM] andi15701
something like udevadm test /sys/bus/i2c/devices/1-0024/input/input0


[7/12/2023 10:11 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-DF4B4.txt


[7/12/2023 10:11 AM] andi15701
you need to set the correct path


[7/12/2023 10:11 AM] andi15701
to the touchscreen


[7/12/2023 10:11 AM] andi15701
that was clara example


[7/12/2023 10:13 AM] kuratius
kobo-nia:/etc/udev/rules.d$ cat /sys/bus/i2c/devices/
0-0015/  0-0036/  0-0062/  3-0032/  i2c-0/   i2c-3/
kobo-nia:/etc/udev/rules.d$ cat /sys/bus/i2c/devices/0-00
0-0015/  0-0036/  0-0062/
kobo-nia:/etc/udev/rules.d$ cat /sys/bus/i2c/devices/0-0015/
driver/                          power/
input/                           subsystem/
modalias                         supplier:platform:209c000.gpio/
name                             uevent
of_node/
kobo-nia:/etc/udev/rules.d$ cat /sys/bus/i2c/devices/0-0015/input/input0/
capabilities/  id/            name           properties     uniq
device/        inhibited      phys           subsystem/
event0/        modalias       power/         uevent


[7/12/2023 10:13 AM] andi15701
/sys/bus/i2c/devices/0-0015/input/input0 I guess


[7/12/2023 10:13 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-8C2A8.txt


[7/12/2023 10:14 AM] kuratius
kobo-nia:/etc/udev/rules.d$ cat 99-ektf2232.rules 
ATTRS{device}=="ektf2232", ENV{LIBINPUT_CALIBRATION_MATRIX}="-0.528,0,758,0,0.5336,0"
kobo-nia:/etc/udev/rules.d$ 
 should I change device back to name?


[7/12/2023 10:15 AM] andi15701
yes


[7/12/2023 10:16 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-64496.txt


[7/12/2023 10:16 AM] szybet
`LIBINPUT_CALIBRATION_MATRIX=-0.528,0,758,0,0.5336,0` works?


[7/12/2023 10:17 AM] andi15701
well, rule was executed


[7/12/2023 10:17 AM] szybet
so why wasnt it before?


[7/12/2023 10:17 AM] andi15701
so can the libinput cmdline tool now deal with the device


[7/12/2023 10:17 AM] kuratius
kobo-nia:~$ libinput list-devices
Device:           ektf2232
Kernel:           /dev/input/event0
Group:            1
Seat:             seat0, default
Capabilities:     touch 
Tap-to-click:     n/a
Tap-and-drag:     n/a
Tap drag lock:    n/a
Left-handed:      n/a
Nat.scrolling:    n/a
Middle emulation: n/a
Calibration:      identity matrix
Scroll methods:   none
Click methods:    none
Disable-w-typing: n/a
Disable-w-trackpointing: n/a
Accel profiles:   n/a
Rotation:         0.0

kobo-nia:~$


[7/12/2023 10:18 AM] kuratius
kobo-nia:/etc/udev/rules.d$ cat 99-ektf2232.rules 
ATTRS{name}=="ektf2232", ENV{LIBINPUT_CALIBRATION_MATRIX}="-0.528,0,758,0,0.5336,0"
kobo-nia:/etc/udev/rules.d$


[7/12/2023 10:18 AM] kuratius
does name need to be capitalized?


[7/12/2023 10:19 AM] kuratius
nope


[7/12/2023 10:24 AM] kuratius
@andi on your clara, is x up/down or left/right for screen coordinates?


[7/12/2023 10:26 AM] szybet
x is left / right


[7/12/2023 10:26 AM] szybet
y is up down


[7/12/2023 10:26 AM] szybet
x and y shoud be 0 both at the left top of the screen


[7/12/2023 10:31 AM] kuratius
with usb port on the right?


[7/12/2023 10:31 AM] kuratius
then I have to adjust the calibration a bit


[7/12/2023 10:34 AM] szybet
idk about the usb port?


[7/12/2023 10:34 AM] szybet
it doesnt matter?


[7/12/2023 10:35 AM] szybet
also: this depends on rotation ( which edge )


[7/12/2023 10:41 AM] kuratius
(0,0.5336112558624285,0,-0.5282229965156795,0,758.0)


[7/12/2023 4:54 PM] kuratius
btw just noticed it, but more than 2 fingers is a nogo in the debug events


[7/12/2023 4:55 PM] kuratius
if I could get past this error I would be able to see where the screeen registers then events
kobo-nia:~$ libinput debug-gui
Unable to init server: Could not connect: Connection refused


[7/12/2023 4:55 PM] kuratius
sudo doesnt work


[7/12/2023 4:57 PM] kuratius
I got it


[7/12/2023 4:58 PM] kuratius
ok yeah the calibration is super wrong


[7/12/2023 4:58 PM] kuratius
moving to the right moves the dot on the screen downwards


[7/12/2023 4:58 PM] kuratius
and tapping bottomt left (0,0) is mapped to top right


[7/12/2023 4:59 PM] kuratius
I dont have a phone that makes this easy to film so just trust me for now


[7/12/2023 4:59 PM] kuratius
for the record, I disabled lightdm
then did sudo xinit
and in a separate ssh connection I ran 
DISPLAY=:0 libinput debug-gui


[7/12/2023 5:00 PM] kuratius
I still think the default xfce4/lightdm must be misconfigured in some way


[7/12/2023 5:00 PM] kuratius
the other calibration tool didnt work with it either


[7/12/2023 5:00 PM] kuratius
I'll try again with the lightdm and the DISPLAY option, but I reckon it wont work


[7/12/2023 5:04 PM] kuratius
is it maybe getting events from a different place?


[7/12/2023 5:05 PM] kuratius
like, it's applying the calibration to something completely different


[7/12/2023 5:07 PM] kuratius
ooh


[7/12/2023 5:07 PM] kuratius
now it works


[7/12/2023 5:07 PM] kuratius
it opens a window


[7/12/2023 5:07 PM] kuratius
aaand it's miscalibrated


[7/12/2023 5:08 PM] kuratius
now if only libinput wasnt ignoring the config file I would be so happy


[7/12/2023 5:10 PM] kuratius
kobo-nia:~$ DISPLAY=:0 xinput_calibrator --list
Device "ektf2232" id=6


[7/12/2023 5:10 PM] kuratius
got this to work


[7/12/2023 5:19 PM] kuratius
kobo-nia:/etc/X11/xinit$ DISPLAY=:0 xinput list-props ektf2232
Device 'ektf2232':
    Device Enabled (123):    1
    Coordinate Transformation Matrix (124):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Rotation Angle (247):    0.000000
    libinput Rotation Angle Default (248):    0.000000
    libinput Calibration Matrix (249):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Calibration Matrix Default (250):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Send Events Modes Available (251):    1, 0
    libinput Send Events Mode Enabled (252):    0, 0
    libinput Send Events Mode Enabled Default (253):    0, 0
    Device Node (254):    "/dev/input/event0"
    Device Product ID (255):    0, 0
kobo-nia:/etc/X11/xinit$


[7/12/2023 5:27 PM] kuratius
libinput debug-gui is ignoring the calibration from xinput


[7/12/2023 5:27 PM] kuratius
not good


[7/12/2023 5:29 PM] kuratius
kobo-nia:~$ DISPLAY=:0 xinput set-prop "ektf2232" --type=float "Coordinate Trans
formation Matrix" 0 0.5336112558624285 0 -0.5282229965156795 0 758.0 0 0 1
kobo-nia:~$ DISPLAY=:0 xinput list-props ektf2232
Device 'ektf2232':
    Device Enabled (123):    1
    Coordinate Transformation Matrix (124):    0.000000, 0.533611, 0.000000, -0.528223, 0.000000, 758.000000, 0.000000, 0.000000, 1.000000
    libinput Rotation Angle (247):    0.000000
    libinput Rotation Angle Default (248):    0.000000
    libinput Calibration Matrix (249):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Calibration Matrix Default (250):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Send Events Modes Available (251):    1, 0
    libinput Send Events Mode Enabled (252):    0, 0
    libinput Send Events Mode Enabled Default (253):    0, 0
    Device Node (254):    "/dev/input/event0"
    Device Product ID (255):    0, 0
kobo-nia:~$


[7/12/2023 5:30 PM] kuratius
this does nothing


[7/12/2023 7:06 PM] andi15701
but other apps use the stuff?


[7/12/2023 9:25 PM] kuratius
I have tried modifying the "libinput calibration matrix" property also, it accepted the modification but didn't  use it


[7/12/2023 9:25 PM] kuratius
Not that I noticed


[7/12/2023 9:30 PM] andi15701
btw: the 2020.10 kobo nia u-boot should work on both somewhat


[7/12/2023 9:30 PM] andi15701
besides of powerbutton


[7/12/2023 9:30 PM] andi15701
so maybe an i2c probe for the different pmics might be possible


[7/12/2023 9:32 PM] andi15701
and so create a single image for both nia models


[7/12/2023 9:32 PM] andi15701
something like


[7/12/2023 9:33 PM] andi15701
if (rn5t618_accessible) load kobo-nia-a.dtb else load kobo-nia-b.dtb


[7/12/2023 9:37 PM] kuratius
Also xinput told me to create a config file in a directory  that doesn't exist, sec will rerun it and copy the output


[7/12/2023 9:38 PM] kuratius
I think it's weird that that directory isn't there


[7/12/2023 9:43 PM] kuratius
kobo-nia:~$ DISPLAY=:0 xinput_calibrator -v --device ektf2232 --misclick 100
DEBUG: XInputExtension version is 2.4
DEBUG: Skipping virtual master devices and devices without axis valuators.
DEBUG: Selected device: ektf2232
DEBUG: Not usbtouchscreen calibrator: Not a usbtouchscreen device
DEBUG: Not evdev calibrator: Evdev: invalid "Evdev Axis Calibration" property format
Calibrating standard Xorg driver "ektf2232"
    current calibration values: min_x=0, max_x=65535 and min_y=0, max_y=65535
    If these values are estimated wrong, either supply it manually with the --precalib option, or run the 'get_precalib.sh' script to automatically get it (through HAL).
DEBUG: Adding click 0 (X=607, Y=119)
DEBUG: Adding click 1 (X=566, Y=757)
DEBUG: Adding click 2 (X=183, Y=103)
DEBUG: Adding click 3 (X=164, Y=757)


--> Making the calibration permanent <--
DEBUG: Found that 'ektf2232' is a sysfs name.
  copy the snippet below into '/etc/X11/xorg.conf.d/99-calibration.conf'
Section "InputClass"
    Identifier    "calibration"
    MatchProduct    "ektf2232"
    Option    "MinX"    "74756"
    Option    "MaxX"    "288"
    Option    "MinY"    "6698"
    Option    "MaxY"    "41940"
    Option    "SwapXY"    "1" # unless it was already set to 1
EndSection


[7/12/2023 9:43 PM] kuratius
xorg.conf.d doesnt exist


[7/12/2023 9:44 PM] kuratius
kobo-nia:~$ ls /etc/X11/
Xwrapper.config  xinit
kobo-nia:~$


[7/12/2023 9:44 PM] kuratius
also these values dont make any sense


[7/12/2023 9:48 PM] kuratius
74556 min x???


[7/12/2023 9:48 PM] kuratius
and max x smaller than min x?


[7/12/2023 9:48 PM] kuratius
Whoever wrote this tool didn't  ensure it does a good job


[7/12/2023 9:50 PM] kuratius
I created the folder and file recommended by xinput calibrator


[7/12/2023 9:50 PM] kuratius
it is ignored


[7/12/2023 9:50 PM] kuratius
rofl


[7/12/2023 9:52 PM] kuratius
Oooh


[7/12/2023 9:52 PM] kuratius
I just got  a calibration that works and isn't ignored


[7/12/2023 9:52 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ DISPLAY=:0 ./xlibinput_calibrator


[7/12/2023 9:53 PM] kuratius
touchscreen is still not perfectly accurate but it actually reacts to taps correctly


[7/12/2023 9:54 PM] kuratius
only issue is I dont know where this got saved


[7/12/2023 9:54 PM] kuratius
and still no idea why all the other options are ignored


[7/12/2023 9:55 PM] kuratius
yeah this calibration is fairly inaccurate


[7/12/2023 10:04 PM] kuratius
but it is a calibration that works


[7/12/2023 10:04 PM] kuratius
now I still dont know where it writes to


[7/12/2023 10:04 PM] kuratius
also: the info on the pmOS wiki about offset constants might be wrong


[7/12/2023 10:05 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ cat mynewX11.txt 

Section "InputClass"
    Identifier    "calibration"
    MatchProduct    "ektf2232"
    Option        "CalibrationMatrix"    "-0.040170 0.883285 0.007321 -1.778966 0.061452 1.070354 0.000000 0.000000 1.000000 "
EndSection

kobo-nia:~/xlibinput_calibrator/src$


[7/12/2023 10:05 PM] kuratius
the offsets constants it generates are way too smal to match that formula


[7/12/2023 10:06 PM] kuratius
https://wiki.archlinux.org/title/Calibrating_Touchscreen
the formula listed  here for the offset constants seems like it might be plausible

{Embed}
https://wiki.archlinux.org/title/Calibrating_Touchscreen
Calibrating Touchscreen


[7/12/2023 10:06 PM] kuratius
since it's a ratio it can be close to 1


[7/12/2023 10:07 PM] kuratius
but still just really confusing


[7/12/2023 10:07 PM] kuratius
literally there should just be 1 config file that everyone uses


[7/12/2023 10:07 PM] kuratius
instead of 5 different ones


[7/12/2023 10:07 PM] kuratius
in 5 different places


[7/12/2023 10:09 PM] kuratius
I'll delete the directory from before


[7/12/2023 10:10 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ cat mynewX11.txt 

Section "InputClass"
    Identifier    "calibration"
    MatchProduct    "ektf2232"
    Option        "CalibrationMatrix"    "-0.040170 0.883285 0.007321 -1.778966 0.061452 1.070354 0.000000 0.000000 1.000000 "
EndSection

kobo-nia:~/xlibinput_calibrator/src$


[7/12/2023 10:10 PM] kuratius
this is the calibration the xlibinput calibrator spits out


[7/12/2023 10:11 PM] kuratius
the offsets are all wrong and I have no idea what file it modifies


[7/12/2023 10:11 PM] kuratius
but touches are approximately correct, just still fairly inaccurate


[7/12/2023 10:11 PM] kuratius
like it will touch the file explorer when I touch the terminal


[7/12/2023 10:11 PM] kuratius
that sort of thing


[7/12/2023 10:15 PM] kuratius
also I really need to disable the lockscreen


[7/12/2023 10:21 PM] kuratius
/usr/share/X11/xorg.conf.d/ this directory exists


[7/12/2023 10:21 PM] andi15701
well, you probably just need to create /etc/X11/xorg.conf.d


[7/12/2023 10:24 PM] kuratius
Copy the snippet below into '/etc/X11/xorg.conf.d/99-calibration.conf' (/usr/share/X11/xorg.conf.d/ in some distro's)


[7/12/2023 10:24 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ DISPLAY=:0 ./xlibinput_calibrator --show-x1
1-config
Copy the snippet below into '/etc/X11/xorg.conf.d/99-calibration.conf' (/usr/share/X11/xorg.conf.d/ in some distro's)

Section "InputClass"
    Identifier    "calibration"
    MatchProduct    "ektf2232"
    Option        "CalibrationMatrix"    "0.020744 0.881953 -0.013859 -1.703590 0.077562 1.089756 0.000000 0.000000 1.000000 "
EndSection

kobo-nia:~/xlibinput_calibrator/src$


[7/12/2023 10:24 PM] andi15701
I guess both are searched


[7/12/2023 10:25 PM] andi15701
but /usr/share is for stuff that come by packages


[7/12/2023 10:25 PM] andi15701
and gets not touched by the user


[7/12/2023 10:30 PM] andi15701
Device:           Neonode zForce touchscreen
Kernel:           /dev/input/event1
Group:            2
Seat:             seat0, default
Capabilities:     touch 
Tap-to-click:     n/a
Tap-and-drag:     n/a
Tap drag lock:    n/a
Left-handed:      n/a
Nat.scrolling:    n/a
Middle emulation: n/a
Calibration:      0.00 1.00 0.00 -1.00 0.00 1.00


[7/12/2023 10:30 PM] andi15701
root@bookworm:~# cat /etc/udev/rules.d/99-touch.rules 
ATTRS{name}=="Neonode zForce touchscreen", ENV{LIBINPUT_CALIBRATION_MATRIX}="0 1 0 -1 0 1"
#ATTRS{name}=="Neonode zForce touchscreen", ENV{LIBINPUT_CALIBRATION_MATRIX}="0 1.34515 0 -0.7434 0 0.7434", RUN="/usr/local/bin/hello.sh"


[7/12/2023 10:31 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ cat /etc/udev/rules.d/99-ektf2232.rules 
ATTRS{name}=="ektf2232", ENV{LIBINPUT_CALIBRATION_MATRIX}="0,0.5336112558624285,0,-0.5282229965156795,0,758.0"
kobo-nia:~/xlibinput_calibrator/src$


[7/12/2023 10:32 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ DISPLAY=:0 ./xlibinput_calibrator --show-xinput-cmd
Install the 'xinput' tool and copy the command(s) below in a script that starts with your X session

       xinput set-float-prop "ektf2232" "libinput Calibration Matrix" \
            -0.029432 0.919006 -0.033686 -2.160159 0.085088 \
            1.078435 0.000000 0.000000 1.000000

kobo-nia:~/xlibinput_calibrator/src$ DISPLAY=:0 xinput list-props ektf2232
Device 'ektf2232':
    Device Enabled (123):    1
    Coordinate Transformation Matrix (124):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Rotation Angle (247):    0.000000
    libinput Rotation Angle Default (248):    0.000000
    libinput Calibration Matrix (249):    -0.029432, 0.919006, -0.033686, -2.160159, 0.085088, 1.078435, 0.000000, 0.000000, 1.000000
    libinput Calibration Matrix Default (250):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Send Events Modes Available (251):    1, 0
    libinput Send Events Mode Enabled (252):    0, 0
    libinput Send Events Mode Enabled Default (253):    0, 0
    Device Node (254):    "/dev/input/event0"
    Device Product ID (255):    0, 0
kobo-nia:~/xlibinput_calibrator/src$


[7/12/2023 10:32 PM] kuratius
this config file is stored somewhere else


[7/12/2023 11:10 PM] andi15701
CmaTotal:          16384 kB
CmaFree:            2112 kB


[7/12/2023 11:10 PM] andi15701
while playing around wtih the shine2


[7/12/2023 11:11 PM] kuratius
So do I need to change the cma allocation I set before?


[7/12/2023 11:11 PM] kuratius
Or does that mean 16MB is just enough?


[7/12/2023 11:11 PM] andi15701
no idea, but we need to keep an eye open


[7/12/2023 11:12 PM] andi15701
actually it was not enough anymore


[7/12/2023 11:12 PM] andi15701
also something might be leaking


[7/13/2023 12:16 AM] andi15701
so did you find it?


[7/13/2023 12:17 AM] andi15701
grepping for the values in the filesystem


[7/13/2023 12:37 AM] kuratius
I have not looked, I will probably  do it tomorrow after the exam


[7/13/2023 12:38 AM] kuratius
What would I pipe into grep?


[7/13/2023 12:38 AM] kuratius
cat /*


[7/13/2023 12:38 AM] kuratius
This?


[7/13/2023 12:39 AM] andi15701
grep -R 0.02943 /var /etc /home


[7/13/2023 1:26 PM] kuratius
This did not return  anything


[7/13/2023 1:26 PM] kuratius
Just errors


[7/13/2023 1:30 PM] kuratius
Will run list-props after a fresh boot, maybe it doesn't get saved


[7/13/2023 1:35 PM] kuratius
kobo-nia:~$ DISPLAY=:0 xinput list-props ektf2232
Device 'ektf2232':
    Device Enabled (123):    1
    Coordinate Transformation Matrix (124):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Rotation Angle (247):    0.000000
    libinput Rotation Angle Default (248):    0.000000
    libinput Calibration Matrix (249):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Calibration Matrix Default (250):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Send Events Modes Available (251):    1, 0
    libinput Send Events Mode Enabled (252):    0, 0
    libinput Send Events Mode Enabled Default (253):    0, 0
    Device Node (254):    "/dev/input/event0"
    Device Product ID (255):    0, 0
kobo-nia:~$


[7/13/2023 1:35 PM] kuratius
it doesnt get saved anywhere


[8/13/2023 9:50 AM] kuratius
@andi On your clara, are you able to change the touchscreen calibration in  a way that gets saved properly and that lets you check the output of the calibration?


[8/13/2023 10:55 AM] kuratius
kobo-nia:~$ DISPLAY=:0 xinput set-prop "ektf2232" --type=float "libinput Calibra
tion Matrix" 0 0.5336112558624285 0 -0.5282229965156795 0 1 0 0 1
kobo-nia:~$ 

this calibration seems to work with the keyboard I think


[8/13/2023 10:55 AM] kuratius
I had to  put 1 instead of 758 because it uses the offset weirdly


[8/13/2023 10:56 AM] kuratius
nevermind that something may still be broken


[8/13/2023 11:03 AM] kuratius
apparently the coefficients are also off by a bit, it scales the input wrong, let me check something


[8/13/2023 11:15 AM] kuratius
right now I'm using touches in on the keyboard to guess calibration coeffs


[8/13/2023 11:20 AM] kuratius
would be much nicer if they could just apply the matrix and not fuck with the coefficients


[8/13/2023 11:31 AM] kuratius
kobo-nia:~$ DISPLAY=:0 xinput set-prop "ektf2232" --type=float "libinput Calibra
tion Matrix" 0 0.71 0 -1.05 0 1 0 0 1
kobo-nia:~$ 
 this is super scuffed, but the keyboard is usable-ish


[8/13/2023 11:31 AM] kuratius
still get a key wrong half the time


[8/13/2023 11:33 AM] kuratius
managed to pas the lock screen yay


[8/13/2023 11:33 AM] kuratius
*pass


[8/13/2023 11:33 AM] kuratius
there's something really wrong with the way these matrix coefficients are being applied


[8/13/2023 11:34 AM] kuratius
they're being rescaled by garbage, could be because they're not intended to be used for rotation I guess??


[8/13/2023 11:34 AM] kuratius
but still fuck this


[8/13/2023 11:48 AM] kuratius
kobo-nia:~$ DISPLAY=:0 xinput set-prop "ektf2232" --type=float "libinput Calibra
tion Matrix" 0 0.74 0 -1.2 0 1 0 0 1
kobo-nia:~$ 
this is a bit better


[8/13/2023 11:49 AM] kuratius
nope menu button doesnt work


[8/13/2023 11:49 AM] kuratius
kobo-nia:~$ DISPLAY=:0 xinput set-prop "ektf2232" --type=float "libinput Calibra
tion Matrix" 0 0.74 0 -1.4 0 1 0 0 1
kobo-nia:~$ 
 upper left button now works


[8/13/2023 11:50 AM] kuratius
so it's possible to get a screen calibration by pure trial and error


[8/13/2023 11:51 AM] kuratius
(also just for reference, I changed the CMA to 32 MB)


[8/13/2023 12:22 PM] kuratius
(also, these are basically magic numbers, they dont make any sense whatsoever)


[8/13/2023 12:22 PM] kuratius
the sign and position means it's a rotation


[8/13/2023 12:23 PM] kuratius
but the magnitude is fucked up


[8/13/2023 12:23 PM] kuratius
they should both be <1


[8/13/2023 12:23 PM] kuratius
0.74
-1.4

I mean these two


[8/13/2023 12:33 PM] kuratius
also it has problems with ghost touches I think


[8/14/2023 6:16 PM] kuratius
I think I will open an issue on the libinput gitlab.


[8/14/2023 6:22 PM] kuratius
@andi Let me know if you have an idea why it seems to want the second coordinate to be greater than 1, this doesn't make any sense to me. Either it is a bug in libinput or there is some other component fucking up the coordinate conversion


[8/14/2023 6:22 PM] kuratius
if you have no idea I'll just proceed with opening the libinput issue


[8/14/2023 7:12 PM] kuratius
https://gitlab.freedesktop.org/libinput/libinput/-/issues/923

{Embed}
https://gitlab.freedesktop.org/libinput/libinput/-/issues/923
libinput calibration matrix is not applied in a mathematically soun...
Summary Magnitude of coefficients for correct rotation of touchscreen appears nonsensical. Touchscreen coordinates should be mapped using coefficients <1, but one...
/mnt/data/projects/git/conversations/media/twitter_card-570ddb06edf56a2312253c5872489-B0E6E.jpg


[8/14/2023 7:44 PM] andi15701
well, the way forward would be to first fix the devicetree regarding orientation


[8/14/2023 7:45 PM] andi15701
What I really wonder about: Why libinput just does not use GET_ABSINFO stuff


[8/14/2023 7:46 PM] andi15701
if display is correctly rotated


[8/14/2023 7:46 PM] andi15701
then taking that should give all information required for calibration


[8/14/2023 7:47 PM] andi15701
resp. why does Xorg not use that


[8/14/2023 7:50 PM] andi15701
interesting would also be to check if any kind of calibration matrix can be generated by just calcuting stuff using screen dimensions and get_absinfo stuff


[8/14/2023 7:51 PM] kuratius
can you list the output of get_absinfo?


[8/14/2023 7:52 PM] kuratius
it's very easy to get the calibration matrix just from knowing the max values of the touchscreen and knowing where the origin and the corners are supposed to be if you also know the screen dimensions and roation, but libinput seems to do fucky stuff with the coordinate conversion


[8/14/2023 7:53 PM] andi15701
diff --git a/arch/arm/boot/dts/imx6sl-tolino-shine2hd.dts b/arch/arm/boot/dts/imx6sl-tolino-shine2hd.dts
index 50763a186476..1efdbe01bacf 100644
--- a/arch/arm/boot/dts/imx6sl-tolino-shine2hd.dts
+++ b/arch/arm/boot/dts/imx6sl-tolino-shine2hd.dts
@@ -148,6 +148,8 @@ zforce: touchscreen@50 {
                reset-gpios = <&gpio5 9 GPIO_ACTIVE_LOW>;
                x-size = <1072>;
                y-size = <1448>;
+               touchscreen-swapped-x-y;
+               touchscreen-inverted-x;
        };


[8/14/2023 7:53 PM] andi15701
that I did for orientation on the shine2


[8/14/2023 7:53 PM] andi15701
probably the same needed on the nia


[8/14/2023 7:55 PM] kuratius
is this what you have in mind?

{Attachments}
/mnt/data/projects/git/conversations/media/calibrator-EEB32.py


[8/14/2023 7:57 PM] kuratius
if I knew what factor or matrix libinput multiplies the transformation matrix by I could tell you the exact matrix needed


[8/14/2023 7:58 PM] kuratius
but as far as I can tell it doesnt use the transformation matrix as-is, hence why I opened an issue


[8/14/2023 8:08 PM] andi15701
evtest first displays the following section:


[8/14/2023 8:08 PM] andi15701
Supported events:
  Event type 0 (EV_SYN)
  Event type 1 (EV_KEY)
    Event code 330 (BTN_TOUCH)
  Event type 3 (EV_ABS)
    Event code 0 (ABS_X)


[8/14/2023 8:08 PM] andi15701
and then there are max/min values


[8/14/2023 8:09 PM] andi15701
and in theory you should just have to divide things


[8/14/2023 8:09 PM] andi15701
to have a scale factor


[8/14/2023 8:10 PM] kuratius
```x_max=1435
y_max=1919```
in my script that'd be these lines


[8/14/2023 8:10 PM] andi15701
yes


[8/14/2023 8:10 PM] kuratius
yes but both of these should get mapped to something smaller than before


[8/14/2023 8:10 PM] kuratius
yet libinput wants a coefficient >1


[8/14/2023 8:11 PM] kuratius
so that's not really sensible


[8/14/2023 8:11 PM] kuratius
I could guess that maybe it's doing something like 1435/1919 for the first coordinate, and 1919/1435 for the second


[8/14/2023 8:12 PM] kuratius
but there is no logical reason to do that


[8/14/2023 8:12 PM] kuratius
> 1435/1919
> 0.7477853048462741
> >>> 1919/1435
> 1.3372822299651568
> >>>


[8/14/2023 8:13 PM] andi15701
so do you have this x_max/y_max in evtest?


[8/14/2023 8:13 PM] kuratius
```kobo-nia:~$ evtest
No device specified, trying to scan all of /dev/input/event*
Not running as root, no devices may be available.
Available devices:
/dev/input/event0:    ektf2232
Select the device event number [0-0]: 0
Input driver version is 1.0.1
Input device ID: bus 0x18 vendor 0x0 product 0x0 version 0x0
Input device name: "ektf2232"
Supported events:
  Event type 0 (EV_SYN)
  Event type 1 (EV_KEY)
    Event code 330 (BTN_TOUCH)
  Event type 3 (EV_ABS)
    Event code 0 (ABS_X)
      Value   1360
      Min        0
      Max     1919
    Event code 1 (ABS_Y)
      Value   1858
      Min        0
      Max     1435
    Event code 47 (ABS_MT_SLOT)
      Value      0
      Min        0
      Max        4
    Event code 53 (ABS_MT_POSITION_X)
      Value      0
      Min        0
      Max     1919
    Event code 54 (ABS_MT_POSITION_Y)
      Value      0
      Min        0
      Max     1435
    Event code 57 (ABS_MT_TRACKING_ID)
      Value      0
      Min        0
      Max    65535
Properties:
  Property type 1 (INPUT_PROP_DIRECT)
Testing ... (interrupt to exit) ```


[8/14/2023 8:14 PM] andi15701
I first want to get together things which can be cleanly specified in the devicetree


[8/14/2023 8:14 PM] andi15701
and then upstream that


[8/14/2023 8:14 PM] andi15701
on top of that dirty things can follow


[8/14/2023 8:15 PM] andi15701
hmm, ABS_Y: value > max?


[8/14/2023 8:15 PM] andi15701
that is insane


[8/14/2023 8:17 PM] kuratius
these two event types dont get used... I think 
    Event code 53 (ABS_MT_POSITION_X)
      Value      0
      Min        0
      Max     1919
    Event code 54 (ABS_MT_POSITION_Y)
      Value      0
      Min        0
      Max     1435
 only these do

{Attachments}
/mnt/data/projects/git/conversations/media/message-93442.txt


[8/14/2023 8:18 PM] kuratius
I have no explanation for event codes 0 and 1


[8/14/2023 8:18 PM] kuratius
kobo-nia:~$ evtest
No device specified, trying to scan all of /dev/input/event*
Not running as root, no devices may be available.
Available devices:
/dev/input/event0:    ektf2232
Select the device event number [0-0]: 0
Input driver version is 1.0.1
Input device ID: bus 0x18 vendor 0x0 product 0x0 version 0x0
Input device name: "ektf2232"
Supported events:
  Event type 0 (EV_SYN)
  Event type 1 (EV_KEY)
    Event code 330 (BTN_TOUCH)
  Event type 3 (EV_ABS)
    Event code 0 (ABS_X)
      Value   1288
      Min        0
      Max     1919
    Event code 1 (ABS_Y)
      Value     64
      Min        0
      Max     1435
    Event code 47 (ABS_MT_SLOT)
      Value      0
      Min        0
      Max        4
    Event code 53 (ABS_MT_POSITION_X)
      Value      0
      Min        0
      Max     1919
    Event code 54 (ABS_MT_POSITION_Y)
      Value      0
      Min        0
      Max     1435
    Event code 57 (ABS_MT_TRACKING_ID)
      Value      0
      Min        0
      Max    65535
Properties:
  Property type 1 (INPUT_PROP_DIRECT)
Testing ... (interrupt to exit)


[8/14/2023 8:18 PM] kuratius
ran evtest again


[8/14/2023 8:19 PM] kuratius
now it seems sane


[8/14/2023 8:19 PM] kuratius
maybe it registers bugged events sometimes?


[8/14/2023 8:19 PM] kuratius
or after a reboot it intizalizes to a wrong value?


[8/14/2023 8:19 PM] andi15701
maybe


[8/14/2023 8:20 PM] kuratius
would explain ghost touches


[8/14/2023 8:21 PM] kuratius
bad would be if it reads event data from a wrong memory location or something, but I don't know what the driver does to get this data


[8/14/2023 8:21 PM] kuratius
maybe it's something like capacitance and it gets fucked up if you touch the screen with charged fingers or something


[8/14/2023 8:22 PM] kuratius
I dont really know


[8/14/2023 8:24 PM] kuratius
also scratch that statement, eventcode 0 and 1 do get used, I just didnt read the log thoroughly, but the touches I tested here didnt produce anything abnormal


[8/14/2023 8:29 PM] kuratius
also, I sometimes get warnings that the touchscreen driver is running behind when testing libinput, but I think that's just xfce being heavy


[8/14/2023 8:30 PM] kuratius
will show an example sec


[8/14/2023 8:31 PM] kuratius
kobo-nia:~$ DISPLAY=:0 libinput debug-gui

(libinput-debug-gui:1824): Gtk-CRITICAL **: 20:31:32.862: gtk_widget_set_events: assertion '!_gtk_widget_get_realized (widget)' failed
info: event0 ektf2232                       added
event0  - ektf2232: client bug: event processing lagging behind by 155ms, your system is too slow


[8/15/2023 6:41 AM] kuratius
https://gitlab.freedesktop.org/libinput/libinput/-/blob/main/src/evdev.c#L2546

{Embed}
https://gitlab.freedesktop.org/libinput/libinput/-/blob/main/src/evdev.c
src/evdev.c · main · libinput / libinput · GitLab
Input device management and event handling library
/mnt/data/projects/git/conversations/media/twitter_card-570ddb06edf56a2312253c5872489-B0E6E.jpg


[8/15/2023 6:42 AM] kuratius
Someone posted this on the issue I opened, they do apply extra matrices


[8/15/2023 6:45 AM] kuratius
Just need to figure out what they are, then I can invert them as needed to calculate the actual input matrix


[8/15/2023 6:45 AM] kuratius
(Still wish they'd just not do that, it's dumb)


[8/15/2023 7:38 AM] andi15701
It might be just  what they should do


[8/15/2023 7:38 AM] andi15701
so just try to get orientation right via devicetree


[8/15/2023 7:38 AM] andi15701
and these extra things might do the rest needed


[8/15/2023 7:39 AM] andi15701
just had a first, quick look at the code


[8/15/2023 8:38 AM] kuratius
Is your theory that the device tree is causing them to calculate these extra matrices incorrectly?
Or do you think that they are not set up to handle rotation correctly? (These are separate issues)


[8/15/2023 8:38 AM] kuratius
fixing the device tree would fix it in both cases, but the latter would be something they'd still need to change


[8/15/2023 8:42 AM] andi15701
if set up correctly, rotated coordinates just come out directly of /dev/eventX


[8/15/2023 8:43 AM] andi15701
so libinput does not need to care about it


[8/15/2023 8:43 AM] andi15701
but if that is not the case, libinput might do things like scale_factor_x = touchscreen_max_y/display_max_x


[8/15/2023 8:44 AM] andi15701
then leading to insane matrixes


[8/15/2023 9:25 AM] andi15701
so libinput might be totally right, first use kernel input/information (rotated coordinates, then apply ranges screen vs. input), then applying additional matrixes


[8/15/2023 3:25 PM] andi15701
As said the kernel's job is to provide correctly-oriented touchscreen events and the range of x and y, libinput can expect that is provided and act accordingly.


[8/15/2023 3:29 PM] kuratius
the thing I'm confused about is that if these normalization matrices are correct, this shouldn't happen with a rotation, example

{Attachments}
/mnt/data/projects/git/conversations/media/image-1F80E.png


[8/15/2023 3:29 PM] szybet
how can all of this work on the old kernel?


[8/15/2023 3:29 PM] szybet
and not on the newer one?


[8/15/2023 3:30 PM] kuratius
I dont know of a way to debug this other than recompiling libinput with extra print statements


[8/15/2023 3:30 PM] andi15701
just add that two lines to the devicetree


[8/15/2023 3:31 PM] andi15701
and check what is happening then


[8/15/2023 3:33 PM] andi15701
#else if
        if(1==gptHWCFG->m_val.bDisplayResolution) {  // resolution 1024*758
                *x = _y * 1023 / rangeY;
                if (gIsCustomerUi) 
                        *y = 757 - (_x * 757 / rangeX);
                else
                        *y = (_x * 757 / rangeX);
        }else{
                *x = 799 - (_x * 799 / 1088);
                *y = (_y * 599 / 768);
        }
#endif


[8/15/2023 3:33 PM] andi15701
old driver in old kernel


[8/15/2023 3:33 PM] andi15701
x = _y can be specified by the devicetree


[8/15/2023 3:35 PM] kuratius
is the formatting of that block broken?
x = _y 1023 / rangeY; is missing an operator


[8/15/2023 3:35 PM] andi15701
```
#else if
        if(1==gptHWCFG->m_val.bDisplayResolution) {  // resolution 1024*758
                *x = _y * 1023 / rangeY;
                if (gIsCustomerUi) 
                        *y = 757 - (_x * 757 / rangeX);
                else
                        *y = (_x * 757 / rangeX);
        }else{
                *x = 799 - (_x * 799 / 1088);
                *y = (_y * 599 / 768);
        }
#endif
```


[8/15/2023 3:37 PM] kuratius
this is correct as far as I can tell


[8/15/2023 3:38 PM] andi15701
and probably libinput would just do that too, if orientation is correctly specified


[8/15/2023 3:39 PM] andi15701
so just take that shine2 example and apply it to the nia devicetree


[8/15/2023 3:39 PM] kuratius
I have to use the kernel build again right? So clone your linux repo again, then edit dtb there?


[8/15/2023 3:39 PM] kuratius
the envkernel stuff


[8/15/2023 3:40 PM] andi15701
yes


[8/15/2023 3:41 PM] andi15701
so result should be: evtest will spit out correctly-oriented stuff


[8/15/2023 3:41 PM] andi15701
and libinput-gui should hopefully scale things in a sane way


[8/15/2023 3:51 PM] kuratius
in nia-common.dtsi?

{Attachments}
/mnt/data/projects/git/conversations/media/image-2F866.png


[8/15/2023 3:52 PM] kuratius
couldnt find reference to the touchscreen in the .dts file


[8/15/2023 3:52 PM] andi15701
yes


[8/15/2023 3:54 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-27AB8.png


[8/15/2023 3:54 PM] andi15701
yes, I think that should do the trick


[8/15/2023 4:01 PM] kuratius
building now


[8/15/2023 4:09 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-748B7.txt


[8/15/2023 4:10 PM] kuratius
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ pmbootstrap build --envkernel linux-kobo-clara-mainline
[16:01:19] WARNING: package devicepkg-dev: aport version 0.14.3-r0 is lower than 0.15.3-r0 from the binary repository. 0.15.3-r0 will be used when installing devicepkg-dev. See also: <https://postmarketos.org/warning-repo2>
[16:01:19] (native) install bash bc bison devicepkg-dev findutils flex gmp-dev lzop mpc1-dev mpfr-dev openssl-dev perl binutils-armv7
[16:01:21] (native) build armv7/linux-kobo-clara-mainline-6.3.0_p20230815160116-r0.apk
[16:01:23] NOTE: The failed command's output is above the ^^^ line in the log file: /home/dk/.local/var/pmbootstrap/log.txt
[16:01:23] ERROR: Command failed (exit code 1): (native) % cd /home/pmos/build; busybox su pmos -c CARCH=armv7 CHOST=armv7 CBUILD=x86_64 SUDO_APK='abuild-apk --no-progress' HOME=/home/pmos abuild rootpkg
[16:01:23] See also: <https://postmarketos.org/troubleshooting>
Run 'pmbootstrap log' for details.


[8/15/2023 4:14 PM] kuratius
git reset --hard
git pull
 cd arch/arm/boot/dts/

 vim imx6ull-kobo-nia-common.dtsi 
cd ~/nia/linux
source ../../pmbootstrap/helpers/envkernel.sh
make kobo_nia_defconfig
 pmbootstrap build --envkernel linux-kobo-clara-mainline


[8/15/2023 4:14 PM] kuratius
that's all I did


[8/15/2023 4:15 PM] kuratius
i did not copy the defconfig again


[8/15/2023 4:43 PM] andi15701
the error is a bit earlier in the log


[8/15/2023 4:53 PM] kuratius
somewhere here?

{Attachments}
/mnt/data/projects/git/conversations/media/image-6AD74.png


[8/15/2023 4:54 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-AC7AA.png


[8/15/2023 4:54 PM] kuratius
the rtl error?


[8/15/2023 4:54 PM] kuratius
for some reason that line is not shown in pmboostrap log


[8/15/2023 4:54 PM] kuratius
weird


[8/15/2023 4:55 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-1AE4A.png


[8/15/2023 4:56 PM] kuratius
found this also


[8/15/2023 4:58 PM] kuratius
is there a nia-c defconfig that I need?


[8/15/2023 5:19 PM] andi15701
rtl error: comment this line in the kernel APKBUILD


[8/15/2023 5:19 PM] andi15701
install -Dm644 "$_rtl8189fs_dir"/8189fs.ko "$pkgdir/lib/modules/$(make -s O="$_outdir" ARCH="$_carch" kernelrelease)/kernel/drivers/net/wireless"


[8/15/2023 5:20 PM] andi15701
nia-c:  remove         imx6ull-kobo-nia-c.dtb \


[8/15/2023 5:20 PM] andi15701
from arch/arm/boot/dts/Makefile


[8/15/2023 5:24 PM] kuratius
I think the removing the nia-c line was enough


[8/15/2023 5:25 PM] kuratius
Or maybe not


[8/15/2023 5:25 PM] kuratius
Sec


[8/15/2023 5:25 PM] kuratius
Will remove that one too then


[8/15/2023 5:27 PM] kuratius
Where is the apkbuild?


[8/15/2023 5:28 PM] kuratius
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ find . -name "APKBUILD"
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ find . -name "*APKBUILD*"
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ find . -name *APKBUILD*
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ find . -name *APKBUILD*


[8/15/2023 5:32 PM] kuratius
.local maybe?


[8/15/2023 5:33 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-5BCF2.png


[8/15/2023 5:33 PM] kuratius
found it


[8/15/2023 5:34 PM] kuratius
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ pmbootstrap build --envkernel linux-kobo-clara-mainline
[17:33:45] WARNING: package devicepkg-dev: aport version 0.14.3-r0 is lower than 0.15.3-r0 from the binary repository. 0.15.3-r0 will be used when installing devicepkg-dev. See also: <https://postmarketos.org/warning-repo2>
[17:33:45] (native) install bash bc bison devicepkg-dev findutils flex gmp-dev lzop mpc1-dev mpfr-dev openssl-dev perl binutils-armv7
[17:33:47] (native) build armv7/linux-kobo-clara-mainline-6.3.0_p20230815173342-r0.apk
[17:33:49] NOTE: chroot is still active (use 'pmbootstrap shutdown' as necessary)
[17:33:49] DONE!
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$


[8/15/2023 5:34 PM] kuratius
this was... quick?


[8/15/2023 5:36 PM] kuratius
that didnt work

{Attachments}
/mnt/data/projects/git/conversations/media/message-2A2C9.txt


[8/15/2023 5:57 PM] andi15701
stop xfce


[8/15/2023 5:57 PM] andi15701
generating initramfs has probably generated too much ram usage


[8/15/2023 5:58 PM] kuratius
also btw I have a new theory what's going wrong with libinput


[8/15/2023 5:59 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-271A0.png


[8/15/2023 5:59 PM] kuratius
these matrices commute if there is no rotation


[8/15/2023 6:00 PM] kuratius
and the code for the matrix denormalization is called first


[8/15/2023 6:00 PM] kuratius
so maybe the matrices are applied in the wrong order


[8/15/2023 6:00 PM] kuratius
and that doesnt matter if there is no rotation, because if there is no rotation the order doesnt matter


[8/15/2023 6:00 PM] kuratius
will disable lightdm and then retry


[8/15/2023 6:04 PM] kuratius
worked this time


[8/15/2023 6:05 PM] kuratius
this is calculating the commutator


[8/15/2023 6:07 PM] kuratius
Event code 0 (ABS_X)
      Value    221
      Min        0
      Max     1919
    Event code 1 (ABS_Y)
      Value   1831
      Min        0
      Max     1435


[8/15/2023 6:07 PM] kuratius
uuuuh


[8/15/2023 6:07 PM] kuratius
what


[8/15/2023 6:07 PM] kuratius
Value>Max?


[8/15/2023 6:09 PM] kuratius
```Testing ... (interrupt to exit)
Event: time 1692115719.624358, type 3 (EV_ABS), code 57 (ABS_MT_TRACKING_ID), value 20
Event: time 1692115719.624358, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 1194
Event: time 1692115719.624358, type 3 (EV_ABS), code 54 (ABS_MT_POSITION_Y), value 1832
Event: time 1692115719.624358, type 1 (EV_KEY), code 330 (BTN_TOUCH), value 1
Event: time 1692115719.624358, type 3 (EV_ABS), code 0 (ABS_X), value 1194
Event: time 1692115719.624358, type 3 (EV_ABS), code 1 (ABS_Y), value 1832
Event: time 1692115719.624358, -------------- SYN_REPORT ------------
Event: time 1692115719.759959, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 1177
Event: time 1692115719.759959, type 3 (EV_ABS), code 54 (ABS_MT_POSITION_Y), value 1826
Event: time 1692115719.759959, type 3 (EV_ABS), code 0 (ABS_X), value 1177
Event: time 1692115719.759959, type 3 (EV_ABS), code 1 (ABS_Y), value 1826
Event: time 1692115719.759959, -------------- SYN_REPORT ------------
Event: time 1692115719.779057, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 1156
Event: time 1692115719.779057, type 3 (EV_ABS), code 54 (ABS_MT_POSITION_Y), value 1821
Event: time 1692115719.779057, type 3 (EV_ABS), code 0 (ABS_X), value 1156
Event: time 1692115719.779057, type 3 (EV_ABS), code 1 (ABS_Y), value 1821
Event: time 1692115719.779057, -------------- SYN_REPORT ------------
Event: time 1692115719.827822, type 3 (EV_ABS), code 57 (ABS_MT_TRACKING_ID), value -1
Event: time 1692115719.827822, type 1 (EV_KEY), code 330 (BTN_TOUCH), value 0
Event: time 1692115719.827822, -------------- SYN_REPORT ------------


```


[8/15/2023 6:09 PM] kuratius
this is not sane


[8/15/2023 6:09 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-E7A00.txt


[8/15/2023 6:10 PM] andi15701
so, max values are not rotated?


[8/15/2023 6:11 PM] andi15701
but actual values are?


[8/15/2023 6:11 PM] kuratius
actual values arent


[8/15/2023 6:11 PM] kuratius
I think only the max values are rotated?


[8/15/2023 6:11 PM] andi15701
max are same as before


[8/15/2023 6:11 PM] kuratius
wait no


[8/15/2023 6:12 PM] kuratius
yeah


[8/15/2023 6:12 PM] kuratius
did the change not apply?


[8/15/2023 6:13 PM] andi15701
check devicetree


[8/15/2023 6:13 PM] andi15701
in /sys


[8/15/2023 6:14 PM] kuratius
kobo-nia:~$ ls /sys/
block/     bus/       class/     dev/       devices/   firmware/  fs/        kernel/    module/    power/
kobo-nia:~$ ls /sys/
block/     bus/       class/     dev/       devices/   firmware/  fs/        kernel/    module/    power/
kobo-nia:~$ ls /sys/devices/
armv7_cortex_a7/  breakpoint/       mmdc0/            platform/         soc0/             software/         system/           virtual/
kobo-nia:~$ ls /sys/devices/


[8/15/2023 6:15 PM] andi15701
/sys/firmware


[8/15/2023 6:15 PM] kuratius
kobo-nia:~$ ls /sys/firmware/devicetree/base/
#address-cells     aliases            clock-cli          clock-di1          compatible         gpio-keys          memory             name               soc                vref3v3-regulator  wifi_pwrseq
#size-cells        chosen             clock-di0          clock-osc          cpus               leds               model              pmu                timer              wifi-regulator
kobo-nia:~$


[8/15/2023 6:15 PM] andi15701
use find


[8/15/2023 6:16 PM] andi15701
then you will find the touchscreen


[8/15/2023 6:16 PM] kuratius
````find . -name *8821* ````


[8/15/2023 6:17 PM] kuratius
kobo-nia:~$ find /sys -name *touch*
find: /sys/kernel/debug: Permission denied
/sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/touchscreen@15
/sys/bus/hid/drivers/hid-multitouch
/sys/module/psmouse/parameters/synaptics_intertouch
kobo-nia:~$


[8/15/2023 6:17 PM] kuratius
?


[8/15/2023 6:17 PM] kuratius
/sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/touchscreen@15
guessing this


[8/15/2023 6:17 PM] andi15701
/sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/touchscreen@15


[8/15/2023 6:17 PM] andi15701
correct


[8/15/2023 6:18 PM] kuratius
kobo-nia:~$ sudo ls /sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/touchscreen@15
[sudo] password for dk-x86: 
compatible           interrupts-extended  name                 power-gpios          reg
kobo-nia:~$


[8/15/2023 6:19 PM] andi15701
uname -a


[8/15/2023 6:20 PM] andi15701
so the rotation properties are missing there


[8/15/2023 6:20 PM] kuratius
kobo-nia:~$ uname -a
Linux kobo-nia 6.3.0 #2 Thu Jun 15 21:42:47 UTC 2023 armv7l Linux
kobo-nia:~$


[8/15/2023 6:20 PM] andi15701
so you are running something old


[8/15/2023 6:21 PM] andi15701
you can also copy over just the newly-compiled devicetree


[8/15/2023 6:27 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-DE7F2.txt


[8/15/2023 6:27 PM] kuratius
how pmboostrap know to use the envkernel?


[8/15/2023 6:28 PM] kuratius
ah nevermind


[8/15/2023 6:28 PM] kuratius
I specified that in the build command with --envkernel


[8/15/2023 6:30 PM] kuratius
should I have ran make without a target in the kernel repo?


[8/15/2023 6:30 PM] kuratius
I'm doing that now and it builds something


[8/15/2023 6:32 PM] kuratius
I deleted all the files here ```[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ ls  ~/.local/var/pmbootstrap/packages/edge/armv7/
APKINDEX.tar.gz             device-kobo-nia-0.1-r1.apk  linux-kobo-clara-mainline-6.3.0_p20230815182418-r0.apk  u-boot-kobo-nia-2016.03-r0.apk  u-boot-kobo-nia-2020.10-r1.apk
device-kobo-nia-0.1-r0.apk  device-kobo-nia-0.1-r2.apk  linux-kobo-clara-mainline-6.3.0_p20230815182530-r0.apk  u-boot-kobo-nia-2020.10-r0.apk```


[8/15/2023 6:34 PM] kuratius
where is that located?


[8/15/2023 6:35 PM] kuratius
I think this was stupid


[8/15/2023 6:36 PM] kuratius
the makefile is not nia specific, and it exists in the original repo


[8/15/2023 6:36 PM] kuratius
so I think I'm either building everything or something generic


[8/15/2023 6:36 PM] kuratius
will abort


[8/15/2023 6:39 PM] kuratius
maybe this is all cause the max of the two axes is rotated


[8/15/2023 6:40 PM] kuratius
and libinput uses the max to generate the matrices


[8/15/2023 6:45 PM] kuratius
apparently I was stupid here


[8/15/2023 6:45 PM] kuratius
it was not suddenly sane


[8/15/2023 6:45 PM] kuratius
I just mixed up the axes


[8/15/2023 6:45 PM] kuratius
and did not touch the screen in all corners


[8/15/2023 6:53 PM] kuratius
I assume the kernel probably supplies the events in evtest right?


[8/15/2023 6:53 PM] kuratius
if so then you were probably right all along


[8/15/2023 6:53 PM] kuratius
just need to figure out why it wont build the new dtb with the extra options


[8/15/2023 6:56 PM] kuratius
is there something I need to delete again?


[8/15/2023 6:58 PM] andi15701
first check it is there


[8/15/2023 6:59 PM] andi15701
in the build


[8/15/2023 6:59 PM] andi15701
and maybe make dtbs


[8/15/2023 6:59 PM] kuratius
how?


[8/15/2023 6:59 PM] andi15701
ls arch/arm/boot/dts


[8/15/2023 7:00 PM] kuratius
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ ls arch/arm/boot/dts/imx6ull-kobo-nia
imx6ull-kobo-nia-c.dts        imx6ull-kobo-nia-common.dtsi  imx6ull-kobo-nia.dts          
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ ls arch/arm/boot/dts/imx6ull-kobo-nia


[8/15/2023 7:01 PM] andi15701
there is some output directory


[8/15/2023 7:06 PM] kuratius
I dont know where that is supposed to be


[8/15/2023 7:07 PM] kuratius
.local?


[8/15/2023 7:07 PM] kuratius
somewhere in the kernel repo?


[8/15/2023 7:11 PM] andi15701
make in the kernel directory is totally the right thing to do


[8/15/2023 7:11 PM] andi15701
let it run


[8/15/2023 8:17 PM] kuratius
kobo-nia:~$ uname -a
Linux kobo-nia 6.3.0 #3 Tue Aug 15 18:07:55 UTC 2023 armv7l Linux


[8/15/2023 8:18 PM] kuratius
Event type 0 (EV_SYN)
  Event type 1 (EV_KEY)
    Event code 330 (BTN_TOUCH)
  Event type 3 (EV_ABS)
    Event code 0 (ABS_X)
      Value      0
      Min        0
      Max     1435
    Event code 1 (ABS_Y)
      Value      0
      Min        0
      Max     1919
    Event code 47 (ABS_MT_SLOT)
      Value      0
      Min        0
      Max        4
    Event code 53 (ABS_MT_POSITION_X)
      Value      0
      Min        0
      Max     1435
    Event code 54 (ABS_MT_POSITION_Y)
      Value      0
      Min        0
      Max     1919
    Event code 57 (ABS_MT_TRACKING_ID)
      Value      0
      Min        0
      Max    65535


[8/15/2023 8:18 PM] kuratius
evtest looks better


[8/15/2023 8:19 PM] kuratius
yaxis has a weird offset


[8/15/2023 8:20 PM] kuratius
Event: time 1692123593.231048, -------------- SYN_REPORT ------------
Event: time 1692123593.421835, type 3 (EV_ABS), code 57 (ABS_MT_TRACKING_ID), value 68
Event: time 1692123593.421835, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 63
Event: time 1692123593.421835, type 3 (EV_ABS), code 54 (ABS_MT_POSITION_Y), value 641
Event: time 1692123593.421835, type 1 (EV_KEY), code 330 (BTN_TOUCH), value 1
Event: time 1692123593.421835, type 3 (EV_ABS), code 0 (ABS_X), value 63
Event: time 1692123593.421835, type 3 (EV_ABS), code 1 (ABS_Y), value 641


[8/15/2023 8:20 PM] kuratius
this is top left corner


[8/15/2023 8:20 PM] kuratius
Event: time 1692123632.520795, -------------- SYN_REPORT ------------
Event: time 1692123632.641538, type 3 (EV_ABS), code 57 (ABS_MT_TRACKING_ID), value 82
Event: time 1692123632.641538, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 1837
Event: time 1692123632.641538, type 3 (EV_ABS), code 54 (ABS_MT_POSITION_Y), value 1791
this is bottom right


[8/15/2023 8:20 PM] kuratius
min value is probably wrong


[8/15/2023 8:21 PM] kuratius
the min value in evtest I mean


[8/15/2023 8:22 PM] andi15701
well, top left with usb connector to the right should be 0/0


[8/15/2023 8:22 PM] kuratius
it's not


[8/15/2023 8:22 PM] andi15701
but offset is weird


[8/15/2023 8:22 PM] kuratius
and bottom right val>greater max


[8/15/2023 8:22 PM] kuratius
for x


[8/15/2023 8:23 PM] kuratius
Max     1435

Event: time 1692123632.641538, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 1837


[8/15/2023 8:23 PM] kuratius
1837>1435


[8/15/2023 8:26 PM] kuratius
is the kernel adding a wrong offset when doing the rotation?


[8/15/2023 8:33 PM] andi15701
just submitted rotation support in kernel for the zforce_ts driver


[8/15/2023 8:33 PM] andi15701
lets see if something can be learned from that


[8/15/2023 8:35 PM] andi15701
but are the rotation properties now in /sys/firmware


[8/15/2023 8:35 PM] andi15701
?


[8/15/2023 8:37 PM] kuratius
kobo-nia:~$ sudo ls /sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/touchscreen@15/
[sudo] password for dk-x86: 
compatible               interrupts-extended      name                     power-gpios              reg                      touchscreen-inverted-x   touchscreen-swapped-x-y
kobo-nia:~$


[8/15/2023 8:38 PM] andi15701
ok, so it is there


[8/15/2023 8:38 PM] andi15701
top right gives what?


[8/15/2023 8:39 PM] kuratius
Event: time 1692124738.889720, type 3 (EV_ABS), code 0 (ABS_X), value 1837
Event: time 1692124738.889720, type 3 (EV_ABS), code 1 (ABS_Y), value 569


[8/15/2023 8:39 PM] kuratius
Available devices:
/dev/input/event0:    gpio-keys
/dev/input/event1:    ektf2232
Select the device event number [0-1]: 1
Input driver version is 1.0.1
Input device ID: bus 0x18 vendor 0x0 pr

the gpio-keys wasnt there before, is that something you added?


[8/15/2023 8:41 PM] kuratius
so top right is (1837,569) roughly


[8/15/2023 8:42 PM] kuratius
Event: time 1692124908.652124, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 52
Event: time 1692124908.652124, type 3 (EV_ABS), code 54 (ABS_MT_POSITION_Y), value 1863
bottom left is this


[8/15/2023 8:42 PM] andi15701
so it does indeed rotate


[8/15/2023 8:43 PM] kuratius
just not with the right offset


[8/15/2023 8:44 PM] kuratius
either the offset needs to be fixed or the min/max val ranges need to be I think


[8/15/2023 8:48 PM] andi15701
you can use touchscreen-min-x =  <value> and touchscreen-min-y = <value> for that job


[8/15/2023 8:48 PM] andi15701
in theory that should be handled by libinput


[8/15/2023 8:49 PM] andi15701
generally an interesting question


[8/15/2023 8:49 PM] andi15701
what libinput does now


[8/15/2023 8:49 PM] kuratius
I can enable xfce again and try to guess


[8/15/2023 8:50 PM] kuratius
I still havent found a debugging tool for libinput that's actually useful beyond just tapping random stuff on the screen


[8/15/2023 8:51 PM] kuratius
also display may be blank


[8/15/2023 8:52 PM] kuratius
not even console came up before


[8/15/2023 8:52 PM] kuratius
did I remove something important with the rtl and nia c stuff?


[8/15/2023 8:52 PM] andi15701
rtl = wifi


[8/15/2023 8:53 PM] kuratius
display is no longer functioning


[8/15/2023 8:53 PM] andi15701
are regulators there?


[8/15/2023 8:53 PM] kuratius
it flashes on boot, but just stays white


[8/15/2023 8:53 PM] kuratius
dmesg?


[8/15/2023 8:53 PM] kuratius
or /sys/firmware?


[8/15/2023 8:54 PM] andi15701
if it flashes, then things should be basically fine


[8/15/2023 8:54 PM] kuratius
nah stays white


[8/15/2023 8:54 PM] kuratius
nothing visible


[8/15/2023 8:54 PM] kuratius
cant test libinput with that


[8/15/2023 8:56 PM] kuratius
I will try to revert to an older kernel


[8/15/2023 8:58 PM] andi15701
dmesg says what?


[8/15/2023 8:59 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-4068C.txt


[8/15/2023 9:00 PM] andi15701
regulator fails to turned *off*


[8/15/2023 9:00 PM] andi15701
wtf...


[8/15/2023 9:58 PM] kuratius
back to working state now


[8/15/2023 10:08 PM] andi15701
you can also revert to a kernel in pmaports and just copy over the devicetree


[8/15/2023 10:08 PM] andi15701
it should be in the /boot partition


[8/16/2023 6:34 AM] kuratius
https://gitlab.freedesktop.org/libinput/libinput/-/issues/923#note_2043443

Should I try to look for the file he mentioned?

{Embed}
https://gitlab.freedesktop.org/libinput/libinput/-/issues/923
libinput calibration matrix is not applied in a mathematically soun...
Summary Magnitude of coefficients for correct rotation of touchscreen appears nonsensical. Touchscreen coordinates should be mapped using coefficients <1, but one...
/mnt/data/projects/git/conversations/media/twitter_card-570ddb06edf56a2312253c5872489-B0E6E.jpg


[8/16/2023 6:36 AM] kuratius
Or is not going to exist because alpine doesn't use systemd?


[8/16/2023 8:34 AM] kuratius
https://github.com/systemd/systemd/blob/main/hwdb.d/60-evdev.hwdb

{Embed}
https://github.com/systemd/systemd/blob/main/hwdb.d/60-evdev.hwdb
systemd/hwdb.d/60-evdev.hwdb at main · systemd/systemd
The systemd System and Service Manager . Contribute to systemd/systemd development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/aa4c3b00-128e-11ea-8853-4f32296220f0-BFCC7


[8/16/2023 8:35 AM] kuratius
yeah it's probably not going to be there


[8/16/2023 8:46 AM] kuratius
also I think know the exact matrix needed now


[8/16/2023 8:46 AM] kuratius
0.7477853048462741
-1.3372822299651568

these are the coefficients


[8/16/2023 8:47 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-31B3F.png


[8/16/2023 8:50 AM] kuratius
yup this looks perfect


[8/16/2023 8:50 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-40652.png


[8/16/2023 8:51 AM] kuratius
so I think the issue is the wrong maxima


[8/16/2023 8:51 AM] kuratius
and maybe wrong axis rotation


[8/16/2023 8:51 AM] kuratius
but the wrong maxima part is worse


[8/16/2023 8:58 AM] kuratius
```DISPLAY=:0 xinput set-prop "ektf2232" --type=float "libinput Calibra
tion Matrix" 0 0.748 0 -1.337 0 1 0 0 1
```


[8/16/2023 9:00 AM] kuratius
do you know how the wrong axis ranges in the driver can be fixed?


[8/16/2023 9:00 AM] kuratius
maybe the kernel relies on them when it rotates the axes, and that' s why the offset is wrong


[8/16/2023 9:01 AM] kuratius
should I just try these and see what happens in evtest?


[8/16/2023 9:03 AM] kuratius
or maybe touchscreen-max-x and touchscreen-max-y


[8/16/2023 9:03 AM] kuratius
but same issue


[8/16/2023 9:05 AM] kuratius
screen will probably break again if I do that


[8/16/2023 9:06 AM] kuratius
I'll hard reset the kernel repo and try an envkernel, maybe I just deleted a line too many or something


[8/16/2023 9:09 AM] kuratius
if it doesnt work then I will try reverting the kernel repo to an earlier commit


[8/16/2023 9:12 AM] andi15701
Documentation/devicetree/bindings/input/touchscreen/touchscreen.yaml


[8/16/2023 9:12 AM] andi15701
about the properties


[8/16/2023 9:13 AM] andi15701
touchscreen_apply_prop_to_x_y in drivers/input/touchscreen.c


[8/16/2023 9:14 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-5828E.txt


[8/16/2023 9:14 AM] andi15701
you can play around with min/max


[8/16/2023 9:15 AM] andi15701
min/size


[8/16/2023 9:16 AM] kuratius
also i should stop trying to flash kernels with lightdm on


[8/16/2023 9:16 AM] kuratius
it crashes half the time


[8/16/2023 9:16 AM] kuratius
lol


[8/16/2023 9:22 AM] kuratius
ya screen is broken again


[8/16/2023 9:22 AM] kuratius
I'll just compile a kernel to check evtest then try reverting the nia c commit


[8/16/2023 9:33 AM] kuratius
... this is the second time I accidently rebooted my pc instead of the nia


[8/16/2023 9:35 AM] kuratius
oh hey evtest is sensible now


[8/16/2023 9:35 AM] kuratius
```kobo-nia:~$ evtest
No device specified, trying to scan all of /dev/input/event*
Not running as root, no devices may be available.
Available devices:
/dev/input/event0:    gpio-keys
/dev/input/event1:    ektf2232
Select the device event number [0-1]: 1
Input driver version is 1.0.1
Input device ID: bus 0x18 vendor 0x0 product 0x0 version 0x0
Input device name: "ektf2232"
Supported events:
  Event type 0 (EV_SYN)
  Event type 1 (EV_KEY)
    Event code 330 (BTN_TOUCH)
  Event type 3 (EV_ABS)
    Event code 0 (ABS_X)
      Value     47
      Min        0
      Max     1918
    Event code 1 (ABS_Y)
      Value     92
      Min        0
      Max     1434
    Event code 47 (ABS_MT_SLOT)
      Value      0
      Min        0
      Max        4
    Event code 53 (ABS_MT_POSITION_X)
      Value      0
      Min        0
      Max     1918
    Event code 54 (ABS_MT_POSITION_Y)
      Value      0
      Min        0
      Max     1434
    Event code 57 (ABS_MT_TRACKING_ID)
      Value      0
      Min        0
      Max    65535
Properties:
  Property type 1 (INPUT_PROP_DIRECT)
Testing ... (interrupt to exit)```


[8/16/2023 9:36 AM] kuratius
bottom right gets you this 
```Event: time 1692171359.932363, type 3 (EV_ABS), code 0 (ABS_X), value 1849
Event: time 1692171359.932363, type 3 (EV_ABS), code 1 (ABS_Y), value 1273
Event: time 1692171359.932363, -------------- SYN_REPORT ------------
```


[8/16/2023 9:37 AM] kuratius
I should probably put 1920 and 1436 as sizes, the maxima are off by 1


[8/16/2023 9:37 AM] kuratius
but progress


[8/16/2023 9:45 AM] kuratius
yay screen is working again after reverting commits


[8/16/2023 9:46 AM] kuratius
git checkout 9120a7618bebd49dcd0068cc957d6ce22d0ce7bc


[8/16/2023 9:46 AM] kuratius
this is what I did


[8/16/2023 9:51 AM] kuratius
maxima are correct now


[8/16/2023 9:52 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-6037A.png


[8/16/2023 9:52 AM] kuratius
Supported events:
  Event type 0 (EV_SYN)
  Event type 1 (EV_KEY)
    Event code 330 (BTN_TOUCH)
  Event type 3 (EV_ABS)
    Event code 0 (ABS_X)
      Value   1814
      Min        0
      Max     1919
    Event code 1 (ABS_Y)
      Value    198
      Min        0
      Max     1435
    Event code 47 (ABS_MT_SLOT)
      Value      0
      Min        0
      Max        4
    Event code 53 (ABS_MT_POSITION_X)
      Value      0
      Min        0
      Max     1919
    Event code 54 (ABS_MT_POSITION_Y)
      Value      0
      Min        0
      Max     1435
    Event code 57 (ABS_MT_TRACKING_ID)
      Value      0
      Min        0
      Max    65535
Properties:


[8/16/2023 9:53 AM] kuratius
Event: time 1692172372.252111, type 3 (EV_ABS), code 0 (ABS_X), value 1827
Event: time 1692172372.252111, type 3 (EV_ABS), code 1 (ABS_Y), value 1219
bottom right


[8/16/2023 9:53 AM] kuratius
Event: time 1692172390.619041, type 1 (EV_KEY), code 330 (BTN_TOUCH), value 1
Event: time 1692172390.619041, type 3 (EV_ABS), code 0 (ABS_X), value 87
Event: time 1692172390.619041, type 3 (EV_ABS), code 1 (ABS_Y), value 249
top left


[8/16/2023 9:54 AM] kuratius
might still be shifted by 200 pixels or something


[8/16/2023 9:54 AM] kuratius
but better than before


[8/16/2023 9:54 AM] kuratius
will enable lightdm


[8/16/2023 9:57 AM] kuratius
still a bit iffy, but seems to work without setting an input matrix


[8/16/2023 10:00 AM] kuratius
yeah something is wonky with the top left corner


[8/16/2023 10:00 AM] andi15701
So summary, if kernel rotates things and gives out correct ranges, libinput does something sane with it


[8/16/2023 10:00 AM] kuratius
yeah


[8/16/2023 10:00 AM] kuratius
but I still dont get why the top left corner is 87 249 or something


[8/16/2023 10:01 AM] kuratius
should be 80 80 or something like it


[8/16/2023 10:04 AM] kuratius
I cant get taps to the alpine logo in the top left corner to work because of this


[8/16/2023 10:06 AM] kuratius
will remove the tweaks and test my libinput matrix again


[8/16/2023 10:17 AM] kuratius
top left logo works better with 1.4 instead of 1.33, maybe the touchscreen is shifted somewhere and that shift isnt documented, or the maximum for one of the coordinates was always wrong


[8/16/2023 10:17 AM] kuratius
1436 might not be the correct size


[8/16/2023 10:18 AM] kuratius
might be 1200 or something


[8/16/2023 10:18 AM] kuratius
or the screen dimensions are wrong somewhere


[8/16/2023 10:19 AM] kuratius
@Szybet You talked about your touchscreen being in accurate before, did you ever do any testing on that?


[8/16/2023 10:20 AM] kuratius
can you give the raw events for tapping the four corners?


[8/16/2023 10:23 AM] kuratius
I should buy a capacitive stylus


[8/16/2023 10:29 AM] kuratius
yeah actual max might be 1250 or something, not 1435


[8/16/2023 10:37 AM] szybet
it was like that on nickel too

maybe its just me and kobo ereaders
maybe my fingers


[8/16/2023 11:13 AM] kuratius
yeah maybe


[8/16/2023 11:15 AM] kuratius
just noticed one of the coefficients is leet


[8/16/2023 11:15 AM] kuratius
lol


[8/16/2023 11:17 AM] kuratius
there's something seriously wrong with this touchscreen


[8/16/2023 11:19 AM] kuratius
on screenkeyboard is way harder to use than it should be


[8/16/2023 11:19 AM] kuratius
even with a working calibration


[8/16/2023 11:21 AM] kuratius
the same touch can make two different rows of keys light up


[8/16/2023 11:23 AM] kuratius
I think the touchscreen data is noisy and it's not averaging


[8/16/2023 11:25 AM] kuratius
I cant show this very well, but if you hold a finger on the touchscreen and drag like you are selecting something, then stop your finger, the selection window oscillates wildly


[8/16/2023 11:26 AM] kuratius
ok I think the accuracy is maybe just really bad in the corners


[8/16/2023 11:27 AM] kuratius
I dont get this in the middle


[8/16/2023 11:28 AM] kuratius
@andi Next time you get your hands on your clara, can you tell me if you get the same when dragging the selection window to one of the corners?


[8/16/2023 11:28 AM] kuratius
this may explain the issues I'm having with selecting keys


[8/16/2023 11:35 AM] kuratius
maybe I need to set this 
touchscreen-average-samples:
    description: Number of data samples which are averaged for each read (valid
      values dependent on the controller)
    $ref: /schemas/types.yaml#/definitions/uint32


[8/16/2023 11:36 AM] kuratius
or the noise value


[8/16/2023 11:39 AM] kuratius
touchscreen-fuzz-x:
    description: horizontal noise value of the absolute input device (in pixels)
    $ref: /schemas/types.yaml#/definitions/uint32


[8/16/2023 11:44 AM] kuratius
testing this

{Attachments}
/mnt/data/projects/git/conversations/media/image-0E198.png


[8/16/2023 11:44 AM] kuratius
should result in 1/3 the noise


[8/16/2023 11:47 AM] kuratius
better, but I'll see if 100 samples is still usable in terms of latency


[8/16/2023 12:05 PM] kuratius
kobo-nia:~/xlibinput_calibrator/src$ DISPLAY=:0 ./xlibinput_calibrator --show-xi
nput-cmd
Install the 'xinput' tool and copy the command(s) below in a script that starts with your X session

       xinput set-float-prop "ektf2232" "libinput Calibration Matrix" \
            1.028468 0.022709 -0.015813 -0.034980 1.375372 \
            -0.200162 0.000000 0.000000 1.000000

kobo-nia:~/xlibinput_calibrator/src$ 
seems to really want to rescale the y-axis (see the 1.37 factor)


[8/16/2023 12:06 PM] kuratius
alright I don't trust the ektf2232 anymore


[8/16/2023 12:06 PM] kuratius
I think it's giving out wrong ranges


[8/16/2023 12:06 PM] kuratius
and this causes massive inaccuracy in the corners


[8/16/2023 12:06 PM] kuratius
needs manual calibration


[8/16/2023 12:07 PM] kuratius
or it thinks this is supposed to be a different touchscreen


[8/16/2023 12:07 PM] kuratius
does the kobo UI have buttons in the very corners?


[8/16/2023 12:07 PM] kuratius
It doesnt right?


[8/16/2023 12:15 PM] kuratius
I'll see if I can plot the accuracy of the readouts somehow


[8/16/2023 12:15 PM] kuratius
If maybe it's only linear near the middle of the screen


[8/16/2023 12:15 PM] kuratius
And gets inaccurate near the corners


[8/16/2023 12:16 PM] kuratius
I can do a curve fit to fix that, but it's not going to work with libinput


[8/16/2023 1:18 PM] kuratius
I would normally expect any sort of non linearity to be handled in the touchscreen driver


[8/16/2023 1:23 PM] kuratius
is ektf2232 the same driver that is used by Nickel?


[8/16/2023 1:35 PM] kuratius
I'll see if I can use X to get graphical output without lightdm/xfce


[8/16/2023 1:35 PM] kuratius
then maybe I can make a proper calibrator and get to the bottom of this


[8/16/2023 1:37 PM] andi15701
Driver used by nickel is not the same


[8/16/2023 1:38 PM] andi15701
but I do not see anything regarding nonlinearity there


[8/16/2023 1:38 PM] kuratius
the logic here is: I tried xlibinputcalibrator and it gave me these coefficients when going through the calibration process, even after fixing the maxima and rotation via kernel


[8/16/2023 1:39 PM] kuratius
and it has a weird offset and a weird scaling for the y axis


[8/16/2023 1:39 PM] kuratius
so either xlibinputcalibrator doesnt work correctly, or the touchschreen is somehow giving data that confuses it


[8/16/2023 1:40 PM] kuratius
out of curiosity, can you link the nickel driver?


[8/16/2023 1:40 PM] andi15701
not easily


[8/16/2023 1:41 PM] kuratius
later is fine too if it's in a repo somewhere


[8/16/2023 1:42 PM] kuratius
if it's not available publicly then idk


[8/16/2023 1:43 PM] andi15701
the driver in the kobo kernel is too dirty to be used anywhere else without modifing too much, so that we might accidentially change things unintendetly


[8/16/2023 1:44 PM] kuratius
is making modifications to the ektf2232 driver viable?


[8/16/2023 1:44 PM] kuratius
I'm more interested in looking at the nickel driver to check constants and maxima, not for using it directly


[8/16/2023 1:46 PM] andi15701
drivers/input/touchscreen/elan_touch_i2c.c in the nia kernel


[8/16/2023 1:47 PM] andi15701
but there is also an elan_ts.c and an elants_i2c.c


[8/16/2023 1:49 PM] andi15701
what I think might help: comparing with other nias, adding debug output in the stock nia kernel before and after scaling


[8/16/2023 1:49 PM] andi15701
checking evtest with inkbox


[8/16/2023 1:55 PM] kuratius
https://github.com/kobolabs/Kobo-Reader 
this isnt the kobo kernel repo is it?

{Embed}
https://github.com/kobolabs/Kobo-Reader
GitHub - kobolabs/Kobo-Reader
Contribute to kobolabs/Kobo-Reader development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/Kobo-Reader-CD705


[8/16/2023 1:59 PM] kuratius
@Szybet How do I get ssh? I'm using the inkbox image I compiled way back when you asked me to test the docker container for the build system


[8/16/2023 1:59 PM] szybet
are you rooted


[8/16/2023 1:59 PM] szybet
or not


[8/16/2023 1:59 PM] kuratius
also is there a menu I can check to see if it's rooted?


[8/16/2023 1:59 PM] szybet
if its rooted you will have ssh open when wifi connects


[8/16/2023 2:00 PM] szybet
it is


[8/16/2023 2:03 PM] kuratius
maybe I should download the newest release, I cant even select a wifi network


[8/16/2023 2:03 PM] kuratius
now it works


[8/16/2023 2:04 PM] szybet
what?


[8/16/2023 2:04 PM] szybet
it sometimes shows no network found when its turned on, it appears like 25% of time for me so hard to debug


[8/16/2023 2:05 PM] szybet
so i didnt cared for now


[8/16/2023 2:05 PM] kuratius
i tapped on the network name and nothing happened


[8/16/2023 2:05 PM] szybet
you need to tap on the arrow on the right...


[8/16/2023 2:06 PM] kuratius
was hard to hit apparently


[8/16/2023 2:06 PM] kuratius
I have wifi now


[8/16/2023 2:06 PM] szybet
i designed this part of inkbox, nicolas made the UI better

welp i have no problems with the arrow


[8/16/2023 2:07 PM] kuratius
(cant stress enough how much of an improvement 2.0 was, now I can actually enter my wifi password with the keyboard)


[8/16/2023 2:07 PM] kuratius
half the arrow is hidden by the scroll bar


[8/16/2023 2:07 PM] szybet
what


[8/16/2023 2:07 PM] szybet
how xD


[8/16/2023 2:07 PM] szybet
ye


[8/16/2023 2:08 PM] szybet
long network names
yea


[8/16/2023 2:09 PM] szybet
i will add to todo to make it character wrap the next line


[8/16/2023 2:09 PM] kuratius
Will delete soon but see how the scroll bar overlaps the arrow?


[8/16/2023 2:09 PM] andi15701
it is


[8/16/2023 2:09 PM] andi15701
and also in the inkbox repos


[8/16/2023 2:10 PM] szybet
yes i see the issue and know the solution


[8/16/2023 2:11 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-DF095.png


[8/16/2023 2:11 PM] kuratius
maybe the search function is just garbage then


[8/16/2023 2:11 PM] szybet
yes


[8/16/2023 2:11 PM] szybet
the github one is the worst


[8/16/2023 2:11 PM] szybet
they made it smarter and faster - it doesnt work for 99.9% of repos


[8/16/2023 2:20 PM] kuratius
is there a default ssh login?


[8/16/2023 2:22 PM] kuratius
I'll see if I can turn on usb networking


[8/16/2023 2:22 PM] szybet
root 
root


[8/16/2023 2:23 PM] szybet
if you can ping the device - scan for ports / connect to ssh if it is there


[8/16/2023 2:23 PM] kuratius
I am in


[8/16/2023 2:23 PM] kuratius
dk@dk-ThinkPad-E560:~/nia/linux$ ssh root@192.168.178.113
root@192.168.178.113's password: 
Welcome to InkBox OS!
* Warning *
Root filesystem is mounted read-only.
Invoke `ifsctl mnt rootfs rw' to make it read-write.
kobo:~#


[8/16/2023 2:24 PM] kuratius
kobo:~# evtest
No device specified, trying to scan all of /dev/input/event*
Available devices:
/dev/input/event0:    gpio-keys
/dev/input/event1:    elan-touch
Select the device event number [0-1]: 1
Input driver version is 1.0.1
Input device ID: bus 0x18 vendor 0x0 product 0x0 version 0x0
Input device name: "elan-touch"
Supported events:
  Event type 0 (EV_SYN)
  Event type 1 (EV_KEY)
    Event code 258 (BTN_2)
    Event code 330 (BTN_TOUCH)
  Event type 3 (EV_ABS)
    Event code 0 (ABS_X)
      Value    444
      Min        0
      Max     1024
    Event code 1 (ABS_Y)
      Value    307
      Min        0
      Max      758
    Event code 16 (ABS_HAT0X)
      Value      0
      Min        0
      Max     1024
    Event code 17 (ABS_HAT0Y)
      Value      0
      Min        0
      Max      758
    Event code 24 (ABS_PRESSURE)
      Value      0
      Min        0
      Max     2048
    Event code 48 (ABS_MT_TOUCH_MAJOR)
      Value      0
      Min        0
      Max        2
    Event code 50 (ABS_MT_WIDTH_MAJOR)
      Value      0
      Min        0
      Max        2
    Event code 53 (ABS_MT_POSITION_X)
      Value      0
      Min        0
      Max     1024
    Event code 54 (ABS_MT_POSITION_Y)
      Value      0
      Min        0
      Max      758
    Event code 57 (ABS_MT_TRACKING_ID)
      Value      0
      Min        0
      Max        2
Properties:
Testing ... (interrupt to exit)


[8/16/2023 2:25 PM] kuratius
top left is (27, 55)


[8/16/2023 2:25 PM] kuratius
(985, 45) is top right


[8/16/2023 2:26 PM] kuratius
(986,688) is bottom right


[8/16/2023 2:26 PM] kuratius
bottom left (21, 701)


[8/16/2023 2:30 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-67BEE.png


[8/16/2023 2:30 PM] kuratius
wtf is wrong with github


[8/16/2023 2:31 PM] szybet
https://github.com/baskerville/plato/issues/220#issuecomment-1033530777

{Embed}
https://github.com/baskerville/plato/issues/220
Kobo nia support · Issue #220 · baskerville/plato
I own a kobo nia and I tryied to install plato on it. It launches, it shows the books, it responds to USB to PC connection, it responds also to the shutdown button. It seems everything works but no...
/mnt/data/projects/git/conversations/media/220-563D4


[8/16/2023 2:31 PM] szybet
hmm look at that, idk if related


[8/16/2023 2:31 PM] szybet
it will never be indexed


[8/16/2023 2:35 PM] kuratius
wtf is the touch phoenix protocl


[8/16/2023 2:38 PM] szybet
i still don't know


[8/16/2023 2:39 PM] kuratius
@NiLuJe Any idea?


[8/16/2023 2:40 PM] kuratius
also I'm cloning the inkbox kernel repo to see if I can find the driver with "find"


[8/16/2023 2:43 PM] szybet
ys you can


[8/16/2023 2:43 PM] szybet
in commits you will see that i modified it a bit


[8/16/2023 2:43 PM] szybet
unrelated sleep things


[8/16/2023 2:51 PM] kuratius
magic numbers

{Attachments}
/mnt/data/projects/git/conversations/media/image-80758.png


[8/16/2023 3:01 PM] kuratius
dk@dk-ThinkPad-E560:~/nia/linux$ find . -name *ektf2232*
dk@dk-ThinkPad-E560:~/nia/linux$ find . -name ektf2232*
dk@dk-ThinkPad-E560:~/nia/linux$ find . -name ektf2232
dk@dk-ThinkPad-E560:~/nia/linux$ 

ektf2232 driver is not in the kernel repo I guess?


[8/16/2023 3:03 PM] kuratius
ektf2127 seems to have a driver file


[8/16/2023 3:10 PM] kuratius
https://esphome.io/api/ektf2232_8cpp_source


[8/16/2023 3:10 PM] kuratius
https://esphome.io/api/ektf2232_8h_source


[8/16/2023 4:05 PM] kuratius
Is there a dtb for the inkbox kernel?


[8/16/2023 4:06 PM] kuratius
dts


[8/16/2023 4:07 PM] kuratius
This seems to imply that the driver outputs Max 799 and 599


[8/16/2023 4:07 PM] kuratius
But this has  different max


[8/16/2023 4:26 PM] andi15701
drivers/input/touchscreen/elan_touch_i2c.c in the nia kernel


[8/16/2023 4:26 PM] kuratius
that's where this screenshot is from


[8/16/2023 4:27 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-144D8.txt


[8/16/2023 4:31 PM] andi15701
ektf2127 driver in mainline was extended to support more devices


[8/16/2023 4:39 PM] kuratius
@Szybet how does inkbox get to 1024  using the elan driver? 
Max     1024 seems to conflict with the rotation/scaling the elan driver does


[8/16/2023 4:39 PM] szybet
i have no idea?


[8/16/2023 4:40 PM] szybet
it works - we didnt dug deeper at all


[8/16/2023 4:41 PM] kuratius
does inkbox have a dts?


[8/16/2023 4:41 PM] szybet
dts is?


[8/16/2023 4:42 PM] kuratius
devicetree stuff


[8/16/2023 4:42 PM] szybet
in the sd card via nx stuff


[8/16/2023 4:42 PM] szybet
loading directly from raw bytes in unpartitioned space


[8/16/2023 4:43 PM] kuratius
so the implication is that there is a devicetree binary somewhere, but there is no source code for it?


[8/16/2023 4:43 PM] andi15701
there is


[8/16/2023 4:43 PM] szybet
there is


[8/16/2023 4:43 PM] andi15701
imx6ull-e60u22a00.dts


[8/16/2023 4:43 PM] szybet
you can even uncompile it


[8/16/2023 4:43 PM] andi15701
if i remeber correctly


[8/16/2023 4:43 PM] andi15701
hardly readable if decompiled


[8/16/2023 4:44 PM] szybet
ye


[8/16/2023 4:44 PM] kuratius
dk@dk-ThinkPad-E560:~/inkboxkernel/kernel/kernel/linux-2.6.35.3$ find . -name imx6ull-e60u22a00.dts
dk@dk-ThinkPad-E560:~/inkboxkernel/kernel/kernel/linux-2.6.35.3$


[8/16/2023 4:44 PM] kuratius
should I search the kobo repo?


[8/16/2023 4:45 PM] andi15701
linux-4.1.15-n306


[8/16/2023 4:45 PM] andi15701
I guess


[8/16/2023 4:46 PM] andi15701
is the right directory


[8/16/2023 4:46 PM] szybet
it should be there


[8/16/2023 4:46 PM] kuratius
dk@dk-ThinkPad-E560:~/inkboxkernel/kernel/kernel/linux-4.1.15-n306$ ls
arch  block  COPYING  CREDITS  crypto  Documentation  drivers  firmware  fs  include  init  ipc  Kbuild  Kconfig  kernel  lib  MAINTAINERS  Makefile  mm  net  README  REPORTING-BUGS  samples  scripts  security  sound  tools  usr  virt
dk@dk-ThinkPad-E560:~/inkboxkernel/kernel/kernel/linux-4.1.15-n306$


[8/16/2023 4:46 PM] szybet
maybe in bootloader directory


[8/16/2023 4:46 PM] szybet
actually


[8/16/2023 4:46 PM] kuratius
I see


[8/16/2023 4:46 PM] kuratius
will check


[8/16/2023 4:47 PM] kuratius
dk@dk-ThinkPad-E560:~/inkboxkernel/kernel/kernel/linux-4.1.15-n306$ find . -name imx6ull-e60u22a00.dts
./arch/arm/boot/dts/imx6ull-e60u22a00.dts


[8/16/2023 4:47 PM] kuratius
match


[8/16/2023 4:49 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-D2D8F.png


[8/16/2023 4:52 PM] kuratius
cant find anything that explains the new maximum


[8/16/2023 4:55 PM] kuratius
```
#define ELAN_TS_X_MAX         1500<<1
#define ELAN_TS_Y_MAX         1000<<1 
```
this seems to say the touchscreen has 3000 and 2000 max


[8/16/2023 4:57 PM] kuratius
is there a chance that this was intended to be 0x1500 and 0x1000?


[8/16/2023 4:58 PM] kuratius
```
> >>>4/3
>1.3333333333333333
> >>> (1500<<1)/(1000<<1)
> 1.5
> >>> (0x1500<<1)/(0x1000<<1)
> 1.3125
```


[8/16/2023 4:59 PM] kuratius
nia is 4:3 aspect ratio


[8/16/2023 4:59 PM] kuratius
1024/758=1.35


[8/16/2023 5:00 PM] szybet
the dpi is 212


[8/16/2023 5:00 PM] szybet
its not regular


[8/16/2023 5:01 PM] szybet
idk if this matters


[8/16/2023 5:04 PM] kuratius
I guess these numbers could also be completely arbitrary


[8/16/2023 5:11 PM] kuratius
> 799/1088
> 0.734375
> >>> 599/768
> 0.7799479166666666
> >>> 
this thing is changing the aspect ratio


[8/16/2023 5:14 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-F5AB5.png


[8/16/2023 5:14 PM] kuratius
this is from andis kernel repo


[8/16/2023 5:16 PM] kuratius
So guess first t inverts x, then it swaps x and y, shouldnt it swap the pointers to the max too?


[8/16/2023 5:17 PM] kuratius
I guess that happens here

{Attachments}
/mnt/data/projects/git/conversations/media/image-05BF6.png


[8/16/2023 6:14 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/20230816_181201-CCF9F.mp4


[8/16/2023 6:14 PM] kuratius
This is the corner jitter+it doesn't reach the corner


[8/16/2023 6:15 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-3F4DE.png


[8/16/2023 6:15 PM] kuratius
this is the kernel config I am using


[8/16/2023 6:16 PM] kuratius
Device 'ektf2232':
    Device Enabled (123):    1
    Coordinate Transformation Matrix (124):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Rotation Angle (247):    0.000000
    libinput Rotation Angle Default (248):    0.000000
    libinput Calibration Matrix (249):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Calibration Matrix Default (250):    1.000000, 0.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000, 0.000000, 1.000000
    libinput Send Events Modes Available (251):    1, 0
    libinput Send Events Mode Enabled (252):    0, 0
    libinput Send Events Mode Enabled Default (253):    0, 0
    Device Node (254):    "/dev/input/event0"
    Device Product ID (255):    0, 0
kobo-nia:~$


[8/16/2023 6:16 PM] kuratius
no libinput matrix


[8/16/2023 6:17 PM] kuratius
the average samples paramter doesnt seem to do much


[8/16/2023 6:17 PM] kuratius
maybe it is only used for taps?


[8/16/2023 6:18 PM] kuratius
also there is a fuzz paramter that I dont understand the purpose of


[8/16/2023 6:18 PM] kuratius
this thing


[8/16/2023 6:18 PM] kuratius
(just to recap what the current problems are)


[8/16/2023 6:19 PM] kuratius
so I think the maxima reported by the touchscreen driver are still wrong in some way


[8/16/2023 6:20 PM] kuratius
maybe the touch layer is bigger than the screen


[8/16/2023 6:20 PM] kuratius
or there is a part of the screen hidden by the bezel that is unused/forcibly ingnored


[8/16/2023 6:22 PM] kuratius
this jitter does not happen if I have my finger in the center


[8/16/2023 6:24 PM] kuratius
This is what I mean by ghost touches


[8/16/2023 6:24 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/20230816_182404-83C05.mp4


[8/16/2023 6:25 PM] kuratius
Maybe a byproduct of the jitter, idk


[8/16/2023 6:26 PM] kuratius
You see how it triggers the o?


[8/16/2023 6:26 PM] kuratius
It is difficult to tell if inkbox driver has the same issues


[8/16/2023 6:27 PM] kuratius
Maybe the nia has a garbage touchscreen and the nickel ui just compensates by being slow and waiting a long time to react


[8/16/2023 6:28 PM] kuratius
Or there is some other software trick missing


[8/16/2023 6:28 PM] kuratius
I feel like the samples setting is ignored


[8/16/2023 6:30 PM] kuratius
kobo-nia:~$ ls /sys/firmware/devicetree/base/soc/bus@2100000/i2c@21a0000/touchscreen@15/
compatible                   name                         reg                          touchscreen-inverted-x       touchscreen-size-y
interrupts-extended          power-gpios                  touchscreen-average-samples  touchscreen-size-x           touchscreen-swapped-x-y
kobo-nia:~$


[8/16/2023 6:30 PM] kuratius
it claims it is applied


[8/16/2023 6:30 PM] kuratius
are 1000 samples not enough?


[8/16/2023 6:31 PM] andi15701
andi@aktux:~/kobo/kernel/drivers/input$ grep -R touchscreen-average-samples *
touchscreen/ads7846.c:    if (!of_property_read_u32(node, "touchscreen-average-samples", &value))
touchscreen/imx6ul_tsc.c:    err = of_property_read_u32(np, "touchscreen-average-samples",
touchscreen/imx6ul_tsc.c:            "touchscreen-average-samples (%u) must be 1, 4, 8, 16 or 32\n",


[8/16/2023 6:32 PM] andi15701
it has to be done per-driver


[8/16/2023 6:32 PM] andi15701
apparently


[8/16/2023 6:32 PM] kuratius
Also I think that for some reason pmOS is faster at most things than inkbox, so these things may be hidden if inkbox is slow enough


[8/16/2023 6:33 PM] kuratius
What does per driver mean?


[8/16/2023 6:33 PM] kuratius
Do I have a driver specific set of valid values?


[8/16/2023 6:33 PM] kuratius
Or does this mean I have to set this in the driver instead of the kernel?


[8/16/2023 6:34 PM] andi15701
if the driver does not implement that, it gets ignored


[8/16/2023 6:34 PM] andi15701
so it is not done in drivers/input/touchscreen.c


[8/16/2023 6:35 PM] kuratius
So do I edit the driver?


[8/16/2023 6:36 PM] kuratius
Or check if inkbox has this jitter?


[8/16/2023 6:36 PM] andi15701
let me also sum up things, if I am correct:


[8/16/2023 6:49 PM] andi15701
a) touchscreen rotation in dts is respected and rotated things come out of /dev/input/eventX, b) libinput uses min/size-values provided by the kernel to scale things correctly (provided that min/max are correct) c) touchscreen produces strange things in the corners d) there is some random offset e) no evidence of any sophisticated filtering done by either driver (stock one vs mainline one)


[8/16/2023 6:49 PM] andi15701
so what about: adding some printk to print out unscaled values in the stock driver


[8/16/2023 6:50 PM] andi15701
what is interesting: there are some calibration commands


[8/16/2023 6:50 PM] andi15701
in the stock driver


[8/16/2023 6:52 PM] kuratius
d) could also be caused by wrong max values because it will fuck up the rotations


[8/16/2023 6:52 PM] kuratius
Do I edit inkbox sources and then rebuild the inkbox kernel?


[8/16/2023 6:52 PM] andi15701
the kernel sources in inkbox


[8/16/2023 6:53 PM] andi15701
probably the easiest way


[8/16/2023 6:53 PM] andi15701
yes


[8/16/2023 6:54 PM] kuratius
Really glad there is a docker container for the inkbox build now


[8/16/2023 6:55 PM] andi15701
+static void __elan_10A6_calibration (struct i2c_client *client)
+{
+       int rc;
+       uint8_t buf_recv[6] = { 0 };
+       uint8_t cmd_calib0[] = {0x97 ,0xFF ,0xF1 ,0x00 ,0x00 ,0xF1} ;//delay 100ms 
+       uint8_t cmd_calib1[] = {0x97 ,0x04 ,0x88 ,0x00 ,0x00 ,0xF1} ;//delay 10ms
+       uint8_t cmd_calib2[] = {0x97 ,0x04 ,0x41 ,0x01 ,0x27 ,0xF1} ;//delay 10ms
+       uint8_t cmd_calib3[] = {0x97 ,0x04 ,0x42 ,0x01 ,0x27 ,0xF1} ;//delay 10ms
+       uint8_t cmd_calib4[] = {0x97 ,0x04 ,0xb2 ,0x00 ,0x00 ,0xF1} ;//delay 10ms
+       uint8_t cmd_calib5[] = {0x97 ,0x04 ,0x54 ,0x00 ,0x06 ,0xF1} ;//delay 10ms
+       uint8_t cmd_calib6[] = {0x97 ,0x04 ,0x55 ,0x03 ,0x84 ,0xF1} ;//delay 10ms 
+       uint8_t cmd_calib7[] = {0x97 ,0x04 ,0x56 ,0x03 ,0x20 ,0xF1} ;//delay 10ms 
+       uint8_t cmd_calib8[] = {0x97 ,0x04 ,0x75 ,0x02 ,0x58 ,0xF1} ;//delay 10ms
+       uint8_t cmd_calib9[] = {0x97 ,0x04 ,0xd2 ,0x00 ,0x0C ,0xF1} ;//delay 10ms  
+       uint8_t cmd_calib10[] = {0x97 ,0xFF ,0xF0 ,0x00 ,0x00 ,0xF1} ;//delay 200ms 
+


[8/16/2023 6:55 PM] andi15701
that is some strange thing


[8/16/2023 6:58 PM] ninuje
About what, exactly?


[8/16/2023 6:59 PM] kuratius
Phoenix touch


[8/16/2023 7:01 PM] ninuje
Should be irrelevant for mainline, that's just NTX kernels not following the Linux MT protocols


[8/16/2023 7:02 PM] ninuje
Unrelated to scaling, it just affects how input frames are sent (mainly in terms of slot/id)


[8/16/2023 7:02 PM] ninuje
The Elan driver is awful, FWIW


[8/16/2023 7:02 PM] ninuje
(In NTX kernels, at least)


[8/16/2023 7:03 PM] ninuje
But I don't recall any glaring accuracy issues (for single contacts, at least); besides it just dropping inputs entirely ^^


[8/16/2023 7:04 PM] ninuje
(It's in use by the devices w/ pen support, so they'd have a lot of people shouting at 'em if it did anything very obviously wrong with pen input)


[8/16/2023 7:05 PM] ninuje
(by which I mean, pen input makes accuracy issues very obvious)


[8/16/2023 7:07 PM] kuratius
so just changes event ids, not how often events are sent or anything like that?


[8/16/2023 7:07 PM] kuratius
Nothing related to averaging?


[8/16/2023 7:07 PM] ninuje
Nope


[8/16/2023 7:08 PM] ninuje
That's always done correctly in-kernel, for the panels that require it


[8/16/2023 7:08 PM] ninuje
So's the rotation (except it's... hella wrong)


[8/16/2023 7:08 PM] kuratius
What do you mean by that?


[8/16/2023 7:09 PM] ninuje
It only extremely rarely matches an actual screen orientation


[8/16/2023 7:09 PM] ninuje
(and I mean *any* screen orientation, not simply UR)


[8/16/2023 7:09 PM] ninuje
So we basically undo the swaps & inverts in userland


[8/16/2023 7:09 PM] ninuje
Because they're nonsensical


[8/16/2023 7:10 PM] ninuje
(Well, I suspect they make sense for NTX's Android SDK)


[8/16/2023 7:10 PM] kuratius
Ur=upright?


[8/16/2023 7:10 PM] ninuje
Yes


[8/16/2023 7:10 PM] kuratius
So like a sheet of paper or a TV screen?


[8/16/2023 7:11 PM] kuratius
Person standing or lying down?


[8/16/2023 7:11 PM] ninuje
LinuxFB lingo


[8/16/2023 7:11 PM] ninuje
Screen (as in, the physcal thing) is upright


[8/16/2023 7:11 PM] ninuje
Whatever that might mean for the device


[8/16/2023 7:12 PM] ninuje
(i.e., it might be landscape or portrait)


[8/16/2023 7:12 PM] kuratius
Ah ok


[8/16/2023 7:12 PM] andi15701
and I am really curious about that one


[8/16/2023 7:12 PM] andi15701
what might it do


[8/16/2023 7:13 PM] andi15701
and it is not there in the mainline driver


[8/16/2023 7:25 PM] kuratius
Are they using a touchscreen driver for wacom pens?


[8/16/2023 7:26 PM] kuratius
Or are they a differently type of pen?


[8/16/2023 7:27 PM] kuratius
I know that wacom pens have accuracy issues in the corners too, my galaxy tab does at least, and I think the drawing tablet I have probably does too


[8/16/2023 7:27 PM] kuratius
Have not used the drawing tablet much


[8/16/2023 7:27 PM] kuratius
The pen tech in the Samsung one is licensed/bought from wacom


[8/16/2023 7:43 PM] ninuje
Not wacom emr pens


[8/16/2023 7:43 PM] ninuje
that's rM & Amazon


[8/17/2023 8:34 AM] kuratius
@Szybet What would you recommend for replacing the inkbox kernel with a modified one? Just use the docker container to build a new image or is there a sideload functionality like with pmOS?


[8/17/2023 8:35 AM] szybet
obviously there is


[8/17/2023 8:35 AM] szybet
https://github.com/Szybet/niAudio/blob/main/inkbox.md

{Embed}
https://github.com/Szybet/niAudio/blob/main/inkbox.md
niAudio/inkbox.md at main · Szybet/niAudio
Kobo nia ereader with audio added. Contribute to Szybet/niAudio development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/niAudio-613C3


[8/17/2023 8:36 AM] kuratius
>* I have writed this sentence, and now I don't know whot a talked about. Could you clarify?

may need editing


[8/17/2023 8:38 AM] szybet
its not complet


[8/17/2023 8:38 AM] szybet
but enough for you


[8/17/2023 8:38 AM] szybet
;p


[8/17/2023 8:38 AM] szybet
tldr

env -i GITDIR="${PWD}" TOOLCHAINDIR="${PWD}/toolchain/arm-nickel-linux-gnueabihf/" THREADS=$(($(nproc)*2)) TARGET=arm-nickel-linux-gnueabihf scripts/build_kernel.sh n306 root


[8/17/2023 8:38 AM] szybet
dd if=zImage-root of=/dev/sdcard bs=512 seek=81920


[8/17/2023 9:13 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-6AE83.txt


[8/17/2023 9:13 AM] kuratius
the clone fails for some reason and I dont get why


[8/17/2023 9:14 AM] kuratius
and why the fuck does it ask for an ssh key


[8/17/2023 9:14 AM] szybet
nicolas broke something lately?


[8/17/2023 9:14 AM] szybet
give me a minute


[8/17/2023 9:14 AM] szybet
or a few hours


[8/17/2023 9:15 AM] szybet
go to this commit for now


[8/17/2023 9:15 AM] szybet
60bb030df99f5a7a45f453ae8e74a951cd96f316


[8/17/2023 9:15 AM] szybet
dont clone recursive


[8/17/2023 9:16 AM] andi15701
separate fetch/push urls for repos?


[8/17/2023 9:16 AM] andi15701
might help


[8/17/2023 9:16 AM] andi15701
mygithub    https://github.com/akemnade/linux.git (fetch)
mygithub    git@github.com:akemnade/linux.git (push)

{Embed}
https://github.com/akemnade/linux.git
GitHub - akemnade/linux: Linux kernel source tree
Linux kernel source tree. Contribute to akemnade/linux development by creating an account on GitHub.
/mnt/data/projects/git/conversations/media/linux-7D0BC


[8/17/2023 9:16 AM] andi15701
it my kernel checkout


[8/17/2023 9:17 AM] szybet
#dev described the issue


[8/17/2023 11:20 AM] kuratius
am I reading this right, this is reading from unitialized memory?


[8/17/2023 11:20 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-7837C.png


[8/17/2023 11:21 AM] kuratius
x1, x2, etc are not initialized


[8/17/2023 11:21 AM] kuratius
https://stackoverflow.com/questions/11233602/what-will-be-the-value-of-uninitialized-variable

{Embed}
https://stackoverflow.com/questions/11233602/what-will-be-the-value-of-uninitialized-variable
What will be the value of uninitialized variable?
Possible Duplicate:
  Is uninitialized data behavior well specified?  
I tried the following code

#include<stdio.h>
void main()
{
int i; \
printf('%d',i);
}
The result gave garbage value i...
/mnt/data/projects/git/conversations/media/apple-touch-icon%402-C50E4.png


[8/17/2023 11:21 AM] szybet
could you post the code?


[8/17/2023 11:21 AM] szybet
so i can search it


[8/17/2023 11:21 AM] kuratius
sec


[8/17/2023 11:21 AM] szybet
ctrl f, such a fancy feature


[8/17/2023 11:24 AM] kuratius
cant get vim to copy to clipboard sorry

{Reactions}
😂 

[8/17/2023 11:25 AM] kuratius
static void elan_touch_report_data(struct i2c_client *client, uint8_t *buf)
{
    int i, major, minor;
    
    switch (buf[0]) {
    case idx_coordinate_packet:
    case multi_coordinate_packet: {
        static uint16_t last_x, last_y, last_x2, last_y2;
        uint16_t x1, x2, y1, y2;
        uint8_t finger_stat;
        static uint8_t finger1_index=1, finger2_index=4;

        if(1==gELAN_I2C_format) {
            finger_stat = (buf[idx_finger_state] & 0x03);        // for elan old 5A protocol the finger ID is 0x06
        }
        else if(2==gELAN_I2C_format) {
            finger_stat = (buf[1] & 0x03);  // check 2 fingers out of 10
            finger1_index=3;
            finger2_index=6;
        }
        else {
            finger_stat = (buf[idx_finger_state] & 0x06) >> 1;
        }
        if (finger_stat == 0) {
            if (g_touch_pressed & 1) {
                DBG_MSG ("[%s-%d] finger 1 up (%d, %d)\n", __func__, __LINE__, last_x, last_y);
#ifdef ELAN_TOUCH_MT_EVENT
                input_report_abs(elan_touch_data.input, ABS_MT_TRACKING_ID, 0);
                input_report_abs(elan_touch_data.input, ABS_MT_TOUCH_MAJOR, 0);
                input_report_abs(elan_touch_data.input, ABS_MT_WIDTH_MAJOR, 0);
                input_report_abs(elan_touch_data.input, ABS_MT_POSITION_X, last_x);
                input_report_abs(elan_touch_data.input, ABS_MT_POSITION_Y, last_y);
                input_mt_sync (elan_touch_data.input);
#endif


[8/17/2023 11:25 AM] kuratius
catted the file


[8/17/2023 11:26 AM] szybet
x1, x2, y1, y2 is not used in the code you probided


[8/17/2023 11:26 AM] kuratius
last_x last_y is


[8/17/2023 11:27 AM] szybet
it depends of the DBG_MSG macro


[8/17/2023 11:27 AM] szybet
but, most likely, yes


[8/17/2023 11:31 AM] kuratius
the comment about the resolution setting with the elan_internal stuff is confusing

{Attachments}
/mnt/data/projects/git/conversations/media/image-20F2C.png


[8/17/2023 11:32 AM] kuratius
let me check something


[8/17/2023 11:37 AM] szybet
dont question the default values


[8/17/2023 11:51 AM] kuratius
will uncomment this line, and maybe add a print statement for the elanInternalX, elanInternalY, xResolution, yResolution, screenX, screenY, gELAN_I2C_format variables

{Attachments}
/mnt/data/projects/git/conversations/media/image-CF091.png


[8/17/2023 11:52 AM] szybet
it depends if the code will compile ( ifdefs ) and if printk actually prints to dmesg or is it some other tool that is disabled below


[8/17/2023 11:53 AM] kuratius
what do the __func__ and __line__ parameters do?


[8/17/2023 11:54 AM] szybet
c macros that include as string the function name and line ( as of the file ) when compiling


[8/17/2023 11:54 AM] szybet
cool for debugginng


[8/17/2023 11:55 AM] kuratius
I see, ty


[8/17/2023 12:19 PM] kuratius
yup doesnt boot


[8/17/2023 12:19 PM] szybet
how did you compiled the kernel


[8/17/2023 12:20 PM] kuratius
dk@dk-ThinkPad-E560:~/kernel$ env -i GITDIR="${PWD}" TOOLCHAINDIR="${PWD}/toolchain/arm-nickel-linux-gnueabihf/" THREADS=$(($(nproc)*2)) TARGET=arm-nickel-linux-gnueabihf scripts/build_kernel.sh n306 root


[8/17/2023 12:20 PM] szybet
at what path do you have the repo


[8/17/2023 12:20 PM] kuratius
but sec i may have flashed the wrong file


[8/17/2023 12:20 PM] kuratius
does just compiling the kernel still care about absolute path?


[8/17/2023 12:21 PM] szybet
```
Don't forget to symlink the kernel repository to /home/build/inkbox/kernel or create the repository in that location. The path is fixed.
```
read the readme


[8/17/2023 12:22 PM] kuratius
I will say it again: that is dumb
I have a copy of the repo in that location from the docker stuff btw


[8/17/2023 12:22 PM] szybet
- yes this is lazy programming
- yes nicolas made it lke that when he was 15 years old
- yes we have more important things to develop than fix that
- yes


[8/17/2023 3:04 PM] kuratius
isnt zimage compressed?


[8/17/2023 3:05 PM] szybet
it is


[8/17/2023 3:05 PM] szybet
**z** - image


[8/17/2023 4:03 PM] kuratius
does the kernel image need to be signed?


[8/17/2023 4:06 PM] kuratius
I guess I'll just try running the docker container


[8/17/2023 4:15 PM] szybet
Nope


[8/17/2023 4:15 PM] szybet
What are you even doing


[8/17/2023 4:15 PM] szybet
Can ypu describe the steps?


[8/17/2023 4:16 PM] szybet
You know you need tp flash it to a inknox image?


[8/17/2023 4:16 PM] kuratius
I flashed it to an sd card that had working inkbox on it


[8/17/2023 4:16 PM] szybet
Also maybe gather some serial logs?


[8/17/2023 4:17 PM] kuratius
I'm not gonna do serial again for this, I will just run the container


[8/17/2023 4:17 PM] szybet
Ypu are really unlucky as for inkbox


[8/17/2023 4:17 PM] szybet
;p


[8/17/2023 4:19 PM] szybet
Oh what os are you on


[8/17/2023 4:19 PM] kuratius
xubuntu


[8/17/2023 4:19 PM] kuratius
x86 64 bit


[8/17/2023 4:20 PM] kuratius
it claims the compilation suceeded, but I guess something was still borked


[8/17/2023 4:20 PM] szybet
Arch works fir kernel 99%, debian docker 100%, xubuntu idk


[8/17/2023 4:20 PM] kuratius
since I tested the docker container before I am doing that atm


[8/17/2023 6:46 PM] kuratius
[ 1039.829567] [elan_touch_parse_xy-246] (1272, 68) (36, 87)
[ 1039.829645] elanInternalX: 1436, elanInternalY: 1920, xResolution: 1436, yResolution: 1920, screenX: 757, screenY: 1023, gELAN_I2C_format: 1 
[ 1039.829723] [elan_touch_parse_xy-246] (0, 0) (0, 757)
[ 1039.829776] elanInternalX: 1436, elanInternalY: 1920, xResolution: 1436, yResolution: 1920, screenX: 757, screenY: 1023, gELAN_I2C_format: 1


[8/17/2023 6:50 PM] kuratius
why does a single touch generate two events at completely different locations?


[8/17/2023 6:56 PM] kuratius
top left corner [ 1633.031959] [elan_touch_parse_xy-246] (1332, 62) (33, 55)
 (usb port to the right)


[8/17/2023 6:56 PM] kuratius
1332 62 is the raw driver data, 33,55 is the screen output


[8/17/2023 6:59 PM] kuratius
I guess maybe the driver resets the position when it loses contact


[8/17/2023 7:03 PM] kuratius
[ 1629.330892] [elan_touch_parse_xy-246] (1318, 63) (33, 63)
[ 1629.331045] [elan_touch_parse_xy-246] (0, 0) (0, 757)
[ 1630.711732] [elan_touch_parse_xy-246] (1280, 77) (41, 83)
[ 1630.711888] [elan_touch_parse_xy-246] (0, 0) (0, 757)
[ 1631.503601] [elan_touch_parse_xy-246] (1336, 57) (30, 53)
[ 1631.503758] [elan_touch_parse_xy-246] (0, 0) (0, 757)
[ 1632.196958] [elan_touch_parse_xy-246] (1339, 79) (42, 52)
[ 1632.197043] [elan_touch_parse_xy-246] (0, 0) (0, 757)
[ 1633.031959] [elan_touch_parse_xy-246] (1332, 62) (33, 55)
[ 1633.032094] [elan_touch_parse_xy-246] (0, 0) (0, 757)
[ 1895.863783] [elan_touch_parse_xy-246] (1377, 62) (33, 32)
[ 1895.863940] [elan_touch_parse_xy-246] (0, 0) (0, 757)
[ 1897.140046] [elan_touch_parse_xy-246] (1375, 55) (29, 33)
[ 1897.140132] [elan_touch_parse_xy-246] (0, 0) (0, 757)
[ 1899.445420] [elan_touch_parse_xy-246] (1383, 62) (33, 28)
[ 1899.445572] [elan_touch_parse_xy-246] (0, 0) (0, 757)
[ 1927.420371] [elan_touch_parse_xy-246] (1368, 66) (35, 36)
[ 1927.420520] [elan_touch_parse_xy-246] (0, 0) (0, 757)
[ 2042.049908] [elan_touch_parse_xy-246] (1386, 76) (40, 27)
[ 2042.050061] [elan_touch_parse_xy-246] (0, 0) (0, 757)


[8/17/2023 7:03 PM] kuratius
top left corner


[8/17/2023 7:04 PM] kuratius
the fuck is wrong with the clock


[8/17/2023 7:04 PM] kuratius
those are not seconds


[8/17/2023 7:05 PM] kuratius
so I guess summary is: elan driver uses the same max/min, but it doesnt have any weird offsets


[8/17/2023 7:06 PM] szybet
these are maybe system ticks? something like that


[8/17/2023 7:14 PM] kuratius
I also don't think it has a lot of jitter, but I maybe wrong. It's weird that it reports a second event every time. I will check what happens if I keep my finger on it


[8/17/2023 7:16 PM] kuratius
[ 2862.430745] [elan_touch_parse_xy-246] (1314, 70) (37, 65)
[ 2862.430898] [elan_touch_parse_xy-246] (0, 0) (0, 757)
I think the elan driver doesnt continuously report events


[8/17/2023 7:17 PM] kuratius
yeah I think it doesnt


[8/17/2023 7:17 PM] kuratius
evtest also behaves kindle like that


[8/17/2023 7:17 PM] kuratius
on inkbox


[8/17/2023 7:19 PM] kuratius
yeah it reports 1 event on initial touch, and then waits until the touch stops and then reports the same coordinates


[8/17/2023 7:19 PM] kuratius
it doesnt continuously report


[8/17/2023 7:20 PM] kuratius
and doesnt update on loss of contact


[8/17/2023 7:20 PM] kuratius
I think this driver cannot support gestures


[8/17/2023 7:20 PM] kuratius
I think the one on pmOS can, but because the touchscreen is bad it needs additional processing to make it any good


[8/17/2023 7:21 PM] szybet
thats how everything works


[8/17/2023 7:21 PM] kuratius
still havent figured out the the offset thing


[8/17/2023 7:21 PM] szybet
in linux


[8/17/2023 7:21 PM] szybet
i think?


[8/17/2023 7:21 PM] kuratius
the pmOS driver reports events continously I think


[8/17/2023 7:21 PM] kuratius
let me check again


[8/17/2023 7:22 PM] kuratius
btw if you enter poweroff without && exit I think it crashes the ssh client on inkbox


[8/17/2023 7:22 PM] kuratius
lol


[8/17/2023 7:23 PM] kuratius
cant ctr+c even


[8/17/2023 7:23 PM] kuratius
anyway booting pmOS


[8/17/2023 7:27 PM] kuratius
pmOS driver reports continously even in evtest


[8/17/2023 7:27 PM] kuratius
ektf2232 I mean


[8/17/2023 7:27 PM] kuratius
I can wiggle my finger and see the values change


[8/17/2023 7:28 PM] szybet
thats stupid then


[8/17/2023 7:28 PM] szybet
lol


[8/17/2023 7:28 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-6E6BA.txt


[8/17/2023 7:28 PM] szybet
swipes should work on inkbox too


[8/17/2023 7:28 PM] kuratius
do you use swipes for anything atm?


[8/17/2023 7:29 PM] szybet
soon, yes


[8/17/2023 7:30 PM] szybet
actually no


[8/17/2023 7:30 PM] szybet
well, no


[8/17/2023 7:30 PM] szybet
;p


[8/17/2023 7:30 PM] kuratius
then I would not guarantee that the driver works for swipes atm


[8/17/2023 7:30 PM] szybet
;p


[8/17/2023 7:30 PM] szybet
should


[8/17/2023 7:32 PM] kuratius
wait do you support pinch and zoom?


[8/17/2023 7:32 PM] szybet
kinda


[8/17/2023 7:32 PM] szybet
if i liked gestures i would use plato...


[8/17/2023 7:33 PM] kuratius
I'll start inkbox again and check what happens when I swipe


[8/17/2023 7:37 PM] szybet
ok bullshit, we have paint and swipes in it work


[8/17/2023 7:37 PM] kuratius (pinned)
also note to self: remove kernel rotation & kernel axis inversion and check if the top left corner has the weird offset if I do the rotation manually


[8/17/2023 7:37 PM] szybet
Pinned a message.


[8/17/2023 7:38 PM] kuratius
do you get any wiggling if you paint in a corner?


[8/17/2023 7:39 PM] szybet
its not accurate at all, so yes


[8/17/2023 7:39 PM] szybet
just check it, plato paint user app idk


[8/17/2023 7:40 PM] andi15701
$ find . -name "*.dtsi" -exec grep ektf \{\} \+
./arch/arm/boot/dts/nvidia/tegra30-asus-nexus7-grouper-common.dtsi:        compatible = "elan,ektf3624";
$  find . -name "*.dts" -exec grep ektf \{\} \+
./arch/arm/boot/dts/nxp/imx/imx50-kobo-aura.dts:        compatible = "elan,ektf2132";
./arch/arm/boot/dts/nxp/imx/imx6sl-tolino-vision.dts:        compatible = "elan,ektf2132";
./arch/arm/boot/dts/nvidia/tegra30-asus-tf300t.dts:            compatible = "elan,ektf3624";
./arch/arm/boot/dts/nvidia/tegra30-asus-tf300tg.dts:            compatible = "elan,ektf3624";
./arch/arm/boot/dts/nvidia/tegra30-asus-tf700t.dts:            compatible = "elan,ektf3624";


[8/17/2023 7:40 PM] andi15701
looking for other users of that driver


[8/17/2023 7:41 PM] andi15701
ektf3* seems to be elants_i2c


[8/17/2023 7:41 PM] kuratius
wait is the fuzz value what prevents continuous reporting?


[8/17/2023 7:42 PM] andi15701
static int input_defuzz_abs_event(int value, int old_val, int fuzz)


[8/17/2023 7:42 PM] andi15701
drivers/input/input.c


[8/17/2023 7:43 PM] andi15701
*pval = input_defuzz_abs_event(*pval, *pold,
                                                dev->absinfo[code].fuzz);
                if (*pold == *pval)
                        return INPUT_IGNORE_EVENT;


[8/17/2023 7:45 PM] andi15701
seems not to be used in vendor kernel


[8/17/2023 7:45 PM] andi15701
interesting would also be: comparing i2c traffic


[8/17/2023 7:45 PM] andi15701
esp. initialization


[8/17/2023 7:45 PM] andi15701
between the two drivers


[8/17/2023 7:47 PM] andi15701
you can define some i2c_master_send_debug() in the driver and right after it: #define i2c_master_send i2c_master_send_debug


[8/17/2023 7:49 PM] kuratius
so I write a function for printing i2c comms and then set a preprocessor directive? or something?


[8/17/2023 7:49 PM] kuratius
what does the directive do?


[8/17/2023 7:50 PM] kuratius
is there some other codeblock that gets enabled by it?


[8/17/2023 7:51 PM] andi15701
you write i2c_master_send_debug() to print the data and call i2c_master_send()


[8/17/2023 7:52 PM] andi15701
and by preprocessor, you direct every call to i2c_master_send() coming in the code after your i2c_master_send_debug() to that debug function


[8/17/2023 8:01 PM] kuratius
Ooh I did not see the second argument, I thought this was just something for ifdef statements, not a full replacement.


Ok then I'll give that a try after I check the offset thing again.
These i2c debug functions already exist and I just need to call them right? Or do I need to do something specific to listen in?
Also do the comms get sent to dmesk/printk?

And can you give the path of the ektf2232 driver?


[8/17/2023 8:02 PM] szybet
unrelated @Kuratius :
why dont you contribute to inkbox: you have the knowledge, will and time?...


[8/17/2023 8:03 PM] kuratius
I have the knowledge because andi was super helpful and clear with instructions


[8/17/2023 8:04 PM] kuratius
And I can write basic C now since I took a lecture this summer


[8/17/2023 8:05 PM] szybet
well at first i learned a lot from nicolas too


[8/17/2023 8:05 PM] szybet
but this still doesnt answer my question


[8/17/2023 8:07 PM] andi15701
drivers/input/touchscreen/ektf2127.c


[8/17/2023 8:08 PM] andi15701
basically ```
int  i2c_master_send_debug(data)
{
  printk(data)
  return i2c_master_send(data)
}
#define i2c_master_send i2c_master_send_debug
```


[8/17/2023 8:11 PM] kuratius
technically I shouldn't be doing this even now,  I'm procrastinating on other stuff. Right now I'm interested in fixing the driver thingy first, then maybe I could look into running inkbox/koreader/plato on pmOS since xfce is not usable.


[8/17/2023 8:14 PM] kuratius
So yes I can contribute, but please fix your infrastructure. The docker image was a really good first step towards  that.

Also would it be good to have a wiki integrated into the github? I've seen that with a lot of other projects, it's neat.


[8/17/2023 8:15 PM] szybet
infrastructure as what excatly?

i would also prefer it. please talk to nicolas / make a github issue about it and i will back it up ( he didnt listened to me when i requested )


[8/17/2023 8:16 PM] szybet
running inkbox on pm os is like vegeterian sausages

there is no point in converting something good to imit something and the result will be bad


[8/17/2023 8:17 PM] kuratius
Build system, build scripts for kernels, add an example hello world for a custom inkbox app


[8/17/2023 8:18 PM] szybet
build system is not great, i agree - still not that bad
for kernel? only tha path is the issue and the recent commit

sanki is really well written and can be an example - there is also a very minimal syncthing app - no need for hello world...


[8/17/2023 8:21 PM] szybet
also thats the point of contributing: fixing stuff you dont like


[8/17/2023 8:22 PM] kuratius
nr 1 thing: missing hello world that can be compiled and tested easily
nr 2 thing: furigana support or support for a reader app with furigana support


[8/17/2023 8:23 PM] kuratius
why is pmOS bad?


[8/17/2023 8:24 PM] szybet
inkbox user apps are just qt apps with extra steps... really no need for hello world...

as we talked, furigana is hard to add, at all


[8/17/2023 8:25 PM] kuratius
koreader user app?


[8/17/2023 8:26 PM] szybet
doesnt work on older devices and to make a proper ereader experience, inkbox is what it is because we applied our software to alpine and its soo much of this software that it is another distro now


[8/17/2023 8:26 PM] szybet
using alternative backends is next level


[8/17/2023 8:26 PM] szybet
it took me a few days to port plato sketch so yea


[8/17/2023 8:43 PM] tux_linux
Why


[8/17/2023 8:43 PM] szybet
the current reader app is bad


[8/17/2023 8:43 PM] szybet
apart from pdf


[8/17/2023 8:43 PM] tux_linux
So even your improved version is bad?


[8/17/2023 8:43 PM] szybet
***current***


[8/17/2023 8:44 PM] tux_linux
I'm not sure what current means in this case


[8/17/2023 8:44 PM] szybet
https://tenor.com/view/inugami-korone-hololive-thinking-anime-confused-gif-17902545

{Embed}
https://tenor.com/view/inugami-korone-hololive-thinking-anime-confused-gif-17902545
/mnt/data/projects/git/conversations/media/inugami-korone-hololive-BF49A.png


[8/17/2023 8:45 PM] tux_linux
Anyway, Wikipedia is powered by MediaWiki, I trust it, there is even a link to the wiki on the github readme


[8/17/2023 8:46 PM] kuratius
stable, non dev version


[8/17/2023 8:46 PM] szybet
its slow and no export and no markdown and bots and uptime


[8/17/2023 8:46 PM] szybet
kuratius also wants it


[8/17/2023 8:46 PM] szybet
its 2 - 1


[8/17/2023 8:48 PM] kuratius
I have a vote?


[8/17/2023 8:48 PM] szybet
why not lol


[8/17/2023 8:48 PM] kuratius
I thought this was benevolent dictator government


[8/17/2023 8:48 PM] szybet
dictator is in power until we fork the distro lol


[8/17/2023 8:49 PM] kuratius
also I still think running inkbox on pmOS cant be that hard


[8/17/2023 8:49 PM] kuratius
it almost worked on x86 when I tried


[8/17/2023 8:49 PM] szybet
its a waste of time - thats it


[8/17/2023 8:50 PM] kuratius
do you have a package manager on inkbox?


[8/17/2023 8:50 PM] szybet
we use alpine base for half the system


[8/17/2023 8:51 PM] szybet
so, yes


[8/17/2023 8:53 PM] tux_linux
Prove your point
Just look at C init program
Or power daemon


[8/17/2023 8:53 PM] kuratius
do you have a debug build of inkbox with stubs just for UI testing btw?


[8/17/2023 8:54 PM] szybet
what are stubs


[8/17/2023 8:54 PM] szybet
translate doesnt help


[8/17/2023 8:54 PM] kuratius
function stubs are empty functions that are used in place of calls that would otherwise fail or crash the program


[8/17/2023 8:54 PM] szybet
power daemon could run on pm os oob propably - for most basic features at least


[8/17/2023 8:55 PM] szybet
whats the point?... what?...


[8/17/2023 8:55 PM] kuratius
https://en.wikipedia.org/wiki/Method_stub

{Embed}
https://en.wikipedia.org/wiki/Method_stub
Method stub
A method stub or simply stub in software development is a piece of code used to stand in for some other programming functionality. A stub may simulate the behavior of existing code (such as a procedure on a remote machine; such methods are often called mocks) or be a temporary substitute for yet-to-be-developed code. Stubs are therefore most use...


[8/17/2023 8:55 PM] szybet
i ported many qt programs - none have something like that


[8/17/2023 8:55 PM] tux_linux
Then user apps


[8/17/2023 8:55 PM] tux_linux
Namespaces


[8/17/2023 8:55 PM] tux_linux
Chroots


[8/17/2023 8:55 PM] kuratius
it's for debugging/porting to get to a working configuration faster basically


[8/17/2023 8:56 PM] kuratius
so for example a battery stub would be a function that just always returns 100 % instead of trying to ask the kernel or some chip on the system for the actual percentage


[8/17/2023 8:57 PM] kuratius
which may fail on a different kernel


[8/17/2023 8:57 PM] tux_linux
Well, for that specific case, it already does that


[8/17/2023 8:57 PM] szybet
there is most often an else statement, thats it


[8/17/2023 8:58 PM] szybet
thats why it didnt crashed for you on 86


[8/17/2023 8:59 PM] kuratius
In the first place, you port inkbox to new kernels all the time


[8/17/2023 9:00 PM] szybet
yes, for kobo nia c i simply added another if else for battery


[8/17/2023 9:01 PM] kuratius
pmOS cant be harder than that unless you have to rip out things from the kernel all the time


[8/17/2023 9:02 PM] kuratius
and it could mean inkbox runs on every device pmOS runs on


[8/17/2023 9:02 PM] kuratius
which is a lot of devices


[8/17/2023 9:02 PM] szybet
lol... look at any porting thread


[8/17/2023 9:02 PM] szybet
how will pm os help?


[8/17/2023 9:04 PM] kuratius
compatibility with other pmOS devices
better software compatibility/easier porting in general
adding support for a new device only means you have to change things in the dts instead of in inkbox


[8/17/2023 9:04 PM] kuratius
that sort of thing


[8/17/2023 9:07 PM] szybet
does pm os support alpine base 3.10


[8/17/2023 9:08 PM] kuratius
also: trivial port to pineNote if it comes back from the dead


[8/17/2023 9:09 PM] szybet
one small issue


[8/17/2023 9:09 PM] szybet
very small


[8/17/2023 9:09 PM] szybet
porting mainline kernel is hard?


[8/17/2023 9:09 PM] szybet
you know?


[8/17/2023 9:09 PM] szybet
;p


[8/17/2023 9:11 PM] kuratius
Is it a problem if you cant port mainline to other devices?


[8/17/2023 9:12 PM] szybet
pm os wont run?


[8/17/2023 9:13 PM] kuratius
pmOS wouldnt but inkbox would still run on those older devices, and it would run on a lot of mainline kernel devices


[8/17/2023 9:13 PM] szybet
also: you are trying to make ***one*** ( 1 ) driver to work for the nia on mainline for the past few months


[8/17/2023 9:13 PM] szybet
now imagine 10 other devices


[8/17/2023 9:14 PM] szybet
supporting diffrent bases will be impossible?


[8/17/2023 9:14 PM] kuratius
you would not be concerned with that, that'd be for the people porting pmOS to those devices


[8/17/2023 9:14 PM] szybet
so at this point you have another distro


[8/17/2023 9:14 PM] kuratius
you already support different kernel versions/bases


[8/17/2023 9:14 PM] szybet
mainline kernel once again


[8/17/2023 9:14 PM] szybet
base is the same


[8/17/2023 9:25 PM] kuratius
What would you do if kobo releases a device with a mainline kernel?


[8/17/2023 9:38 PM] szybet
use it?


[8/17/2023 9:39 PM] szybet
it would be already ported


[8/17/2023 9:41 PM] kuratius
inkbox on pmOS is different somehow?


[8/17/2023 9:42 PM] szybet
base


[8/17/2023 9:43 PM] szybet
we use alpine 3.10 and in a chroot buildroot for reasons, and those 2 work together


[8/17/2023 9:45 PM] andi15701
well, fix one driver used on quite some devices...


[8/17/2023 9:51 PM] andi15701
well, there are other people getting some near-mainline kernel to run on new devices just under one week, as their first time experience with such things.


[8/17/2023 9:56 PM] andi15701
That is a good thing here, that the total amount of drivers involved is quite small


[8/17/2023 11:08 PM] andi15701
well, I expect a battery to work out of the box on any distro, no work needed. If you get a new laptop, do you need to care about the battery.  I have added some comments in the inkbox code how this can be done. Same for power buttons, perhaps a bit harder. If kernel is insane, you need of course quirks in the userspace


[8/17/2023 11:15 PM] kuratius
did you make a PR?


[8/17/2023 11:23 PM] kuratius
also I checked again without kernel rotation, I think the weird offset is all from the ektf2232 driver


[8/18/2023 7:56 AM] andi15701
https://github.com/Kobo-InkBox/rootfs/commit/f5f4800bcc467e611672a815d23bed9056c9c8c9

{Embed}
https://github.com/Kobo-InkBox/rootfs/commit/f5f4800bcc467e611672a815d23bed9056c9c8c9
`battery_watchdog`: N306C support (@KitKat-ok) · Kobo-InkBox/rootfs...
/mnt/data/projects/git/conversations/media/f5f4800bcc467e611672a815d23bed9056c9c8c9-EE000


[8/18/2023 7:56 AM] andi15701
was talking about that one


[8/18/2023 10:12 AM] kuratius
i2c_master_send only exists in the elan driver, looking for the equivalent in the ektf driver


[8/18/2023 10:12 AM] kuratius
I assume we need data from both right?


[8/18/2023 10:13 AM] andi15701
it is used also on the ektf driver


[8/18/2023 10:14 AM] kuratius
oh I am dumb


[8/18/2023 10:14 AM] kuratius
I was search the dts file


[8/18/2023 10:21 AM] kuratius
do I need to write a function for printing the struct or does that already exist?

{Attachments}
/mnt/data/projects/git/conversations/media/image-4099F.png


[8/18/2023 10:21 AM] szybet
doubt it


[8/18/2023 10:24 AM] kuratius
also why is buf cast to a char pointer again?


[8/18/2023 10:25 AM] kuratius
wouldnt you just write &buf?


[8/18/2023 10:25 AM] szybet
const is the problem propably


[8/18/2023 10:25 AM] szybet
as for function arguments


[8/18/2023 10:25 AM] szybet
ask chatgpt


[8/18/2023 10:31 AM] andi15701
only buf is interesting


[8/18/2023 10:33 AM] andi15701
but if you do it there, you need also the i2c address


[8/18/2023 10:35 AM] kuratius
data doesnt have a type here, so I assume I need to copy the arguments and types of i2c_master_send


[8/18/2023 10:38 AM] kuratius
just wrote a test, the & turns it form * buf into **buf, so it's not needed


[8/18/2023 10:46 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-C8AFB.png


[8/18/2023 10:47 AM] szybet
. remember that


[8/18/2023 10:47 AM] kuratius
I am not doing it in i2c.c


[8/18/2023 10:47 AM] kuratius
so I think it doesnt matter


[8/18/2023 10:48 AM] andi15701
yes, if not doing it in i2c.c then you do not need the address


[8/18/2023 10:48 AM] andi15701
printk("}\n"); btw


[8/18/2023 10:53 AM] kuratius
typo in the struct type


[8/18/2023 10:53 AM] kuratius
fixing it


[8/18/2023 11:03 AM] kuratius
printk doesnt seem to print to dmesg, is there a dmesg, printk option or a setting I need to change?


[8/18/2023 11:05 AM] kuratius
ah now I see it


[8/18/2023 11:07 AM] kuratius
kobo-nia:~$ dmesg | grep "Begin i2c" -A 7
[   13.382065] Begin i2c message:{ 
[   13.382089] S, 
[   13.382099] c, 
[   13.382103] \x00, 
[   13.382107] \x00, 
[   13.382111] }
[   13.388718] sy7636_detect():opmode=0x0
[   13.388755] sy7636_detect success
--
[   13.421771] Begin i2c message:{ 
[   13.421796] S, 
[   13.421805] `, 
[   13.421810] \x00, 
[   13.421814] \x00, 
[   13.421818] }
[   13.432458] videodev: Linux video capture interface: v2.00
[   13.469444] input: ektf2232 as /devices/platform/soc/2100000.bus/21a0000.i2c/i2c-0/0-0015/input/input0
kobo-nia:~$


[8/18/2023 11:07 AM] szybet
videodev?


[8/18/2023 11:08 AM] kuratius
(may not answer your question, but for reference, this is on pmOS)


[8/18/2023 11:08 AM] szybet
bloated kernel config


[8/18/2023 11:09 AM] kuratius
next I guess is adding the function to the elan driver


[8/18/2023 11:10 AM] kuratius
and remaking the sd card image because flashing the zImage of the kernel doesnt work for me


[8/18/2023 11:10 AM] szybet
😒


[8/18/2023 11:10 AM] kuratius
maybe removing it would help with the ram issues the nia has


[8/18/2023 11:10 AM] szybet
use serial


[8/18/2023 11:10 AM] szybet
what?


[8/18/2023 11:11 AM] szybet
you said its pm os


[8/18/2023 11:11 AM] kuratius
yes but xfce is scraping the limit of what the nia can do


[8/18/2023 11:11 AM] szybet
nia config is fine, i even added audio usb support and it added a little Kb only


[8/18/2023 11:11 AM] szybet
oh in that, well doubt it


[8/18/2023 11:11 AM] szybet
it would be to be heavily bloated


[8/18/2023 11:12 AM] kuratius
this is more a "cut away small things bit by bit" way of thinking


[8/18/2023 11:12 AM] kuratius
is videodev used for anything important?


[8/18/2023 11:13 AM] kuratius
It sounds like it's for screen recording


[8/18/2023 11:13 AM] kuratius
is it used for vnc?


[8/18/2023 11:13 AM] szybet
maybe your xorg needs it


[8/18/2023 11:13 AM] szybet
lol


[8/18/2023 11:16 AM] kuratius
oh wait


[8/18/2023 11:16 AM] kuratius
I may have messed up the print loop


[8/18/2023 11:16 AM] kuratius
count might not be the length of the buf array


[8/18/2023 11:16 AM] szybet
apart from ++i herezy it looks fine?


[8/18/2023 11:18 AM] kuratius
I've been taught that postcrement causes weird behavior and should be avoided for readability reasons
like a=b++ is
a=b
b++
and a=++b
is b++
a=b


[8/18/2023 11:21 AM] szybet
https://www.geeksforgeeks.org/pre-increment-and-post-increment-in-c/

{Embed}
https://www.geeksforgeeks.org/pre-increment-and-post-increment-in-c/
Pre-increment and Post-increment in C/C++ - GeeksforGeeks
A Computer Science portal for geeks. It contains well written, well thought and well explained computer science and programming articles, quizzes and practice/competitive programming/company interview Questions.


[8/18/2023 11:21 AM] kuratius
array_length = (total size of the array) / (size of the first element in the array)


[8/18/2023 11:21 AM] szybet
use i++ and dont introduce heresy


[8/18/2023 11:21 AM] kuratius
I guess it's fine if a char is 1 byte


[8/18/2023 11:22 AM] szybet
yep


[8/18/2023 11:36 AM] andi15701
use %02x instead of %c


[8/18/2023 11:54 AM] kuratius
what does that do?


[8/18/2023 11:54 AM] szybet
%02x means print at least 2 digits, prepend it with 0's if there's less. In your case it's 7 digits, so you get no extra 0 in front.

Also, %x is for int


[8/18/2023 11:54 AM] szybet
https://stackoverflow.com/questions/18438946/format-specifier-02x

{Embed}
https://stackoverflow.com/questions/18438946/format-specifier-02x
Format specifier %02x
I have a simple program :

#include <stdio.h>
int main()
{
        long i = 16843009;
        printf ("%02x \n" ,i);
}
I am using %02x format specifier to get 2 char output,
However, the out...
/mnt/data/projects/git/conversations/media/apple-touch-icon%402-C50E4.png


[8/18/2023 11:56 AM] kuratius
also my inkbox thingy doesnt build anymore


[8/18/2023 11:56 AM] kuratius
lol


[8/18/2023 11:57 AM] szybet
https://tenor.com/view/anime-cry-fma-terrible-day-gif-25502341

{Embed}
https://tenor.com/view/anime-cry-fma-terrible-day-gif-25502341
/mnt/data/projects/git/conversations/media/anime-cry-17311.png


[8/18/2023 11:58 AM] szybet
we cant fix your problems if we cant replicate them


[8/18/2023 11:58 AM] kuratius
maybe it's a duplicate function name or something


[8/18/2023 12:03 PM] kuratius
or file permissions


[8/18/2023 12:07 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-719F0.txt


[8/18/2023 12:07 PM] kuratius
oha


[8/18/2023 12:07 PM] kuratius
for loops arent allowed in the C dialect your kernel uses


[8/18/2023 12:09 PM] szybet
what the fu


[8/18/2023 12:44 PM] kuratius
is there a chance inkbox checks if the zImage-root matches the one on the recovery partition?


[8/18/2023 12:44 PM] szybet
no


[8/18/2023 12:45 PM] szybet
stop hating on inkbox build system, and quessing what is going on ***just connect serial my god***


[8/18/2023 12:46 PM] szybet
its not porting a new device, testing new features - I have been overwriting the kobo nia kernel hundrets of times by now with almost no issues.


[8/18/2023 12:47 PM] kuratius
will try with the zimage in the same folder as the original image


[8/18/2023 12:47 PM] szybet
the problem is either your host OS, your hardware or you doing something wrong like using the wrong commit in the kernel repo

the end


[8/18/2023 12:47 PM] szybet
what?


[8/18/2023 12:48 PM] kuratius
dk@dk-ThinkPad-E560:/home/build/inkbox/imgtool/out/release$ pwd
/home/build/inkbox/imgtool/out/release
dk@dk-ThinkPad-E560:/home/build/inkbox/imgtool/out/release$ ls
inkbox-2.0-n306.img  rootfs-partition.tar.xz  user-partition.tar.xz  zImage-std
inkbox-n306.img      u-boot_inkbox.bin        zImage-root
dk@dk-ThinkPad-E560:/home/build/inkbox/imgtool/out/release$


[8/18/2023 12:48 PM] szybet
```
zImage-root
```


[8/18/2023 12:48 PM] kuratius
yeah will try that one


[8/18/2023 12:48 PM] szybet
which one did you tried


[8/18/2023 12:48 PM] kuratius
if it bricks I am blaming you because the inkbox-2.0 image is functional


[8/18/2023 12:49 PM] szybet
imagine connecting serial and not complain for 2 days now


[8/18/2023 12:52 PM] kuratius
did not brick


[8/18/2023 12:53 PM] kuratius
this was the first one I tried today, the one yesterday was without your build container


[8/18/2023 12:53 PM] szybet
yea your os is borked


[8/18/2023 12:54 PM] andi15701
well, int i; for(i=.....)


[8/18/2023 12:54 PM] szybet
w h y?


[8/18/2023 12:54 PM] kuratius
frankenstein while loop I guess?


[8/18/2023 12:54 PM] andi15701
no


[8/18/2023 12:55 PM] andi15701
you just have to declare variables before the for loop


[8/18/2023 12:55 PM] szybet
why


[8/18/2023 12:55 PM] andi15701
if some older standard is enforced


[8/18/2023 12:55 PM] andi15701
something older than c99


[8/18/2023 12:55 PM] szybet
understandable


[8/18/2023 1:01 PM] kuratius
```kobo:~# dmesg | grep "Begin i2c" -A 7
[    5.859975] Begin i2c message:{ 53, 00, 00, 01, }
[    5.861535] [__elan_touch_init-380] firmware version 52 01 2C 31 (12C3)
[    5.861556] Begin i2c message:{ 53, f0, 00, 01, }
[    5.863100] [__elan_touch_init-387] firmware ID 52 F1 B5 01 (1B50)
[    5.863123] Begin i2c message:{ 53, 01, 00, 01, }
[    5.864651] [__elan_touch_init-419] boot code version  52 05 56 81
[    5.864670] Begin i2c message:{ 53, 60, 00, 00, }
[    5.866196] [__elan_touch_init-424] x resolution: 1436 
[    5.866215] Begin i2c message:{ 53, 63, 00, 00, }
[    5.867744] [__elan_touch_init-429] y resolution: 1920 
[    5.868438] input: elan-touch as /devices/virtual/input/input1
[    5.869777] elan ts starts in interrupt mode.
[    5.870111] cyttsp5_loader_init: Parade TTSP FW Loader Driver (Built TTDA.03.07.844339) rc=0
[    5.872980] snvs_rtc 20cc000.snvs:snvs-rtc-lp: rtc core: registered 20cc000.snvs:snvs-r as rtc1
[    5.873329] i2c /dev entries driver
[    5.874645] syscon-poweroff 20cc000.snvs:snvs-poweroff: pm_power_off already claimed 80021c08 ntx_machine_poweroff
kobo:~#```


[8/18/2023 1:09 PM] kuratius
I'll add the char format change to pmOS too and rerun


[8/18/2023 1:09 PM] kuratius
also dk@dk-ThinkPad-E560:/home/build/inkbox/kernel$ scp root@192.168.178.25:~/dmesglog.txt .
root@192.168.178.25's password: 
./dmesglog.txt: Permission denied
dk@dk-ThinkPad-E560:/home/build/inkbox/kernel$ 
why


[8/18/2023 1:10 PM] szybet
is ~ intepreted by your host shell? ;)


[8/18/2023 1:11 PM] kuratius
```^Cdk@dk-ThinkPad-E560:/home/build/inkbox/kernel$ scp root@192.168.178.25:dmesglog.txt .
root@192.168.178.25's password: 
./dmesglog.txt: Permission denied
dk@dk-ThinkPad-E560:/home/build/inkbox/kernel$ scp root@192.168.178.25:dmesglog.txt .
root@192.168.178.25's password: 
./dmesglog.txt: Permission denied
dk@dk-ThinkPad-E560:/home/build/inkbox/kernel$ scp root@192.168.178.25:~/dmesglog.txt .
root@192.168.178.25's password: 
./dmesglog.txt: Permission denied
dk@dk-ThinkPad-E560:/home/build/inkbox/kernel$ scp root@192.168.178.25:/root/dmesglog.txt .
root@192.168.178.25's password: 
./dmesglog.txt: Permission denied
dk@dk-ThinkPad-E560:/home/build/inkbox/kernel$```


[8/18/2023 1:11 PM] kuratius
kobo:~# ls
dmesglog.txt
kobo:~# pwd
/root
kobo:~#


[8/18/2023 1:12 PM] szybet
what is the dot at the end of scp


[8/18/2023 1:12 PM] andi15701
and what permission has it


[8/18/2023 1:12 PM] andi15701
you destination directory


[8/18/2023 1:12 PM] kuratius
that may be the issue


[8/18/2023 1:12 PM] kuratius
thank you


[8/18/2023 1:13 PM] kuratius
worked now


[8/18/2023 1:14 PM] kuratius
inkbox build directory is not writable without root


[8/18/2023 1:20 PM] szybet
because you cloned as root


[8/18/2023 1:20 PM] kuratius
makes it copy to current directory


[8/18/2023 1:20 PM] szybet
just sudo chown -R kuratius:kuratius *


[8/18/2023 1:20 PM] szybet
there is no space in between


[8/18/2023 1:21 PM] kuratius
there is?


[8/18/2023 1:21 PM] szybet
discord formatting


[8/18/2023 1:21 PM] szybet
hehe


[8/18/2023 1:22 PM] kuratius
added codeblock


[8/18/2023 1:22 PM] kuratius
```kobo-nia:~$ dmesg | grep "Begin i2c" -A 7
[   13.362459] Begin i2c message:{ 
[   13.362483] 53, 
[   13.362496] 63, 
[   13.362502] 00, 
[   13.362506] 00, 
[   13.362511] }
[   13.363374] lm3630a_bl 0-0036: LM3630A backlight register OK.
[   13.399435] Begin i2c message:{ 
[   13.399461] 53, 
[   13.399475] 60, 
[   13.399480] 00, 
[   13.399485] 00, 
[   13.399489] }
[   13.411350] mc: Linux media interface: v0.10
[   13.452981] input: ektf2232 as /devices/platform/soc/2100000.bus/21a0000.i2c/i2c-0/0-0015/input/input0
kobo-nia:~$```


[8/18/2023 1:25 PM] kuratius
53, 63,  00, 00, 
 53, 60,  00, 00, 

this is what ektf sends

[    5.859975] Begin i2c message:{ 53, 00, 00, 01, }
[    5.861556] Begin i2c message:{ 53, f0, 00, 01, }
[    5.863123] Begin i2c message:{ 53, 01, 00, 01, }
[    5.864670] Begin i2c message:{ 53, 60, 00, 00, }
[    5.866215] Begin i2c message:{ 53, 63, 00, 00, }

this is what elan sends


[8/18/2023 1:25 PM] szybet
i would like to know how will this help resolve the issue


[8/18/2023 1:26 PM] kuratius
andi said we should look at how the driver communicates with the touchscreen because there is magic init data being send by the elan driver


[8/18/2023 1:29 PM] szybet
relly? its calibrated like that?


[8/18/2023 1:32 PM] kuratius
I still dont know if the struct actually contained any important data


[8/18/2023 1:40 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-CD56D.txt


[8/18/2023 1:40 PM] kuratius
guessing it's this function?


[8/18/2023 1:40 PM] szybet
yep


[8/18/2023 1:40 PM] szybet
and i dont see here anything important


[8/18/2023 1:41 PM] kuratius
oh hey


[8/18/2023 1:42 PM] kuratius
the ektf driver sends the resolution setting in the wrong order


[8/18/2023 1:42 PM] szybet
https://tenor.com/view/dance-dancing-duck-duck-shuba-duck-hey-ya-gif-22806014

{Embed}
https://tenor.com/view/dance-dancing-duck-duck-shuba-duck-hey-ya-gif-22806014
/mnt/data/projects/git/conversations/media/dance-dancing-duck-E5B16.png


[8/18/2023 1:42 PM] szybet
yea that might be important


[8/18/2023 1:44 PM] kuratius
and it does not send firmware id, firmware ver, and bootcode version commands


[8/18/2023 1:45 PM] szybet
it doesnt ask for them


[8/18/2023 1:49 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-2A8D5.png


[8/18/2023 1:50 PM] szybet
if below 0?...


[8/18/2023 1:50 PM] kuratius
still doesnt explain why the ektf driver has more events or why it doesnt have so much jitter though


[8/18/2023 1:51 PM] andi15701
if below 0, some error code is passed through


[8/18/2023 1:51 PM] kuratius
or the offset stuff


[8/18/2023 1:51 PM] szybet
for more events it could just repeat itself


[8/18/2023 1:51 PM] szybet
idk


[8/18/2023 1:51 PM] szybet
would be interesting seeing the ektf driver being more accurate then the one inkbox uses


[8/18/2023 1:54 PM] kuratius
true is supposed to request width


[8/18/2023 1:54 PM] kuratius
but on the nia it should get height instead


[8/18/2023 1:57 PM] szybet
change it and try


[8/18/2023 2:19 PM] kuratius
wonder if this is important

{Attachments}
/mnt/data/projects/git/conversations/media/image-F9D4F.png


[8/18/2023 2:19 PM] szybet
nope, regular stuff


[8/18/2023 2:23 PM] kuratius
just in case it becomes important

{Attachments}
/mnt/data/projects/git/conversations/media/dmesglog-9DBAF.txt


[8/18/2023 2:25 PM] kuratius
I'm not really sure what a good place to change it would be, I could change the function, swap the function calls, or change the preprocessor directive for the bytes that mean height/width


[8/18/2023 2:25 PM] szybet
idk too, for test swap the function calls


[8/18/2023 2:30 PM] kuratius
it is also reading the data from a different buffer index & swaps  the & 0xf0 and & x0f


[8/18/2023 2:39 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-3AA87.png


[8/18/2023 2:39 PM] kuratius
this has mimum index of 2


[8/18/2023 2:39 PM] kuratius
this reads from index 0

{Attachments}
/mnt/data/projects/git/conversations/media/image-3777D.png


[8/18/2023 2:42 PM] kuratius
the evtest maxima are correct now


[8/18/2023 2:42 PM] kuratius
```
kobo-nia:~$ evtest
No device specified, trying to scan all of /dev/input/event*
Not running as root, no devices may be available.
Available devices:
/dev/input/event0:    ektf2232
Select the device event number [0-0]: 0
Input driver version is 1.0.1
Input device ID: bus 0x18 vendor 0x0 product 0x0 version 0x0
Input device name: "ektf2232"
Supported events:
  Event type 0 (EV_SYN)
  Event type 1 (EV_KEY)
    Event code 330 (BTN_TOUCH)
  Event type 3 (EV_ABS)
    Event code 0 (ABS_X)
      Value      0
      Min        0
      Max     1435
    Event code 1 (ABS_Y)
      Value      0
      Min        0
      Max     1919
    Event code 47 (ABS_MT_SLOT)
      Value      0
      Min        0
      Max        4
    Event code 53 (ABS_MT_POSITION_X)
      Value      0
      Min        0
      Max     1435
    Event code 54 (ABS_MT_POSITION_Y)```
      Value      0
      Min        0
      Max     1919
    Event code 57 (ABS_MT_TRACKING_ID)
      Value      0
      Min        0
      Max    65535
Properties:


[8/18/2023 2:43 PM] kuratius
(i changed the dts stuff back also)


[8/18/2023 2:43 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-B8583.png


[8/18/2023 2:44 PM] kuratius
it still does the weird offset bs


[8/18/2023 2:46 PM] kuratius
wait


[8/18/2023 2:46 PM] kuratius
maybe note


[8/18/2023 2:46 PM] kuratius
*not


[8/18/2023 2:46 PM] kuratius
or maybe less


[8/18/2023 2:46 PM] kuratius
let me boot lightdm


[8/18/2023 2:46 PM] kuratius
if this was the fix I wanna cry


[8/18/2023 2:51 PM] kuratius
ok the offset stuff is still not fixed


[8/18/2023 2:52 PM] kuratius
I could try changing the buffer index being read


[8/18/2023 2:56 PM] kuratius
ok I looked at the caller, it gives a pointer to the middle of the buffer, so this doesnt actually read at index0, it reads at index 1 for the first finger, and at index 4 for the second finger


[8/18/2023 2:57 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-BB600.png


[8/18/2023 2:57 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-D29C1.png


[8/18/2023 2:58 PM] szybet
what the fu is this code


[8/18/2023 2:59 PM] szybet
index of a buffer is what finger touched the screen


[8/18/2023 2:59 PM] kuratius
elan driver


[8/18/2023 2:59 PM] kuratius
*shrugs*


[8/18/2023 2:59 PM] szybet
😵‍💫


[8/18/2023 3:03 PM] kuratius
ektf driver reads at indices 2 and 5


[8/18/2023 3:05 PM] kuratius
I have no idea what data is supposed to be in the buffer


[8/18/2023 3:06 PM] kuratius
like maybe these are fast updating vs slow updating


[8/18/2023 3:06 PM] kuratius
or something else idk


[8/18/2023 3:08 PM] szybet
you would need to reverse engineer both drivers


[8/18/2023 3:16 PM] kuratius
elan driver schedules a bunch of delayed work after a touch event


[8/18/2023 3:21 PM] kuratius
I think the buffer size is 21 for ektf and 20 for elan

{Attachments}
/mnt/data/projects/git/conversations/media/image-2FEC3.png


[8/18/2023 3:21 PM] kuratius
(not in this screenshot, will post in a sec)


[8/18/2023 3:21 PM] kuratius
in this screenshot I'm just wondering where the memory buffer gets allocated


[8/18/2023 3:22 PM] kuratius
I dont think it does, I think they just declare a pointer and then add to it....


[8/18/2023 3:23 PM] kuratius
found it

{Attachments}
/mnt/data/projects/git/conversations/media/image-610D3.png


[8/18/2023 3:25 PM] kuratius
this is why I think the elan uses 20 as its buffer size

{Attachments}
/mnt/data/projects/git/conversations/media/image-15642.png


[8/18/2023 3:25 PM] kuratius
but I probably have to reverse engineer that kmalloc call maybe


[8/18/2023 3:26 PM] kuratius
this is why I think ektf uses 21

{Attachments}
/mnt/data/projects/git/conversations/media/image-65096.png


[8/18/2023 3:29 PM] kuratius
sometimes the ektf driver reads from index 0,1,4

{Attachments}
/mnt/data/projects/git/conversations/media/image-AFD50.png


[8/18/2023 3:30 PM] kuratius
the fuck is ts_shifted_status


[8/18/2023 3:33 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-7EC64.png


[8/18/2023 3:33 PM] kuratius
maybe this should be false?


[8/18/2023 3:33 PM] kuratius
just guessing


[8/18/2023 3:33 PM] kuratius
I may be wrong


[8/18/2023 3:42 PM] kuratius
I'm changing this to index=1+i*3


[8/18/2023 3:42 PM] kuratius
I dont trust this driver


[8/18/2023 3:42 PM] kuratius
will check if it behaves better


[8/18/2023 3:43 PM] kuratius
if that doesnt help I will fiddle with shifted_status


[8/18/2023 3:49 PM] kuratius
the driver still works?


[8/18/2023 3:52 PM] kuratius
doesnt behave better


[8/18/2023 3:52 PM] kuratius
which to me is a sign my change didnt change anything


[8/18/2023 3:52 PM] kuratius
at the very list I should have broken something


[8/18/2023 3:52 PM] kuratius
I will remove the shifted status


[8/18/2023 4:00 PM] kuratius
aha! now I broke something


[8/18/2023 4:00 PM] kuratius
no more evtest


[8/18/2023 4:00 PM] kuratius
going back to previous config


[8/18/2023 4:05 PM] kuratius
maybe I should also print the touch receive events


[8/18/2023 4:06 PM] kuratius
i2c receive I mean


[8/18/2023 4:06 PM] kuratius
or try to force the version request stuff


[8/18/2023 4:53 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-C0BE3.png


[8/18/2023 4:53 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/image-43F9B.png


[8/18/2023 4:53 PM] kuratius
are these equivalent?


[8/18/2023 4:54 PM] kuratius
the gpio stuff


[8/18/2023 5:00 PM] andi15701
rst vs. power, looks equal


[8/18/2023 5:01 PM] kuratius
the 0 is both active high and edge falling?


[8/18/2023 5:02 PM] andi15701
#ifdef _THREADED_IRQ_
                if (55==gptHWCFG->m_val.bPCB) {  //E70Q02
                        err = request_threaded_irq(client->irq, NULL, elan_touch_ts_interrupt, IRQF_TRIGGER_LOW | IRQF_ONESHOT, ELAN_TS_NAME, &elan_touch_data);
                } else 
                {
                        err = request_threaded_irq(client->irq, NULL, elan_touch_ts_interrupt, IRQF_TRIGGER_FALLING | IRQF_ONESHOT, ELAN_TS_NAME, &elan_touch_data);
                }
#else
                err = request_irq(client->irq, elan_touch_ts_interrupt, IRQF_TRIGGER_FALLING,
                                  ELAN_TS_NAME, &elan_touch_data);
#endif


[8/18/2023 5:02 PM] andi15701
interesting thing about interrupts


[8/18/2023 5:02 PM] andi15701
third parameter often got ignored in earlier times, better to check what the driver really does


[8/18/2023 5:03 PM] andi15701
well, reset and power have inverted meaning


[8/18/2023 5:05 PM] andi15701
I introduced that upon information given by the tolino vision4hd porter


[8/18/2023 5:06 PM] kuratius
what does it do?


[8/18/2023 5:07 PM] andi15701
according him, the bits for the active fingers are shifted by 1 to right on the ektf2232 compared to ektf2132


[8/18/2023 5:10 PM] kuratius
I am a bit confused as to what to do next
Try tweaking stuff until I get a result
Try listening to raw packets being read
implement a sleep like elan driver has


[8/18/2023 5:11 PM] kuratius
these are my ideas for now


[8/18/2023 6:52 PM] kuratius
Did you run into anything like this on the clara?


[8/18/2023 6:57 PM] andi15701
no


[8/18/2023 6:57 PM] andi15701
not seen on the shine2hd, the shine3


[8/18/2023 6:57 PM] andi15701
did not look that deeply into vision 5 yet


[8/18/2023 6:57 PM] andi15701
cyttsp driver in kernel behaves


[8/18/2023 6:58 PM] andi15701
zforce_ts : there I need to add rotation


[8/18/2023 7:06 PM] kuratius
The first principles solution is probably to collect i2c_master_recv packets on both, try to parse them and figure out from there if there is still a difference.
If there is not, then probably see if ektf driver can be made to emulate the elan behavior in some way, or if the problems can be mitigated by implementing an averaging function or a fuzz value.


[8/18/2023 7:07 PM] kuratius
if there were still a difference it'd be a sign init is wrong, or that something is interfering with the driver


[8/18/2023 7:10 PM] kuratius
where do dev_debug messages get printed?


[8/18/2023 7:11 PM] andi15701
if DEBUG is defined


[8/18/2023 7:12 PM] andi15701
they will be printed


[8/18/2023 7:26 PM] kuratius
is there an easy way to write to a log file or should I just put everything in dmesg?


[8/18/2023 7:29 PM] kuratius
I'll add a print function for the received bytes as well, maybe it's not completely unintelligible


[8/18/2023 7:31 PM] andi15701
well, you can use syslog to filter things out


[8/18/2023 7:32 PM] andi15701
but dmesg will just do the job


[8/18/2023 7:32 PM] kuratius
then I'll do that and write a parser for it later


[8/18/2023 7:32 PM] kuratius
is all the communication via i2c?


[8/18/2023 7:33 PM] andi15701
yes


[8/18/2023 7:34 PM] kuratius
this function is never called, at least the print statement isnt anywhere in my dmesg

{Attachments}
/mnt/data/projects/git/conversations/media/image-761F8.png


[8/18/2023 7:34 PM] kuratius
so I can ignore that for now


[8/18/2023 7:36 PM] kuratius
also the packet size on elan is 8 I think


[8/18/2023 7:36 PM] kuratius
doesnt fit into 21


[8/18/2023 7:37 PM] kuratius
so maybe buffer on ektf is supposed to be 24 or something


[8/18/2023 7:44 PM] szybet
```
[38883.940511] dpm_run_callback(): elan_touch_suspend+0x0/0x114 returns 1610612755
```
after reboot its fine - touchscreen stopped working on my nia first time in 2 years


[8/18/2023 7:44 PM] szybet
¯\_(ツ)_/¯


[8/18/2023 8:03 PM] kuratius
I think I managed to crash the driver by adding send statements


[8/18/2023 8:04 PM] kuratius
do I need a recv after every send?


[8/18/2023 8:04 PM] kuratius
mayve


[8/18/2023 8:04 PM] kuratius
*maybe


[8/18/2023 8:04 PM] kuratius
will add one


[8/18/2023 8:12 PM] kuratius
```[   13.544409] Begin i2c message:{ 
[   13.544433] 53, 
[   13.544447] 00, 
[   13.544453] 00, 
[   13.544457] 01, 
[   13.544461] }
[   13.546366] Begin i2c message:{ 
[   13.546391] 53, 
[   13.546403] f0, 
[   13.546409] 00, 
[   13.546413] 01, 
[   13.546418] }
[   13.558444] mc: Linux media interface: v0.10
[   13.637033] videodev: Linux video capture interface: v2.00
[   13.679426] rc5t619-rtc rc5t619-rtc: registered as rtc0
[   13.694000] rc5t619-rtc rc5t619-rtc: setting system clock to 2023-08-18T17:56:18 UTC (1692381378)
[   13.815259] pxp 21cc000.pxp: Device registered as /dev/video0
[   14.168700] Begin i2c message:{ 
[   14.168725] 53, 
[   14.168739] 01, 
[   14.168744] 00, 
[   14.168748] 01, 
[   14.168752] }
[   14.176984] Begin i2c message:{ 
[   14.177008] 53, 
[   14.177022] 60, 
[   14.177027] 00, 
[   14.177031] 00, 
[   14.177036] }
[   14.177921] lm3630a_bl 0-0036: LM3630A backlight register OK.
[   14.798534] elan_ektf2127 0-0015: Failed to request height: -110
[   14.798641] elan_ektf2127: probe of 0-0015 failed with error -110```


[8/18/2023 8:12 PM] kuratius
for reference this is what happened


[8/18/2023 8:13 PM] kuratius
```[   13.451979] Begin i2c message:{ 
[   13.452004] 53, 
[   13.452018] 00, 
[   13.452023] 00, 
[   13.452027] 01, 
[   13.452032] }
[   13.454556] sy7636_detect():opmode=0x0
[   13.454589] sy7636_detect success
[   13.455046] sy7636 0-0062: PMIC SY7636 for eInk display
[   13.455071] sy7636_probe success
[   13.456209] Begin i2c message:{ 
[   13.456231] 53, 
[   13.456242] f0, 
[   13.456247] 00, 
[   13.456251] 01, 
[   13.456256] }
[   13.458507] Begin i2c message:{ 
[   13.458531] 53, 
[   13.458545] 01, 
[   13.458607] 00, 
[   13.458614] 01, 
[   13.458619] }
[   13.460458] Begin i2c message:{ 
[   13.460482] 53, 
[   13.460497] 60, 
[   13.460502] 00, 
[   13.460507] 00, 
[   13.460512] }
[   13.471154] mc: Linux media interface: v0.10
[   13.499623] Begin i2c message:{ 
[   13.499649] 53, 
[   13.499664] 63, 
[   13.499668] 00, 
[   13.499674] 00, 
[   13.499678] }
[   13.555555] input: ektf2232 as /devices/platform/soc/2100000.bus/21a0000.i2c/i2c-0/0-0015/input/input0
``` now it works


[8/18/2023 8:30 PM] kuratius
aaaand I put my function in the wrong place


[8/18/2023 8:30 PM] kuratius
need to reorder it a bit


[8/18/2023 8:38 PM] kuratius
oh and without evtest running, the touch screen driver isnt either if lightdm isnt there, good to know


[8/18/2023 9:09 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-B7B70.txt


[8/18/2023 9:09 PM] kuratius
I modified ektf so that it also send the version stuff


[8/18/2023 9:09 PM] kuratius
even if it's useless


[8/18/2023 9:24 PM] kuratius
next is parsing raw coordinates from this, and once that is done I need to add this modification to inkbox if I'm still unclear on what's happening


[8/18/2023 10:11 PM] kuratius
Btw @Szybet, can you show what drawing in paint in inkBox looks like? You said it has accuracy issues too right?


[8/18/2023 10:11 PM] szybet
just like every touchscreen


[8/18/2023 10:12 PM] szybet
capacitive


[8/18/2023 10:12 PM] kuratius
What I want to know is if it's jittering


[8/18/2023 10:19 PM] szybet
maybe tommorow i will record it


[8/18/2023 10:19 PM] szybet
you can search through discord, there are some videos


[8/18/2023 10:21 PM] kuratius
Any hint on what to search?


[8/18/2023 10:22 PM] szybet
actually nothing i spam too much gifs here to find it


[8/19/2023 9:17 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-014B3.txt


[8/19/2023 9:22 AM] kuratius
this is me trying top left then bottom left and parsing the raw packets


[8/19/2023 9:23 AM] kuratius
bottom left is showing a weird offset too, will probably have to retest this


[8/19/2023 9:24 AM] kuratius
this part is still basically magic to me
I dont get why they use bitwise or

{Attachments}
/mnt/data/projects/git/conversations/media/image-A5BD6.png


[8/19/2023 9:25 AM] kuratius
I guess they're combining bytes?


[8/19/2023 9:26 AM] kuratius
so wer have 12 bits for the coordinates


[8/19/2023 9:37 AM] kuratius
another thing that confuses be is that there are sometimes crazy packets


[8/19/2023 9:37 AM] kuratius
packet: 
finger: 1
1365 1365 ;
finger: 4
4095 4095 ;

like wtf is this


[8/19/2023 9:43 AM] kuratius
also I guess the jitter is up to 40-60 units


[8/19/2023 9:44 AM] kuratius
maybe 80


[8/19/2023 9:44 AM] kuratius
I am still confused, so I guess I need to listen to inkbox


[8/19/2023 9:45 AM] szybet
What about porting inkbox driver to mainline?...


[8/19/2023 9:46 AM] kuratius
maybe the issue isnt the driver and it's some BS about how the i2c communications are read, idk

I think porting the elan driver to mainline is possible, but andi said it's too dirty to upstream it


[8/19/2023 9:47 AM] szybet
Well depends how much time do you have


[8/19/2023 9:48 AM] szybet
To do it


[8/19/2023 9:48 AM] szybet
If limited, go with porting it


[8/19/2023 9:48 AM] szybet
Upstreaming it, welp


[8/19/2023 9:54 AM] kuratius
also the events reported are a different type


[8/19/2023 9:54 AM] kuratius
elan driver reports touch size


[8/19/2023 9:54 AM] kuratius
ektf does not


[8/19/2023 9:55 AM] kuratius
major/minor is touch size


[8/19/2023 9:57 AM] kuratius
the other thing is, if there is a bug in the ektf driver, maybe that bug affects other devices as well


[8/19/2023 9:58 AM] kuratius
for now I'll just parse the packets and see what I get


[8/19/2023 10:42 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/dmesg2-3E746.txt


[8/19/2023 10:56 AM] kuratius
```recv { 55 55 55 55 ff ff ff ff }
send { 53 00 00 01 }
recv { 52 01 2c 31 }
send { 53 f0 00 01 }
recv { 52 f1 b5 01 }
send { 53 01 00 01 }
recv { 52 05 56 81 }
send { 53 60 00 00 }
recv { 52 60 9c 51 }
send { 53 63 00 00 }
recv { 52 63 80 71 }
recv { 5a 14 db 91 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 30 15 66 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 41 c6 64 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 01 bf 86 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 42 40 9f 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 42 87 a7 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 42 72 97 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 42 93 ad 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 42 9c a1 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 42 8a 95 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 42 84 98 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 42 bd ad 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 42 a8 9c 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 42 92 a1 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 43 1b 31 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 43 24 32 00 00 00 01 }
recv { 5a 43 1a 37 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 43 1f 5e 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 43 24 3a 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 43 31 31 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 26 b9 51 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 50 4c 48 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 50 6b 3c 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 00 31 3e 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
recv { 5a 00 00 43 00 00 00 01 }
recv { 5a 00 00 00 00 00 00 00 }
```


[8/19/2023 11:02 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-7B452.txt


[8/19/2023 11:02 AM] kuratius
looks a bit weird, but at least bottom left corner doesnt give a weird offset


[8/19/2023 11:04 AM] kuratius
Will redo it again with better labeling
but I think that it either asks for events too fast, or it does the i2c communication wrong


[8/19/2023 11:05 AM] kuratius
```for packet in packetlist:
    if len(packet)>4:
        print("packet: ")
        for fingerindex in [1,4]:
            print("finger:", fingerindex)
            fingerdata=packet[fingerindex:fingerindex+3]
            for i in range(len(fingerdata)):
                byte=int(fingerdata[i], 16)
                fingerdata[i]=byte
            x=((fingerdata[0] & 0xf0)<<4) | fingerdata[1]
            y=((fingerdata[0] & 0x0f)<<8) | fingerdata[2]
            print(x,y, ";")
            
        #print()
            #buf.append()
    #print(buf)
```


[8/19/2023 11:10 AM] kuratius
also now I realize why there's weird values in the middle of the screen


[8/19/2023 11:11 AM] kuratius
I was using inkbox ui


[8/19/2023 11:11 AM] kuratius
lol


[8/19/2023 11:11 AM] kuratius
anyway this doesnt have weird offsets in the corners


[8/19/2023 11:11 AM] kuratius
so I think it's how often it receives i2c messages, or how it translates them to bytes


[8/19/2023 11:12 AM] kuratius
so there may not be a bug in the driver, it's just that the driver is getting bad data


[8/19/2023 11:14 AM] kuratius
also: does the driver need to schedule reads in some way to prevent interference?


[8/19/2023 11:14 AM] kuratius
like doing wifi comms and reads separated by x milliseconds


[8/19/2023 11:17 AM] kuratius
also in case it matters, here are the print functions

{Attachments}
/mnt/data/projects/git/conversations/media/image-5C1B4.png


[8/19/2023 11:25 AM] kuratius
I'll go and eat breakfast, maybe I'm missing something, but this is what I think right now


[8/19/2023 11:31 AM] kuratius
maybe I'll also take another look at the client struct


[8/19/2023 11:35 AM] kuratius
any chance this is noise from screen refreshes?


[8/19/2023 11:37 AM] kuratius
maybe it's not safe to touchscreen reads within x milliseconds of a screen refresh


[8/19/2023 11:38 AM] andi15701
maybe, maybe not, so just ensure that there is no screen refresh


[8/19/2023 11:38 AM] andi15701
configuation of the irq line might also be an issue


[8/19/2023 11:39 AM] andi15701
and don't forget /sys/class/graphics/fbcon/cursor_blink


[8/19/2023 11:41 AM] kuratius
how?


[8/19/2023 11:41 AM] kuratius
where do I change that?


[8/19/2023 11:43 AM] kuratius
does that contain a value I change?


[8/19/2023 11:44 AM] andi15701
yes


[8/19/2023 11:44 AM] andi15701
it turns of cursor blinking


[8/19/2023 11:44 AM] andi15701
when in console mode


[8/19/2023 11:45 AM] andi15701
so you can turn off graphics and try from console


[8/19/2023 12:21 PM] kuratius
offset is gone


[8/19/2023 12:21 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-C0A0C.txt


[8/19/2023 12:22 PM] kuratius
will turn it back on


[8/19/2023 12:22 PM] kuratius
also it doesnt constantly spam touch events anymore


[8/19/2023 12:24 PM] kuratius
turned the blinking back on, it spams touch events again

{Attachments}
/mnt/data/projects/git/conversations/media/message-AF7BF.txt


[8/19/2023 12:24 PM] kuratius
and it has jitter and sometimes an offset


[8/19/2023 12:25 PM] kuratius
Event: time 1692440602.521795, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 85
Event: time 1692440602.521795, type 3 (EV_ABS), code 54 (ABS_MT_POSITION_Y), value 175


[8/19/2023 12:26 PM] kuratius
Event: time 1692440749.063607, type 3 (EV_ABS), code 53 (ABS_MT_POSITION_X), value 68
Event: time 1692440749.063607, type 3 (EV_ABS), code 54 (ABS_MT_POSITION_Y), value 112


[8/19/2023 12:26 PM] kuratius
wait


[8/19/2023 12:27 PM] kuratius
I think the blinking broke


[8/19/2023 12:27 PM] kuratius
it's set to 1 but I cant see it blink


[8/19/2023 12:27 PM] kuratius
lol


[8/19/2023 12:28 PM] kuratius
will reboot


[8/19/2023 12:30 PM] kuratius
after reboot it blinked despite blink being set to 0?


[8/19/2023 12:31 PM] kuratius
ok without blinking there is no jitter


[8/19/2023 12:32 PM] kuratius
not 100 % sure about the offset


[8/19/2023 12:32 PM] kuratius
ok yeah with blinking evtest gets spammed


[8/19/2023 12:33 PM] kuratius
and I think there is +70 extra pixels offset on the vertical axis


[8/19/2023 12:33 PM] kuratius
also note to self, dont try to edit this config file with vim, use sudo sh and then echo


[8/19/2023 12:34 PM] kuratius
what do I do now?


[8/19/2023 12:37 PM] kuratius
also I still dont get what is causing the cursor to turn off after a while


[8/19/2023 12:38 PM] kuratius
I'll take a photo to show what I mean


[8/19/2023 12:39 PM] kuratius
well, video


[8/19/2023 12:45 PM] kuratius
cant replicate it


[8/19/2023 12:45 PM] kuratius
maybe screen goes to sleep or something idk


[8/19/2023 12:46 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-5EF3D.txt


[8/19/2023 12:46 PM] kuratius
full log


[8/19/2023 12:46 PM] kuratius
I think this is the cause


[8/19/2023 12:46 PM] kuratius
screen refreshes and touch events cant happen at the same time


[8/19/2023 12:46 PM] kuratius
@Szybet We found the cause


[8/19/2023 12:48 PM] szybet
You know this has nothing to do with it


[8/19/2023 12:48 PM] kuratius
it makes sense because eink is driven with high voltage


[8/19/2023 12:48 PM] kuratius
uuuh what?


[8/19/2023 12:48 PM] kuratius
maybe you misread the context


[8/19/2023 12:49 PM] szybet
I2C communication needs many settings to get it right


[8/19/2023 12:49 PM] szybet
What


[8/19/2023 12:50 PM] szybet
What


[8/19/2023 12:50 PM] szybet
Thats stupid?


[8/19/2023 12:50 PM] szybet
Hey, maybe its just your device?


[8/19/2023 12:50 PM] andi15701
I guess that is the delay in the elan_touch driver for


[8/19/2023 12:50 PM] andi15701
probably some workaround for some missing capacitor


[8/19/2023 12:50 PM] szybet
What about paint apps, they shouldnt work then?


[8/19/2023 12:51 PM] kuratius
you can do reads, but they will have awful accuracy, or you can do refresh, wait a few ms, do read, do refresh, wait a few ms


[8/19/2023 12:51 PM] szybet
Ugh stupid?


[8/19/2023 12:53 PM] andi15701
there are sometimes strange interactions: the 63th harmonics of one commonly used clock frequency of sd cards interferes with gps reception


[8/19/2023 12:53 PM] andi15701
happend with the Neo Freeruner


[8/19/2023 12:54 PM] szybet
Dear god


[8/19/2023 12:55 PM] andi15701
so you have two solutions, filter the clock by adding a few pF capacitor to it or turn off the clocks as often as possible


[8/19/2023 12:55 PM] andi15701
and of course that problem does not appear in the hardware lab


[8/19/2023 12:56 PM] szybet
Why


[8/19/2023 12:56 PM] andi15701
well, you do not expect good gps reception there


[8/19/2023 12:57 PM] andi15701
probably same for the touchscren, you test the touchscreen and you test the display separately


[8/19/2023 12:57 PM] szybet
Um no...


[8/19/2023 12:57 PM] szybet
Imagine test drones inside a room


[8/19/2023 12:59 PM] andi15701
I do not say that every kind of these problem happen everytime, but there is always a risk


[8/19/2023 12:59 PM] andi15701
for a drone probably having working gps position is probably soo important


[8/19/2023 1:00 PM] kuratius
may be a reason to use resistive touch or ir touch on eink


[8/19/2023 1:00 PM] kuratius
instead of capacitive


[8/19/2023 1:00 PM] andi15701
so important that people are alert and take care of testing more


[8/19/2023 1:04 PM] andi15701
with GPS: I had one interesting story: chip with antenne inside box of device: it did not work, almost no reception at all, same chip but using the usb interface works


[8/19/2023 1:04 PM] andi15701
ok, so I thought what are the differences: we have serial vs. usb and we have short cable vs. long cable


[8/19/2023 1:05 PM] andi15701
so to sort out things, I used a long cable also for the serial connection


[8/19/2023 1:05 PM] andi15701
after a hard time convincing people that I should try it out


[8/19/2023 1:05 PM] andi15701
and it suddenly worked


[8/19/2023 1:06 PM] kuratius
```

[   14.258007] sy7636_sensor_probe success
[   14.270160] sy7636-pmic sy7636-pmic: num_regulators 4
[   14.270310] sy7636-pmic sy7636-pmic: on_delay1=0x2
[   14.270322] sy7636-pmic sy7636-pmic: on_delay2=0x2
[   14.270333] sy7636-pmic sy7636-pmic: on_delay3=0x2
[   14.270342] sy7636-pmic sy7636-pmic: on_delay4=0x2
[   14.270353] sy7636-pmic sy7636-pmic: failed to get VLDO property,default will be 0x2
[   14.270363] sy7636-pmic sy7636-pmic: turnoff_delay_ep3v3=100
[   14.270410] sy7636-pmic sy7636-pmic: request vcom gpio failed (-16)!
[   14.270436] sy7636-pmic sy7636-pmic: request powerup gpio failed (-16)!
[   14.270477] sy7636_regulator_probe(947): SY7636@48c11bc5
[   14.270492] sy7636_regulator_probe():initial vcom=2500000uV
                
[   14.281314] _sy7636_vcom_get_voltage() : vcom=2620000uV
[   14.281356] VCOM: Bringing 2620000uV into 2750000-2750000uV
[   14.282860] _sy7636_vcom_get_voltage() : vcom=2620000uV
[   14.284382] _sy7636_vcom_get_voltage() : vcom=2620000uV
[   14.289468] _sy7636_vcom_get_voltage() : vcom=2750000uV
[   14.291115] _sy7636_vcom_get_voltage() : vcom=2750000uV
[   14.292463] sy7636_get_temperature():temperature = 0,reg=0x0
[   14.353648] mxc_epdc 228c000.epdc: EPDC pix format: 400
[   14.357556] [drm] Initialized mxc_epdc 1.0.0 20201007 for 228c000.epdc on minor 0
[   14.393323] mxc_epdc 228c000.epdc: Mode: 1024 x 758
[   14.399216] mxc_epdc 228c000.epdc: Unable to get an accurate EPDC pix clkdesired = 80000000, actual = 72605042
[   15.464806] Console: switching to colour frame buffer device 128x47
[   16.096372] mxc_epdc 228c000.epdc: [drm] fb0: mxc_epdcdrmfb frame buffer device
[   16.445857] mxc_epdc 228c000.epdc: TCE underrun! Will continue to update panel
[   16.456189] EXT4-fs (mmcblk0p2): re-mounted 75520dc3-2e9d-48e0-b687-38e05def9012. Quota mode: none.
[   16.477884] mxc_epdc 228c000.epdc: TCE underrun! Will continue to update panel
```
are these errors maybe related to the screen not starting back up again?


[8/19/2023 1:07 PM] kuratius
Who convinced who?


[8/19/2023 1:08 PM] andi15701
I convinced the others that I should try it


[8/19/2023 1:08 PM] andi15701
was not in my spare time


[8/19/2023 1:08 PM] kuratius
aah


[8/19/2023 1:09 PM] andi15701
but the worst thing you can do is not to document those odd things


[8/19/2023 1:09 PM] kuratius
so where do we put this info?


[8/19/2023 1:09 PM] kuratius
the touchscreen stuff


[8/19/2023 1:10 PM] kuratius
comment in the driver?


[8/19/2023 1:10 PM] kuratius
wiki?


[8/19/2023 1:11 PM] andi15701
well, if we do some workaround in the driver, just there


[8/19/2023 1:11 PM] andi15701
until then: in the pmOS device wiki page


[8/19/2023 1:14 PM] kuratius
is the screen turning off after being idle for a few min in console mode intended?


[8/19/2023 2:54 PM] szybet
When you finish, could you compare the accuracy between the 2 drivers?


[8/19/2023 2:54 PM] kuratius
all they do is parse i2c packets


[8/19/2023 2:54 PM] kuratius
the driver doesnt directly affect accuracy


[8/19/2023 2:55 PM] kuratius
I think the ektf driver is better for not dropping touch events


[8/19/2023 2:55 PM] kuratius
@NiLuJe You said elan driver drops touches sometimes right?


[8/19/2023 2:55 PM] kuratius
I think it does that on purpose


[8/19/2023 2:56 PM] kuratius
I think it may be possible to add a modification that makes reads while the screen is refreshing less bad, maybe


[8/19/2023 2:58 PM] kuratius
like using averaging+rescaling to get touches to work somewhat ok
or to add features that use averaging to guess the contact size, depending on the raw data


[8/19/2023 3:01 PM] szybet
Just compare them for the sake of motivating me to port the kernel to inkbox


[8/19/2023 3:01 PM] szybet
You could also compare power consumption of you can


[8/19/2023 3:01 PM] szybet
That would be interesting


[8/19/2023 3:02 PM] kuratius
once we have settled on a solution I'll do it


[8/19/2023 3:02 PM] kuratius
wont be hard


[8/19/2023 7:38 PM] ninuje
`static uint16_t last_x, last_y, last_x2, last_y2;` <- go read what `static` means in that context 😉


[8/19/2023 7:39 PM] ninuje
Likely CLOCK_MONOTONIC


[8/19/2023 7:39 PM] ninuje
(which is good)


[8/19/2023 7:42 PM] kuratius
>A local static variable is a variable, whose lifetime doesn't stop with a function call where it is declared

I see, ty.


[8/19/2023 7:43 PM] kuratius
Have you seen that problem with the screen refreshes fucking up touch input happen on other devices btw?


[8/19/2023 7:43 PM] kuratius
is that supposed to be in seconds?


[8/19/2023 7:48 PM] kuratius
I will assume this also means that it does get initialized to 0 like a global variable, otherwise the problem still occurs at program start at the very least.
Makes me wonder if these are actually more like global variables that live in the bss segment.


[8/19/2023 7:51 PM] ninuje
Yup


[8/19/2023 7:52 PM] ninuje
`man clock_gettime`


[8/19/2023 7:52 PM] ninuje
And in case that's not documented quite so explicitly, there's another Linux twist compared to other unixes: it doesn't tick during suspend/standby


[8/19/2023 7:53 PM] ninuje
(monotonic, I mean)


[8/19/2023 7:58 PM] kuratius
What about this question?


[8/19/2023 8:00 PM] kuratius
@NiLuJe


[8/19/2023 8:08 PM] kuratius
(also note to self: when I test touch accuracy on inkbox vs pmOS again, make sure to play an animation on inkbox)


[8/19/2023 8:08 PM] szybet
animation?...


[8/19/2023 8:09 PM] kuratius
forcing constant screen refreshes to check if the screen driver on pmOS is maybe the issue


[8/19/2023 8:09 PM] szybet
🫡


[8/19/2023 8:10 PM] kuratius
I think it probably isnt, but it should probably be tested to make sure


[8/19/2023 8:10 PM] kuratius
like maybe there's a touch-safe refresh mode


[8/19/2023 10:24 PM] andi15701
well, you might also be able to use some newer usb devices


[8/19/2023 10:25 PM] szybet
i had problems with a wireless mouse indeed


[8/19/2023 10:33 PM] andi15701
Today I was heavily fighting again with hacking the Moverio BT-200. That is totally another league than the kobos. Even questions for accessing fastboot were left unresponded for years until I have picked up that device. I needed to write drivers for the LED, some clocks, fix stuff in driver for USB, for measuring any voltages, fixing audio driver cpu side and codec side, bluetooth firmware needed to be hacked, but contrary to the vendor kernel  BLE is usable. So the vendor kernel did not even fully support the hardware. HW had BLE support but vendor kernel not. So there is some reward for going through that massive solid rock.


[8/19/2023 10:34 PM] andi15701
I think the next important step is to consolidate things


[8/19/2023 10:36 PM] andi15701
clean up the parts of the devicetree which work with clean mainline on both rev a and c and submit them. Rebase the other stuff on top of that and produce a merge request for pmOS.


[8/19/2023 10:44 PM] kuratius
So revert kernel repo to recent commit and figure out the screen bug?


[8/19/2023 10:44 PM] kuratius
Or have you found that already?


[8/19/2023 10:50 PM] szybet
700 Eur, ouchy


[8/19/2023 10:51 PM] ninuje
Doubtful, because my experience of them has predominantly been on devices with pen input


[8/19/2023 10:51 PM] ninuje
And pen input == lots of input events right in the middle of lots of screen refreshes


[8/19/2023 10:52 PM] kuratius
Are the pens capacitive touch based?


[8/19/2023 10:53 PM] ninuje
I would assume, yeah


[8/19/2023 10:54 PM] ninuje
On sunxi SoCs, though, not nxp


[8/19/2023 10:54 PM] ninuje
Might be yet another driver 😉


[8/19/2023 10:55 PM] ninuje
And might be yet another variant for the MTK kernels, because the Elipsa 2E is also using one


[8/19/2023 11:12 PM] kuratius
I think if that were the case they would be identical in performance to capacitive passive styluses, so it's probably more complicated than that


[8/19/2023 11:12 PM] kuratius
Can they sense hover?


[8/19/2023 11:13 PM] szybet
as for my knowledge, as for some wacom screens ( included in lcd's ) they use another layer of something


[8/19/2023 11:13 PM] szybet
¯\_(ツ)_/¯


[8/19/2023 11:13 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/Screenshot_20230819-231332_Chrome-EAD41.png


[8/19/2023 11:13 PM] szybet
ye


[8/19/2023 11:14 PM] kuratius
This is the pen stuff in the elipsa I think


[8/19/2023 11:14 PM] kuratius
The "good" wacom stuff is emr, but as niluje said that isn't  used in the kobos


[8/19/2023 11:16 PM] kuratius
So basically I think that aes is probably less sensitive to interference than capacitive touch, or the nia has a hardware design flaw that was  never fixed


[8/19/2023 11:16 PM] kuratius
They could both be true


[8/19/2023 11:21 PM] szybet
https://tenor.com/view/the-road-to-el-dorado-both-both-is-good-gif-8304204

{Embed}
https://tenor.com/view/the-road-to-el-dorado-both-both-is-good-gif-8304204
/mnt/data/projects/git/conversations/media/the-road-to-el-dorado-both-99DF1.png


[8/19/2023 11:24 PM] ninuje
Yes


[8/19/2023 11:24 PM] ninuje
Not EMR pens, though


[8/19/2023 11:25 PM] kuratius
Then probably not the same as capacitive touch


[8/19/2023 11:25 PM] ninuje
yeah, I forgot if there's a battery in it


[8/19/2023 11:25 PM] kuratius
There probably is


[8/19/2023 11:25 PM] ninuje
Err, yes, there is


[8/19/2023 11:26 PM] ninuje
That had completely slipped my mind, yeah


[8/19/2023 11:26 PM] ninuje
So, not EMR, not capacitive, but active something


[8/19/2023 11:27 PM] kuratius
So it's possible other devices have this problem,  just that nobody has checked


[8/19/2023 11:28 PM] szybet
@Kuratius for the sake of curiosity you could compare if they changed anything in the c model driver for elan


[8/19/2023 11:28 PM] ninuje
They weren't using Elan panels before


[8/19/2023 11:28 PM] ninuje
Parade or Goodix


[8/19/2023 11:28 PM] ninuje
were the norm


[8/19/2023 11:29 PM] ninuje
Elipsa, Sage, Elipsa 2E (all w/ pen support) use one


[8/19/2023 11:29 PM] ninuje
The Clara 2E doesn't


[8/19/2023 11:29 PM] ninuje
No idea about the Libra 2


[8/19/2023 11:29 PM] ninuje
And the Nia was a weird frankenstein monster that should never have seen the light of day


[8/19/2023 11:29 PM] ninuje
It makes zero sense in Kobo's lineup


[8/19/2023 11:30 PM] ninuje
Which probably explains why they sold like, three of 'em


[8/19/2023 11:30 PM] szybet
elan doesn't have pen support built in right?


[8/19/2023 11:30 PM] szybet
its cheap


[8/19/2023 11:30 PM] szybet
the nia is the most popular inkbox device ;)


[8/19/2023 11:31 PM] ninuje
```
 126   │ #define HID_I2C_FINGER_HEADER       0x3F
 127   │ #define HID_I2C_FINGER_HEADER_V2    0x12
 128   │ //#define HID_I2C_PEN_HEADER        0x13  //0x22
 129   │ #define HID_I2C_PEN_HEADER_0D       0x0D  //0x22
 130   │ #define HID_I2C_PEN_HEADER_13       0x13  //0x22
 131   │ #define HEADER_REPORT_10_FINGER 0x62
 132   │ #define RSP_LEN               2
```


[8/19/2023 11:31 PM] ninuje
Looks pretty built-in to me ;p


[8/19/2023 11:31 PM] ninuje
It's barely any cheaper than the Clara 2E, and it is infinitely worse


[8/19/2023 11:32 PM] szybet
it propably needs bluetooth? the pen?


[8/19/2023 11:32 PM] ninuje
Nope


[8/19/2023 11:32 PM] szybet
the clara 2E didnt exist at the time


[8/19/2023 11:32 PM] ninuje
The Clara HD did


[8/19/2023 11:32 PM] szybet
well it was old


[8/19/2023 11:32 PM] szybet
whatever


[8/19/2023 11:32 PM] ninuje
But, true, timing probably plaid a part on the device's inception, I agree on that


[8/19/2023 11:32 PM] szybet
so i could modify the kernel, buy such a pen and use it?


[8/19/2023 11:33 PM] kuratius
No the digitizer layer is missing


[8/19/2023 11:33 PM] ninuje
Oh, on a Nia? No idea, it probably requires a grid in the lamination sandwich


[8/19/2023 11:33 PM] szybet
thats what im thinking too


[8/19/2023 11:34 PM] ninuje
You can *probably* see it under a microscope, but then, I wouldn't know how to tell it apart from the standard capacitive grid


[8/19/2023 11:34 PM] szybet
nia is a frankenstein because kobo propably didn't get the bluetooth chip for it at the time - there is a place for it, drivers are enabled so


[8/19/2023 11:34 PM] szybet
i only can see eink capsules

well i dont have an electron microscope tho


[8/19/2023 11:34 PM] ninuje
lord knows I get shocked often enough on capacitive grids ;p


[8/19/2023 11:35 PM] kuratius
Inb4 someone solders a bluetooth chip to the nia


[8/19/2023 11:35 PM] kuratius
I have seen people replacd the soldered ram with 32 GB and the wifi chip on a steam deck  lol


[8/19/2023 11:35 PM] szybet
if i knew which one is it and someone paid me to do it then why not


[8/19/2023 11:36 PM] szybet
the antena is missing tho


[8/19/2023 11:36 PM] szybet
you would need a small external one


[8/19/2023 11:36 PM] kuratius
Small internal antenna isnt on the chip?


[8/19/2023 11:37 PM] szybet
its only a connector


[8/19/2023 11:38 PM] szybet
dear god no one does that


[8/19/2023 11:38 PM] szybet
look up esp32 for example


[8/19/2023 11:40 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/ID_207754_orig-41038.jpg


[8/19/2023 11:41 PM] kuratius
Bottom zig zag?


[8/19/2023 11:58 PM] szybet
yep


[8/19/2023 11:58 PM] szybet
the antena


[8/20/2023 12:00 AM] kuratius
Pico 's antenna doesn't even look like an antenna

{Attachments}
/mnt/data/projects/git/conversations/media/hero-mobile-226918a036a9f3717d04170387cd43-8F08F.png


[8/20/2023 12:01 AM] szybet
its there just hidden in the pcb


[8/20/2023 6:17 AM] andi15701
Not the driver, but I wonder but maybe a capacitor was added at an important place


[8/20/2023 6:39 AM] andi15701
there are bluetooth chips with internal antenna, look e.g. at the bgm13s22f512


[8/20/2023 11:35 AM] szybet
then they would remove the delay


[8/20/2023 11:36 AM] szybet
welp okay


[8/22/2023 4:42 PM] kuratius
These are on pmOS, tapping finger on the same position, taken from the log I posted befoore
I had to lift my finger a few times so the orange blob is not supposed to be this big, but you can already see that the areas don't overlap so averaging alone cannot fix the the screen refresh inaccuracy

If you do a test like like this for every point you can probably come up with a very scuffed correction scheme.
I should probably read up on how a capacitive touch sensor works in more detail.

https://www.infineon.com/dgdl/Infineon-Industrial_Capacitive_Touchscreen_Design_Made_Simpler-Whitepaper-v01_00-EN.pdf?fileId=8ac78c8c85ecb34701862ada8e16683b

this seems interesting
https://www.dush.co.jp/english/method-type/capacitive-touchscreen/

{Attachments}
/mnt/data/projects/git/conversations/media/jHP2SXRkTNiIdpiKhV2rNnD9asWYPNmzfDx8cH7dq1-21DC7.png

{Embed}
https://www.dush.co.jp/english/method-type/capacitive-touchscreen/
How Capacitive Touchscreen Work
DMC's Capacitive Touchscreen Structure page. This page introduces the types of capacitive touchscreens, their operating principles and types.


[8/23/2023 7:41 AM] andi15701
so, which kernel had display not working and which one are you using now?


[8/23/2023 9:42 AM] kuratius
git checkout 9120a7618bebd49dcd0068cc957d6ce22d0ce7bc

is working


[8/23/2023 9:42 AM] kuratius
Newest kernel was not


[8/23/2023 9:43 AM] kuratius
Have not tested in between


[8/23/2023 10:01 AM] andi15701
so cfae077d2444406f307c57585edb58b33709ab12 was without working display?


[8/23/2023 10:03 AM] kuratius
Yep


[8/24/2023 11:40 AM] andi15701
just to check if it does not have anything to do with build options or procedures:


[8/24/2023 11:40 AM] andi15701
can you just copy over the dtb from the kernel without working display


[8/24/2023 11:40 AM] andi15701
creating dtb is just make dtbs


[8/24/2023 11:40 AM] andi15701
check creation ledata of the fi


[8/24/2023 12:54 PM] kuratius
```[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ make dtbs
*** pmbootstrap envkernel.sh active for /home/dk/nia/linux! ***
make: Entering directory '/mnt/linux'
  DTC     arch/arm/boot/dts/imx6ull-kobo-nia.dtb
  DTC     arch/arm/boot/dts/imx6ull-kobo-nia-c.dtb
make: Leaving directory '/mnt/linux'
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$```


[8/24/2023 12:54 PM] kuratius
then copy over?


[8/24/2023 12:55 PM] kuratius
sorry what?


[8/24/2023 12:56 PM] kuratius
trying to figure out where the file is and where it needs to be


[8/24/2023 1:07 PM] szybet
data of the file


[8/24/2023 1:07 PM] szybet
letters made a parkour


[8/24/2023 1:15 PM] kuratius
I found where the file is


[8/24/2023 1:15 PM] kuratius
in /home/dk/nia/linux/.output/arch/arm/boot/dts/imx6ull-kobo-nia.dtb


[8/24/2023 1:16 PM] kuratius
and a copy in a pmboostrap mnt folder


[8/24/2023 1:16 PM] kuratius
still not sure where it needs to be copied


[8/24/2023 1:18 PM] kuratius
kobo-nia:~$ ls /boot/
boot.scr              initramfs             uImage
dtbs                  initramfs-extra       uInitrd
imx6ull-kobo-nia.dtb  lost+found            vmlinuz
kobo-nia:~$


[8/24/2023 1:18 PM] kuratius
the file also exists in in /boot/dtbs


[8/24/2023 1:18 PM] kuratius
do I need it in both locations?


[8/24/2023 1:19 PM] kuratius
I'll overwrite both and see what happens


[8/24/2023 1:19 PM] kuratius
maybe one is a file that I copied over manually at some point idk


[8/24/2023 1:22 PM] kuratius
kobo-nia:~$ sudo cp imx6ull-kobo-nia.dtb /boot/dtbs/.
[sudo] password for dk-x86: 
kobo-nia:~$ sudo cp imx6ull-kobo-nia.dtb /boot/.
kobo-nia:~$ sudo reboot
kobo-nia:~$ Connection to 172.16.42.1 closed by remote host.
Connection to 172.16.42.1 closed.
dk@dk-ThinkPad-E560:~$


[8/24/2023 1:22 PM] kuratius
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ scp .output/arch/arm/boot/dts/imx6ull-kobo-nia.dtb dk-x86@172.16.42.1:.
dk-x86@172.16.42.1's password: 
imx6ull-kobo-nia.dtb                          100%   31KB   2.1MB/s   00:00    
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$


[8/24/2023 1:23 PM] kuratius
screen is blank now


[8/24/2023 1:40 PM] andi15701
well, check creation date of the file -> I must have touched the mouse and moved the cursor so the last two letters appeared at another place


[8/24/2023 1:43 PM] kuratius
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$ ls -l .output/arch/arm/boot/dts/imx6ull-kobo-nia.dtb
-rw-r--r-- 1 12345 12345 32084  8月 24 12:54 .output/arch/arm/boot/dts/imx6ull-kobo-nia.dtb
[envkernel] dk@dk-ThinkPad-E560:~/nia/linux$


[8/24/2023 1:43 PM] kuratius
月 is month


[8/24/2023 1:43 PM] kuratius
I have Japanese locale, dont ask


[8/24/2023 1:44 PM] andi15701
ok, it looks fresh


[8/24/2023 1:46 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-2F2F6.txt


[8/24/2023 1:46 PM] kuratius
it's still the modified kernel that I had working display with before, so there's i2c comms being printed


[8/24/2023 10:59 PM] kuratius
if you split the big separation commit into a commit that just separates them, and smaller commits that include the modifications made, maybe it's easier to find the point where it breaks


[8/24/2023 11:00 PM] kuratius
I can test them then


[8/24/2023 11:00 PM] kuratius
I mean the big commit that splits things into nia and nia-c


[8/24/2023 11:00 PM] andi15701
I think I have found it


[8/24/2023 11:01 PM] andi15701
decompiling both results


[8/24/2023 11:01 PM] andi15701
and diffing


[8/24/2023 11:01 PM] kuratius
ok that sounds faster


[8/24/2023 11:01 PM] kuratius
what was the issue?


[8/24/2023 11:02 PM] andi15701
I moved the pinctrls of the pmic into the wrong section


[8/25/2023 8:53 AM] andi15701
pushed


[8/25/2023 8:54 AM] andi15701
check the newest dtb


[8/25/2023 10:01 AM] kuratius
screen is back


[8/25/2023 10:02 AM] kuratius
looks like it's fixed


[8/25/2023 10:02 AM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-9D498.txt


[8/25/2023 1:11 PM] andi15701
I am a bit confused about sleepcovers for the kobo


[8/25/2023 1:11 PM] andi15701
https://eu.kobobooks.com/products/kobo-nia-sleepcover

{Embed}
https://eu.kobobooks.com/products/kobo-nia-sleepcover
Kobo Nia SleepCover
Created from soft, vegan leather, the Kobo Nia SleepCover case incorporates innovative sleep and wake technology while providing maximum protection on-the-go.
/mnt/data/projects/git/conversations/media/LunaAccessoryClosedAqua_1200x1200-B5842.jpg


[8/25/2023 1:11 PM] andi15701
for the kobo nia


[8/25/2023 1:12 PM] andi15701
according to dtb, only rev c seems to have a sensor for these devices?!


[8/25/2023 1:12 PM] andi15701
but kobo itself sells them without remarks


[8/25/2023 1:13 PM] andi15701
saying that it is only for newer readers


[8/25/2023 1:14 PM] andi15701
I think I have finally fixed this one:


[8/25/2023 1:14 PM] andi15701
imx6ul-pinctrl 2290000.iomuxc-snvs: could not request pin 5 (MX6ULL_PAD_SNVS_TAMPER3) from group gpio_snvs_keys_grp  on device 2290000.iomuxc-snvs


[8/25/2023 1:14 PM] andi15701
which is also on stock kernel If I remember correctly


[8/25/2023 1:14 PM] andi15701
and due to less error-checking there, it is not harmful


[8/25/2023 1:15 PM] andi15701
while on newer kernels it seems to block the button registration


[8/25/2023 1:16 PM] kuratius
Power button?


[8/25/2023 1:17 PM] andi15701
yes


[8/25/2023 1:17 PM] andi15701
I accidently added the hall sensor from the rev c


[8/25/2023 1:18 PM] andi15701
which might not be there


[8/25/2023 1:18 PM] andi15701
can be checked with a magnet


[8/25/2023 1:21 PM] kuratius
https://old.reddit.com/r/kobo/comments/14g7z15/kobo_nia_sleepcover_doesnt_work/

{Embed}
https://old.reddit.com/r/kobo/comments/14g7z15/kobo_nia_sleepcover_doesnt_work/
From the kobo community on Reddit: Kobo Nia sleepcover doesn't work?
Explore this post and more from the kobo community
/mnt/data/projects/git/conversations/media/14g7z15-9BD12


[8/25/2023 1:22 PM] kuratius
I'll see if I can find  something


[8/25/2023 1:23 PM] szybet
no no no, the A also has a hal sensor


[8/25/2023 1:23 PM] szybet
it is there


[8/25/2023 1:24 PM] szybet
i even designed 2 3d printed cases for the nia...


[8/25/2023 1:24 PM] szybet
as for why its not in dts, no idea - maybe pmic manages it somehow, maybe its hardcoded - also it goes from event0 as power button


[8/25/2023 1:27 PM] andi15701
why not in the dts... well, it is ntx


[8/25/2023 2:00 PM] kuratius
got a magnet, where do i put it and what should happen when I do?


[8/25/2023 2:01 PM] szybet
left top


[8/25/2023 2:01 PM] szybet
idk, evtest event0 something should appear


[8/25/2023 2:03 PM] kuratius
will flash the new kernel


[8/25/2023 2:10 PM] kuratius


{Attachments}
/mnt/data/projects/git/conversations/media/message-19830.txt


[8/25/2023 2:10 PM] kuratius
seems to work


[8/25/2023 2:11 PM] kuratius
events only happen when I fuck around in the bottom left corner (top left in normal reader orientation, bottom left in pmbos screen orientation with usb port to the right)


[8/25/2023 2:34 PM] kuratius
dmesg for newest kernel

{Attachments}
/mnt/data/projects/git/conversations/media/message-A075D.txt


[8/25/2023 3:08 PM] kuratius
@Szybet Is there currently anything in inkbox that plays a continuous animation? something like a blinking cursor


[8/25/2023 3:08 PM] kuratius
?


[8/25/2023 3:09 PM] szybet
just write an fbink script...


[8/25/2023 3:09 PM] szybet
even my implemented mouse cursor doesnt blink


[8/25/2023 3:09 PM] szybet
i disabled all blinking cursors obviously


[8/25/2023 3:09 PM] szybet
freaking doom lol


[8/30/2023 5:24 PM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/IMG_20230827_192922-63674.jpg


[8/30/2023 5:24 PM] szybet
tolino shine, directly on the screen


[8/30/2023 5:24 PM] szybet
;D


[8/30/2023 5:45 PM] kuratius
What is that?  Extra capacitors so it doesn't get the nia issue?


[8/30/2023 5:47 PM] szybet
those are big capacitors


[8/30/2023 5:47 PM] andi15701
so probably for higher voltages


[8/30/2023 5:47 PM] szybet
its more than next to the PMIC im most kobos i saw


[8/30/2023 5:47 PM] szybet
yep


[8/30/2023 6:56 PM] andi15701
btw: do we have some register dump of the bd718?? on the Nia C from u-boot?


[8/30/2023 7:24 PM] szybet
nope


[8/30/2023 7:24 PM] szybet
i can provide if you say how


[8/30/2023 8:37 PM] andi15701
i2c dev 2


[8/30/2023 8:37 PM] andi15701
i2c md 0x4b 0 0xff


[8/30/2023 8:55 PM] szybet
in uboot?...


[8/30/2023 9:26 PM] andi15701
yes


[8/31/2023 12:00 AM] szybet
Tommorow i hope i will supply it


[8/31/2023 5:04 PM] .kitkat1.
```eBR-1A # i2c dev 2                                                              
Setting bus to 2                                                                
eBR-1A # i2c md 0x4b 0 0xff                                                     
wait_for_sr_state: failed sr=81 cr=a0 state=2020                                
i2c_init_transfer: failed for chip 0x4b retry=0                                 
wait_for_sr_state: failed sr=81 cr=a0 state=2020                                
i2c_init_transfer: failed for chip 0x4b retry=1                                 
wait_for_sr_state: failed sr=81 cr=a0 state=2020                                
i2c_init_transfer: failed for chip 0x4b retry=2                                 
i2c_init_transfer: give up i2c_regs=0x21a8000                                   
Error reading the chip: -110                                                    
eBR-1A # 
```


[8/31/2023 5:06 PM] .kitkat1.
whoops


[8/31/2023 5:20 PM] andi15701
i2c probe?


[8/31/2023 5:21 PM] andi15701
maybe in pmOS u-boot (booted via uuu)


[8/31/2023 5:21 PM] andi15701
perhaps the u-boot just does not do anything


[8/31/2023 5:24 PM] szybet
thats a command?


[8/31/2023 5:24 PM] andi15701
yes


[8/31/2023 5:25 PM] andi15701
the known working 2020.10 u-boot fork is somewhere in this thread also


[8/31/2023 7:59 PM] andi15701


{Attachments}
/mnt/data/projects/git/conversations/media/u-boot-dtb-2889F.imx


[9/1/2023 10:45 AM] szybet
will it worek on the C?


[9/1/2023 10:46 AM] szybet
+ how to boot it without overwriting? uuu somehow


[9/1/2023 2:20 PM] andi15701
well, remove sd card


[9/1/2023 2:21 PM] andi15701
and then turn it on and call uuu


[9/1/2023 2:21 PM] andi15701
should work on the c


[9/1/2023 3:21 PM] andi15701
so just uuu u-boot-dtb.imx


[9/1/2023 3:23 PM] andi15701
if uuu is not available as a package, it might be in a package called mfgtools


[9/1/2023 7:29 PM] andi15701
with a bit of creativity in the u-boot env you would probably be able to autodetect a/c


[9/1/2023 7:29 PM] andi15701
and load the corresponding binaries


[9/2/2023 10:12 PM] .kitkat1.
```
U-Boot 2020.10-00026-ge45fdb097f (Aug 31 2023 - 19:31:01 +0200)

arm-linux-gnueabihf-gcc (Debian 12.2.0-14) 12.2.0
GNU ld (GNU Binutils for Debian) 2.40
=> 
```
booted?


[9/2/2023 10:12 PM] .kitkat1.
```
=> i2c dev 2
Setting bus to 2
Failure changing bus number (-19)
=> 
```


[9/2/2023 10:12 PM] .kitkat1.
another error


[9/2/2023 10:13 PM] andi15701
three


[9/2/2023 10:14 PM] .kitkat1.
yes makes sense


[9/2/2023 10:14 PM] .kitkat1.
```
=> i2c dev 3
Setting bus to 3
=> i2c md 0x4b 0 0xff
0000: 22 12 83 01 00 00 00 09 0f 00 06 90 40 90 00 00    "...........@...
0010: 00 00 00 00 06 10 08 30 00 00 00 00 0e 00 0c 0e    .......0........
0020: 00 08 0e 00 10 00 00 06 40 40 40 00 00 00 00 00    ........@@@.....
0030: 00 06 30 10 40 00 00 00 00 0e 32 0e 32 10 14 0e    ..0.@.....2.2...
0040: 32 0e 32 32 00 0e 28 00 02 00 10 03 03 14 a0 06    2.22..(.........
0050: 02 09 23 44 15 93 00 23 07 23 00 00 12 00 01 01    ..#D...#.#......
0060: 00 00 00 00 00 03 02 30 01 03 01 63 00 09 00 01    .......0...c....
0070: c9 36 04 37 2f 2e 18 1d 64 a2 60 09 94 30 30 30    .6.7/...d.`..000
0080: 00 14 42 03 0f c9 0f 92 0f 92 0f 8d 0f c6 0f 13    ..B.............
0090: 10 8a 0f 39 0f e6 0f e2 0f 0f 11 30 03 dc 1b 07    ...9.......0....
00a0: ec 0a 93 08 6b 00 8c 28 c8 28 01 ff 6a 0f 00 00    ....k..(.(..j...
00b0: 06 94 06 91 00 03 f6 f7 14 03 e2 1a 96 00 00 00    ................
00c0: 00 00 18 01 40 7f 64 71 8c 5e a5 0a 03 61 00 3f    ....@.dq.^...a.?
00d0: 00 1f 00 00 00 00 00 00 00 00 00 00 00 00 00 54    ...............T
00e0: 00 01 2d 00 80 00 00 02 00 00 00 00 00 00 00 00    ..-.............
00f0: 50 d2 3c 00 20 50 98 04 31 08 23 00 00 00 00    P.<. P..1.#....
```


[9/2/2023 10:14 PM] .kitkat1.
the pmic on the nia A also is on the 3 bus


[9/2/2023 10:15 PM] andi15701
i2c md 0x32 0 1


[9/2/2023 10:15 PM] andi15701
echo $?


[9/2/2023 10:17 PM] andi15701
if that is not zero, we also could auto-detect the revision in u-boot and select correct devicetree and other things and have one combined image for both revisions


[9/2/2023 10:19 PM] andi15701
that is just couriosity


[9/2/2023 10:29 PM] .kitkat1.
the device gets into a boot brick after booting this uboot, and many looong tries of rebooting it are needed to make it actually reboot


[9/2/2023 10:31 PM] andi15701
ok, interesting to know


[9/2/2023 10:32 PM] andi15701
this u-boot cannot power off the device, so you have to rely on long button presses to have things powered off


[9/2/2023 10:32 PM] .kitkat1.
makes sense


[9/2/2023 10:32 PM] .kitkat1.
```
=> i2c dev 3
Setting bus to 3
=> i2c md 0x32 0 1
Error reading the chip: -121
=> 
```


[9/2/2023 10:32 PM] andi15701
echo $?


[9/2/2023 10:33 PM] .kitkat1.
```
=> i2c dev 3
Setting bus to 3
=> i2c md 0x32 0 1
Error reading the chip: -121
=> echo $
$
=> 
```


[9/2/2023 10:33 PM] .kitkat1.
?


[9/2/2023 10:33 PM] andi15701
with question mark


[9/2/2023 10:33 PM] andi15701
$? = result of last command


[9/2/2023 10:33 PM] .kitkat1.
it's 0


[9/2/2023 10:34 PM] .kitkat1.
wait


[9/2/2023 10:34 PM] .kitkat1.
its 1


[9/2/2023 10:34 PM] .kitkat1.
```
=> i2c md 0x32 0 1
No I2C bus selected
Error reading the chip: -19
=> i2c dev 3
Setting bus to 3
=> i2c md 0x32 0 1
Error reading the chip: -121
=> echo $
$
=> echo $?
0
=> i2c md 0x32 0 1
Error reading the chip: -121
=> echo $?        
1
=> 
```


[9/2/2023 10:34 PM] andi15701
ok, that can be used in an if clause


[9/2/2023 10:34 PM] andi15701
but that is something for later


[9/2/2023 10:35 PM] .kitkat1.
anything else to try?


[9/2/2023 10:40 PM] andi15701
well,


[9/2/2023 10:40 PM] andi15701
register dump in a running system


[9/2/2023 10:40 PM] andi15701
inkbox or nickel


[9/2/2023 10:41 PM] andi15701
i2cdump -f -y  3 0x4b


[9/2/2023 10:44 PM] andi15701
might be included in e.g. busybox


[10/1/2023 8:12 PM] kuratius
@andi One of my friends bought a tolino page 2 recently,  do you think it's worth trying if the nia image boots?


[10/1/2023 8:16 PM] andi15701
not without checking the hw differences


[10/1/2023 8:17 PM] kuratius
Will see in a bit what it looks like, he apparently just ordered it


[10/10/2023 6:26 AM] kuratius
I'm gonna try to see if koreader armhf deb works on pmOS without lightdm


[10/10/2023 6:48 AM] kuratius
apparently alpine has dpkg in its repo, so first need to figure out how to give it internet again


[10/10/2023 6:48 AM] kuratius
networking via usb doesnt seem to be working, so I'll remove the modified kernel first


[10/10/2023 7:15 AM] kuratius
am I forgetting something?
did this on nia
sudo route add default gw 172.16.42.2

did this on laptop with sudo sh
echo 1 >/proc/sys/net/ipv4/ip_forward ; iptables -t nat -I POSTROUTING -o wlp1s0 -j MASQUERADE


[10/10/2023 7:16 AM] kuratius
kobo-nia:~$ echo nameserver 9.9.9.9 | sudo tee /etc/resolv.conf
nameserver 9.9.9.9
kobo-nia:~$


[10/10/2023 7:20 AM] kuratius
kobo-nia:~$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8): 56 data bytes
^C
--- 8.8.8.8 ping statistics ---
6 packets transmitted, 0 packets received, 100% packet loss
kobo-nia:~$


[10/10/2023 7:20 AM] kuratius
kobo-nia:~$ uname -a
Linux kobo-nia 6.3.0 #6-postmarketOS Tue Oct 10 04:54:16 UTC 2023 armv7l Linux
kobo-nia:~$


[10/10/2023 7:24 AM] kuratius
kobo-nia:~$ ifconfig
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

usb0      Link encap:Ethernet  HWaddr AA:27:7F:49:94:6D  
          inet addr:172.16.42.1  Bcast:172.16.255.255  Mask:255.255.0.0
          inet6 addr: fe80::b581:6040:ffb:d495/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:738 errors:0 dropped:0 overruns:0 frame:0
          TX packets:530 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:56210 (54.8 KiB)  TX bytes:88825 (86.7 KiB)


[10/10/2023 7:26 AM] kuratius
```
 iwconfig
lo        no wireless extensions.

enp0s31f6  no wireless extensions.

wlp1s0    IEEE 802.11  ESSID:"snip"  
          Mode:Managed  Frequency:2.437 GHz  Access Point: 34:31:C4:41:97:6C   
          Bit Rate=72.2 Mb/s   Tx-Power=20 dBm   
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Encryption key:off
          Power Management:on
          Link Quality=68/70  Signal level=-42 dBm  
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:0  Invalid misc:167   Missed beacon:0

docker0   no wireless extensions.

usb0      no wireless extensions.```


[10/10/2023 7:35 AM] kuratius
https://wiki.postmarketos.org/wiki/USB_Internet

{Embed}
https://wiki.postmarketos.org/wiki/USB_Internet
USB Internet


[10/10/2023 7:35 AM] kuratius
will try this


[10/10/2023 7:37 AM] kuratius
this worked


[10/10/2023 7:37 AM] kuratius
for some reason


[10/10/2023 7:38 AM] kuratius
kobo-nia:~$ sudo dpkg -i koreader-2023.08-armhf.deb 
dpkg: error processing archive koreader-2023.08-armhf.deb (--install):
 package architecture (armhf) does not match system (musl-linux-armhf)
Errors were encountered while processing:
 koreader-2023.08-armhf.deb
kobo-nia:~$


[10/10/2023 7:39 AM] kuratius
so question is now: is this error irrelevant? or do I need a koreader compiled with musl?


[10/10/2023 7:39 AM] kuratius
@NiLuJe Do you happen to know if there is a musl package of koreader or do I need to make one?


[10/10/2023 1:00 PM] andi15701
well, it is not, bottom line, there is a build system hard to understand,  forked libraries everywhere, even bugfixes are not upstreamed


[10/10/2023 1:02 PM] andi15701
so if you want to rebuild all that stuff, you have to redo all the fixes done by alpine


[10/10/2023 1:03 PM] andi15701
well, it is basically a bunch of lua scripts


[10/10/2023 1:03 PM] andi15701
using some shared library plugins, depending on various other libraries


[10/10/2023 1:05 PM] andi15701
so you probably get a lot of stuff done by copying just the lua stuff in place


[10/10/2023 1:07 PM] kuratius
https://github.com/koreader/koreader/pull/10115

{Embed}
https://github.com/koreader/koreader/pull/10115
[doc] Build deps for alpine by mio-19 · Pull Request #10115 · korea...
This change is
/mnt/data/projects/git/conversations/media/10115-46FC1


[10/10/2023 1:07 PM] andi15701
some dev claimed that he just copied over stuff


[10/10/2023 1:08 PM] andi15701
and done it that way


[10/10/2023 1:11 PM] andi15701
so what  is going on there:


[10/10/2023 1:11 PM] andi15701
https://github.com/koreader/koreader/issues/10116

{Embed}
https://github.com/koreader/koreader/issues/10116
Build issue on Alpine with tesseract · Issue #10116 · koreader/kore...
KOReader version: 91ff6ce Issue Log /base/thirdparty/leptonica/build/aarch64-alpine-linux-musl-debug/leptonica-prefix/src/leptonica/src/. -Og -g -pipe -fno-omit-frame-pointer -march=native -fPIC -O...
/mnt/data/projects/git/conversations/media/10116-7B1B0


[10/10/2023 1:12 PM] andi15701
it is about fixid build issues probably already fixed if you would just use the alpine package for that library


[10/10/2023 1:15 PM] kuratius
I'm confused about how to translate that into actionable steps
Do I need to compile on the device itself?
Do I need to compile somewhere else first then copy some parts?


[10/10/2023 1:16 PM] kuratius
I am assuming there is some dev library required by koreader that has a working alpine equivalent


[10/10/2023 1:16 PM] kuratius
so getting the alpine equiv would mean either compiling in in alpine environment or copying lua scripts and whatnot


[10/10/2023 1:17 PM] kuratius
anyway, I cloned the koreader repo for now, will see if the emulator builds


[10/10/2023 1:30 PM] andi15701
koreader brings everything by its own to survive in a hostile environment


[10/10/2023 1:31 PM] andi15701
and that is fine, but


[10/10/2023 1:31 PM] andi15701
most projects have options in their build process


[10/10/2023 1:32 PM] andi15701
to use system-provided libraries


[10/10/2023 1:32 PM] andi15701
koreader has not


[10/10/2023 1:32 PM] andi15701
and here we are not in a hostile environment like the stock operating system of some reader


[10/10/2023 1:34 PM] andi15701
well, the step forward might be to create an install script to install all that lua stuff


[10/10/2023 1:35 PM] andi15701
the "emulator" builds use sdl from host and base everything on top of that


[10/10/2023 1:44 PM] andi15701
you can probably install the lua stuff


[10/10/2023 1:45 PM] andi15701
and then find out what is missing


[10/10/2023 4:34 PM] ninuje
There isn't. I'm also not sure if anyone ever tried it, there may be GNUisms involved (and possibly via FFI, for extra funtimes).


[10/10/2023 4:34 PM] ninuje
You'll have better success just running it in a glibc chroot


[10/10/2023 4:36 PM] ninuje
Said FFI stuff is also why we can't really do a system-libs approach, as even a minor API break would cause issues, unlike in C (or any language that actually *links*)


[10/10/2023 4:37 PM] ninuje
Instead, because FFI, this is dlopen & dlsym land, so, pinned vendored stuff it is.


[10/10/2023 6:05 PM] andi15701
well, I doubt, it is totally black and white. you use system libsdl. You run into trouble also in c if runtime libraries does not match compile time api.  That can be a bit catched by different version numbers in the library.so. If we really create a comparable situation in c, it would be shipping the library headers of the required libraries and then linking with the system libraries, it will break if struct sizes are different, etc. So the only clean and safe way (so useable for an official release) to use system libraries would be if also the system provides lua bindings or they are generated during the build process.


[10/10/2023 6:05 PM] andi15701
so it is some work to do


[10/10/2023 6:32 PM] ninuje
We indeed have had runtime SDL issues because of outdated FFI declarations in the past ;).


[10/10/2023 6:32 PM] ninuje
The macOS build ships it to avoid that


[10/10/2023 6:33 PM] ninuje
Generating the cdecls during build wouldn't help you if there's an API break that requires code changes, though


[10/10/2023 6:34 PM] ninuje
(And the current GCC plugin we use for that is starting to break down on current GCC versions, which is another hurdle for that)


[10/10/2023 6:35 PM] ninuje
I use Gentoo, I'm fully aware that vendoring stuff is awful and terrible and I hate it (hai, rust). We just don't really have a sane way to do otherwise here ;o)


[10/10/2023 10:34 PM] andi15701
well, using system libraries comes always with compatibility checks and/or defining some version requirements, that should be nothing different than that, if the lua-specific stuff is generated from system headers/provided by system. If it is more than just using libs from  distro rolling releases (like alpine edge), that will become harder


[10/10/2023 10:35 PM] andi15701
some words about my activity, I am a bit more focussed on the bt200 the last weeks because I want to try out hammock-hacking a bit. before it gets too cold


[10/10/2023 10:36 PM] andi15701
and that one is a beast in a totally different level than the kobos


[10/10/2023 11:07 PM] andi15701
regarding koreader: to me it looks like the choice between the devil and the deep blue sea


[10/10/2023 11:07 PM] andi15701
glibc chroot consumes more memory


[10/10/2023 11:07 PM] andi15701
fixing things to work with musl ends up in duplicate work


[10/10/2023 11:11 PM] andi15701
using system libraries.. we have discussed it


[10/10/2023 11:45 PM] szybet
```
[11821.621484] PMU: mainFlowOfLowVoltage :    Noxx : cc_delta_cap is -6, cc_delta_cap_now is -286, last_cc_delta_cap is -280
[11821.621557] PMU: mainFlowOfLowVoltage :    Noxx : temp_cc_delta_cap is 0, after temp_cc_delta_cap_mas is -128, cc_cap_mas -92524
[11821.621634] PMU: mainFlowOfLowVoltage :    No9 :Cap is 9220 , low_rate is 124, dsoc is 9460, capnow is 9170, capzero is 0, delta cc is -7, delta cc ori is -6
[11821.621685] PMU: mainFlowOfLowVoltage :    No10 :temp_mas is -270, offset_mas is -142, value is -744, final value is -7
[11821.624229] PMU : set_current_time2register : second is 1696971929, hour is 471381
[11821.629243] PMU:STATUS= 7: IBAT= -48: VSYS= 4035000: VBAT= 4051225: DSOC= 9460: RSOC= 9900: cc_delta=91: rrf= 0
```
those messages are also new


[10/10/2023 11:49 PM] szybet
As i have the oldest nia of all people, i will ask this question and ignore the fact that i modified the heck out of it ( the PMIC current change, usb host mode, external sd card... ):

sometimes my nia doesnt wake up from sleep when its being charged: also it doesnt charge to 100% only to and always 92%. Sometimes if i click the button a few times faster it wake ups, based on the led activity i'm sure that the system inside works, it's waking up but the eink screen only refreshes, clears itself but nothing new appears on the screen, it remains pure white??? After a forced reboot everything is fine?


[10/11/2023 8:15 AM] andi15701
well, from all that modifications: I would expect some wrong capacity showing up in the first place


[10/11/2023 9:46 AM] szybet
thats understandable


[10/11/2023 9:47 AM] szybet
as 60% of the time im charging it from the second battery then well, yea


[10/11/2023 8:41 PM] ninuje
Oh, yeah, to clarify, that was just as a recommendation as the path of least resistance for a quick PoC


[10/11/2023 8:41 PM] ninuje
I expect minor but not insurmountable build issues against musl


[10/11/2023 8:42 PM] ninuje
And possibly hilariously GNUisms issues at runtime that would be *very* fun to debug


[10/11/2023 8:42 PM] ninuje
And would need a way to be able to ID musl at runtime (say, a specific symbol in the libc?) to handle


[10/11/2023 8:42 PM] ninuje
Patches very welcome for those


[10/11/2023 8:44 PM] ninuje
(Or some musl-specific behavior in some functions that could be probed, like we probe for BSD variants via clock_getres clock IDs)


[10/17/2023 12:06 AM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/image-C033F.png


[10/17/2023 12:07 AM] szybet
How do i use this fancy ntx reset ;)...


[10/17/2023 12:38 AM] andi15701
you can try to unbind and re-bind the driver


[10/17/2023 12:38 AM] andi15701
but first I need some sleep


[10/17/2023 8:59 AM] szybet
Well, how


[10/17/2023 9:06 AM] andi15701
usually you have /sys/bus/$bustype/devices/$dev and /sys/bus/$bustype/drivers/$driver


[10/17/2023 9:07 AM] andi15701
you do echo $dev >/sys/bus/$bustype/drivers/$driver/unbind


[10/17/2023 9:07 AM] andi15701
and echo $dev >/sys/bus/$bustype/drivers/$driver/bind


[10/17/2023 9:08 AM] andi15701
in sys/bus/$bustype/drivers/$driver you find also symlinks to sys/bus/$bustype/devices/$dev if the driver is bound to that device


[10/17/2023 10:11 AM] szybet
we


[10/17/2023 10:11 AM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/message-D7A91.txt


[10/17/2023 10:14 AM] andi15701
echo 0-0015 should be correct


[10/17/2023 10:14 AM] andi15701
if there is no symlink in the driver directory, unbind should be succesful


[10/17/2023 10:15 AM] andi15701
echo 0-0015 >bind should then rebind it


[10/17/2023 10:16 AM] szybet
```
[  951.498618] [elan_touch_report_data-603] Hello packet 55:55:55:55:ff:ff:ff:ff received
[  952.468171] [elan] __hello_packet_handler: touch_int not low.
[  953.691173] [elan] __hello_packet_handler: touch_int not low.
[  954.909157] [elan] __hello_packet_handler: touch_int not low.
[  956.119159] [elan] __hello_packet_handler: touch_int not low.
[  957.340144] [elan] __hello_packet_handler: touch_int not low.
[  958.545757] [elan] __hello_packet_handler: touch_int not low.
[  958.545783] Read Hello Packet Fail
[  958.545827] elan-touch: probe of 0-0015 failed with error -22
```
unbind doesnt work, only bind


[10/17/2023 10:16 AM] szybet
and it still waits a few second and then gives `-bash: echo: write error: No such device` anyway with those dmesg messages


[10/17/2023 10:17 AM] szybet
and touch no longer works


[10/17/2023 10:17 AM] szybet
well no suprice


[10/17/2023 10:18 AM] andi15701
the 0-0015 symlink in  /sys/bus/i2c/drivers/elan_touch/ seems to have disappeared, so unbind should be successful despite of errors. You can then also try to export that reset gpio and do the reset via /sys/class/gpio


[10/17/2023 10:18 AM] andi15701
and then do the bind


[10/17/2023 10:19 AM] szybet
```
kobo:/sys/class/gpio# ls
export       gpiochip0    gpiochip128  gpiochip32   gpiochip64   gpiochip96   unexport
```


[10/17/2023 10:19 AM] szybet
hm, how


[10/17/2023 10:20 AM] andi15701
echo 38 >/sys/class/gpio/export


[10/17/2023 10:20 AM] szybet
how do you know its 38


[10/17/2023 10:20 AM] andi15701
it is not


[10/17/2023 10:21 AM] szybet
?...


[10/17/2023 10:21 AM] szybet
then why


[10/17/2023 10:21 AM] andi15701
gpio_elan_rst = <&gpio1 6 0>;


[10/17/2023 10:21 AM] andi15701
the 1 there is not counting from 0


[10/17/2023 10:22 AM] andi15701
so it is (1 -1)*32  + 6


[10/17/2023 10:22 AM] andi15701
you can look at arch/arm/boot/dts/imx6ull.dtsi to confirm that we are starting at 1


[10/17/2023 10:23 AM] andi15701
so it is echo 6 >/sys/class/gpio/export


[10/17/2023 10:23 AM] szybet
ugh... i hate gpio numbering on any device or cpu


[10/17/2023 10:24 AM] szybet


{Attachments}
/mnt/data/projects/git/conversations/media/message-E50CA.txt


[10/17/2023 10:24 AM] szybet
idk what to look for


[10/17/2023 10:24 AM] andi15701
welle gpio1


[10/17/2023 10:25 AM] andi15701
and check if there is a gpio0


[10/17/2023 10:26 AM] szybet
```
/ {
    aliases {
        can0 = &flexcan1;
        can1 = &flexcan2;
        ethernet0 = &fec1;
        ethernet1 = &fec2;
        gpio0 = &gpio1;
        gpio1 = &gpio2;
        gpio2 = &gpio3;
        gpio3 = &gpio4;
        gpio4 = &gpio5;
```


[10/17/2023 10:26 AM] andi15701
to really cross check you can try to export it while the touchscreen is bound


[10/17/2023 10:27 AM] andi15701
it should say busy


[10/17/2023 10:27 AM] andi15701
and then try again after it is unbound


[10/17/2023 10:27 AM] andi15701
i should not say busy anymore


[10/17/2023 10:27 AM] andi15701
to really be sure, you use the right number


[10/17/2023 10:28 AM] szybet
so 6 then?


[10/17/2023 10:28 AM] andi15701
yes


[10/17/2023 10:33 AM] szybet
yep says busy


[10/17/2023 10:34 AM] szybet
unbind does in fact turn off the touch screen


[10/17/2023 10:34 AM] szybet
and the device crashed now


[10/17/2023 10:45 AM] szybet
yea i always crashes now


[10/17/2023 10:45 AM] szybet
idk why it worked the first time


[1/24/2024 9:52 PM] kuratius
I tried compiling the clara image again on arm 64, is there a way for me to figure out the header gcc needs to find the function gen_load_tp_hard?


[1/24/2024 9:56 PM] kuratius
https://www.apt-browse.org/browse/ubuntu/xenial/universe/amd64/gcc-arm-none-eabi/15:4.9.3+svn231177-1/file/usr/lib/gcc/arm-none-eabi/4.9.3/plugin/include/insn-flags.h maybe this?


[1/24/2024 10:01 PM] kuratius
I'll try adding extern rtx gen_load_tp_hard(rtx) to the gcc plugin and see if the linker finds it eventually


[1/24/2024 10:02 PM] kuratius
ok great pmbootstrap overwrites my changes


[1/24/2024 10:04 PM] kuratius
the file I tried to modify (and where compiler is complaining about a missing header) is .local/var/pmboostrap/chroot_native/home/pmos/build/serc/linux-879daa81c5939cae8bc079bcb34e911b6658e500/scripts/gcc-plugins/arm_ssp_per_task_plugin.c


[1/24/2024 10:07 PM] kuratius
that src directory doesnt even exist on my x86 install


[1/24/2024 10:07 PM] kuratius
wtf


[1/24/2024 10:08 PM] kuratius
now it exists


[1/24/2024 10:09 PM] kuratius
different numbers are linux- in the directory path


[1/24/2024 10:09 PM] kuratius
but I'll ignore that


[1/24/2024 10:09 PM] kuratius
the file looks the same


[1/24/2024 10:09 PM] kuratius
let's check the header


[1/24/2024 10:10 PM] kuratius
and see if complains about the missing symbol if I randomly try to compile it


[1/24/2024 10:19 PM] kuratius
yah this thing doesnt find a lot more headers if I do that


[1/25/2024 3:48 AM] kuratius
maybe gcc-10-plugin-dev has the right header?


[1/25/2024 3:50 AM] kuratius
nope


==============================================================
Exported 5,521 message(s)
==============================================================
